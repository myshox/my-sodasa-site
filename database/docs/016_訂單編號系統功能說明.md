# 訂單編號系統功能說明

## 📋 功能概覽

本次更新為贊助系統新增了**完整的訂單編號追蹤系統**，讓用戶和管理員都能透過唯一的訂單編號輕鬆追蹤每一筆交易。

---

## ✨ 主要功能

### 1️⃣ 資料庫層級

#### 新增欄位
- **欄位名稱**: `order_number`
- **類型**: TEXT
- **約束**: UNIQUE（確保唯一性）
- **索引**: 已建立 `idx_donations_order_number` 以優化查詢效能

#### 訂單編號格式
```
格式：SD + 日期 + 流水號
範例：SD20260201-001
      SD20260201-002
      SD20260202-001 (新的一天重新計數)
```

- **SD**: 蘇打石器 (SoDa Stone Age) 的縮寫
- **日期**: YYYYMMDD 格式
- **流水號**: 3位數字，每天從001開始

#### 自動生成機制
1. **PostgreSQL 函數**: `generate_order_number()`
   - 自動產生符合格式的唯一訂單編號
   - 每天流水號從001開始遞增
   - 確保不會重複

2. **觸發器**: `trigger_set_order_number`
   - 在插入新記錄時自動觸發
   - 無需前端手動處理
   - 確保每筆交易都有訂單編號

3. **歷史資料補全**
   - 為現有沒有訂單編號的紀錄自動生成
   - 按照 `created_at` 時間順序分配編號

---

### 2️⃣ 前端顯示（用戶端）

#### 儲值確認彈窗
當用戶選擇支付方式後，會在支付確認彈窗中看到：

```
┌──────────────────────────────┐
│ 訂單編號    SD20260201-001  📋 │  ← 可點擊複製
│ 遊戲帳號    PlayerName123      │
│ LINE 名稱   我是玩家           │
│ 支付金額    NT$ 100           │
│ 獲得金幣    150 Gold          │
└──────────────────────────────┘
```

**功能**:
- ✅ 訂單編號以紫色高亮顯示
- ✅ 點擊複製按鈕可快速複製到剪貼簿
- ✅ 複製後會顯示「訂單編號已複製」提示
- ✅ 用戶可截圖保存以便日後查詢

---

### 3️⃣ 後台管理（管理員端）

#### 桌面版表格
在「贊助管理」頁面中，新增**訂單編號**欄位：

```
┌─────────────┬─────────┬───────────┬────────┐
│  訂單編號    │  時間   │ 玩家資訊  │  金額  │
├─────────────┼─────────┼───────────┼────────┤
│ SD20260201  │ 02/01   │ Player123 │ NT$100 │
│ -001 📋     │ 15:30   │ xxx@xx    │        │
└─────────────┴─────────┴───────────┴────────┘
```

#### 手機版卡片
手機版會在卡片頂部顯示：

```
┌─────────────────────────────────┐
│ ☑  ✅ 已完成          02/01    │
│ 訂單：SD20260201-001 📋         │  ← 可點擊複製
├─────────────────────────────────┤
│ PlayerName123                   │
│ xxx@gmail.com                   │
└─────────────────────────────────┘
```

#### CSV 匯出
匯出的 CSV 檔案包含訂單編號欄位：

| 訂單編號 | 時間 | 遊戲帳號 | Email | LINE名稱 | 金額 | ... |
|---------|------|---------|-------|---------|------|-----|
| SD20260201-001 | 2026/02/01 15:30 | Player | xxx@xx | ... | 100 | ... |

---

## 🔧 實作細節

### 資料庫函數

```sql
-- 生成訂單編號
CREATE OR REPLACE FUNCTION generate_order_number()
RETURNS TEXT AS $$
DECLARE
    date_prefix TEXT;
    max_sequence INTEGER;
    new_order_number TEXT;
BEGIN
    date_prefix := 'SD' || TO_CHAR(NOW(), 'YYYYMMDD');
    
    SELECT COALESCE(MAX(CAST(SUBSTRING(order_number FROM LENGTH(date_prefix) + 2) AS INTEGER)), 0)
    INTO max_sequence
    FROM donations
    WHERE order_number LIKE date_prefix || '-%';
    
    new_order_number := date_prefix || '-' || LPAD((max_sequence + 1)::TEXT, 3, '0');
    
    RETURN new_order_number;
END;
$$ LANGUAGE plpgsql;
```

### 觸發器

```sql
-- 自動設置訂單編號
CREATE TRIGGER trigger_set_order_number
    BEFORE INSERT ON donations
    FOR EACH ROW
    EXECUTE FUNCTION set_order_number();
```

---

## 🎯 使用場景

### 用戶查詢
用戶可以透過訂單編號聯繫客服：
> "您好，我的訂單編號 SD20260201-001 已經支付，但尚未收到金幣，麻煩協助查詢。"

### 管理員對帳
管理員可以快速搜尋特定訂單：
1. 在搜尋框輸入訂單編號
2. 快速定位到該筆交易
3. 查看詳細資訊並處理

### 報表匯出
匯出 CSV 檔案時：
- 包含完整訂單編號
- 方便在 Excel 中進行對帳
- 可用於財務報表製作

---

## 📊 技術優勢

### 1. 唯一性保證
- 資料庫層級 UNIQUE 約束
- PostgreSQL 函數確保序列不重複

### 2. 效能優化
- 建立索引加速查詢
- 觸發器自動執行，不影響前端效能

### 3. 用戶體驗
- 一鍵複製功能
- 清晰的視覺呈現
- 手機與桌面版均適配

### 4. 可追溯性
- 每筆交易都有明確編號
- 便於問題追蹤與客服支援
- 方便財務對帳

---

## 🔄 向後兼容

- ✅ 現有記錄會自動補全訂單編號
- ✅ 按時間順序分配，保持連續性
- ✅ 前端會檢查 `order_number` 是否存在，未來擴展性強

---

## 📝 部署步驟

1. **執行 SQL 腳本**:
   ```bash
   # 在 Supabase SQL Editor 執行
   database/migrations/016_add_order_number.sql
   ```

2. **驗證功能**:
   - 新增一筆測試贊助
   - 確認訂單編號自動生成
   - 檢查前端是否正確顯示

3. **測試複製功能**:
   - 點擊複製按鈕
   - 確認 Toast 提示正常
   - 驗證剪貼簿內容

---

## 🎉 使用效果

### 前端（用戶視角）
用戶在支付時可以看到醒目的訂單編號，並可隨時複製保存，方便聯繫客服時提供明確的交易憑證。

### 後台（管理員視角）
管理員可以快速透過訂單編號搜尋特定交易，大幅提升對帳效率和客服品質。

---

## 🚀 未來擴展

可考慮的功能：
- 訂單編號 QR Code 生成
- 訂單狀態推播通知（關聯訂單編號）
- 訂單編號自動發送到用戶信箱
- 訂單編號統計分析報表
