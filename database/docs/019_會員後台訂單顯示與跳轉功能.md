# 會員後台訂單顯示與跳轉功能

## 📋 更新概覽

根據用戶需求，完成以下兩個主要功能：
1. **會員後台顯示訂單編號和詳細儲值記錄**
2. **儲值完成後自動跳轉到會員後台查看訂單**

---

## ✨ 主要功能

### 1️⃣ 會員後台訂單顯示優化

#### 新增功能
- ✅ 顯示訂單編號（紫色標籤 + 可複製）
- ✅ 顯示獲得金幣數量
- ✅ 支付方式中文化（LINE Pay、SHOPLINE）
- ✅ 待處理訂單顯示提醒區塊
- ✅ 響應式設計（手機/桌面）

#### 訂單卡片結構

```
┌─────────────────────────────────────────────┐
│ NT$ 100    [SD20260201-001] 📋   ✅ 已完成  │
├─────────────────────────────────────────────┤
│ 方案名稱：金幣 150 方案                      │
│ 獲得金幣：150 Gold                          │
│ 遊戲帳號：PlayerName                        │
│ 支付方式：LINE Pay                          │
│ 儲值時間：2026/02/01 15:30:00               │
└─────────────────────────────────────────────┘
```

#### 待處理訂單提醒

當訂單狀態為 `pending`（處理中）時，會在卡片底部顯示黃色提醒區塊：

```
┌─────────────────────────────────────────────┐
│ ⏳ 待處理：請將訂單編號截圖傳送給           │
│ [LINE 客服] 完成核對                        │
│ ⏰ 人工客服時間：10:00 - 18:00              │
└─────────────────────────────────────────────┘
```

---

### 2️⃣ 支付完成後跳轉功能

#### LINE Pay 流程

```
用戶完成 LINE Pay 支付
    ↓
點擊「是否完成支付？」
    ↓
生成訂單編號
    ↓
顯示「✅ 訂單已建立」對話框
    ↓
點擊「前往會員後台查看」
    ↓
【自動跳轉到會員後台】
    ↓
顯示最新訂單記錄 ✅
```

#### SHOPLINE 流程

```
點擊「前往外部支付頁面」
    ↓
生成訂單編號
    ↓
顯示「⚠️ 前往付款前請先閱讀」對話框
    ↓
點擊「我已截圖，前往支付」
    ↓
【開啟外部支付頁面（新分頁）】
【同時跳轉到會員後台（原分頁）】
    ↓
用戶在會員後台看到新建立的訂單
    ↓
用戶在新分頁完成支付
    ↓
返回會員後台，將截圖傳送給客服 ✅
```

---

## 🔧 技術實作

### 1. 會員後台訂單顯示

#### 修改 `MemberPage` 組件

```jsx
<div className="space-y-4">
    {sponsorships.map((item) => (
        <div key={item.id} className="bg-stone-50 rounded-2xl p-5 border-2 border-stone-100 hover:border-gold-200 transition-colors">
            {/* 頭部：金額 + 訂單編號 + 狀態 */}
            <div className="flex flex-col md:flex-row md:items-center justify-between mb-3 gap-2">
                <div className="flex items-center gap-3">
                    <span className="text-gold-600 font-black text-lg">
                        NT$ {item.amount}
                    </span>
                    {item.order_number && (
                        <div className="flex items-center gap-2">
                            <code className="text-xs font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded border border-purple-300">
                                {item.order_number}
                            </code>
                            <button onClick={() => {
                                navigator.clipboard.writeText(item.order_number);
                                showToast('訂單編號已複製', 'success');
                            }}>
                                <Copy size={14} />
                            </button>
                        </div>
                    )}
                </div>
                <span className={`px-3 py-1 rounded-full text-sm font-bold ${...}`}>
                    {item.status === 'completed' ? '✅ 已完成' : '⏳ 處理中'}
                </span>
            </div>
            
            {/* 訂單詳情 */}
            <div className="text-stone-600 text-sm space-y-1">
                <p>方案名稱：{item.plan_name}</p>
                <p>獲得金幣：<span className="text-gold-600 font-bold">{item.coins.toLocaleString()} Gold</span></p>
                <p>遊戲帳號：{item.game_account}</p>
                <p>支付方式：{item.payment_method === 'linepay' ? 'LINE Pay' : 'SHOPLINE'}</p>
                <p>儲值時間：{new Date(item.created_at).toLocaleString('zh-TW')}</p>
            </div>
            
            {/* 待處理提醒 */}
            {item.status === 'pending' && (
                <div className="mt-3 pt-3 border-t border-stone-200">
                    <div className="bg-yellow-50 border-l-4 border-yellow-500 p-3 rounded">
                        <p className="text-sm text-stone-700">
                            ⏳ 待處理：請將訂單編號截圖傳送給 
                            <a href="LINE客服連結" className="text-line-500 font-bold hover:underline">
                                LINE 客服
                            </a> 完成核對
                        </p>
                        <p className="text-xs text-stone-500 mt-1">⏰ 人工客服時間：10:00 - 18:00</p>
                    </div>
                </div>
            )}
        </div>
    ))}
</div>
```

---

### 2. 支付完成跳轉功能

#### 添加 `useNavigate` Hook

```jsx
const RechargePage = () => {
    const navigate = useNavigate();
    // ... 其他狀態
};
```

#### LINE Pay 按鈕邏輯

```jsx
<Button onClick={async () => {
    onClose();
    showToast('正在生成訂單編號...', 'info');
    
    const result = await onSaveRecord();
    const newOrderNumber = typeof result === 'string' ? result : null;
    
    if (result) {
        setTimeout(() => {
            showConfirm(
                '✅ 訂單已建立',
                <div>
                    {/* 訂單編號顯示 */}
                    {/* 截圖提醒 */}
                    {/* LINE 客服連結 */}
                </div>,
                () => {
                    // 跳轉到會員後台
                    window.location.hash = '#/member';
                    showToast('已建立訂單，請將截圖傳送給客服', 'success');
                },
                '前往會員後台查看'  // 按鈕文字更新
            );
        }, 500);
    }
}}>
    是否完成支付？
</Button>
```

**關鍵變更**：
- 確認回調函數從 `null` 改為跳轉邏輯
- 按鈕文字從「我已截圖並了解」改為「前往會員後台查看」

#### SHOPLINE 按鈕邏輯

```jsx
<Button onClick={async () => {
    showToast('正在生成訂單編號...', 'info');
    const result = await onSaveRecord();
    const newOrderNumber = typeof result === 'string' ? result : null;
    
    if (result) {
        onClose();
        setTimeout(() => {
            showConfirm(
                '⚠️ 前往付款前請先閱讀',
                <div>
                    {/* 訂單編號、截圖提醒、客服連結 */}
                </div>,
                () => {
                    // 開啟外部支付頁面（新分頁）
                    window.open(plan.url, '_blank');
                    // 跳轉到會員後台（原分頁）
                    setTimeout(() => {
                        window.location.hash = '#/member';
                        showToast('訂單已建立，請完成支付後聯繫客服', 'success');
                    }, 500);
                },
                '我已截圖，前往支付'
            );
        }, 500);
    }
}}>
    前往外部支付頁面
</Button>
```

**關鍵變更**：
- 確認回調中同時執行兩個動作：
  1. `window.open(plan.url, '_blank')` - 開啟外部支付頁面
  2. `window.location.hash = '#/member'` - 跳轉到會員後台

---

## 📊 用戶體驗流程

### LINE Pay 完整流程

```
【儲值頁面】
選擇 LINE Pay + 方案
    ↓
點擊「確認贊助」
    ↓
顯示 QR Code 掃碼彈窗
    ↓
用戶完成支付
    ↓
點擊「是否完成支付？」
    ↓
【生成訂單編號】
    ↓
顯示「✅ 訂單已建立」對話框
- 訂單編號：SD20260201-001
- 截圖提醒
- LINE 客服連結
    ↓
點擊「前往會員後台查看」
    ↓
【跳轉到會員後台】
    ↓
看到新訂單（狀態：⏳ 處理中）
- 訂單編號已顯示
- 顯示待處理提醒
- 可點擊 LINE 客服連結
    ↓
將截圖傳送給客服
    ↓
客服核對後更新訂單狀態為「✅ 已完成」
    ↓
用戶刷新頁面看到狀態更新 ✅
```

### SHOPLINE 完整流程

```
【儲值頁面】
選擇 SHOPLINE + 方案
    ↓
點擊「確認贊助」
    ↓
點擊「前往外部支付頁面」
    ↓
【生成訂單編號】
    ↓
顯示「⚠️ 前往付款前請先閱讀」對話框
- 訂單編號：SD20260201-001（可截圖）
- 提醒需截圖兩個畫面
    ↓
點擊「我已截圖，前往支付」
    ↓
【分頁 A】開啟外部支付頁面
【分頁 B】跳轉到會員後台（原分頁）
    ↓
用戶在分頁 A 完成支付
    ↓
返回分頁 B（會員後台）
看到新訂單（狀態：⏳ 處理中）
    ↓
將兩張截圖傳送給客服
    ↓
客服核對後更新狀態為「✅ 已完成」✅
```

---

## 🎨 視覺設計

### 訂單編號標籤

```jsx
<code className="text-xs font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded border border-purple-300">
    SD20260201-001
</code>
```

- 紫色主題（與支付確認對話框一致）
- 小字體（`text-xs`），不搶主要資訊的焦點
- 圓角 + 邊框，清晰可辨識

### 待處理提醒區塊

```jsx
<div className="bg-yellow-50 border-l-4 border-yellow-500 p-3 rounded">
    <p className="text-sm text-stone-700">
        <span className="font-bold">⏳ 待處理：</span>
        請將訂單編號截圖傳送給 
        <a href="LINE客服" className="text-line-500 font-bold hover:underline">
            LINE 客服
        </a> 完成核對
    </p>
    <p className="text-xs text-stone-500 mt-1">⏰ 人工客服時間：10:00 - 18:00</p>
</div>
```

- 黃色警告色系（提醒用戶需採取行動）
- 左側粗邊框（視覺引導）
- LINE 客服連結可直接點擊

---

## 💡 功能優勢

### 1. 統一的訂單管理
- 用戶可在會員後台查看所有儲值記錄
- 訂單編號一目了然
- 狀態清楚標示

### 2. 自動跳轉省時省力
- 儲值後自動導航到會員後台
- 無需手動尋找頁面
- 立即看到新建立的訂單

### 3. 待處理訂單提醒
- 清楚告知用戶下一步動作
- 直接提供客服連結
- 降低用戶困惑

### 4. 響應式設計
- 手機版：金額、訂單號、狀態垂直排列
- 桌面版：水平排列，更緊湊
- 所有裝置都能清晰查看

---

## ✅ 測試檢查清單

### 會員後台顯示
- [ ] 訂單編號正確顯示（紫色標籤）
- [ ] 點擊複製按鈕，確認複製成功
- [ ] 「獲得金幣」正確顯示
- [ ] 支付方式顯示為中文（LINE Pay / SHOPLINE）
- [ ] 待處理訂單顯示黃色提醒區塊
- [ ] LINE 客服連結可點擊
- [ ] 手機版排版正常
- [ ] 桌面版排版正常

### 跳轉功能
- [ ] LINE Pay 完成後點擊確認，正確跳轉到會員後台
- [ ] 跳轉後顯示成功提示訊息
- [ ] 會員後台中能看到新建立的訂單
- [ ] SHOPLINE 點擊按鈕後，外部頁面在新分頁開啟
- [ ] 原分頁跳轉到會員後台
- [ ] 會員後台顯示新訂單

### 資料一致性
- [ ] 訂單編號格式正確（SD20260201-001）
- [ ] 金額與選擇的方案一致
- [ ] 遊戲帳號顯示正確
- [ ] 狀態為「⏳ 處理中」（pending）

---

## 🚀 未來優化方向

1. **自動刷新訂單狀態**
   - 使用 WebSocket 或輪詢機制
   - 客服更新狀態後，用戶端自動刷新

2. **訂單詳情頁**
   - 點擊訂單卡片查看更多細節
   - 顯示 IP 位置、處理日誌等

3. **訂單搜尋與篩選**
   - 按訂單編號搜尋
   - 按狀態篩選（已完成/處理中/已取消）
   - 按日期範圍篩選

4. **訂單狀態推播**
   - 訂單狀態更新時，發送 Email 通知
   - 或透過站內通知系統告知用戶

5. **快速客服功能**
   - 在訂單卡片中直接顯示「聯繫客服」按鈕
   - 自動帶入訂單編號到對話中

---

## 📝 注意事項

1. **訂單編號必須存在**
   - 確保資料庫中 `order_number` 欄位已正確填充
   - 舊訂單可能沒有訂單編號（執行 SQL 遷移補全）

2. **跳轉時機**
   - LINE Pay：點擊「前往會員後台查看」後跳轉
   - SHOPLINE：點擊「我已截圖，前往支付」後跳轉

3. **使用 Hash 路由**
   - 跳轉使用 `window.location.hash = '#/member'`
   - 確保 React Router 使用 HashRouter

4. **SHOPLINE 雙分頁處理**
   - 外部支付頁面在新分頁開啟
   - 原分頁跳轉到會員後台
   - 用戶完成支付後返回原分頁即可看到訂單

---

**實作完成！** 🎊

用戶現在可以：
✅ 在會員後台清楚看到所有訂單編號
✅ 儲值完成後自動跳轉到會員後台
✅ 輕鬆複製訂單編號
✅ 了解待處理訂單的後續步驟
