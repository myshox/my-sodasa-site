# 支付流程優化 - 訂單編號生成時機調整

## 📋 更新概覽

根據用戶需求，調整了支付流程和訂單編號生成時機，並優化了提醒文字的視覺強度，確保用戶不會遺漏重要步驟。

---

## 🔄 流程變更

### ❌ 舊流程（已棄用）

```
用戶選擇方案
    ↓
點擊「確認贊助」
    ↓
【立即生成訂單編號】
    ↓
顯示支付彈窗（含訂單編號）
    ↓
點擊「我已完成支付」
    ↓
關閉彈窗
```

**問題**：
- 訂單編號過早生成，用戶可能未實際支付
- 可能產生大量未支付的訂單記錄

---

### ✅ 新流程（目前使用）

#### LINE Pay 流程

```
用戶選擇方案
    ↓
點擊「確認贊助」
    ↓
顯示支付彈窗（尚未生成訂單）
    ↓
用戶掃碼並完成 LINE Pay 支付
    ↓
點擊「是否完成支付？」按鈕
    ↓
【生成訂單編號】
    ↓
顯示「✅ 訂單已建立」對話框
    ↓
- 顯示訂單編號（可複製）
- 提醒截圖保存
- 提供 LINE 客服連結
    ↓
點擊「我已截圖並了解」
    ↓
完成流程
```

#### SHOPLINE 流程

```
用戶選擇方案
    ↓
點擊「確認贊助」
    ↓
顯示支付彈窗
    ↓
點擊「前往外部支付頁面」
    ↓
【生成訂單編號】
    ↓
顯示「⚠️ 前往付款前請先閱讀」對話框
    ↓
- 顯示訂單編號（可複製）
- 提醒需截圖兩個畫面
- 提供 LINE 客服連結
    ↓
點擊「我已截圖，前往支付」
    ↓
開啟外部支付頁面（新分頁）
    ↓
用戶完成支付
    ↓
聯繫 LINE 客服並提供截圖
```

---

## 🎨 視覺優化

### 1. 重要提醒文字放大

#### 原始大小
- 一般文字：`text-sm` (14px)
- 重要提醒：`text-base` (16px)

#### 優化後大小
- 標題：`text-lg` - `text-xl` (18px - 20px)
- 重要警告：`text-xl` (20px)，字體加粗 `font-black`
- 一般重要文字：`text-base` (16px)，字體加粗 `font-bold`
- 次要說明：`text-sm` (14px)

### 2. 警告區塊強化

```jsx
// 截圖提醒區塊
<div className="bg-yellow-50 border-2 border-yellow-500 p-4 rounded-lg">
    <p className="text-xl text-red-600 font-black mb-2">
        ⚠️ 必須截圖！
    </p>
    <p className="text-base text-stone-800 font-bold">
        📸 請立即截圖本頁面保存訂單編號
    </p>
    <p className="text-sm text-stone-600 mt-2">
        作為支付憑證，避免糾紛
    </p>
</div>
```

**視覺特點**：
- 邊框從 `border-l-4` 改為 `border-2`（四周邊框）
- 標題使用紅色 `text-red-600` + `font-black`
- 內容使用深色 `text-stone-800` + `font-bold`

### 3. 訂單編號顯示優化

```jsx
<div className="bg-purple-50 border-2 border-purple-500 p-4 rounded-lg">
    <p className="text-sm text-stone-600 font-bold mb-2">您的訂單編號</p>
    <div className="flex items-center gap-3 justify-center">
        <code className="text-xl font-black text-purple-600 bg-white px-4 py-2 rounded-lg border-2 border-purple-300">
            {newOrderNumber}
        </code>
        <button>
            <Copy size={20} />
        </button>
    </div>
</div>
```

**視覺特點**：
- 訂單編號放大到 `text-xl` (20px)
- 使用 `font-black` 最粗字重
- 白底 + 雙層邊框強調重要性
- 複製按鈕圖標加大到 20px

---

## 🔧 技術實作

### 1. 修改 `handlePayment` 函數

```jsx
const handlePayment = async () => {
    // 驗證表單
    // ...
    
    // 直接顯示支付彈窗，不立即儲存記錄
    setShowModal(true);
};
```

**變更**：移除了 `await saveSponsorshipRecord()` 的調用。

---

### 2. 修改 `saveSponsorshipRecord` 返回值

```jsx
const saveSponsorshipRecord = async () => {
    // ...儲存邏輯
    
    if (data && data[0] && data[0].order_number) {
        setOrderNumber(data[0].order_number);
        return data[0].order_number; // 返回訂單編號（string）
    }
    
    return true; // 成功但沒有訂單號（boolean）
};
```

**變更**：
- 原本只返回 `true`
- 現在返回生成的訂單編號字串
- 方便在確認對話框中立即顯示

---

### 3. PaymentModal 新增 `onSaveRecord` prop

```jsx
const PaymentModal = ({ 
    method, 
    plan, 
    gameAccount, 
    lineName, 
    orderNumber, 
    onClose, 
    onSaveRecord  // 新增
}) => {
    // ...
};
```

**用途**：讓 PaymentModal 能夠調用 `saveSponsorshipRecord` 函數。

---

### 4. 按鈕點擊邏輯

#### LINE Pay「是否完成支付？」按鈕

```jsx
<Button onClick={async () => {
    // 1. 關閉當前彈窗
    onClose();
    
    // 2. 顯示載入提示
    showToast('正在生成訂單編號...', 'info');
    
    // 3. 儲存記錄並獲取訂單號
    const result = await onSaveRecord();
    const newOrderNumber = typeof result === 'string' ? result : null;
    
    // 4. 顯示二次確認對話框（含訂單號）
    if (result) {
        setTimeout(() => {
            showConfirm(
                '✅ 訂單已建立',
                <div>
                    {/* 訂單編號顯示 */}
                    {/* 截圖提醒 */}
                    {/* LINE 客服連結 */}
                </div>,
                null,
                '我已截圖並了解'
            );
        }, 500);
    }
}}>
    是否完成支付？
</Button>
```

#### SHOPLINE「前往外部支付頁面」按鈕

```jsx
<Button onClick={async () => {
    // 1. 先生成訂單編號
    showToast('正在生成訂單編號...', 'info');
    const result = await onSaveRecord();
    const newOrderNumber = typeof result === 'string' ? result : null;
    
    // 2. 關閉當前彈窗
    if (result) {
        onClose();
        
        // 3. 顯示提醒對話框（含訂單號）
        setTimeout(() => {
            showConfirm(
                '⚠️ 前往付款前請先閱讀',
                <div>
                    {/* 訂單編號顯示 */}
                    {/* 截圖提醒（兩個畫面） */}
                    {/* LINE 客服連結 */}
                </div>,
                () => {
                    window.open(plan.url, '_blank');
                },
                '我已截圖，前往支付'
            );
        }, 500);
    }
}}>
    前往外部支付頁面
</Button>
```

---

## 📊 流程對比圖

### LINE Pay

```
┌─────────────────────────────────────────┐
│            選擇 LINE Pay 方案            │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         點擊「確認贊助」按鈕             │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│    【彈窗 1】顯示 QR Code 掃碼支付       │
│    - 尚未生成訂單編號                   │
│    - 顯示金額、遊戲帳號等資訊           │
└─────────────────────────────────────────┘
                    ↓
          用戶完成 LINE Pay 支付
                    ↓
┌─────────────────────────────────────────┐
│       點擊「是否完成支付？」按鈕         │
└─────────────────────────────────────────┘
                    ↓
        🔄 生成訂單編號（資料庫）
                    ↓
┌─────────────────────────────────────────┐
│    【彈窗 2】✅ 訂單已建立               │
│    - 顯示訂單編號（紫色大字）           │
│    - ⚠️ 必須截圖！（紅色警告）          │
│    - 💬 立即聯繫 LINE 客服按鈕          │
│    - ⏰ 客服時間：10:00 - 18:00         │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      點擊「我已截圖並了解」按鈕          │
└─────────────────────────────────────────┘
                    ↓
              流程完成 ✅
```

### SHOPLINE

```
┌─────────────────────────────────────────┐
│          選擇 SHOPLINE 方案              │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         點擊「確認贊助」按鈕             │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│    【彈窗 1】SHOPLINE 付款說明           │
│    - 尚未生成訂單編號                   │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│     點擊「前往外部支付頁面」按鈕         │
└─────────────────────────────────────────┘
                    ↓
        🔄 生成訂單編號（資料庫）
                    ↓
┌─────────────────────────────────────────┐
│  【彈窗 2】⚠️ 前往付款前請先閱讀         │
│  - 顯示訂單編號（紫色大字 + 複製）      │
│  - ⚠️ 必須截圖兩個畫面！                │
│    1. 本對話框（含訂單編號）            │
│    2. 支付成功畫面                      │
│  - 💬 立即聯繫 LINE 客服按鈕            │
│  - ⏰ 客服時間：10:00 - 18:00           │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│    點擊「我已截圖，前往支付」按鈕        │
└─────────────────────────────────────────┘
                    ↓
          開啟外部支付頁面（新分頁）
                    ↓
          用戶完成 SHOPLINE 支付
                    ↓
       用戶將截圖傳送給 LINE 客服
                    ↓
        客服核對訂單編號並發放金幣 ✅
```

---

## 🎯 優勢與改進

### 1. 減少無效訂單
- **舊流程**：用戶選擇方案後立即生成訂單，可能未實際支付
- **新流程**：只有在用戶確認完成支付後才生成訂單

### 2. 提升截圖率
- **字體放大**：重要提醒從 14px 提升到 20px
- **顏色對比**：紅色警告 + 黃色背景
- **雙重提醒**：生成訂單後再次提醒截圖

### 3. 降低糾紛機率
- 明確顯示「作為支付憑證，避免糾紛」
- 強調「必須截圖」的重要性
- 提供一鍵複製訂單編號功能

### 4. 優化客服對接
- 直接提供 LINE 客服連結按鈕
- 顯示人工客服時間（10:00 - 18:00）
- 說明客服核對流程

---

## 📱 響應式適配

所有對話框內容在手機和桌面版均保持良好可讀性：

- **手機版**：
  - 垂直排列，間距適中（`space-y-4`）
  - 按鈕寬度 100%（`w-full`）
  - 訂單編號居中對齊

- **桌面版**：
  - 最大寬度限制（`max-w-md`）
  - 保持視覺焦點
  - 按鈕圖標適當放大

---

## ✅ 測試檢查清單

部署後請測試以下流程：

### LINE Pay
- [ ] 選擇 LINE Pay 方案，點擊「確認贊助」
- [ ] 確認顯示 QR Code 掃碼彈窗（無訂單編號）
- [ ] 點擊「是否完成支付？」
- [ ] 確認顯示「正在生成訂單編號...」提示
- [ ] 確認顯示「✅ 訂單已建立」對話框
- [ ] 確認訂單編號正確顯示且可複製
- [ ] 確認「⚠️ 必須截圖！」文字為紅色大字
- [ ] 點擊「立即聯繫 LINE 客服」按鈕，確認開啟 LINE
- [ ] 確認客服時間顯示為「10:00 - 18:00」

### SHOPLINE
- [ ] 選擇 SHOPLINE 方案，點擊「確認贊助」
- [ ] 點擊「前往外部支付頁面」
- [ ] 確認顯示「正在生成訂單編號...」提示
- [ ] 確認顯示「⚠️ 前往付款前請先閱讀」對話框
- [ ] 確認訂單編號正確顯示且可複製
- [ ] 確認「必須截圖兩個畫面」提示清晰
- [ ] 點擊「我已截圖，前往支付」
- [ ] 確認外部支付頁面在新分頁開啟

### 資料庫
- [ ] 確認訂單只在點擊確認後才建立
- [ ] 確認訂單編號格式正確（SD20260201-001）
- [ ] 確認訂單包含所有必要資訊

---

## 🚀 未來優化方向

1. **自動複製訂單編號**
   - 彈出對話框時自動複製到剪貼簿

2. **倒數計時提醒**
   - 「請在 24 小時內聯繫客服」

3. **客服在線狀態**
   - 顯示「客服在線中 🟢」或「客服已下班 🔴」

4. **訂單查詢功能**
   - 用戶可在個人頁面查看訂單處理進度

---

**實作完成！** 🎊
