# 註冊用戶累計儲值與充值紀錄同步

## 問題

客人充值紀錄不會同步到「註冊用戶」的累積金額（後台「註冊用戶」頁的累計儲值／累計金幣顯示為 0 或不正確）。

## 原因

- 後台「註冊用戶」的累計儲值／金幣是透過 RPC `get_all_users()` 從 `donations` 表加總而來。
- 舊版 `get_all_users` 使用 **email** 關聯：`LEFT JOIN donations d ON u.email = d.email`。
- 儲值寫入時使用的是 **user_id**（`donations.user_id`）與 **email**（`donations.email`）。若資料庫中 `auth.users.email` 與 `donations.email` 因大小寫或前後空白不一致，JOIN 會對不到，導致該筆充值沒有被算進該用戶的累計。

## 解法

- 改為以 **user_id** 為主關聯：`d.user_id = u.id`，與前端儲值時寫入的 `user_id: user.id` 一致，確保每筆充值都會算到對應的註冊用戶。
- 保留以 email 的相容：若舊資料有 `user_id` 為 NULL、僅有 email，則用 `LOWER(TRIM(email))` 比對，避免漏算歷史資料。

## 執行方式

1. 開啟 **Supabase Dashboard** → **SQL Editor**。
2. 執行 `database/migrations/028_fix_get_all_users_cumulative_sync.sql` 整段內容。
3. 執行後重新進入後台「註冊用戶」頁，重新整理；累計儲值／累計金幣應會正確顯示並與充值紀錄同步。

## 驗證

- 在「贊助管理」查詢某用戶的贊助紀錄，加總金額與金幣。
- 在「註冊用戶」找到同一用戶，確認「累計儲值」「累計金幣」與上面加總一致。
