# 會員中心訂單編號同步與支付方式說明

## 📋 更新概覽

完成以下功能：
1. **確保會員中心正確顯示訂單編號**（與管理後台同步）
2. **為每個支付方式提供詳細操作說明**
3. **統一客服聯繫流程**

---

## ✨ 主要功能

### 1️⃣ 訂單編號顯示

#### 會員中心訂單卡片

```
┌─────────────────────────────────────────────┐
│ NT$ 100  [SD20260201-001] 📋  ✅ 已完成     │
├─────────────────────────────────────────────┤
│ 方案名稱：金幣 150 方案                      │
│ 獲得金幣：150 Gold                          │
│ 遊戲帳號：PlayerName                        │
│ 支付方式：LINE Pay                          │
│ 儲值時間：2026/02/01 15:30:00               │
└─────────────────────────────────────────────┘
```

**訂單編號特點**：
- ✅ 紫色標籤顯示
- ✅ 可點擊複製
- ✅ 與管理後台完全同步
- ✅ 從 `donations` 表直接載入

---

### 2️⃣ 支付方式說明

#### LINE Pay 付款流程

當訂單狀態為「⏳ 處理中」且支付方式為 `linepay` 時：

```
┌─────────────────────────────────────────────┐
│ ⏳ 待處理：請依照以下步驟完成                │
│                                             │
│ 📱 LINE Pay 付款流程：                      │
│  1. 掃描 QR Code 完成 LINE Pay 支付         │
│  2. 截圖支付成功畫面                        │
│  3. 將截圖與訂單編號傳送給客服核對          │
│                                             │
│ [立即聯繫 LINE 客服] ⏰ 10:00 - 18:00      │
└─────────────────────────────────────────────┘
```

---

#### SHOPLINE 付款流程

當訂單狀態為「⏳ 處理中」且支付方式為 `shopline` 時：

```
┌─────────────────────────────────────────────┐
│ ⏳ 待處理：請依照以下步驟完成                │
│                                             │
│ 💳 SHOPLINE 付款流程：                      │
│  1. 前往外部支付頁面完成付款                │
│  2. 截圖支付成功畫面                        │
│  3. 將截圖與訂單編號傳送給客服核對          │
│                                             │
│ [立即聯繫 LINE 客服] ⏰ 10:00 - 18:00      │
└─────────────────────────────────────────────┘
```

---

#### 其他支付方式（需聯繫客服）

當訂單狀態為「⏳ 處理中」且支付方式為其他（非 linepay/shopline）時：

```
┌─────────────────────────────────────────────┐
│ ⏳ 待處理：請依照以下步驟完成                │
│                                             │
│ 💬 此方式需聯繫客服索取付款資訊：           │
│  1. 加入官方 LINE 帳號（ID: @mNL9exXRFd）  │
│  2. 告知客服您欲使用 [支付方式] 支付        │
│  3. 提供您的贊助金額 NT$ XXX               │
│  4. 完成轉帳後回傳截圖與訂單編號            │
│                                             │
│ [立即聯繫 LINE 客服] ⏰ 10:00 - 18:00      │
└─────────────────────────────────────────────┘
```

**動態內容**：
- `[支付方式]`：動態顯示實際支付方式（例如：ATM轉帳、虛擬帳號等）
- `NT$ XXX`：動態顯示訂單金額

---

## 🔧 技術實作

### 訂單編號顯示邏輯

```jsx
{item.order_number && (
    <div className="flex items-center gap-2">
        <code className="text-xs font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded border border-purple-300">
            {item.order_number}
        </code>
        <button
            onClick={() => {
                navigator.clipboard.writeText(item.order_number);
                showToast('訂單編號已複製', 'success');
            }}
            className="p-1 hover:bg-purple-100 rounded transition-colors"
            title="複製訂單編號"
        >
            <Copy size={14} className="text-purple-600" />
        </button>
    </div>
)}
```

**關鍵點**：
- 使用 `item.order_number` 直接從資料庫載入
- 與管理後台的 `donations` 表完全同步
- 只有當 `order_number` 存在時才顯示

---

### 支付方式說明邏輯

```jsx
{item.status === 'pending' && (
    <div className="bg-yellow-50 border-l-4 border-yellow-500 p-3 rounded space-y-2">
        <p className="text-sm text-stone-700 font-bold">
            ⏳ 待處理：請依照以下步驟完成
        </p>
        
        {/* LINE Pay 說明 */}
        {item.payment_method === 'linepay' && (
            <div className="text-sm text-stone-700 space-y-1">
                <p className="font-bold text-stone-800">📱 LINE Pay 付款流程：</p>
                <ol className="list-decimal ml-5 space-y-0.5">
                    <li>掃描 QR Code 完成 LINE Pay 支付</li>
                    <li>截圖支付成功畫面</li>
                    <li>將截圖與訂單編號傳送給客服核對</li>
                </ol>
            </div>
        )}
        
        {/* SHOPLINE 說明 */}
        {item.payment_method === 'shopline' && (
            <div className="text-sm text-stone-700 space-y-1">
                <p className="font-bold text-stone-800">💳 SHOPLINE 付款流程：</p>
                <ol className="list-decimal ml-5 space-y-0.5">
                    <li>前往外部支付頁面完成付款</li>
                    <li>截圖支付成功畫面</li>
                    <li>將截圖與訂單編號傳送給客服核對</li>
                </ol>
            </div>
        )}
        
        {/* 其他支付方式說明 */}
        {!item.payment_method || (item.payment_method !== 'linepay' && item.payment_method !== 'shopline') && (
            <div className="text-sm text-stone-700 space-y-1">
                <p className="font-bold text-stone-800">💬 此方式需聯繫客服索取付款資訊：</p>
                <ol className="list-decimal ml-5 space-y-0.5">
                    <li>加入官方 LINE 帳號（ID: @mNL9exXRFd）</li>
                    <li>告知客服您欲使用 {item.payment_method || '其他'} 支付</li>
                    <li>提供您的贊助金額 NT$ {item.amount?.toLocaleString()}</li>
                    <li>完成轉帳後回傳截圖與訂單編號</li>
                </ol>
            </div>
        )}
        
        {/* 客服按鈕 */}
        <div className="flex items-center gap-2 pt-2 border-t border-yellow-200">
            <a href="https://line.me/ti/p/mNL9exXRFd" target="_blank" rel="noopener noreferrer" 
               className="inline-flex items-center gap-2 px-3 py-2 bg-line-500 text-white rounded-lg text-sm font-bold hover:bg-line-600 transition-colors">
                <MessageSquare size={16} />
                立即聯繫 LINE 客服
                <ExternalLink size={12} />
            </a>
            <span className="text-xs text-stone-500">⏰ 人工客服時間：10:00 - 18:00</span>
        </div>
    </div>
)}
```

---

## 📊 支付方式對應表

| 支付方式代碼 | 顯示名稱 | 說明類型 |
|------------|---------|---------|
| `linepay` | LINE Pay | 標準流程（QR Code） |
| `shopline` | SHOPLINE | 標準流程（外部連結） |
| 其他或空值 | 實際支付方式名稱 | 需聯繫客服索取資訊 |

---

## 🎯 使用場景

### 場景 1：LINE Pay 用戶

```
用戶完成 LINE Pay 支付
    ↓
在會員中心看到訂單（⏳ 處理中）
    ↓
查看「📱 LINE Pay 付款流程」說明
    ↓
依照步驟：
  1. 已掃描 QR Code ✅
  2. 截圖支付成功畫面 ✅
  3. 點擊「立即聯繫 LINE 客服」
    ↓
傳送截圖和訂單編號給客服
    ↓
客服核對後更新狀態為「✅ 已完成」
```

---

### 場景 2：SHOPLINE 用戶

```
用戶前往外部頁面完成支付
    ↓
返回會員中心看到訂單（⏳ 處理中）
    ↓
查看「💳 SHOPLINE 付款流程」說明
    ↓
依照步驟：
  1. 已完成外部付款 ✅
  2. 截圖支付成功畫面 ✅
  3. 點擊「立即聯繫 LINE 客服」
    ↓
傳送截圖和訂單編號給客服
    ↓
客服核對後更新狀態為「✅ 已完成」
```

---

### 場景 3：其他支付方式用戶（例如：ATM轉帳）

```
用戶選擇 ATM 轉帳（假設）
    ↓
在會員中心看到訂單（⏳ 處理中）
    ↓
查看「💬 此方式需聯繫客服索取付款資訊」說明
    ↓
依照步驟：
  1. 加入官方 LINE 帳號（ID: @mNL9exXRFd）
  2. 告知客服：「我要使用 ATM轉帳 支付」
  3. 提供金額：「NT$ 100」
  4. 客服提供 ATM 轉帳資訊
    ↓
用戶完成轉帳
    ↓
回傳轉帳截圖和訂單編號
    ↓
客服核對後更新狀態為「✅ 已完成」
```

---

## 💡 LINE 官方帳號資訊

### 連結
- **URL**: `https://line.me/ti/p/mNL9exXRFd`
- **LINE ID**: `@mNL9exXRFd`

### 客服時間
- **時間**: 10:00 - 18:00（台灣時間）
- **服務**: 訂單核對、支付資訊提供、問題解答

---

## 🎨 視覺設計

### 支付方式圖標

- **LINE Pay**: 📱（手機圖標）
- **SHOPLINE**: 💳（信用卡圖標）
- **其他方式**: 💬（對話圖標）

### 顏色區分

- **標題**：`text-stone-800`（深色，醒目）
- **步驟列表**：`text-stone-700`（中等深度）
- **背景**：`bg-yellow-50`（黃色淺底，提醒作用）
- **左側邊框**：`border-yellow-500`（黃色粗邊框）
- **客服按鈕**：`bg-line-500`（LINE 品牌綠色）

---

## ✅ 資料同步

### 會員中心資料來源

```jsx
// MemberPage 載入訂單資料
useEffect(() => {
    const loadUserData = async () => {
        // ...
        
        // 載入用戶的贊助紀錄（從 donations 表）
        const { data: donations, error } = await supabase
            .from('donations')
            .select('*')  // 包含 order_number 欄位
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });
        
        setSponsorships(donations || []);
    };
    
    loadUserData();
}, []);
```

**重要**：
- 使用 `.select('*')` 確保載入所有欄位
- `order_number` 會自動包含在結果中
- 與管理後台的 `donations` 表完全同步

---

## 🔄 管理後台同步

### 後台顯示訂單編號

```jsx
// AdminPage - 贊助管理
<td className="px-6 py-4 whitespace-nowrap">
    {donation.order_number ? (
        <div className="flex items-center gap-2">
            <code className="text-xs font-bold text-purple-400 bg-purple-900/20 px-2 py-1 rounded border border-purple-500/30">
                {donation.order_number}
            </code>
            <button onClick={() => {
                navigator.clipboard.writeText(donation.order_number);
                showToast('訂單編號已複製', 'success');
            }}>
                <Copy size={14} />
            </button>
        </div>
    ) : (
        <span className="text-stone-600 text-xs">無</span>
    )}
</td>
```

**同步確認**：
- ✅ 會員中心和管理後台使用相同的 `donations` 表
- ✅ 訂單編號由資料庫自動生成（Trigger）
- ✅ 前端只負責顯示，不生成編號
- ✅ 複製功能在兩邊都可用

---

## 📱 響應式設計

### 手機版優化

```jsx
// 訂單編號和狀態
<div className="flex flex-col md:flex-row md:items-center justify-between mb-3 gap-2">
    <div className="flex items-center gap-3">
        <span className="text-gold-600 font-black text-lg">NT$ {item.amount}</span>
        {/* 訂單編號 */}
    </div>
    <span className="px-3 py-1 rounded-full text-sm font-bold whitespace-nowrap">
        {/* 狀態 */}
    </span>
</div>
```

**適配說明**：
- **桌面版**（`md:flex-row`）：金額、訂單號、狀態橫向排列
- **手機版**（`flex-col`）：垂直排列，更易閱讀
- **訂單編號**：自動換行，不會被截斷

---

## ⚠️ 注意事項

### 1. 舊訂單處理

**問題**：資料庫中可能存在沒有 `order_number` 的舊訂單

**解決**：
```sql
-- 為舊訂單補全訂單編號
-- 請執行 database/migrations/016_add_order_number.sql
```

### 2. 支付方式識別

**邏輯**：
```jsx
if (item.payment_method === 'linepay') {
    // 顯示 LINE Pay 說明
} else if (item.payment_method === 'shopline') {
    // 顯示 SHOPLINE 說明
} else {
    // 顯示「需聯繫客服」說明
}
```

### 3. LINE ID 顯示

- **格式**：`@mNL9exXRFd`（帶 @ 符號）
- **連結**：`https://line.me/ti/p/mNL9exXRFd`（不帶 @ 符號）
- **顯示**：在說明文字中顯示 `@mNL9exXRFd`，讓用戶可以手動搜尋

---

## 📝 測試檢查清單

### 會員中心顯示
- [ ] 訂單編號正確顯示（紫色標籤）
- [ ] 點擊複製按鈕，確認複製成功
- [ ] 手機版排版正常（金額、訂單號、狀態垂直排列）
- [ ] 桌面版排版正常（橫向排列）

### 支付方式說明
- [ ] LINE Pay 訂單顯示正確的 3 步驟說明
- [ ] SHOPLINE 訂單顯示正確的 3 步驟說明
- [ ] 其他支付方式顯示「需聯繫客服」的 4 步驟說明
- [ ] 動態內容正確（支付方式名稱、金額）
- [ ] LINE ID 顯示為 `@mNL9exXRFd`

### 客服按鈕
- [ ] 「立即聯繫 LINE 客服」按鈕可點擊
- [ ] 點擊後正確開啟 LINE 對話
- [ ] 客服時間顯示為「10:00 - 18:00」

### 資料同步
- [ ] 新建訂單立即顯示在會員中心
- [ ] 訂單編號與管理後台一致
- [ ] 狀態更新後會員中心同步顯示

---

## 🚀 未來優化

1. **自動刷新**
   - 訂單狀態更新時自動刷新會員中心
   - 使用 WebSocket 或輪詢機制

2. **進度追蹤**
   - 顯示訂單處理進度條
   - 「已提交 → 處理中 → 已完成」

3. **客服快捷功能**
   - 點擊按鈕自動帶入訂單編號到 LINE 對話
   - 減少用戶輸入步驟

4. **支付方式擴展**
   - 新增更多支付方式（ATM、虛擬帳號等）
   - 每種方式都有專屬說明

---

**實作完成！** 🎊

用戶現在可以：
✅ 在會員中心清楚看到訂單編號（與後台同步）
✅ 根據不同支付方式查看詳細操作流程
✅ 快速聯繫 LINE 客服（ID: @mNL9exXRFd）
✅ 了解每種支付方式的完整步驟
