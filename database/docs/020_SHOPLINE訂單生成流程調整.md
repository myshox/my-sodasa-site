# SHOPLINE 訂單生成流程調整

## 📋 問題說明

**原因**：SHOPLINE 是外部支付連結，無法串接 API，無法在用戶完成支付後自動回傳結果。

**解決方案**：在用戶**準備付款時就產生訂單編號**，方便後續人工查帳核對。

---

## 🔄 新舊流程對比

### ❌ 舊流程（不適用於 SHOPLINE）

```
用戶選擇 SHOPLINE
    ↓
點擊「確認贊助」
    ↓
顯示支付彈窗
    ↓
點擊「前往外部支付頁面」
    ↓
【生成訂單編號】← 太晚生成，用戶已經準備離開
    ↓
開啟外部頁面
```

**問題**：
- 用戶可能關閉彈窗就離開
- 沒有看到訂單編號
- 客服無法查帳

---

### ✅ 新流程（適用於 SHOPLINE）

```
用戶選擇 SHOPLINE + 方案
    ↓
點擊「確認贊助」按鈕
    ↓
【立即生成訂單編號】← 提前生成，確保有記錄
    ↓
顯示「✅ 訂單已建立」對話框
- 訂單編號：SD20260201-001
- 截圖提醒（兩個畫面）
- LINE 客服連結
    ↓
用戶截圖保存訂單編號
    ↓
點擊「我已截圖，前往支付」
    ↓
【新分頁】開啟外部支付頁面
【原分頁】跳轉到會員後台
    ↓
用戶在新分頁完成支付
    ↓
返回會員後台
看到訂單（⏳ 處理中）
    ↓
將兩張截圖傳送給客服
    ↓
客服人工查帳核對 ✅
```

---

## ✨ 主要優勢

### 1. 確保訂單記錄
- 即使用戶未完成支付，也有訂單記錄
- 方便追蹤流失訂單
- 客服可主動聯繫跟進

### 2. 方便人工查帳
- 訂單編號在資料庫中已存在
- 用戶提供訂單編號時可快速查詢
- 核對金額、時間、遊戲帳號等資訊

### 3. 提升用戶體驗
- 用戶提前看到訂單編號
- 有明確的憑證可截圖
- 降低對帳時的溝通成本

### 4. 減少糾紛
- 有明確的訂單時間戳記
- 支付前後都有記錄
- 方便追溯問題

---

## 🔧 技術實作

### 修改 `handlePayment` 函數

```jsx
const handlePayment = async () => {
    // 驗證表單
    // ...
    
    // SHOPLINE：先生成訂單編號（外部連結無法串接）
    if (selectedMethod === 'shopline') {
        showToast('正在生成訂單編號...', 'info');
        const result = await saveSponsorshipRecord();
        const newOrderNumber = typeof result === 'string' ? result : null;
        
        if (result && newOrderNumber) {
            // 顯示訂單編號和提醒
            setTimeout(() => {
                showConfirm(
                    '✅ 訂單已建立',
                    <div>
                        {/* 訂單編號 */}
                        <div className="bg-purple-50 border-2 border-purple-500 p-4 rounded-lg">
                            <p>您的訂單編號</p>
                            <code>{newOrderNumber}</code>
                            <button>複製</button>
                            <p>請務必截圖保存此訂單編號</p>
                        </div>
                        
                        {/* 截圖提醒 */}
                        <div className="bg-yellow-50 border-2 border-yellow-500 p-4 rounded-lg">
                            <p className="text-xl">⚠️ 必須截圖兩個畫面！</p>
                            <ol>
                                <li>📸 本對話框（含訂單編號）</li>
                                <li>📸 支付成功畫面</li>
                            </ol>
                            <p>作為支付憑證，方便查帳核對</p>
                        </div>
                        
                        {/* LINE 客服 */}
                        <div className="bg-blue-50 p-4 rounded">
                            <p>💬 完成支付後，請立即將截圖傳送給 LINE 客服</p>
                            <a href="LINE客服連結">立即聯繫 LINE 客服</a>
                            <p>⏰ 人工客服時間：10:00 - 18:00</p>
                        </div>
                        
                        {/* 查帳提醒 */}
                        <div className="bg-red-50 p-3 rounded">
                            <p>💡 客服會根據訂單編號和支付憑證為您查帳核對</p>
                        </div>
                    </div>,
                    () => {
                        // 開啟外部支付頁面
                        window.open(selectedPlan.url, '_blank');
                        // 跳轉到會員後台
                        setTimeout(() => {
                            window.location.hash = '#/member';
                            showToast('訂單已建立，請完成支付後聯繫客服', 'success');
                        }, 500);
                    },
                    '我已截圖，前往支付'
                );
            }, 500);
        }
    } else {
        // LINE Pay：直接顯示支付彈窗，稍後生成訂單
        setShowModal(true);
    }
};
```

**關鍵邏輯**：
1. 檢查支付方式是否為 `shopline`
2. 如果是，立即調用 `saveSponsorshipRecord()` 生成訂單
3. 獲取訂單編號後顯示確認對話框
4. 用戶確認後開啟外部頁面並跳轉會員後台

---

## 📊 完整用戶流程

### SHOPLINE 支付流程

```
【儲值頁面】
1. 選擇 SHOPLINE 支付方式
2. 選擇金幣方案（例如：NT$ 100 → 150 Gold）
3. 選擇遊戲帳號
4. 點擊「確認贊助」
   ↓
【生成訂單 - 資料庫】
- 訂單編號：SD20260201-001
- 狀態：pending（處理中）
- 金額：NT$ 100
- 金幣：150
- 遊戲帳號：PlayerName
- 支付方式：shopline
   ↓
【對話框：✅ 訂單已建立】
5. 看到訂單編號（紫色大字）
6. 點擊複製按鈕（複製到剪貼簿）
7. 閱讀提醒：
   - ⚠️ 必須截圖兩個畫面
   - 📸 本對話框（含訂單編號）
   - 📸 支付成功畫面
8. 截圖保存對話框
9. 點擊「我已截圖，前往支付」
   ↓
【雙分頁行為】
- 【新分頁】開啟 SHOPLINE 外部支付頁面
- 【原分頁】跳轉到會員後台
   ↓
【會員後台】
10. 看到新訂單：
    - 訂單編號：SD20260201-001
    - 狀態：⏳ 處理中
    - 金額：NT$ 100
    - 獲得金幣：150 Gold
    - 待處理提醒（黃色區塊）
   ↓
【新分頁 - SHOPLINE】
11. 完成支付流程
12. 截圖支付成功畫面
   ↓
【返回會員後台】
13. 點擊「LINE 客服」連結
14. 傳送兩張截圖：
    - 訂單編號截圖
    - 支付成功截圖
   ↓
【客服處理】
15. 客服根據訂單編號查詢資料庫
16. 核對金額、時間、遊戲帳號
17. 確認支付憑證
18. 更新訂單狀態為「✅ 已完成」
19. 發放金幣到遊戲帳號
   ↓
【完成】✅
```

---

## 🎯 LINE Pay 流程對比

### LINE Pay（稍後生成訂單）

```
選擇 LINE Pay
    ↓
點擊「確認贊助」
    ↓
顯示 QR Code 掃碼彈窗
    ↓
用戶完成支付
    ↓
點擊「是否完成支付？」
    ↓
【此時才生成訂單編號】← 確認支付後生成
    ↓
顯示訂單編號 + 提醒
    ↓
跳轉會員後台
```

**為什麼不同**：
- LINE Pay 是即時支付，用戶在頁面內完成
- 可以確認用戶完成支付後再生成訂單
- 減少未支付的訂單記錄

---

## 💾 資料庫訂單狀態

### SHOPLINE 訂單特點

```sql
INSERT INTO donations (
    user_id,
    email,
    game_account,
    amount,
    coins,
    plan_name,
    payment_method,  -- 'shopline'
    status,          -- 'pending'
    order_number,    -- 'SD20260201-001' (自動生成)
    created_at       -- 訂單建立時間
)
```

**重要欄位**：
- `status = 'pending'`：等待客服核對
- `order_number`：唯一訂單編號
- `created_at`：訂單建立時間（用於追蹤）

### 客服查帳流程

**步驟 1：接收截圖**
- 用戶提供訂單編號
- 用戶提供支付憑證截圖

**步驟 2：查詢訂單**
```sql
SELECT * FROM donations 
WHERE order_number = 'SD20260201-001';
```

**步驟 3：核對資訊**
- 金額是否一致
- 遊戲帳號是否正確
- 支付時間是否合理

**步驟 4：更新狀態**
```sql
UPDATE donations 
SET 
    status = 'completed',
    processed_at = NOW(),
    notes = '已核對支付憑證並發放金幣'
WHERE order_number = 'SD20260201-001';
```

---

## 📱 手機版優化

### 對話框響應式設計

- **訂單編號**：
  - 桌面版：20px 大字
  - 手機版：18px，確保可讀

- **按鈕**：
  - 桌面版：橫向排列
  - 手機版：垂直排列，100% 寬度

- **截圖提醒**：
  - 手機版：文字放大，更醒目
  - 確保用戶在小螢幕上也能清楚看到

---

## ⚠️ 注意事項

### 1. 未完成支付的訂單

**問題**：用戶生成訂單後可能不完成支付

**解決**：
- 訂單狀態保持為 `pending`
- 後台可篩選長時間未處理的訂單
- 客服可主動聯繫確認

### 2. 重複訂單

**問題**：用戶可能多次點擊「確認贊助」

**解決**：
- 按鈕點擊後立即禁用
- 生成訂單期間顯示 loading 提示
- 每次都會生成新的訂單編號（便於追蹤）

### 3. 訂單查詢

**建議**：
- 後台新增訂單編號搜尋功能
- 可按時間、狀態篩選
- 顯示未完成支付的訂單數量

---

## 🚀 未來優化方向

### 1. 訂單過期機制
- 24 小時未處理的訂單自動標記為「已過期」
- 發送提醒通知給用戶

### 2. 批次處理
- 客服可批次更新多筆訂單狀態
- 提高處理效率

### 3. 自動對帳
- 如果 SHOPLINE 未來提供 API
- 可自動比對訂單並更新狀態

### 4. 訂單統計
- 統計未支付訂單比例
- 分析支付轉換率
- 優化支付流程

---

## ✅ 測試檢查清單

### SHOPLINE 流程
- [ ] 選擇 SHOPLINE 方案，點擊「確認贊助」
- [ ] 確認立即顯示「正在生成訂單編號...」提示
- [ ] 確認顯示「✅ 訂單已建立」對話框
- [ ] 確認訂單編號正確顯示且可複製
- [ ] 確認「⚠️ 必須截圖兩個畫面」提示清晰
- [ ] 點擊「我已截圖，前往支付」
- [ ] 確認外部支付頁面在新分頁開啟
- [ ] 確認原分頁跳轉到會員後台
- [ ] 確認會員後台顯示新訂單（⏳ 處理中）

### 資料庫檢查
- [ ] 確認訂單已寫入資料庫
- [ ] 確認訂單編號格式正確
- [ ] 確認 `status = 'pending'`
- [ ] 確認 `payment_method = 'shopline'`
- [ ] 確認所有必要欄位都已填寫

### 客服查帳
- [ ] 使用訂單編號搜尋訂單
- [ ] 確認可查看所有訂單資訊
- [ ] 測試更新訂單狀態為「已完成」
- [ ] 確認用戶端可看到狀態更新

---

## 📝 總結

**核心改變**：
1. SHOPLINE 在**準備付款時**就生成訂單
2. 用戶提前看到訂單編號並截圖
3. 方便客服人工查帳核對
4. 即使未完成支付也有記錄可追蹤

**實作完成！** 🎊
