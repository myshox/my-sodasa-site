<!DOCTYPE html>
<html lang="zh-TW" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="format-detection" content="telephone=no">
    <title>è˜‡æ‰“çŸ³å™¨ï¼šå…¬ç›Šæœ | æœ€äººæƒ…å‘³çš„çŸ³å™¨æ™‚ä»£ç§æœ 2.5</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="è˜‡æ‰“çŸ³å™¨ - ç¶“å…¸çŸ³å™¨æ™‚ä»£ 2.5 ç§æœï¼Œå®Œç¾å¾©åˆ»åŸæ±åŸå‘³ï¼Œç´”æ·¨éŠæˆ²ç’°å¢ƒï¼Œé•·ä¹…ç©©å®šç¶“ç‡Ÿã€‚å…è²»éŠç©ï¼Œå…¬å¹³ç«¶æŠ€ï¼Œæœ€æœ‰äººæƒ…å‘³çš„çŸ³å™¨æ™‚ä»£ç¤¾ç¾¤ã€‚">
    <meta name="keywords" content="çŸ³å™¨æ™‚ä»£,çŸ³å™¨ç§æœ,è˜‡æ‰“çŸ³å™¨,2.5ç‰ˆæœ¬,çŸ³å™¨æ™‚ä»£ç§æœ,å…è²»éŠæˆ²,ç·šä¸ŠéŠæˆ²,MMORPG,å¾©å¤éŠæˆ²,ç¶“å…¸éŠæˆ²">
    <meta name="author" content="è˜‡æ‰“çŸ³å™¨åœ˜éšŠ">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://sodasa.org/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://sodasa.org/">
    <meta property="og:title" content="è˜‡æ‰“çŸ³å™¨ - æœ€äººæƒ…å‘³çš„çŸ³å™¨æ™‚ä»£ç§æœ">
    <meta property="og:description" content="å®Œç¾å¾©åˆ»çŸ³å™¨æ™‚ä»£ 2.5 ç‰ˆæœ¬ï¼Œç´”æ·¨ç’°å¢ƒï¼Œé•·ä¹…ç©©å®šï¼Œå…è²»éŠç©ï¼é‡æº«ç¶“å…¸ï¼Œæ‰¾å›ç«¥å¹´çš„æ„Ÿå‹•ã€‚">
    <meta property="og:image" content="https://sodasa.org/images/og-image.jpg">
    <meta property="og:locale" content="zh_TW">
    <meta property="og:site_name" content="è˜‡æ‰“çŸ³å™¨">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="è˜‡æ‰“çŸ³å™¨ - æœ€äººæƒ…å‘³çš„çŸ³å™¨æ™‚ä»£ç§æœ">
    <meta name="twitter:description" content="å®Œç¾å¾©åˆ»çŸ³å™¨æ™‚ä»£ 2.5 ç‰ˆæœ¬ï¼Œç´”æ·¨ç’°å¢ƒï¼Œé•·ä¹…ç©©å®š">
    <meta name="twitter:image" content="https://sodasa.org/images/og-image.jpg">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#fdcb6e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è˜‡æ‰“çŸ³å™¨">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/images/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/images/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/images/icon-512.png">
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://esm.sh">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://pheoswycciabslxpsjyw.supabase.co" crossorigin>
    <link rel="dns-prefetch" href="https://pheoswycciabslxpsjyw.supabase.co">
    <link rel="dns-prefetch" href="https://unpkg.com">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (ä½¿ç”¨ media å±¬æ€§å»¶é²è¼‰å…¥) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet"></noscript>
    
    <!-- Babel (Fixed Version) -->
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- å¾Œå°å°ˆç”¨è…³æœ¬æ”¹ç‚ºå»¶é²è¼‰å…¥ï¼Œé¦–é /æ”»ç•¥/æ´»å‹•ç­‰ç„¡éœ€ç­‰å¾…ï¼Œé€²å…¥å¾Œå°æ™‚å†è¼‰å…¥ -->
    <script>
        window.__adminScriptsPromise = null;
        window.loadAdminScripts = function() {
            if (window.__adminScriptsPromise) return window.__adminScriptsPromise;
            if (window.Chart && window.Quill) return Promise.resolve();
            window.__adminScriptsPromise = (function() {
                var urls = [
                    'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js',
                    'https://cdn.quilljs.com/1.3.6/quill.min.js',
                    'https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js',
                    'https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js',
                    'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js'
                ];
                var link = document.createElement('link');
                link.rel = 'stylesheet'; link.href = 'https://cdn.quilljs.com/1.3.6/quill.snow.css';
                document.head.appendChild(link);
                var load = function(src) {
                    return new Promise(function(res, rej) {
                        if (src.indexOf('pdf.min') !== -1 && window.pdfjsLib) return res();
                        if (src.indexOf('chart') !== -1 && window.Chart) return res();
                        if (src.indexOf('quill') !== -1 && window.Quill) return res();
                        var s = document.createElement('script');
                        s.src = src; s.onload = res; s.onerror = rej;
                        document.head.appendChild(s);
                    });
                };
                return Promise.all(urls.map(load)).then(function() {
                    if (window.pdfjsLib) window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
                });
            })();
            return window.__adminScriptsPromise;
        };
    </script>

    <!-- Import Map (ä½¿ç”¨ç”Ÿç”¢ç‰ˆæœ¬ï¼Œæ¸›å°‘æ–‡ä»¶å¤§å°) -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.3.1",
            "react-dom": "https://esm.sh/react-dom@18.3.1",
            "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
            "react-router-dom": "https://esm.sh/react-router-dom@6.22.3?external=react,react-dom",
            "framer-motion": "https://esm.sh/framer-motion@10.16.4?external=react,react-dom",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react"
        }
    }
    </script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        display: ['"Zen Maru Gothic"', 'sans-serif'],
                    },
                    colors: {
                        stone: { 50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1', 400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c', 800: '#4a4036', 900: '#2d2520', 950: '#1a1614' },
                        fire: { 400: '#ff8e8e', 500: '#ff6b6b', 600: '#e05252' },
                        water: { 400: '#7ed4e6', 500: '#4fc3dc', 600: '#2b9db3' },
                        wind: { 400: '#6ce0ba', 500: '#42ca9f', 600: '#2da881' },
                        earth: { 400: '#fad390', 500: '#f6b93b', 600: '#e58e26' },
                        gold: { 400: '#ffeaa7', 500: '#fdcb6e', 600: '#e1b12c' },
                        discord: { 500: '#5865F2', 600: '#4752C4' },
                        line: { 500: '#06C755', 600: '#05B34C' },
                        sand: { 100: '#fdf6e3', 400: '#e6cca0', 500: '#d4b483', 600: '#b08d55' },
                        wood: { 600: '#8b5a2b', 700: '#6d4c41' }
                    },
                    backgroundImage: {
                        'stone-texture': "url('https://www.transparenttextures.com/patterns/concrete-wall.png')",
                        'noise': "url('https://www.transparenttextures.com/patterns/stardust.png')",
                        'gradient-tribal': 'linear-gradient(135deg, #fbf6e9 0%, #fff5d7 100%)',
                    },
                    boxShadow: {
                        'stone': '6px 6px 0px rgba(139, 90, 43, 0.2)',
                        'stone-hover': '3px 3px 0px rgba(139, 90, 43, 0.2)',
                        'card': '0 12px 24px -8px rgba(139, 90, 43, 0.12)',
                        'btn': '0 6px 0 rgba(0,0,0,0.15)',
                        'btn-press': '0 0 0 rgba(0,0,0,0)',
                        'glow-gold': '0 0 25px rgba(253, 203, 110, 0.5)',
                        'glow-fire': '0 0 25px rgba(255, 107, 107, 0.4)',
                    },
                    animation: {
                        'float': 'float 8s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s infinite',
                        'shimmer': 'shimmer 2.5s linear infinite',
                        'bounce-slow': 'bounce 3s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-12px)' },
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' }
                        },
                        fadeIn: {
                            '0%': { opacity: 0, transform: 'scale(0.98) translateY(10px)' },
                            '100%': { opacity: 1, transform: 'scale(1) translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
        body { 
            background-color: #fbf6e9;
            color: #4a4036;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            font-size: 16px;
            line-height: 1.65;
            letter-spacing: 0.01em;
        }
        #root:empty::before {
            content: 'æ­£åœ¨å‰å¾€å°¼æ–¯å¤§é™¸...';
            display: block;
            text-align: center;
            padding-top: 20vh;
            color: #d4b483;
            font-weight: bold;
            font-size: 1.5rem;
            font-family: "Zen Maru Gothic", sans-serif;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f5f0e6; }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, #d4b483, #b08d55); 
            border-radius: 4px; 
            border: 2px solid #fbf6e9;
        }
        ::-webkit-scrollbar-thumb:hover { background: #b08d55; }
        
        /* ç„¦é»å¯è¦‹æ€§ï¼šç„¡éšœç¤™å‹å–„ */
        *:focus-visible {
            outline: 2px solid #d4b483;
            outline-offset: 2px;
        }
        button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
            outline: 2px solid #d4b483;
            outline-offset: 2px;
        }
        
        .stone-panel {
            background-color: #ffffff;
            background-image: url('https://www.transparenttextures.com/patterns/natural-paper.png');
            border: 3px solid #e6cca0;
            border-radius: 28px;
            box-shadow: 6px 6px 0px rgba(212, 180, 131, 0.35);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }
        
        .stone-panel:hover {
            box-shadow: 8px 8px 0px rgba(212, 180, 131, 0.5);
            transform: translateY(-3px);
        }
        
        .text-outline {
            text-shadow: 2px 2px 0px rgba(139, 90, 43, 0.2);
        }
        
        .btn-shine {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            background-size: 200% 100%;
        }
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }
        @media (max-width: 768px) {
            .event-content img { max-width: 100%; height: auto; }
            .event-content table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        }
        
        ::selection {
            background: #ffeaa7;
            color: #57534e;
        }
        
        /* è·‘é¦¬ç‡ˆå‹•ç•« */
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .marquee-content {
            display: inline-flex;
            animation: marquee 30s linear infinite;
        }
        .marquee-content:hover { animation-play-state: paused; }
        
        /* è§¸æ§å„ªåŒ–ï¼šæœ€å° 44px é»æ“Šå€ */
        @media (max-width: 768px) {
            button, a[href], [role="button"] { min-height: 44px; min-width: 44px; }
        }
        
        /* å¤§å­—æ¨¡å¼ï¼šä¸­é«˜é½¡å‹å–„ï¼ˆå­—é«”æ”¾å¤§ã€æŒ‰éˆ•åŠ å¤§ï¼‰ */
        html.accessibility-large {
            font-size: 18px;
        }
        html.accessibility-large body {
            font-size: 1.125rem;
            line-height: 1.7;
        }
        html.accessibility-large button,
        html.accessibility-large [role="button"],
        html.accessibility-large input,
        html.accessibility-large select,
        html.accessibility-large textarea,
        html.accessibility-large a[href] {
            min-height: 48px;
            min-width: 48px;
        }
        html.accessibility-large input,
        html.accessibility-large select,
        html.accessibility-large textarea {
            padding: 0.75rem 1rem;
            font-size: 1rem;
        }
        html.accessibility-large .text-xs { font-size: 0.9375rem !important; }
        html.accessibility-large .text-sm { font-size: 1rem !important; }
        html.accessibility-large .text-base { font-size: 1.125rem !important; }
        html.accessibility-large .text-lg { font-size: 1.25rem !important; }
        html.accessibility-large .text-xl { font-size: 1.375rem !important; }
    </style>
</head>
<body>
    <script>
        // å¤§å­—æ¨¡å¼ï¼šé é¢è¼‰å…¥å‰å³å¥—ç”¨ï¼Œé¿å…æ–‡å­—é–ƒçˆ
        if (localStorage.getItem('sodasa-accessibility-large') === '1') {
            document.documentElement.classList.add('accessibility-large');
        }
    </script>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useLayoutEffect, useRef, useMemo, memo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { BrowserRouter, Routes, Route, Link, useLocation, useNavigate, useParams } from 'react-router-dom';
        import { motion, AnimatePresence } from 'framer-motion';
        import { 
            ShieldCheck, Shield, Star, Home, Download, MessageSquare, 
            Heart, CreditCard, Landmark, Smartphone, 
            Menu, X, CheckCircle, AlertCircle, Loader2, Sparkles, Sword, Crown, ScrollText, Coins,
            HeartHandshake, Eye, EyeOff, ExternalLink, User, Mail, Send, LayoutDashboard, Flame, Wind, Bell, ChevronDown,
            Volume2, VolumeX, ArrowRight, Lock, LogOut, Copy, Clipboard, Trash2, Search, Key, Check, Plus, Megaphone,
            Edit, Edit2, Settings, UserPlus, Calendar, Tag, SkipForward, Music, FolderOpen, MessageCircle,
            ChevronLeft, ChevronRight, ChevronsLeft, ChevronsRight, TrendingUp, BarChart3,
            BookOpen, ArrowLeft, Clock, Users, LayoutGrid, List, Type, Share2, Gift
        } from 'lucide-react';
        
        // --- Supabase é…ç½® ---
        const SUPABASE_URL = 'https://pheoswycciabslxpsjyw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoZW9zd3ljY2lhYnNseHBzanl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwOTA4NDcsImV4cCI6MjA4NTY2Njg0N30.zQm1nL1mbg4ClpCEo_upK4eHVKODF6gy9hB-JevXb38';
        // è‡ªè¨‚ fetchï¼šå° AbortErrorï¼ˆå°ˆæ¡ˆå†·å•Ÿå‹•ã€ç¶²è·¯æ…¢ï¼‰è‡ªå‹•é‡è©¦ï¼Œæœ€å¤š 2 æ¬¡
        const fetchWithRetry = (url, opts = {}) => {
            const doFetch = (attempt) => {
                const fetchOpts = attempt > 0 ? { ...opts, signal: undefined } : opts;
                return fetch(url, fetchOpts).catch((err) => {
                    const isAbort = err?.name === 'AbortError' || String(err?.message || '').includes('aborted');
                    if (isAbort && attempt < 2) {
                        const delay = (attempt + 1) * 2500;
                        return new Promise(r => setTimeout(r, delay)).then(() => doFetch(attempt + 1));
                    }
                    throw err;
                });
            };
            return doFetch(0);
        };
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            global: { fetch: fetchWithRetry },
            auth: {
                persistSession: true,        // æŒä¹…åŒ– session åˆ° localStorage
                autoRefreshToken: true,      // è‡ªå‹•åˆ·æ–° token
                detectSessionInUrl: true,    // åµæ¸¬ URL ä¸­çš„ sessionï¼ˆå¯†ç¢¼é‡è¨­ç”¨ï¼‰
                storageKey: 'sodasa-auth'    // è‡ªè¨‚ storage key
            }
        });
        
        // --- IP ä½ç½®è¿½è¹¤è¼”åŠ©å‡½æ•¸ ---
        const getIpLocation = async () => {
            try {
                // ä½¿ç”¨ ipapi.coï¼ˆå…è²»ï¼Œç„¡éœ€ API keyï¼Œ1000æ¬¡/å¤©ï¼‰
                const response = await fetch('https://ipapi.co/json/');
                if (!response.ok) {
                    throw new Error('IP API è«‹æ±‚å¤±æ•—');
                }
                
                const data = await response.json();
                
                return {
                    ip: data.ip,
                    country: data.country_name,
                    country_code: data.country_code,
                    region: data.region,
                    city: data.city,
                    postal: data.postal,
                    latitude: data.latitude,
                    longitude: data.longitude,
                    timezone: data.timezone,
                    isp: data.org,
                    raw_data: data
                };
            } catch (error) {
                console.error('å–å¾— IP ä½ç½®å¤±æ•—:', error);
                // å¦‚æœä¸»è¦ API å¤±æ•—ï¼Œå˜—è©¦å‚™ç”¨ API
                try {
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    return { ip: data.ip }; // è‡³å°‘å–å¾— IP
                } catch (err) {
                    console.error('å‚™ç”¨ IP API ä¹Ÿå¤±æ•—:', err);
                    return null;
                }
            }
        };
        
        // å„²å­˜ IP ä½ç½®åˆ°è³‡æ–™åº«
        const saveIpLocation = async (ipData) => {
            if (!ipData || !ipData.country) return;
            
            try {
                const { error } = await supabase.rpc('upsert_ip_location', {
                    p_ip_address: ipData.ip,
                    p_country: ipData.country || null,
                    p_country_code: ipData.country_code || null,
                    p_region: ipData.region || null,
                    p_city: ipData.city || null,
                    p_postal_code: ipData.postal || null,
                    p_latitude: ipData.latitude || null,
                    p_longitude: ipData.longitude || null,
                    p_timezone: ipData.timezone || null,
                    p_isp: ipData.isp || null,
                    p_organization: ipData.isp || null,
                    p_raw_data: ipData.raw_data || {}
                });
                
                if (error) {
                    console.error('å„²å­˜ IP ä½ç½®å¤±æ•—:', error);
                }
            } catch (err) {
                console.error('å„²å­˜ IP ä½ç½®ç•°å¸¸:', err);
            }
        };
        
        // --- Authentication Helper Functions ---
        const authHelpers = {
            // è¨»å†Šæ–°ç”¨æˆ¶
            signUp: async (email, password, gameAccount = '') => {
                const { data, error } = await supabase.auth.signUp({ 
                    email, 
                    password,
                    options: {
                        data: {
                            game_accounts: [{ // å„²å­˜ç‚ºé™£åˆ—ï¼Œæ”¯æ´å¤šå€‹éŠæˆ²å¸³è™Ÿï¼ˆæœ€å¤š5å€‹ï¼‰
                                id: Date.now().toString(),
                                name: gameAccount,
                                is_primary: true,
                                created_at: Date.now()
                            }]
                        }
                    }
                });
                return { data, error };
            },
            
            // ç™»å…¥
            signIn: async (email, password) => {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                return { data, error };
            },
            
            // ç™»å‡º
            signOut: async () => {
                const { error } = await supabase.auth.signOut();
                return { error };
            },
            
            // ç²å–ç•¶å‰ç”¨æˆ¶
            getCurrentUser: async () => {
                const { data: { user } } = await supabase.auth.getUser();
                return user;
            },
            
            // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
            onAuthStateChange: (callback) => {
                return supabase.auth.onAuthStateChange(callback);
            },
            
            // æ›´æ–°å¯†ç¢¼
            updatePassword: async (newPassword) => {
                const { data, error } = await supabase.auth.updateUser({ password: newPassword });
                return { data, error };
            }
        };
        
        // --- éœæ…‹è³‡æ–™èˆ‡ç´ æ ---
        const ASSETS = {
            LOGO: 'images/logo.jpg', 
            HERO: 'images/é¦–é .jpg', 
            LINE_LOGO: 'images/LINE_logo.jpg',
            LINE_PAY_LOGO: 'images/LINEPAY.jpg', 
            JKOPAY_LOGO: 'images/jkopay.jpg', 
            APPLE_PAY_LOGO: 'images/applepay.jpg',
            SHOPLINE_LOGO: 'images/shopline.jpg',
            BGM: 'music/ä¼Šç”¸åœ’.mp3', 
            LOVE_BG: 'images/LOVE.jpg',
            LINE_QRS: {
                100: 'images/LINE100QR.jpg',
                300: 'images/LINE300QR.jpg',
                500: 'images/LINE500QR.jpg',
                1000: 'images/LINE1000QR.jpg',
                3000: 'images/LINE3000QR.jpg',
                5000: 'images/LINE5000QR.jpg',
                10000: 'images/LINE10000QR.jpg'
            }
        };
        // ä¾ç›®å‰é é¢ç¶²å€è§£æè³‡æºè·¯å¾‘ï¼Œç¢ºä¿æœ¬åœ°ï¼éƒ¨ç½²å¾Œéƒ½èƒ½è¼‰å…¥
        const getAssetUrl = (filename) => {
            if (!filename) return '';
            if (filename.startsWith('http')) return filename;
            try {
                var base = window.location.href;
                if (window.location.protocol === 'file:') {
                    base = base.replace(/[#?].*$/, '').replace(/\/[^/]*$/, '/');
                    return base + filename;
                }
                return new URL(filename, window.location.origin + window.location.pathname).href;
            } catch (e) {
                return (window.location.pathname.replace(/\/[^/]*$/, '') || '/') + '/' + filename;
            }
        };

        const PLANS = [
            { amount: 100, base: 10000, bonus: 0, total: 10000, rate: "0%", popular: false, url: "https://pl.sl-pay.com/VevhHNNf" },
            { amount: 300, base: 30000, bonus: 2000, total: 32000, rate: "~6.6%", popular: false, url: "https://pl.sl-pay.com/ryeXRyc9" },
            { amount: 500, base: 50000, bonus: 5000, total: 55000, rate: "10%", popular: false, url: "https://pl.sl-pay.com/6XLAiYMQ" },
            { amount: 1000, base: 100000, bonus: 15000, total: 115000, rate: "15%", popular: true, url: "https://pl.sl-pay.com/Z676xyrq" },
            { amount: 3000, base: 300000, bonus: 60000, total: 360000, rate: "20%", popular: false, url: "https://pl.sl-pay.com/6gzNTMQD" },
            { amount: 5000, base: 500000, bonus: 125000, total: 625000, rate: "25%", popular: false, url: "https://pl.sl-pay.com/qhRzXM7l" },
            { amount: 10000, base: 1000000, bonus: 300000, total: 1300000, rate: "30%", popular: false, url: "https://pl.sl-pay.com/Bcmcg0pc" }
        ];

        const PAYMENT_METHODS = [
            { 
                id: 'shopline', 
                name: 'SHOPLINE æ•´åˆæ”¯ä»˜', 
                subLabel: 'åˆ·å¡ / ATM / Apple Pay / è¡—å£æ”¯ä»˜', 
                icons: [CreditCard, Landmark],
                imgs: [ASSETS.APPLE_PAY_LOGO, ASSETS.JKOPAY_LOGO]
            },
            { id: 'linepay', name: 'LINE Pay æƒç¢¼', subLabel: 'æ‰‹æ©Ÿæƒæ QR Code', img: ASSETS.LINE_PAY_LOGO }
        ];

        const EVENT_TAGS = [
            { id: 'event', label: 'ğŸ”¥ æ´»å‹•', color: 'bg-fire-500 text-white' },
            { id: 'announcement', label: 'ğŸ“¢ å…¬å‘Š', color: 'bg-water-500 text-white' },
            { id: 'maintenance', label: 'ğŸ”§ ç¶­è­·', color: 'bg-stone-500 text-white' },
            { id: 'bonus', label: 'ğŸ ç¦åˆ©', color: 'bg-gold-500 text-white' },
        ];

        // --- Supabase è³‡æ–™åº«å‡½æ•¸ ---
        const DB_TABLES = {
            SPONSORSHIPS: 'sponsorships',
            ADMINS: 'admins',
            EVENTS: 'events',
            PLAYLIST: 'playlist',
            ANNOUNCEMENTS: 'announcements'
        };

        const BANNER_ICONS = {
            megaphone: Megaphone,
            bookopen: BookOpen,
            gift: Gift,
            star: Star,
            flame: Flame,
            bell: Bell,
            sparkles: Sparkles,
        };

        // å¾ Supabase è®€å–è³‡æ–™ï¼ˆå¯é¸ columnsã€limit ä»¥æ¸›å°‘å‚³è¼¸é‡ï¼‰
        const getSupabaseData = async (table, opts = {}) => {
            try {
                const cols = opts.columns || '*';
                let q = supabase.from(table).select(cols).order('created_at', { ascending: false });
                if (opts.limit) q = q.limit(opts.limit);
                const { data, error } = await q;
                if (error) {
                    console.error(`Supabase error reading ${table}:`, error);
                    return [];
                }
                return data || [];
            } catch (err) {
                console.error(`Error reading ${table}:`, err);
                return [];
            }
        };

        // æ–°å¢è³‡æ–™åˆ° Supabase
        const insertSupabaseData = async (table, record) => {
            try {
                const { data, error } = await supabase
                    .from(table)
                    .insert([record])
                    .select();
                
                if (error) {
                    console.error(`Supabase error inserting to ${table}:`, error);
                    return null;
                }
                return data?.[0] || null;
            } catch (err) {
                console.error(`Error inserting to ${table}:`, err);
                return null;
            }
        };

        // æ›´æ–° Supabase è³‡æ–™
        const updateSupabaseData = async (table, id, updates) => {
            try {
                const { data, error } = await supabase
                    .from(table)
                    .update(updates)
                    .eq('id', id)
                    .select();
                
                if (error) {
                    console.error(`Supabase error updating ${table}:`, error);
                    return null;
                }
                return data?.[0] || null;
            } catch (err) {
                console.error(`Error updating ${table}:`, err);
                return null;
            }
        };

        // åˆªé™¤ Supabase è³‡æ–™
        const deleteSupabaseData = async (table, id) => {
            try {
                const { error } = await supabase
                    .from(table)
                    .delete()
                    .eq('id', id);
                
                if (error) {
                    console.error(`Supabase error deleting from ${table}:`, error);
                    return false;
                }
                return true;
            } catch (err) {
                console.error(`Error deleting from ${table}:`, err);
                return false;
            }
        };

        // --- ç´”å‘ˆç¾çµ„ä»¶å„ªåŒ– ---
        const DiscordIcon = memo(({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1432-.1064.2868-.2132.4233-.3251a.0743.0743 0 01.0786-.0102c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1365.1119.2801.2187.4233.3251a.076.076 0 01-.0076.1277 12.2573 12.2573 0 01-1.8722.8923.077.077 0 00-.0416.1057c.3658.71.7773 1.3749 1.226 1.9942a.076.076 0 00.0842.0276c1.961-.6066 3.9495-1.5218 6.0023-3.0294a.077.077 0 00.0313-.0561c.693-5.1917-.2962-9.6379-1.3793-13.6655a.061.061 0 00-.032-.0277zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.419-2.1568 2.419zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.419-2.1568 2.419z"/></svg>
        ));

        const LineIcon = memo(({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM17.15 14.53C17.15 14.78 16.96 15 16.7 15H15.15C15 15 14.88 14.93 14.79 14.82L13.2 12.72V14.53C13.2 14.78 13.01 15 12.75 15H11.95C11.69 15 11.5 14.78 11.5 14.53V9.47C11.5 9.22 11.69 9 11.95 9H13.5C13.65 9 13.77 9.07 13.86 9.18L15.45 11.28V9.47C15.45 9.22 15.64 9 15.9 9H16.7C16.96 9 17.15 9.22 17.15 9.47V14.53ZM9.9 14.53C9.9 14.78 9.71 15 9.45 15H7.05C6.79 15 6.6 14.78 6.6 14.53V9.47C6.6 9.22 6.79 9 7.05 9H7.85V11.6H9.45C9.71 11.6 9.9 11.81 9.9 12.07V12.53C9.9 12.79 9.71 13 9.45 13H7.85V14.53H9.9Z"/></svg>
        ));

        const SmartImage = memo(({ src, alt, className, fallbackType = 'hero' }) => {
            const [imgSrc, setImgSrc] = useState(src);
            const FALLBACKS = {
                hero: 'https://images.unsplash.com/photo-1518709268805-4e9042af9f23?auto=format&fit=crop&q=80&w=2000', 
                logo: 'https://cdn-icons-png.flaticon.com/512/3034/3034870.png',
            };
            useEffect(() => { setImgSrc(src); }, [src]);
            return <img src={imgSrc} alt={alt || 'Logo'} className={className} onError={() => setImgSrc(FALLBACKS[fallbackType] || FALLBACKS.logo)} loading="lazy" />;
        });

        // --- çµ„ä»¶ ---
        const MusicPlayer = () => {
            const [playlist, setPlaylist] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [hasError, setHasError] = useState(false);
            const audioRef = useRef(null);

            useEffect(() => {
                const loadPlaylist = async () => {
                    const list = await getSupabaseData(DB_TABLES.PLAYLIST);
                    if (list.length > 0) setPlaylist(list);
                };
                loadPlaylist();
                window.addEventListener('storage-update', loadPlaylist);
                return () => window.removeEventListener('storage-update', loadPlaylist);
            }, []);

            useEffect(() => {
                if (audioRef.current) {
                    audioRef.current.volume = 0.3; // é è¨­éŸ³é‡
                }
            }, []);

            useEffect(() => {
                if (playlist.length > 0 && isPlaying && audioRef.current) {
                    audioRef.current.load();
                    audioRef.current.play().catch(e => console.log("Auto-play failed:", e));
                }
            }, [currentIndex, playlist]);

            const currentTrack = playlist[currentIndex] || { url: '', title: '' };

            const togglePlay = () => {
                if (!audioRef.current || playlist.length === 0) return;
                
                if (isPlaying) {
                    audioRef.current.pause();
                    setIsPlaying(false);
                } else {
                    audioRef.current.play()
                        .then(() => {
                            setIsPlaying(true);
                            setHasError(false);
                        })
                        .catch(err => {
                            console.error("æ’­æ”¾å¤±æ•—:", err);
                            handleAudioError(); 
                        });
                }
            };

            const playNext = () => {
                if (playlist.length === 0) return;
                setHasError(false);
                setCurrentIndex((prev) => (prev + 1) % playlist.length);
                setIsPlaying(true);
            };

            const handleAudioError = () => {
                console.warn(`Audio Error for: ${currentTrack.title}`);
                if (playlist.length > 1) {
                    playNext();
                } else {
                    setHasError(true);
                    setIsPlaying(false);
                }
            };

            if (playlist.length === 0) return null;

            return (
                <div className="flex items-center gap-2 bg-white/90 backdrop-blur-lg rounded-2xl py-2 px-3 md:px-4 border border-stone-200/80 shadow-md shadow-stone-200/20 transition-all duration-200 hover:shadow-lg hover:bg-white">
                    <audio 
                        ref={audioRef} 
                        src={currentTrack.url} 
                        loop={false}
                        onEnded={playNext}
                        preload="auto" 
                        onError={handleAudioError}
                    />
                    
                    <button 
                        onClick={togglePlay} 
                        className={`p-2 rounded-full hover:bg-sand-100 transition-colors ${hasError ? 'text-red-500' : 'text-stone-600'}`}
                        title={hasError ? "ç„¡æ³•è®€å–" : (isPlaying ? "æš«åœ" : "æ’­æ”¾")}
                    >
                        {hasError ? <AlertCircle size={18}/> : (isPlaying ? <Volume2 size={18} className="text-gold-600"/> : <VolumeX size={18}/>)}
                    </button>

                    <div className="flex flex-col max-w-[120px] hidden md:flex px-1">
                        <span className="text-[10px] text-stone-400 font-bold leading-none tracking-wider mb-0.5">NOW PLAYING</span>
                        <span className="text-xs text-stone-700 font-bold truncate leading-tight">{currentTrack.title}</span>
                    </div>

                    <div className="w-px h-5 bg-stone-200 mx-1 hidden md:block"></div>

                    <button 
                        onClick={playNext}
                        className="p-1.5 rounded-full hover:bg-sand-100 text-stone-400 hover:text-gold-600 transition-colors"
                        title="ä¸‹ä¸€é¦–"
                    >
                        <SkipForward size={16} />
                    </button>
                </div>
            );
        };

        const PaymentModal = ({ method, plan, gameAccount, lineName, orderNumber, onClose, onSaveRecord, showConfirm }) => {
            if (!method || !plan) return null;
            
            const ReminderSection = () => (
                <div className="bg-red-50/50 border-2 border-red-200 rounded-3xl p-6 mb-8 relative overflow-hidden space-y-4">
                    <div className="flex gap-4">
                        <div className="bg-red-100 p-3 rounded-full h-fit text-red-500 shrink-0">
                            <AlertCircle size={24} />
                        </div>
                        <div>
                            <p className="text-red-600 font-black text-lg mb-1">ä»˜æ¬¾å¾Œè«‹å‹™å¿…æˆªåœ–ï¼</p>
                            <p className="text-stone-600 font-medium text-sm leading-relaxed">
                                ç‚ºäº†ç¢ºä¿æ‚¨çš„æ¬Šç›Šï¼Œè«‹å°‡æ”¯ä»˜ä½è­‰å‚³é€çµ¦ <span className="text-stone-800 font-bold border-b border-red-300">å®˜æ–¹å®¢æœ</span> ä»¥é ˜å–é‡‘å¹£ã€‚
                            </p>
                        </div>
                    </div>
                    <div className="bg-red-100/50 border border-red-300 rounded-2xl p-4">
                        <p className="text-red-700 font-bold text-sm leading-relaxed">
                            âš ï¸ <strong>å¦‚å„²å€¼æœ‰å•é¡Œ</strong>ï¼Œè«‹å‹™å¿…æˆªåœ–<strong className="underline">å®˜ç¶²é é¢</strong>èˆ‡<strong className="underline">è½‰å¸³ç´€éŒ„</strong>ï¼Œä¸¦è¯ç¹«å®¢æœæŸ¥æ ¸ã€‚
                        </p>
                    </div>
                </div>
            );

            const AmountInfo = () => (
                <div className="bg-stone-50/80 rounded-3xl p-6 border border-stone-100 mb-6 space-y-4">
                    {orderNumber && (
                        <div className="flex justify-between items-center border-b border-stone-200/50 pb-3 border-dashed">
                            <span className="text-stone-500 font-bold text-sm tracking-wide">è¨‚å–®ç·¨è™Ÿ</span>
                            <div className="flex items-center gap-2">
                                <code className="text-base font-black text-purple-600 bg-purple-50 px-3 py-1 rounded-lg border border-purple-200">
                                    {orderNumber}
                                </code>
                                <button
                                    onClick={() => {
                                        navigator.clipboard.writeText(orderNumber);
                                        showToast('è¨‚å–®ç·¨è™Ÿå·²è¤‡è£½', 'success');
                                    }}
                                    className="p-1.5 hover:bg-stone-200 rounded-lg transition-colors"
                                    title="è¤‡è£½è¨‚å–®ç·¨è™Ÿ"
                                >
                                    <Copy size={16} className="text-stone-500" />
                                </button>
                            </div>
                        </div>
                    )}
                    <div className="flex justify-between items-center border-b border-stone-200/50 pb-3 border-dashed">
                        <span className="text-stone-500 font-bold text-sm tracking-wide">éŠæˆ²å¸³è™Ÿ</span>
                        <span className="text-lg font-black text-stone-700 font-mono tracking-wide">{gameAccount}</span>
                    </div>
                    {lineName && (
                        <div className="flex justify-between items-center border-b border-stone-200/50 pb-3 border-dashed">
                            <span className="text-stone-500 font-bold text-sm tracking-wide">LINE æˆ– Discord åç¨±</span>
                            <span className="text-base font-bold text-green-600 flex items-center gap-1">
                                <span>ğŸ“±</span>
                                {lineName}
                            </span>
                        </div>
                    )}
                    <div className="flex justify-between items-center border-b border-stone-200/50 pb-3 border-dashed">
                        <span className="text-stone-500 font-bold text-sm tracking-wide">æ”¯ä»˜é‡‘é¡</span>
                        <span className="text-xl font-black text-stone-800">NT$ {plan.amount.toLocaleString()}</span>
                    </div>
                    <div className="flex justify-between items-center pt-1">
                        <span className="text-stone-500 font-bold text-sm tracking-wide">ç²å¾—é‡‘å¹£</span>
                        <div className="text-right flex items-baseline gap-1 justify-end">
                            <span className="text-2xl font-black text-gold-500">{plan.total.toLocaleString()}</span>
                            <span className="text-xs font-bold text-gold-600 uppercase">Gold</span>
                        </div>
                    </div>
                </div>
            );

            const ModalWrapper = ({ children, borderColor = "border-line-500" }) => (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-md animate-fade-in">
                    <motion.div initial={{ scale: 0.95, opacity: 0, y: 20 }} animate={{ scale: 1, opacity: 1, y: 0 }} transition={{ type: "spring", stiffness: 300, damping: 30 }} className={`bg-white rounded-[2.5rem] p-6 md:p-10 max-w-md w-full shadow-2xl relative border-0 max-h-[95vh] overflow-y-auto`}>
                        <button onClick={onClose} className="absolute top-6 right-6 text-stone-400 hover:text-stone-600 p-2 hover:bg-stone-100 rounded-full transition-colors z-10" aria-label="é—œé–‰"><X size={24} /></button>
                        {children}
                    </motion.div>
                </div>
            );

            if (method === 'linepay') {
                const qrImage = getAssetUrl(ASSETS.LINE_QRS[plan.amount]);
                return (
                    <ModalWrapper borderColor="border-line-500">
                        <div className="text-center">
                            <div className="w-16 h-16 mx-auto bg-line-500 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-green-200"><img src={getAssetUrl(ASSETS.LINE_PAY_LOGO)} alt="LINE Pay" className="w-10 h-auto object-contain brightness-0 invert" /></div>
                            <h3 className="text-2xl font-black text-stone-800 mb-2">LINE Pay æƒç¢¼</h3>
                            <p className="text-stone-500 font-medium mb-6 text-sm">è«‹ä½¿ç”¨æ‰‹æ©Ÿæƒæä¸‹æ–¹æ¢ç¢¼</p>
                            
                            <div className="bg-white p-4 rounded-3xl border border-stone-100 mb-6 inline-block shadow-sm">
                                {qrImage && !qrImage.includes('placeholder') ? <img src={qrImage} alt={`NT$ ${plan.amount}`} className="w-48 h-48 object-contain rounded-xl mix-blend-multiply" /> : <div className="w-48 h-48 flex flex-col items-center justify-center text-stone-400"><AlertCircle size={40} className="mb-2"/><span className="text-sm text-center">QR Code æ¸¬è©¦ä¸­<br/>(è«‹è¯ç¹«å®¢æœ)</span></div>}
                            </div>
                            
                            <Button variant="line" className="w-full py-4 text-lg rounded-2xl mb-6" onClick={async () => {
                                onClose();
                                // è¨‚å–®å·²åœ¨é–‹å•Ÿå½ˆçª—æ™‚å»ºç«‹ï¼Œè‹¥æœ‰ orderNumber å‰‡ä¸é‡è¤‡å¯«å…¥
                                let newOrderNumber = orderNumber || null;
                                if (!newOrderNumber) {
                                    showToast('æ­£åœ¨å–å¾—è¨‚å–®ç·¨è™Ÿ...', 'info');
                                    const result = await onSaveRecord();
                                    newOrderNumber = typeof result === 'string' ? result : null;
                                }
                                const showReminderDialog = (num) => {
                                    showConfirm(
                                        'âœ… è¨‚å–®å·²å»ºç«‹',
                                        <div className="text-left space-y-4">
                                            {num && (
                                                <div className="bg-purple-50 border-2 border-purple-500 p-4 rounded-lg">
                                                    <p className="text-sm text-stone-600 font-bold mb-2">æ‚¨çš„è¨‚å–®ç·¨è™Ÿ</p>
                                                    <div className="flex items-center gap-3 justify-center">
                                                        <code className="text-xl font-black text-purple-600 bg-white px-4 py-2 rounded-lg border-2 border-purple-300">{num}</code>
                                                        <button onClick={() => { navigator.clipboard.writeText(num); showToast('è¨‚å–®ç·¨è™Ÿå·²è¤‡è£½', 'success'); }} className="p-2 hover:bg-purple-100 rounded-lg transition-colors" title="è¤‡è£½è¨‚å–®ç·¨è™Ÿ"><Copy size={20} className="text-purple-600" /></button>
                                                    </div>
                                                </div>
                                            )}
                                            <div className="bg-yellow-50 border-2 border-yellow-500 p-4 rounded-lg">
                                                <p className="text-xl text-red-600 font-black mb-2">âš ï¸ å¿…é ˆæˆªåœ–ï¼</p>
                                                <p className="text-base text-stone-800 font-bold">ğŸ“¸ è«‹ç«‹å³æˆªåœ–æœ¬é é¢ä¿å­˜è¨‚å–®ç·¨è™Ÿ</p>
                                                <p className="text-sm text-stone-600 mt-2">ä½œç‚ºæ”¯ä»˜æ†‘è­‰ï¼Œé¿å…ç³¾ç´›</p>
                                            </div>
                                            <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded space-y-3">
                                                <p className="text-base text-stone-800 font-black">ğŸ’¬ è«‹ç«‹å³å°‡æˆªåœ–å‚³é€çµ¦ LINE å®˜æ–¹å®¢æœ</p>
                                                <a href="https://lin.ee/3vSihiH" target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 px-4 py-3 bg-line-500 text-white rounded-lg text-base font-bold hover:bg-line-600 transition-colors shadow-lg w-full justify-center">
                                                    <MessageSquare size={20} /> ç«‹å³è¯ç¹« LINE å®¢æœ <ExternalLink size={16} />
                                                </a>
                                                <p className="text-sm text-stone-600 font-bold text-center">â° äººå·¥å®¢æœæ™‚é–“ï¼š10:00 - 22:00</p>
                                            </div>
                                            <div className="bg-red-50 border border-red-300 rounded-lg p-3">
                                                <p className="text-sm text-red-700 font-bold">ğŸ’¡ å®¢æœæœƒæ ¸å°æ‚¨çš„è¨‚å–®ç·¨è™Ÿå’Œæ”¯ä»˜æ†‘è­‰å¾Œç™¼æ”¾é‡‘å¹£</p>
                                            </div>
                                        </div>,
                                        () => { window.location.href = '/member'; showToast('å·²å»ºç«‹è¨‚å–®ï¼Œè«‹å°‡æˆªåœ–å‚³é€çµ¦å®¢æœ', 'success'); },
                                        'å‰å¾€æœƒå“¡å¾Œå°æŸ¥çœ‹'
                                    );
                                };
                                setTimeout(() => showReminderDialog(newOrderNumber), 300);
                            }}>æ˜¯å¦å®Œæˆæ”¯ä»˜ï¼Ÿ</Button>
                            
                            <AmountInfo />
                            <ReminderSection />
                        </div>
                    </ModalWrapper>
                );
            }
            
            if (method === 'shopline') {
                return (
                    <ModalWrapper borderColor="border-gold-400">
                        <div className="text-center">
                            <div className="w-20 h-20 mx-auto bg-gradient-to-br from-amber-50 to-gold-50 rounded-2xl flex items-center justify-center mb-6 shadow-lg border-2 border-gold-200/80 p-3">
                                <img src={getAssetUrl(ASSETS.SHOPLINE_LOGO)} alt="SHOPLINE" className="w-14 h-auto object-contain" />
                            </div>
                            <h3 className="text-2xl font-black text-stone-800 mb-2">å³å°‡å‰å¾€ä»˜æ¬¾é é¢</h3>
                            <p className="text-stone-500 text-sm font-medium mb-6">æ”¯æ´åˆ·å¡ã€ATMã€Apple Payã€è¡—å£æ”¯ä»˜</p>
                            
                            <AmountInfo />
                            <ReminderSection />

                            <Button variant="gold" className="w-full py-4 text-lg rounded-2xl" onClick={async () => {
                                // å…ˆç”Ÿæˆè¨‚å–®ç·¨è™Ÿ
                                showToast('æ­£åœ¨ç”Ÿæˆè¨‚å–®ç·¨è™Ÿ...', 'info');
                                const result = await onSaveRecord();
                                const newOrderNumber = typeof result === 'string' ? result : null;
                                
                                if (result) {
                                    // é—œé–‰ç•¶å‰å½ˆçª—
                                    onClose();
                                    
                                    // é¡¯ç¤ºæé†’
                                    setTimeout(() => {
                                        showConfirm(
                                            'âš ï¸ å‰å¾€ä»˜æ¬¾å‰è«‹å…ˆé–±è®€',
                                            <div className="text-left space-y-4">
                                                {newOrderNumber && (
                                                    <div className="bg-purple-50 border-2 border-purple-500 p-4 rounded-lg">
                                                        <p className="text-sm text-stone-600 font-bold mb-2">æ‚¨çš„è¨‚å–®ç·¨è™Ÿ</p>
                                                        <div className="flex items-center gap-3 justify-center">
                                                            <code className="text-xl font-black text-purple-600 bg-white px-4 py-2 rounded-lg border-2 border-purple-300">
                                                                {newOrderNumber}
                                                            </code>
                                                            <button
                                                                onClick={() => {
                                                                    navigator.clipboard.writeText(newOrderNumber);
                                                                    showToast('è¨‚å–®ç·¨è™Ÿå·²è¤‡è£½', 'success');
                                                                }}
                                                                className="p-2 hover:bg-purple-100 rounded-lg transition-colors"
                                                                title="è¤‡è£½è¨‚å–®ç·¨è™Ÿ"
                                                            >
                                                                <Copy size={20} className="text-purple-600" />
                                                            </button>
                                                        </div>
                                                        <p className="text-xs text-stone-500 text-center mt-2">è«‹å…ˆæˆªåœ–ä¿å­˜è¨‚å–®ç·¨è™Ÿ</p>
                                                    </div>
                                                )}
                                                <p className="text-base text-stone-800 font-bold">é»æ“Šç¢ºèªå¾Œå°‡é–‹å•Ÿå¤–éƒ¨æ”¯ä»˜é é¢</p>
                                                <div className="bg-yellow-50 border-2 border-yellow-500 p-4 rounded-lg">
                                                    <p className="text-xl text-red-600 font-black mb-3">âš ï¸ å¿…é ˆæˆªåœ–å…©å€‹ç•«é¢ï¼</p>
                                                    <ol className="text-base text-stone-800 font-bold space-y-2 ml-4 list-decimal">
                                                        <li>ğŸ“¸ æœ¬å°è©±æ¡†ï¼ˆå«è¨‚å–®ç·¨è™Ÿï¼‰</li>
                                                        <li>ğŸ“¸ æ”¯ä»˜æˆåŠŸç•«é¢</li>
                                                    </ol>
                                                    <p className="text-sm text-stone-600 mt-3">ä½œç‚ºæ”¯ä»˜æ†‘è­‰ï¼Œé¿å…ç³¾ç´›</p>
                                                </div>
                                                <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded space-y-3">
                                                    <p className="text-base text-stone-800 font-black">ğŸ’¬ å®Œæˆæ”¯ä»˜å¾Œï¼Œè«‹ç«‹å³å°‡æˆªåœ–å‚³é€çµ¦ LINE å®¢æœ</p>
                                                    <a href="https://lin.ee/3vSihiH" target="_blank" rel="noopener noreferrer" 
                                                       className="inline-flex items-center gap-2 px-4 py-3 bg-line-500 text-white rounded-lg text-base font-bold hover:bg-line-600 transition-colors shadow-lg w-full justify-center">
                                                        <MessageSquare size={20} />
                                                        ç«‹å³è¯ç¹« LINE å®¢æœ
                                                        <ExternalLink size={16} />
                                                    </a>
                                                    <p className="text-sm text-stone-600 font-bold text-center">â° äººå·¥å®¢æœæ™‚é–“ï¼š10:00 - 22:00</p>
                                                </div>
                                                <div className="bg-red-50 border border-red-300 rounded-lg p-3">
                                                    <p className="text-sm text-red-700 font-bold">ğŸ’¡ å‚³é€æˆªåœ–å¾Œï¼Œå®¢æœæœƒç‚ºæ‚¨æ ¸å°è¨‚å–®ç·¨è™Ÿä¸¦ç™¼æ”¾é‡‘å¹£</p>
                                                </div>
                                            </div>,
                                            () => {
                                                window.open(plan.url, '_blank');
                                                // è·³è½‰åˆ°æœƒå“¡å¾Œå°
                                                setTimeout(() => {
                                                    window.location.href = '/member';
                                                    showToast('è¨‚å–®å·²å»ºç«‹ï¼Œè«‹å®Œæˆæ”¯ä»˜å¾Œè¯ç¹«å®¢æœ', 'success');
                                                }, 500);
                                            },
                                            'æˆ‘å·²æˆªåœ–ï¼Œå‰å¾€æ”¯ä»˜'
                                        );
                                    }, 500);
                                }
                            }}>
                                å‰å¾€æ”¯ä»˜é é¢ <ExternalLink size={20} className="ml-2"/>
                            </Button>
                        </div>
                    </ModalWrapper>
                );
            }
            
            return null;
        };

        const LoadingScreen = () => (
            <motion.div 
                initial={{ opacity: 1 }} exit={{ opacity: 0 }} transition={{ duration: 0.6 }}
                className="fixed inset-0 z-[100] bg-[#fbf6e9] flex flex-col items-center justify-center text-stone-800"
            >
                <div className="w-20 h-20 mb-8 relative">
                    <motion.div 
                        animate={{ rotate: 360 }} 
                        transition={{ repeat: Infinity, duration: 1.2, ease: "linear" }} 
                        className="w-full h-full border-4 border-sand-200 border-t-gold-500 rounded-full"
                    />
                </div>
                <h2 className="text-xl md:text-2xl font-display font-bold tracking-widest text-stone-600">æ­£åœ¨å‰å¾€å°¼æ–¯å¤§é™¸...</h2>
                <p className="text-stone-400 text-sm mt-2 font-medium">è«‹ç¨å€™</p>
            </motion.div>
        );

        // é€šç”¨ Loading çµ„ä»¶
        const LoadingSpinner = ({ message = 'è¼‰å…¥ä¸­...', size = 'md' }) => {
            const sizeClasses = {
                sm: 'w-8 h-8',
                md: 'w-12 h-12',
                lg: 'w-16 h-16'
            };
            return (
                <div className="flex flex-col items-center justify-center py-16">
                    <motion.div 
                        animate={{ rotate: 360 }} 
                        transition={{ repeat: Infinity, duration: 1, ease: "linear" }} 
                        className={`${sizeClasses[size]} border-3 border-stone-200 border-t-gold-500 rounded-full mb-4`}
                    />
                    <p className="text-stone-500 font-medium">{message}</p>
                </div>
            );
        };

        // åœ–è¡¨åˆå§‹åŒ–çµ„ä»¶
        const StatsCharts = ({ data, methodStats, stats }) => {
            useEffect(() => {
                if (!window.Chart) return;
                
                // éŠ·æ¯€èˆŠåœ–è¡¨
                const destroyChart = (id) => {
                    const canvas = document.getElementById(id);
                    if (canvas) {
                        const chart = window.Chart.getChart(canvas);
                        if (chart) chart.destroy();
                    }
                };
                
                destroyChart('revenueChart');
                destroyChart('paymentMethodChart');
                destroyChart('orderStatusChart');
                
                // 1. ç‡Ÿæ”¶è¶¨å‹¢åœ–ï¼ˆéå» 30 å¤©ï¼‰
                const revenueCanvas = document.getElementById('revenueChart');
                if (revenueCanvas && data.length > 0) {
                    const ctx = revenueCanvas.getContext('2d');
                    
                    // æº–å‚™ 30 å¤©æ•¸æ“š
                    const days = [];
                    const revenues = [];
                    const now = Date.now();
                    
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date(now - i * 24 * 60 * 60 * 1000);
                        const dayStart = new Date(date).setHours(0, 0, 0, 0);
                        const dayEnd = new Date(date).setHours(23, 59, 59, 999);
                        
                        const dayRevenue = data
                            .filter(item => item.timestamp >= dayStart && item.timestamp <= dayEnd)
                            .reduce((sum, item) => sum + (item.amount || 0), 0);
                        
                        days.push(`${date.getMonth() + 1}/${date.getDate()}`);
                        revenues.push(dayRevenue);
                    }
                    
                    new window.Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: days,
                            datasets: [{
                                label: 'æ¯æ—¥ç‡Ÿæ”¶',
                                data: revenues,
                                borderColor: '#d97706',
                                backgroundColor: 'rgba(217, 119, 6, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#d97706',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    titleColor: '#fff',
                                    bodyColor: '#fbbf24',
                                    callbacks: {
                                        label: (context) => `NT$ ${context.parsed.y.toLocaleString()}`
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: {
                                        color: '#9ca3af',
                                        callback: (value) => `$${value}`
                                    }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { color: '#9ca3af', maxRotation: 45, minRotation: 45 }
                                }
                            }
                        }
                    });
                }
                
                // 2. æ”¯ä»˜æ–¹å¼åœ“é¤…åœ–
                const paymentCanvas = document.getElementById('paymentMethodChart');
                if (paymentCanvas && Object.keys(methodStats).length > 0) {
                    const ctx = paymentCanvas.getContext('2d');
                    
                    const methods = Object.keys(methodStats);
                    const amounts = Object.values(methodStats);
                    const colors = ['#d97706', '#06b6d4', '#f43f5e', '#8b5cf6', '#10b981'];
                    
                    new window.Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: methods,
                            datasets: [{
                                data: amounts,
                                backgroundColor: colors.slice(0, methods.length),
                                borderColor: '#1c1917',
                                borderWidth: 3,
                                hoverOffset: 10
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#fff',
                                        padding: 15,
                                        font: { size: 12, weight: 'bold' }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    callbacks: {
                                        label: (context) => {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return `${label}: NT$ ${value.toLocaleString()} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // 3. è¨‚å–®ç‹€æ…‹åœ“ç’°åœ–
                const statusCanvas = document.getElementById('orderStatusChart');
                if (statusCanvas && stats.count > 0) {
                    const ctx = statusCanvas.getContext('2d');
                    
                    new window.Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['å¾…è™•ç†', 'å·²å®Œæˆ', 'å·²å–æ¶ˆ'],
                            datasets: [{
                                data: [stats.pending, stats.completed, stats.cancelled],
                                backgroundColor: ['#d97706', '#06b6d4', '#f43f5e'],
                                borderColor: '#1c1917',
                                borderWidth: 3,
                                hoverOffset: 10
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '60%',
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#fff',
                                        padding: 15,
                                        font: { size: 12, weight: 'bold' }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    callbacks: {
                                        label: (context) => {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return `${label}: ${value} ç­† (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                return () => {
                    destroyChart('revenueChart');
                    destroyChart('paymentMethodChart');
                    destroyChart('orderStatusChart');
                };
            }, [data, methodStats, stats]);
            
            return null;
        };

        const ScrollToTop = () => {
            const { pathname } = useLocation();
            useLayoutEffect(() => { window.scrollTo(0, 0); }, [pathname]);
            return null;
        };

        const PAGE_TITLES = {
            '/': 'è˜‡æ‰“çŸ³å™¨ | æœ€äººæƒ…å‘³çš„çŸ³å™¨æ™‚ä»£ç§æœ 2.5',
            '/events': 'æœ€æ–°æ´»å‹• | è˜‡æ‰“çŸ³å™¨',
            '/guides': 'æ”»ç•¥å°ˆå€ | è˜‡æ‰“çŸ³å™¨',
            '/recharge': 'é‡‘å¹£è´ŠåŠ© | è˜‡æ‰“çŸ³å™¨',
            '/support': 'å®˜æ–¹å®¢æœ | è˜‡æ‰“çŸ³å™¨',
            '/download': 'ä¸‹è¼‰å°ˆå€ | è˜‡æ‰“çŸ³å™¨',
            '/terms': 'æœå‹™æ¢æ¬¾ | è˜‡æ‰“çŸ³å™¨',
            '/auth': 'ç™»å…¥ / è¨»å†Š | è˜‡æ‰“çŸ³å™¨',
            '/member': 'æœƒå“¡ä¸­å¿ƒ | è˜‡æ‰“çŸ³å™¨',
            '/admin': 'å¾Œå°ç®¡ç† | è˜‡æ‰“çŸ³å™¨',
        };
        const PageTitle = () => {
            const { pathname } = useLocation();
            useEffect(() => {
                const base = pathname.startsWith('/guides/') ? 'æ”»ç•¥è©³æƒ… | è˜‡æ‰“çŸ³å™¨' : PAGE_TITLES[pathname];
                document.title = base || 'è˜‡æ‰“çŸ³å™¨ | æœ€äººæƒ…å‘³çš„çŸ³å™¨æ™‚ä»£ç§æœ 2.5';
            }, [pathname]);
            return null;
        };

        // å…¨ç«™å³æ™‚åŒæ­¥ï¼šdonationsã€eventsã€playlistã€guides ä»»ä¸€è®Šæ›´å³å»£æ’­ï¼Œæ‰€æœ‰é é¢è‡ªå‹•æ›´æ–°
        // å»¶é² 2 ç§’è¨‚é–±ï¼Œè®“é¦–å±è³‡æ–™å…ˆè¼‰å…¥å®Œæˆï¼Œæ¸›å°‘é¦–æ¬¡è¼‰å…¥è² æ“”
        const GlobalRealtimeSync = () => {
            useEffect(() => {
                let channels = [];
                const t = setTimeout(() => {
                    try {
                        ['donations', 'events', 'playlist', 'guides'].forEach(table => {
                            const ch = supabase.channel(`sync-${table}`)
                                .on('postgres_changes', { event: '*', schema: 'public', table }, () => {
                                    window.dispatchEvent(new Event('storage-update'));
                                });
                            ch.subscribe();
                            channels.push(ch);
                        });
                    } catch (err) {
                        console.warn('[å…¨ç«™åŒæ­¥] Realtime è¨‚é–±ç•¥é:', err);
                    }
                }, 2000);
                return () => {
                    clearTimeout(t);
                    channels.forEach(ch => supabase.removeChannel(ch));
                };
            }, []);
            return null;
        };

        // Toast é€šçŸ¥ï¼ˆå–ä»£ alertï¼‰
        const showToast = (message, type = 'info') => {
            window.dispatchEvent(new CustomEvent('show-toast', { detail: { message, type } }));
        };

        const ToastContainer = () => {
            const [toasts, setToasts] = useState([]);
            
            useEffect(() => {
                const handler = (e) => {
                    const newToast = { ...e.detail, id: Date.now() };
                    setToasts(prev => [...prev, newToast]);
                };
                window.addEventListener('show-toast', handler);
                return () => window.removeEventListener('show-toast', handler);
            }, []);
            
            useEffect(() => {
                if (toasts.length === 0) return;
                const timer = setTimeout(() => {
                    setToasts(prev => prev.slice(1));
                }, 3500);
                return () => clearTimeout(timer);
            }, [toasts]);

            const getToastStyle = (type) => {
                switch(type) {
                    case 'success': return { bg: 'bg-gradient-to-r from-wind-500 to-wind-600', icon: CheckCircle, color: 'text-white', ring: 'ring-wind-200' };
                    case 'error': return { bg: 'bg-gradient-to-r from-fire-500 to-fire-600', icon: AlertCircle, color: 'text-white', ring: 'ring-fire-200' };
                    case 'warning': return { bg: 'bg-gradient-to-r from-gold-500 to-gold-600', icon: AlertCircle, color: 'text-white', ring: 'ring-gold-200' };
                    default: return { bg: 'bg-gradient-to-r from-stone-700 to-stone-800', icon: Bell, color: 'text-white', ring: 'ring-stone-400' };
                }
            };

            return (
                <div className="fixed top-6 left-1/2 -translate-x-1/2 z-[999] flex flex-col gap-3 pointer-events-none w-full max-w-md px-4">
                    <AnimatePresence>
                        {toasts.map((toast) => {
                            const { bg, icon: Icon, color, ring } = getToastStyle(toast.type);
                            return (
                                <motion.div
                                    key={toast.id}
                                    initial={{ opacity: 0, y: -50, scale: 0.9 }} 
                                    animate={{ opacity: 1, y: 0, scale: 1 }} 
                                    exit={{ opacity: 0, x: 100, scale: 0.8 }}
                                    transition={{ type: 'spring', stiffness: 300, damping: 25 }}
                                    className={`${bg} ${color} px-5 py-3.5 rounded-2xl shadow-2xl font-bold text-sm md:text-base flex items-center gap-3 backdrop-blur-sm ring-2 ${ring}`}
                                >
                                    <Icon size={22} className="shrink-0" strokeWidth={2.5} />
                                    <span className="flex-1">{toast.message}</span>
                                </motion.div>
                            );
                        })}
                    </AnimatePresence>
                </div>
            );
        };

        // æŒ‰éˆ•æ¨£å¼èª¿æ•´ï¼šæ›´åœ“æ½¤ã€é™°å½±æ›´æŸ”å’Œ
        const BUTTON_VARIANTS = {
            primary: "bg-fire-500 text-white shadow-lg shadow-fire-200 hover:bg-fire-600 border-2 border-transparent",
            secondary: "bg-stone-100 text-stone-600 hover:bg-stone-200 border-2 border-stone-200",
            gold: "bg-gradient-to-br from-gold-400 to-gold-500 text-white shadow-lg shadow-gold-200 hover:to-gold-600 border-2 border-transparent",
            discord: "bg-[#5865F2] text-white shadow-lg shadow-indigo-200 hover:bg-[#4752C4] border-2 border-transparent",
            line: "bg-[#06C755] text-white shadow-lg shadow-green-200 hover:bg-[#05B34C] border-2 border-transparent"
        };

        const Button = ({ children, className = "", onClick, variant = "primary", disabled = false, icon: Icon, ...props }) => {
            return (
                <button 
                    disabled={disabled} 
                    onClick={onClick} 
                    className={`relative overflow-hidden px-8 py-3.5 rounded-2xl font-bold tracking-wide transition-all duration-200 transform active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:active:scale-100 group flex items-center justify-center gap-2.5 text-base md:text-lg min-h-[48px] ${BUTTON_VARIANTS[variant]} ${className}`}
                    {...props}
                >
                    <div className="relative flex items-center gap-2">
                        {Icon && <Icon size={22} strokeWidth={2.5} className="group-hover:scale-110 transition-transform duration-200 shrink-0" />}
                        {children}
                    </div>
                </button>
            );
        };

        const PageHeader = memo(({ title, subtitle, icon: Icon, color = "text-fire-500" }) => (
            <div className="text-center mb-12 md:mb-16 relative z-10">
                <div className="flex justify-center mb-5">
                    <div className="p-4 md:p-5 bg-white rounded-2xl border-2 border-stone-100 shadow-lg shadow-stone-200/40 animate-float">
                        {Icon && <Icon size={44} className={color} strokeWidth={1.5} />}
                    </div>
                </div>
                <h1 className="text-3xl md:text-5xl lg:text-6xl font-black text-stone-800 mb-3 tracking-tight drop-shadow-sm font-display px-2">{title}</h1>
                <div className="w-14 md:w-16 h-1 bg-stone-200 mx-auto mb-5 rounded-full"></div>
                <p className="text-stone-500 text-base md:text-lg max-w-2xl mx-auto font-medium px-4 leading-relaxed">{subtitle}</p>
            </div>
        ));

        // --- Mobile Nav ---
        const MobileBottomNav = () => {
            const location = useLocation();
            const [user, setUser] = useState(null);
            
            useEffect(() => {
                authHelpers.getCurrentUser().then(setUser);
                const { data } = authHelpers.onAuthStateChange((event, session) => {
                    setUser(session?.user ?? null);
                });
                return () => {
                    if (data?.subscription) {
                        data.subscription.unsubscribe();
                    }
                };
            }, []);
            
            const navItems = useMemo(() => {
                const base = [
                    { path: '/', label: 'é¦–é ', icon: Home },
                    { path: '/guides', label: 'æ”»ç•¥', icon: BookOpen },
                    { path: '/events', label: 'æ´»å‹•', icon: Calendar },
                    { path: '/recharge', label: 'é‡‘å¹£', icon: Coins },
                ];
                const role = user?.user_metadata?.role;
                if (role === 'admin' || role === 'super_admin') {
                    base.push({ path: '/admin', label: 'å¾Œå°', icon: Settings });
                }
                base.push({ path: user ? '/member' : '/auth', label: user ? 'æœƒå“¡' : 'ç™»å…¥', icon: User });
                return base;
            }, [user]);

            return (
                <div className="fixed bottom-0 left-0 w-full bg-white/98 backdrop-blur-xl border-t border-stone-200/80 z-50 pb-safe md:hidden shadow-[0_-8px_30px_rgba(139,90,43,0.08)]">
                    <div className="flex justify-around items-center h-[72px] px-2">
                        {navItems.map((item) => {
                            const isActive = location.pathname === item.path;
                            return (
                                <Link 
                                    key={item.path} 
                                    to={item.path} 
                                    className={`flex flex-col items-center justify-center flex-1 min-w-0 py-2 px-1 rounded-2xl transition-all duration-200 active:scale-95 ${isActive ? 'text-wood-600' : 'text-stone-400'}`}
                                    aria-current={isActive ? 'page' : undefined}
                                >
                                    <div className={`p-2.5 rounded-2xl transition-all duration-200 ${isActive ? 'bg-sand-100 scale-110' : 'active:bg-stone-50'}`}>
                                        <item.icon size={24} strokeWidth={isActive ? 2.5 : 2} />
                                    </div>
                                    <span className={`text-[11px] font-bold tracking-wide mt-0.5 truncate max-w-full ${isActive ? 'opacity-100' : 'opacity-70'}`}>{item.label}</span>
                                </Link>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- Pages ---
        
        // ç™»å…¥/è¨»å†Šé é¢
        const AuthPage = () => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [gameAccount, setGameAccount] = useState(''); // éŠæˆ²å¸³è™Ÿ
            const [agreeTerms, setAgreeTerms] = useState(false); // åŒæ„æœå‹™æ¢æ¬¾
            const [rememberMe, setRememberMe] = useState(false); // è¨˜ä½å¸³è™Ÿå¯†ç¢¼
            const [showTermsModal, setShowTermsModal] = useState(false); // é¡¯ç¤ºæœå‹™æ¢æ¬¾å½ˆçª—
            const [showForgotPasswordModal, setShowForgotPasswordModal] = useState(false); // é¡¯ç¤ºå¿˜è¨˜å¯†ç¢¼å½ˆçª—
            const [resetEmail, setResetEmail] = useState(''); // é‡è¨­å¯†ç¢¼ç”¨çš„ Email
            const [resetLoading, setResetLoading] = useState(false);
            const [resetMessage, setResetMessage] = useState('');
            const [isRecoveryMode, setIsRecoveryMode] = useState(false); // å¯†ç¢¼é‡è¨­æ¨¡å¼
            const [newPassword, setNewPassword] = useState(''); // æ–°å¯†ç¢¼
            const [newPasswordConfirm, setNewPasswordConfirm] = useState(''); // ç¢ºèªæ–°å¯†ç¢¼
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            
            // è¼‰å…¥è¨˜ä½çš„å¸³è™Ÿå¯†ç¢¼
            useEffect(() => {
                const savedEmail = localStorage.getItem('rememberedEmail');
                const savedPassword = localStorage.getItem('rememberedPassword');
                if (savedEmail) {
                    setEmail(savedEmail);
                    setRememberMe(true);
                }
                if (savedPassword) {
                    setPassword(atob(savedPassword)); // ç°¡å–®è§£ç¢¼ï¼ˆéå®‰å…¨åŠ å¯†ï¼‰
                }
            }, []);
            
            // æª¢æ¸¬æ˜¯å¦ç‚ºå¯†ç¢¼é‡è¨­æ¨¡å¼
            useEffect(() => {
                const hash = window.location.hash;
                // æª¢æŸ¥ URL æ˜¯å¦åŒ…å« access_tokenï¼ˆå¯†ç¢¼é‡è¨­é€£çµçš„æ¨™èªŒï¼‰
                if (hash.includes('access_token') && hash.includes('type=recovery')) {
                    setIsRecoveryMode(true);
                }
            }, []);
            
            // è™•ç†å¯†ç¢¼æ›´æ–°
            const handleUpdatePassword = async (e) => {
                e.preventDefault();
                setError('');
                
                if (!newPassword || !newPasswordConfirm) {
                    setError('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
                    return;
                }
                
                if (newPassword.length < 6) {
                    setError('å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ');
                    return;
                }
                
                if (newPassword !== newPasswordConfirm) {
                    setError('å¯†ç¢¼ä¸ä¸€è‡´');
                    return;
                }
                
                setLoading(true);
                
                try {
                    const { error } = await supabase.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (error) {
                        setError(error.message);
                    } else {
                        showToast('å¯†ç¢¼æ›´æ–°æˆåŠŸï¼è«‹ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥', 'success');
                        setTimeout(() => {
                            setIsRecoveryMode(false);
                            setNewPassword('');
                            setNewPasswordConfirm('');
                            window.location.href = '/auth';
                        }, 2000);
                    }
                } catch (err) {
                    setError('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
                } finally {
                    setLoading(false);
                }
            };
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                
                if (!email || !password) {
                    setError('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
                    return;
                }
                
                if (!isLogin) {
                    if (!gameAccount.trim()) {
                        setError('è«‹å¡«å¯«éŠæˆ²å¸³è™Ÿ');
                        return;
                    }
                    if (password !== confirmPassword) {
                        setError('å¯†ç¢¼ä¸ä¸€è‡´');
                        return;
                    }
                    if (!agreeTerms) {
                        setError('è«‹é–±è®€ä¸¦åŒæ„æœå‹™æ¢æ¬¾');
                        return;
                    }
                }
                
                if (password.length < 6) {
                    setError('å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ');
                    return;
                }
                
                setLoading(true);
                
                try {
                    if (isLogin) {
                        const { error } = await authHelpers.signIn(email, password);
                        if (error) {
                            const msg = error.message || '';
                            let errText = msg === 'Invalid login credentials' ? 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤' : msg;
                            if (msg.includes('Email not confirmed')) errText = 'è«‹å…ˆåˆ°ä¿¡ç®±é»æ“Šé©—è­‰é€£çµ';
                            else if (msg.includes('fetch') || msg.includes('network') || msg.includes('Failed to fetch')) errText = 'ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦';
                            setError(errText);
                        } else {
                            // è™•ç†è¨˜ä½å¸³è™Ÿå¯†ç¢¼
                            if (rememberMe) {
                                localStorage.setItem('rememberedEmail', email);
                                localStorage.setItem('rememberedPassword', btoa(password)); // ç°¡å–®ç·¨ç¢¼ï¼ˆéå®‰å…¨åŠ å¯†ï¼‰
                            } else {
                                localStorage.removeItem('rememberedEmail');
                                localStorage.removeItem('rememberedPassword');
                            }
                            showToast('ç™»å…¥æˆåŠŸï¼', 'success');
                            window.location.href = '/member';
                        }
                    } else {
                        const { error } = await authHelpers.signUp(email, password, gameAccount);
                        if (error) {
                            setError(error.message);
                        } else {
                            showToast('è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥ä¿¡ç®±é©—è­‰', 'success');
                            setIsLogin(true);
                        }
                    }
                } catch (err) {
                    setError('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
                } finally {
                    setLoading(false);
                }
            };
            
            const handleForgotPassword = async () => {
                if (!resetEmail) {
                    setResetMessage('è«‹è¼¸å…¥ Email');
                    return;
                }
                
                setResetLoading(true);
                setResetMessage('');
                
                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(resetEmail, {
                        redirectTo: window.location.origin + '/auth'
                    });
                    
                    if (error) {
                        setResetMessage('ç™¼é€å¤±æ•—ï¼š' + error.message);
                    } else {
                        setResetMessage('å·²ç™¼é€å¯†ç¢¼é‡è¨­ä¿¡ä»¶åˆ°æ‚¨çš„ä¿¡ç®±ï¼Œè«‹æŸ¥æ”¶ï¼');
                        setTimeout(() => {
                            setShowForgotPasswordModal(false);
                            setResetEmail('');
                            setResetMessage('');
                        }, 3000);
                    }
                } catch (err) {
                    setResetMessage('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
                } finally {
                    setResetLoading(false);
                }
            };
            
            return (
                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className="pt-32 md:pt-44 pb-28 md:pb-24 px-4 md:px-6 min-h-screen">
                    {/* æœå‹™æ¢æ¬¾å½ˆçª— */}
                    {showTermsModal && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-stone-900/80 backdrop-blur-sm" onClick={() => setShowTermsModal(false)}>
                            <motion.div 
                                initial={{ scale: 0.95, opacity: 0 }} 
                                animate={{ scale: 1, opacity: 1 }} 
                                className="bg-white rounded-3xl p-6 md:p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-2xl"
                                onClick={(e) => e.stopPropagation()}
                            >
                                <div className="flex items-center justify-between mb-6 sticky top-0 bg-white pb-4 border-b border-stone-200 z-10">
                                    <h2 className="text-2xl md:text-3xl font-black text-stone-800 flex items-center gap-3">
                                        <ScrollText size={32} className="text-gold-500" />
                                        æœå‹™æ¢æ¬¾èˆ‡å…è²¬è²æ˜
                                    </h2>
                                    <button 
                                        onClick={() => setShowTermsModal(false)}
                                        className="p-2 hover:bg-stone-100 rounded-xl transition-colors"
                                    >
                                        <X size={24} className="text-stone-600" />
                                    </button>
                                </div>

                                <div className="space-y-6 text-stone-700 text-sm leading-relaxed">
                                    <div className="bg-red-50 border-2 border-red-300 rounded-xl p-4">
                                        <h3 className="font-black text-red-700 mb-2">âš ï¸ é‡è¦æé†’</h3>
                                        <ul className="space-y-1 ml-4 text-xs">
                                            <li className="text-red-600 font-bold">â€¢ æœ¬ä¼ºæœå™¨ç‚ºéç‡Ÿåˆ©æ€§è³ªï¼Œæ¥å—ç©å®¶è‡ªé¡˜è´ŠåŠ©ä»¥ç¶­æŒé‹ä½œ</li>
                                            <li className="text-red-600 font-bold">â€¢ è´ŠåŠ©ç‚ºè‡ªé¡˜è¡Œç‚ºï¼Œä¸€ç¶“è´ŠåŠ©æ•ä¸é€€æ¬¾æˆ–æ›è²¨</li>
                                            <li>â€¢ è™›å¯¶ç”±ç®¡ç†å“¡äººå·¥å¯©æ ¸å¾Œç™¼æ”¾ï¼Œéå³æ™‚åˆ°å¸³</li>
                                        </ul>
                                    </div>

                                    <div>
                                        <h3 className="font-black text-stone-800 mb-2">å¸³è™Ÿä½¿ç”¨è¦ç¯„</h3>
                                        <ul className="space-y-1 ml-4 text-xs">
                                            <li>â€¢ æ‚¨å¿…é ˆæä¾›çœŸå¯¦ä¸”æ­£ç¢ºçš„è¨»å†Šè³‡è¨Š</li>
                                            <li>â€¢ å¸³è™Ÿå¯†ç¢¼è«‹å¦¥å–„ä¿ç®¡ï¼Œä¸å¾—è½‰è®“æˆ–å‡ºå€Ÿä»–äºº</li>
                                            <li>â€¢ ä¸€å€‹ Email æœ€å¤šå¯è¨»å†Š 5 å€‹éŠæˆ²å¸³è™Ÿ</li>
                                        </ul>
                                    </div>

                                    <div>
                                        <h3 className="font-black text-stone-800 mb-2 text-red-600">ç¦æ­¢äº‹é …</h3>
                                        <ul className="space-y-1 ml-4 text-xs">
                                            <li className="font-bold text-red-600">â€¢ ç¦æ­¢ä½¿ç”¨ä»»ä½•å¤–æ›ã€è…³æœ¬ã€ä¿®æ”¹å™¨</li>
                                            <li className="font-bold text-red-600">â€¢ ç¦æ­¢åˆ©ç”¨éŠæˆ²æ¼æ´é€²è¡Œä¸ç•¶ç²åˆ©</li>
                                            <li className="font-bold text-red-600">â€¢ ç¦æ­¢é€²è¡ŒéŠæˆ²å¹£ã€è™›å¯¶çš„çœŸå¯¦é‡‘éŒ¢äº¤æ˜“</li>
                                        </ul>
                                    </div>

                                    <div>
                                        <h3 className="font-black text-stone-800 mb-2">å…è²¬è²æ˜</h3>
                                        <p className="text-xs">
                                            æœ¬æœå‹™å¯èƒ½å› ç¶­è­·ã€æ›´æ–°ã€ä¸å¯æŠ—åŠ›ç­‰å› ç´ è€Œä¸­æ–·ã€‚å°æ–¼æœå‹™ä¸­æ–·æ‰€é€ æˆçš„ä»»ä½•æå¤±ï¼Œæœ¬æœå‹™ä¸è² è³ å„Ÿè²¬ä»»ã€‚
                                            è‹¥æ±ºå®šçµ‚æ­¢ç‡Ÿé‹ï¼Œå°‡æå‰ 30 å¤©å…¬å‘Šï¼Œæ‰€æœ‰è™›æ“¬ç‰©å“åŠéŠæˆ²ç´€éŒ„å°‡æ°¸ä¹…å¤±æ•ˆï¼Œä¸äºˆé€€æ¬¾ã€‚
                                        </p>
                                    </div>

                                    <div className="bg-gold-50 border-2 border-gold-300 rounded-xl p-4">
                                        <p className="text-xs font-bold text-gold-800">
                                            æœªæ»¿ 18 æ­²çš„ç©å®¶é€²è¡Œå„²å€¼å‰ï¼Œå¿…é ˆå–å¾—æ³•å®šä»£ç†äººï¼ˆå®¶é•·ï¼‰åŒæ„ã€‚
                                        </p>
                                    </div>
                                </div>

                                <div className="flex gap-3 mt-8 pt-6 border-t border-stone-200">
                                    <Link 
                                        to="/terms"
                                        target="_blank"
                                        onClick={() => setShowTermsModal(false)}
                                        className="flex-1 px-4 py-3 bg-stone-100 hover:bg-stone-200 text-stone-700 font-bold rounded-xl transition-colors text-center text-sm"
                                    >
                                        æŸ¥çœ‹å®Œæ•´ç‰ˆ
                                    </Link>
                                    <button 
                                        onClick={() => {
                                            setAgreeTerms(true);
                                            setShowTermsModal(false);
                                        }}
                                        className="flex-1 px-4 py-3 bg-gold-500 hover:bg-gold-600 text-white font-bold rounded-xl transition-colors text-sm flex items-center justify-center gap-2"
                                    >
                                        <CheckCircle size={18} />
                                        æˆ‘å·²é–±è®€ä¸¦åŒæ„
                                    </button>
                                </div>
                            </motion.div>
                        </div>
                    )}

                    {/* å¿˜è¨˜å¯†ç¢¼å½ˆçª— */}
                    {showForgotPasswordModal && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-stone-900/80 backdrop-blur-sm" onClick={() => setShowForgotPasswordModal(false)}>
                            <motion.div 
                                initial={{ scale: 0.95, opacity: 0 }} 
                                animate={{ scale: 1, opacity: 1 }} 
                                className="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl"
                                onClick={(e) => e.stopPropagation()}
                            >
                                <div className="flex items-center justify-between mb-6">
                                    <h2 className="text-2xl font-black text-stone-800 flex items-center gap-3">
                                        <Key size={28} className="text-gold-500" />
                                        å¿˜è¨˜å¯†ç¢¼
                                    </h2>
                                    <button 
                                        onClick={() => setShowForgotPasswordModal(false)}
                                        className="p-2 hover:bg-stone-100 rounded-xl transition-colors"
                                    >
                                        <X size={24} className="text-stone-600" />
                                    </button>
                                </div>

                                <p className="text-stone-600 mb-6 text-sm">
                                    è«‹è¼¸å…¥æ‚¨è¨»å†Šæ™‚ä½¿ç”¨çš„ Emailï¼Œæˆ‘å€‘æœƒç™¼é€å¯†ç¢¼é‡è¨­ä¿¡ä»¶çµ¦æ‚¨ã€‚
                                </p>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-stone-700 font-bold mb-2 text-sm">Email</label>
                                        <input
                                            type="email"
                                            value={resetEmail}
                                            onChange={(e) => setResetEmail(e.target.value)}
                                            placeholder="è«‹è¼¸å…¥æ‚¨çš„ Email"
                                            className="w-full p-4 rounded-xl border-2 border-stone-200 focus:border-gold-400 focus:ring-4 focus:ring-gold-100/50 focus:outline-none bg-stone-50/80 text-stone-700"
                                            disabled={resetLoading}
                                        />
                                    </div>

                                    {resetMessage && (
                                        <div className={`p-4 rounded-xl text-sm font-bold ${
                                            resetMessage.includes('æˆåŠŸ') || resetMessage.includes('å·²ç™¼é€') 
                                                ? 'bg-green-50 text-green-700 border-2 border-green-300' 
                                                : 'bg-red-50 text-red-700 border-2 border-red-300'
                                        }`}>
                                            {resetMessage}
                                        </div>
                                    )}

                                    <div className="flex gap-3 pt-2">
                                        <button
                                            type="button"
                                            onClick={() => setShowForgotPasswordModal(false)}
                                            className="flex-1 px-4 py-3 bg-stone-100 hover:bg-stone-200 text-stone-700 font-bold rounded-xl transition-colors"
                                            disabled={resetLoading}
                                        >
                                            å–æ¶ˆ
                                        </button>
                                        <button
                                            type="button"
                                            onClick={handleForgotPassword}
                                            className="flex-1 px-4 py-3 bg-gold-500 hover:bg-gold-600 text-white font-bold rounded-xl transition-colors flex items-center justify-center gap-2"
                                            disabled={resetLoading}
                                        >
                                            {resetLoading ? <Loader2 size={18} className="animate-spin" /> : <Mail size={18} />}
                                            {resetLoading ? 'ç™¼é€ä¸­...' : 'ç™¼é€é‡è¨­ä¿¡ä»¶'}
                                        </button>
                                    </div>
                                </div>

                                <div className="mt-6 p-4 bg-wind-50 rounded-xl border border-wind-200">
                                    <p className="text-wind-700 text-xs font-bold">
                                        ğŸ’¡ æç¤ºï¼šè«‹æª¢æŸ¥æ‚¨çš„ä¿¡ç®±ï¼ˆåŒ…æ‹¬åƒåœ¾éƒµä»¶ï¼‰ï¼Œé»æ“Šä¿¡ä»¶ä¸­çš„é€£çµå³å¯é‡è¨­å¯†ç¢¼ã€‚
                                    </p>
                                </div>
                            </motion.div>
                        </div>
                    )}

                    <div className="max-w-md mx-auto">
                        <div className="stone-panel p-8 md:p-10">
                            <h1 className="text-3xl md:text-4xl font-black text-stone-800 mb-2 text-center">
                                {isRecoveryMode ? 'è¨­å®šæ–°å¯†ç¢¼' : (isLogin ? 'æœƒå“¡ç™»å…¥' : 'è¨»å†Šå¸³è™Ÿ')}
                            </h1>
                            <p className="text-stone-500 text-center mb-8">
                                {isRecoveryMode ? 'è«‹è¼¸å…¥æ‚¨çš„æ–°å¯†ç¢¼' : (isLogin ? 'æ­¡è¿å›åˆ°è˜‡æ‰“çŸ³å™¨' : 'åŠ å…¥è˜‡æ‰“çŸ³å™¨å¤§å®¶åº­')}
                            </p>
                            
                            {/* å¯†ç¢¼é‡è¨­è¡¨å–® */}
                            {isRecoveryMode ? (
                                <form onSubmit={handleUpdatePassword} className="space-y-4">
                                    {error && (
                                        <div className="bg-fire-50 border-2 border-fire-300 rounded-xl p-4 flex items-center gap-2">
                                            <AlertCircle className="text-fire-500 shrink-0" size={20} />
                                            <span className="text-fire-700 font-bold text-sm">{error}</span>
                                        </div>
                                    )}
                                    
                                    <div>
                                        <label className="block text-stone-700 font-bold mb-2">æ–°å¯†ç¢¼</label>
                                        <input
                                            type="password"
                                            value={newPassword}
                                            onChange={(e) => setNewPassword(e.target.value)}
                                            placeholder="è‡³å°‘ 6 å€‹å­—å…ƒ"
                                            className="w-full text-lg font-bold p-4 rounded-2xl border-2 border-stone-200 focus:border-gold-400 focus:ring-4 focus:ring-gold-100/50 focus:outline-none bg-stone-50/80 text-stone-700 placeholder-stone-400"
                                            disabled={loading}
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-stone-700 font-bold mb-2">ç¢ºèªæ–°å¯†ç¢¼</label>
                                        <input
                                            type="password"
                                            value={newPasswordConfirm}
                                            onChange={(e) => setNewPasswordConfirm(e.target.value)}
                                            placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼"
                                            className="w-full text-lg font-bold p-4 rounded-2xl border-2 border-stone-200 focus:border-gold-400 focus:ring-4 focus:ring-gold-100/50 focus:outline-none bg-stone-50/80 text-stone-700 placeholder-stone-400"
                                            disabled={loading}
                                        />
                                    </div>
                                    
                                    <Button
                                        type="submit"
                                        variant="gold"
                                        className="w-full py-4 text-lg"
                                        disabled={loading}
                                    >
                                        {loading ? <Loader2 size={20} className="animate-spin" /> : <Key size={20} />}
                                        <span>{loading ? 'æ›´æ–°ä¸­...' : 'æ›´æ–°å¯†ç¢¼'}</span>
                                    </Button>
                                    
                                    <div className="text-center mt-6">
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setIsRecoveryMode(false);
                                                window.location.href = '/auth';
                                            }}
                                            className="text-stone-500 hover:text-stone-700 transition-colors text-sm"
                                        >
                                            è¿”å›ç™»å…¥é é¢
                                        </button>
                                    </div>
                                </form>
                            ) : (
                                <>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                {error && (
                                    <div className="bg-fire-50 border-2 border-fire-300 rounded-xl p-4 flex items-center gap-2">
                                        <AlertCircle size={20} className="text-fire-500 shrink-0" />
                                        <p className="text-fire-700 font-bold text-sm">{error}</p>
                                    </div>
                                )}
                                
                                <div>
                                    <label className="block text-stone-700 font-bold mb-2">Email</label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder="your@email.com"
                                        className="w-full text-lg font-bold p-4 rounded-2xl border-2 border-stone-200 focus:border-gold-400 focus:ring-4 focus:ring-gold-100/50 focus:outline-none bg-stone-50/80 text-stone-700 placeholder-stone-400"
                                        disabled={loading}
                                    />
                                </div>
                                
                                {!isLogin && (
                                    <div>
                                        <label className="block text-stone-700 font-bold mb-2 flex items-center gap-2">
                                            <User size={18} className="text-gold-500" />
                                            éŠæˆ²å¸³è™Ÿ
                                            <span className="text-fire-600 text-xs font-medium">ï¼ˆæ³¨æ„ï¼šæ˜¯éŠæˆ²å¸³è™Ÿï¼Œä¸¦éè§’è‰²IDï¼‰</span>
                                        </label>
                                        <input
                                            type="text"
                                            value={gameAccount}
                                            onChange={(e) => setGameAccount(e.target.value)}
                                            placeholder="è«‹è¼¸å…¥æ‚¨çš„éŠæˆ²å¸³è™Ÿï¼ˆç™»å…¥ç”¨çš„å¸³è™Ÿï¼Œèˆ‡è§’è‰²IDä¸åŒï¼‰"
                                            className="w-full text-lg font-bold p-4 rounded-2xl border-2 border-stone-200 focus:border-gold-400 focus:ring-4 focus:ring-gold-100/50 focus:outline-none bg-stone-50/80 text-stone-700 placeholder-stone-400"
                                            disabled={loading}
                                        />
                                        <div className="bg-gold-50 border-2 border-gold-300 rounded-xl p-3 mt-3">
                                            <p className="text-gold-800 font-bold text-sm flex items-start gap-2">
                                                <AlertCircle size={16} className="mt-0.5 shrink-0" />
                                                <span>
                                                    <strong>âš ï¸ é‡è¦æé†’ï¼š</strong>è«‹å¡«å¯«éŠæˆ²å¸³è™Ÿï¼ˆç™»å…¥ç”¨ï¼‰ï¼Œä¸¦éè§’è‰²IDï¼
                                                    <br />
                                                    <span className="text-xs text-gold-700 mt-1 inline-block">è™›å¯¶å°‡ç”±ç®¡ç†å“¡äººå·¥å¯©æ ¸å¾Œç™¼æ”¾è‡³æ­¤å¸³è™Ÿï¼Œå¡«å¯«éŒ¯èª¤å°‡ç„¡æ³•é ˜å–</span>
                                                </span>
                                            </p>
                                        </div>
                                    </div>
                                )}
                                
                                <div>
                                    <div className="flex items-center justify-between mb-2">
                                        <label className="block text-stone-700 font-bold">å¯†ç¢¼</label>
                                        {isLogin && (
                                            <button
                                                type="button"
                                                onClick={() => setShowForgotPasswordModal(true)}
                                                className="text-gold-600 hover:text-gold-700 font-bold text-sm transition-colors"
                                            >
                                                å¿˜è¨˜å¯†ç¢¼ï¼Ÿ
                                            </button>
                                        )}
                                    </div>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        placeholder="è‡³å°‘ 6 å€‹å­—å…ƒ"
                                        className="w-full text-lg font-bold p-4 rounded-2xl border-2 border-stone-200 focus:border-gold-400 focus:ring-4 focus:ring-gold-100/50 focus:outline-none bg-stone-50/80 text-stone-700 placeholder-stone-400"
                                        disabled={loading}
                                    />
                                </div>
                                
                                {/* è¨˜ä½æˆ‘ */}
                                {isLogin && (
                                    <div className="flex items-center gap-2">
                                        <input
                                            type="checkbox"
                                            id="rememberMe"
                                            checked={rememberMe}
                                            onChange={(e) => setRememberMe(e.target.checked)}
                                            className="w-4 h-4 text-gold-600 bg-stone-100 border-stone-300 rounded focus:ring-gold-500 focus:ring-2"
                                        />
                                        <label htmlFor="rememberMe" className="text-stone-600 text-sm cursor-pointer select-none">
                                            è¨˜ä½å¸³è™Ÿå¯†ç¢¼
                                        </label>
                                    </div>
                                )}
                                
                                {!isLogin && (
                                    <div>
                                        <label className="block text-stone-700 font-bold mb-2">ç¢ºèªå¯†ç¢¼</label>
                                        <input
                                            type="password"
                                            value={confirmPassword}
                                            onChange={(e) => setConfirmPassword(e.target.value)}
                                            placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼"
                                            className="w-full text-lg font-bold p-4 rounded-2xl border-2 border-stone-200 focus:border-gold-400 focus:ring-4 focus:ring-gold-100/50 focus:outline-none bg-stone-50/80 text-stone-700 placeholder-stone-400"
                                            disabled={loading}
                                        />
                                    </div>
                                )}
                                
                                {/* åŒæ„æœå‹™æ¢æ¬¾å‹¾é¸ */}
                                {!isLogin && (
                                    <div className="bg-stone-50 rounded-xl p-4 border-2 border-stone-200">
                                        <label className="flex items-start gap-3 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={agreeTerms}
                                                onChange={(e) => setAgreeTerms(e.target.checked)}
                                                className="mt-1 w-5 h-5 text-gold-500 border-2 border-stone-300 rounded focus:ring-2 focus:ring-gold-400 cursor-pointer"
                                                disabled={loading}
                                            />
                                            <span className="text-stone-700 text-sm leading-relaxed">
                                                æˆ‘å·²é–±è®€ä¸¦åŒæ„
                                                <button 
                                                    type="button"
                                                    onClick={() => setShowTermsModal(true)}
                                                    className="text-gold-600 hover:text-gold-700 font-bold mx-1 underline cursor-pointer"
                                                >
                                                    æœå‹™æ¢æ¬¾èˆ‡å…è²¬è²æ˜
                                                </button>
                                                ï¼Œäº†è§£è´ŠåŠ©ç‚ºè‡ªé¡˜è¡Œç‚ºä¸”ä¸å¯é€€æ¬¾ï¼Œè™›æ“¬ç‰©å“å›é¥‹åƒ…ä¾›éŠæˆ²å…§ä½¿ç”¨
                                            </span>
                                        </label>
                                    </div>
                                )}
                                
                                <Button
                                    type="submit"
                                    variant="gold"
                                    className="w-full py-4 text-lg"
                                    disabled={loading}
                                >
                                    {loading ? <Loader2 size={20} className="animate-spin" /> : null}
                                    <span>{loading ? 'è™•ç†ä¸­...' : (isLogin ? 'ç™»å…¥' : 'è¨»å†Š')}</span>
                                </Button>
                                </form>
                            
                                <div className="mt-6 text-center">
                                    <button
                                        onClick={() => {
                                            setIsLogin(!isLogin);
                                            setError('');
                                            setEmail('');
                                            setPassword('');
                                            setConfirmPassword('');
                                            setGameAccount('');
                                        }}
                                        className="text-gold-600 font-bold hover:text-gold-700 transition-colors"
                                    >
                                        {isLogin ? 'é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿç«‹å³è¨»å†Š' : 'å·²æœ‰å¸³è™Ÿï¼Ÿç«‹å³ç™»å…¥'}
                                    </button>
                                </div>
                                </>
                            )}
                        </div>
                    </div>
                </motion.div>
            );
        };
        
        // æœƒå“¡ä¸­å¿ƒé é¢
        const MemberPage = () => {
            const [user, setUser] = useState(null);
            const [sponsorships, setSponsorships] = useState([]);
            const [loading, setLoading] = useState(true); // ç™»å…¥æª¢æŸ¥ä¸­
            const [gameAccounts, setGameAccounts] = useState([]);
            const [showAddAccount, setShowAddAccount] = useState(false);
            const [newAccountName, setNewAccountName] = useState('');
            const [editingAccountId, setEditingAccountId] = useState(null);
            const [editingAccountName, setEditingAccountName] = useState('');
            
            useEffect(() => {
                const loadUserData = async () => {
                    try {
                        const currentUser = await authHelpers.getCurrentUser();
                        if (!currentUser) {
                            window.location.href = '/auth';
                            return;
                        }
                        setUser(currentUser);
                    // è®€å–éŠæˆ²å¸³è™Ÿåˆ—è¡¨ï¼ˆæ”¯æ´èˆŠæ ¼å¼å’Œæ–°æ ¼å¼ï¼‰
                    const accounts = currentUser.user_metadata?.game_accounts || 
                                   (currentUser.user_metadata?.game_account ? [{
                                       id: '1',
                                       name: currentUser.user_metadata.game_account,
                                       is_primary: true,
                                       created_at: Date.now()
                                   }] : []);
                    setGameAccounts(accounts);
                    
                    // è¼‰å…¥ç”¨æˆ¶çš„è´ŠåŠ©ç´€éŒ„ï¼ˆå¾ donations è¡¨ï¼‰- èƒŒæ™¯è¼‰å…¥
                    try {
                        const { data: donations, error } = await supabase
                            .from('donations')
                            .select('*')
                            .eq('user_id', currentUser.id)
                            .order('created_at', { ascending: false });
                        
                        if (error) {
                            console.error('è¼‰å…¥è´ŠåŠ©ç´€éŒ„å¤±æ•—:', error);
                            setSponsorships([]);
                        } else {
                            setSponsorships(donations || []);
                        }
                    } catch (err) {
                        console.error('è¼‰å…¥è´ŠåŠ©ç´€éŒ„ç•°å¸¸:', err);
                        setSponsorships([]);
                    }
                    } finally {
                        setLoading(false);
                    }
                };
                
                loadUserData();
                window.addEventListener('storage-update', loadUserData);
                return () => window.removeEventListener('storage-update', loadUserData);
            }, []);
            
            const handleLogout = async () => {
                if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                    await authHelpers.signOut();
                    showToast('å·²ç™»å‡º', 'info');
                    window.location.href = '/';
                }
            };
            
            const handleAddAccount = async () => {
                if (!newAccountName.trim()) {
                    showToast('è«‹è¼¸å…¥éŠæˆ²å¸³è™Ÿ', 'error');
                    return;
                }
                
                if (gameAccounts.length >= 5) {
                    showToast('æœ€å¤šåªèƒ½æ–°å¢ 5 å€‹éŠæˆ²å¸³è™Ÿ', 'error');
                    return;
                }
                
                try {
                    const newAccount = {
                        id: Date.now().toString(),
                        name: newAccountName.trim(),
                        is_primary: false,
                        created_at: Date.now()
                    };
                    
                    const updatedAccounts = [...gameAccounts, newAccount];
                    
                    const { error } = await supabase.auth.updateUser({
                        data: { game_accounts: updatedAccounts }
                    });
                    
                    if (error) {
                        showToast('æ–°å¢å¤±æ•—ï¼š' + error.message, 'error');
                    } else {
                        setGameAccounts(updatedAccounts);
                        setNewAccountName('');
                        setShowAddAccount(false);
                        showToast('éŠæˆ²å¸³è™Ÿå·²æ–°å¢', 'success');
                        const currentUser = await authHelpers.getCurrentUser();
                        setUser(currentUser);
                    }
                } catch (err) {
                    showToast('æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                }
            };
            
            const handleUpdateAccount = async (accountId) => {
                if (!editingAccountName.trim()) {
                    showToast('éŠæˆ²å¸³è™Ÿä¸èƒ½ç‚ºç©º', 'error');
                    return;
                }
                
                try {
                    const updatedAccounts = gameAccounts.map(acc => 
                        acc.id === accountId ? { ...acc, name: editingAccountName.trim() } : acc
                    );
                    
                    const { error } = await supabase.auth.updateUser({
                        data: { game_accounts: updatedAccounts }
                    });
                    
                    if (error) {
                        showToast('æ›´æ–°å¤±æ•—ï¼š' + error.message, 'error');
                    } else {
                        setGameAccounts(updatedAccounts);
                        setEditingAccountId(null);
                        setEditingAccountName('');
                        showToast('éŠæˆ²å¸³è™Ÿå·²æ›´æ–°', 'success');
                        const currentUser = await authHelpers.getCurrentUser();
                        setUser(currentUser);
                    }
                } catch (err) {
                    showToast('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                }
            };
            
            const handleDeleteAccount = async (accountId) => {
                const account = gameAccounts.find(acc => acc.id === accountId);
                if (account?.is_primary) {
                    showToast('ç„¡æ³•åˆªé™¤ä¸»å¸³è™Ÿ', 'error');
                    return;
                }
                
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤éŠæˆ²å¸³è™Ÿã€Œ${account?.name}ã€å—ï¼Ÿ`)) {
                    return;
                }
                
                try {
                    const updatedAccounts = gameAccounts.filter(acc => acc.id !== accountId);
                    
                    const { error } = await supabase.auth.updateUser({
                        data: { game_accounts: updatedAccounts }
                    });
                    
                    if (error) {
                        showToast('åˆªé™¤å¤±æ•—ï¼š' + error.message, 'error');
                    } else {
                        setGameAccounts(updatedAccounts);
                        showToast('éŠæˆ²å¸³è™Ÿå·²åˆªé™¤', 'success');
                        const currentUser = await authHelpers.getCurrentUser();
                        setUser(currentUser);
                    }
                } catch (err) {
                    showToast('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                }
            };
            
            if (loading) {
                return (
                    <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="pt-32 md:pt-44 pb-28 md:pb-24 px-4 md:px-6 min-h-screen">
                        <LoadingSpinner message="è¼‰å…¥ä¸­..." />
                    </motion.div>
                );
            }
            
            return (
                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className="pt-32 md:pt-44 pb-28 md:pb-24 px-4 md:px-6 min-h-screen">
                    <div className="max-w-4xl mx-auto">
                        <PageHeader title="æœƒå“¡ä¸­å¿ƒ" subtitle="ç®¡ç†æ‚¨çš„å¸³è™Ÿèˆ‡è´ŠåŠ©ç´€éŒ„" icon={User} color="text-wind-500" />
                        
                        {/* ç”¨æˆ¶è³‡è¨Šå¡ */}
                        <div className="stone-panel p-6 md:p-8 mb-6">
                            <div className="flex items-center justify-between mb-6">
                                <h2 className="text-2xl font-black text-stone-800">å€‹äººè³‡æ–™</h2>
                                <div className="flex gap-2">
                                    {/* ç®¡ç†å“¡æ‰é¡¯ç¤ºå¾Œå°æŒ‰éˆ• */}
                                    {(user?.user_metadata?.role === 'admin' || user?.user_metadata?.role === 'super_admin') && (
                                        <Link to="/admin">
                                            <button className="px-4 py-2 bg-gradient-to-r from-gold-500 to-orange-500 hover:from-gold-600 hover:to-orange-600 text-white font-bold rounded-xl transition-colors flex items-center gap-2 shadow-lg">
                                                <Settings size={18} />
                                                <span>å¾Œå°ç®¡ç†</span>
                                            </button>
                                        </Link>
                                    )}
                                    <button
                                        onClick={handleLogout}
                                        className="px-4 py-2 bg-fire-500 hover:bg-fire-600 text-white font-bold rounded-xl transition-colors flex items-center gap-2"
                                    >
                                        <LogOut size={18} />
                                        ç™»å‡º
                                    </button>
                                </div>
                            </div>
                            <div className="space-y-4">
                                <div className="flex items-center gap-3">
                                    <Mail size={20} className="text-stone-400" />
                                    <span className="text-stone-700 font-bold">{user?.email}</span>
                                </div>
                                
                                {/* ç®¡ç†å“¡å¿«é€Ÿå…¥å£ - æ‰‹æ©Ÿç‰ˆæ›´æ˜é¡¯ */}
                                {(user?.user_metadata?.role === 'admin' || user?.user_metadata?.role === 'super_admin') && (
                                    <Link to="/admin" className="block lg:hidden">
                                        <div className="bg-gradient-to-r from-gold-500 to-orange-500 rounded-xl p-4 shadow-lg hover:shadow-xl transition-shadow cursor-pointer">
                                            <div className="flex items-center justify-between text-white">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                                        <Settings size={24} />
                                                    </div>
                                                    <div>
                                                        <p className="font-black text-lg">å¾Œå°ç®¡ç†</p>
                                                        <p className="text-sm opacity-90">
                                                            {user?.user_metadata?.role === 'super_admin' ? 'è¶…ç´šç®¡ç†å“¡' : 'ç®¡ç†å“¡'}
                                                        </p>
                                                    </div>
                                                </div>
                                                <ArrowRight size={24} />
                                            </div>
                                        </div>
                                    </Link>
                                )}
                                
                                {/* éŠæˆ²å¸³è™Ÿåˆ—è¡¨ */}
                                <div className="bg-gold-50 border-2 border-gold-200 rounded-xl p-4">
                                    <div className="flex items-center justify-between mb-4">
                                        <div className="flex items-center gap-2">
                                            <User size={20} className="text-gold-600" />
                                            <span className="text-stone-700 font-bold">æˆ‘çš„éŠæˆ²å¸³è™Ÿ</span>
                                            <span className="text-fire-500 text-xs font-bold">(å¿…å¡«)</span>
                                            <span className="text-xs text-stone-500">ï¼ˆæ³¨æ„ï¼šæ˜¯éŠæˆ²å¸³è™Ÿï¼Œä¸¦éè§’è‰²IDã€‚æœ€å¤š 5 å€‹ï¼‰</span>
                                        </div>
                                        {gameAccounts.length < 5 && (
                                            <button
                                                onClick={() => setShowAddAccount(true)}
                                                className="text-gold-600 hover:text-gold-700 font-bold text-sm flex items-center gap-1"
                                            >
                                                <Plus size={14} />
                                                æ–°å¢å¸³è™Ÿ
                                            </button>
                                        )}
                                    </div>
                                    
                                    {/* å¸³è™Ÿåˆ—è¡¨ */}
                                    <div className="space-y-2">
                                        {gameAccounts.map((account) => (
                                            <div key={account.id} className="bg-white rounded-lg p-3 border border-gold-200">
                                                {editingAccountId === account.id ? (
                                                    <div className="flex gap-2">
                                                        <input
                                                            type="text"
                                                            value={editingAccountName}
                                                            onChange={(e) => setEditingAccountName(e.target.value)}
                                                            className="flex-1 px-3 py-2 border-2 border-gold-300 rounded-lg focus:border-gold-500 focus:outline-none font-bold text-sm"
                                                            placeholder="è¼¸å…¥éŠæˆ²å¸³è™Ÿï¼ˆéè§’è‰²IDï¼‰"
                                                        />
                                                        <button
                                                            onClick={() => handleUpdateAccount(account.id)}
                                                            className="px-3 py-2 bg-gold-500 hover:bg-gold-600 text-white font-bold rounded-lg transition-colors text-sm"
                                                        >
                                                            å„²å­˜
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                setEditingAccountId(null);
                                                                setEditingAccountName('');
                                                            }}
                                                            className="px-3 py-2 bg-stone-300 hover:bg-stone-400 text-stone-700 font-bold rounded-lg transition-colors text-sm"
                                                        >
                                                            å–æ¶ˆ
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-gold-700 font-black">{account.name}</span>
                                                            {account.is_primary && (
                                                                <span className="px-2 py-0.5 bg-gold-500 text-white text-xs font-bold rounded">ä¸»å¸³è™Ÿ</span>
                                                            )}
                                                        </div>
                                                        <div className="flex gap-1">
                                                            <button
                                                                onClick={() => {
                                                                    setEditingAccountId(account.id);
                                                                    setEditingAccountName(account.name);
                                                                }}
                                                                className="p-1.5 text-stone-500 hover:text-gold-600 transition-colors"
                                                                title="ç·¨è¼¯"
                                                            >
                                                                <Edit2 size={14} />
                                                            </button>
                                                            {!account.is_primary && (
                                                                <button
                                                                    onClick={() => handleDeleteAccount(account.id)}
                                                                    className="p-1.5 text-stone-500 hover:text-fire-600 transition-colors"
                                                                    title="åˆªé™¤"
                                                                >
                                                                    <Trash2 size={14} />
                                                                </button>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                        
                                        {/* æ–°å¢å¸³è™Ÿè¼¸å…¥æ¡† */}
                                        {showAddAccount && (
                                            <motion.div 
                                                initial={{ opacity: 0, height: 0 }}
                                                animate={{ opacity: 1, height: 'auto' }}
                                                className="bg-white rounded-lg p-3 border-2 border-gold-400"
                                            >
                                                <div className="mb-2">
                                                    <input
                                                        type="text"
                                                        value={newAccountName}
                                                        onChange={(e) => setNewAccountName(e.target.value)}
                                                        placeholder="è¼¸å…¥éŠæˆ²å¸³è™Ÿï¼ˆç™»å…¥ç”¨ï¼Œéè§’è‰²IDï¼‰"
                                                        className="w-full px-3 py-2 border-2 border-gold-300 rounded-lg focus:border-gold-500 focus:outline-none font-bold text-sm"
                                                        autoFocus
                                                    />
                                                    <p className="text-xs text-gold-700 mt-1.5 ml-1">âš ï¸ æ³¨æ„ï¼šæ˜¯éŠæˆ²å¸³è™Ÿï¼Œä¸¦éè§’è‰²IDã€‚è«‹ç¢ºèªèˆ‡éŠæˆ²å…§å¸³è™Ÿå®Œå…¨ä¸€è‡´</p>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={handleAddAccount}
                                                        className="flex-1 px-4 py-2 bg-gold-500 hover:bg-gold-600 text-white font-bold rounded-lg transition-colors text-sm flex items-center justify-center gap-1"
                                                    >
                                                        <Plus size={14} />
                                                        æ–°å¢
                                                    </button>
                                                    <button
                                                        onClick={() => {
                                                            setShowAddAccount(false);
                                                            setNewAccountName('');
                                                        }}
                                                        className="px-4 py-2 bg-stone-300 hover:bg-stone-400 text-stone-700 font-bold rounded-lg transition-colors text-sm"
                                                    >
                                                        å–æ¶ˆ
                                                    </button>
                                                </div>
                                            </motion.div>
                                        )}
                                    </div>
                                    
                                    {gameAccounts.length === 0 && (
                                        <p className="text-center text-stone-500 text-sm py-4">å°šæœªè¨­å®šéŠæˆ²å¸³è™Ÿ</p>
                                    )}
                                    
                                    <p className="text-xs text-stone-500 mt-3">ğŸ’¡ æ‚¨æœ€å¤šå¯ä»¥æ–°å¢ 5 å€‹éŠæˆ²å¸³è™Ÿï¼ˆç™»å…¥ç”¨å¸³è™Ÿï¼Œéè§’è‰²IDï¼‰</p>
                                </div>
                                
                                <div className="flex items-center gap-3">
                                    <Calendar size={20} className="text-stone-400" />
                                    <span className="text-stone-600">è¨»å†Šæ™‚é–“ï¼š{new Date(user?.created_at).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                        
                        {/* è´ŠåŠ©ç´€éŒ„ */}
                        <div className="stone-panel p-6 md:p-8">
                            <h2 className="text-2xl font-black text-stone-800 mb-6">æˆ‘çš„è´ŠåŠ©ç´€éŒ„</h2>
                            
                            {sponsorships.length === 0 ? (
                                <div className="text-center py-16 text-stone-400">
                                    <Heart size={48} className="mx-auto mb-4 opacity-20" />
                                    <p className="text-xl font-bold">å°šç„¡è´ŠåŠ©ç´€éŒ„</p>
                                    <p className="mt-2">è¶•å¿«å‰å¾€é‡‘å¹£è´ŠåŠ©æ”¯æŒæˆ‘å€‘å§ï¼</p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {sponsorships.map((item) => (
                                        <div key={item.id} className="bg-stone-50 rounded-2xl p-5 border-2 border-stone-100 hover:border-gold-200 transition-colors">
                                            <div className="flex flex-col md:flex-row md:items-center justify-between mb-3 gap-2">
                                                <div className="flex items-center gap-3">
                                                    <span className="text-gold-600 font-black text-lg">NT$ {item.amount}</span>
                                                    {item.order_number && (
                                                        <div className="flex items-center gap-2">
                                                            <code className="text-base font-black text-purple-600 bg-purple-100 px-3 py-1.5 rounded-lg border-2 border-purple-300">
                                                                {item.order_number}
                                                            </code>
                                                            <button
                                                                onClick={() => {
                                                                    navigator.clipboard.writeText(item.order_number);
                                                                    showToast('è¨‚å–®ç·¨è™Ÿå·²è¤‡è£½', 'success');
                                                                }}
                                                                className="p-1.5 hover:bg-purple-100 rounded-lg transition-colors"
                                                                title="è¤‡è£½è¨‚å–®ç·¨è™Ÿ"
                                                            >
                                                                <Copy size={18} className="text-purple-600" />
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                                <span className={`px-3 py-1 rounded-full text-sm font-bold whitespace-nowrap ${
                                                    item.status === 'completed' ? 'bg-wind-100 text-wind-700' :
                                                    item.status === 'pending' ? 'bg-gold-100 text-gold-700' :
                                                    'bg-stone-200 text-stone-600'
                                                }`}>
                                                    {item.status === 'completed' ? 'âœ… å·²å®Œæˆ' : item.status === 'pending' ? 'â³ è™•ç†ä¸­' : 'âŒ å·²å–æ¶ˆ'}
                                                </span>
                                            </div>
                                            <div className="text-stone-600 text-sm space-y-1">
                                                <p><span className="font-bold">æ–¹æ¡ˆåç¨±ï¼š</span>{item.plan_name}</p>
                                                <p><span className="font-bold">ç²å¾—é‡‘å¹£ï¼š</span><span className="text-gold-600 font-bold">{item.coins ? item.coins.toLocaleString() : 0} Gold</span></p>
                                                <p><span className="font-bold">éŠæˆ²å¸³è™Ÿï¼š</span>{item.game_account}</p>
                                                <p><span className="font-bold">æ”¯ä»˜æ–¹å¼ï¼š</span>{
                                                    item.payment_method === 'linepay' ? 'LINE Pay' : 
                                                    item.payment_method === 'shopline' ? 'SHOPLINE' : 
                                                    item.payment_method
                                                }</p>
                                                <p><span className="font-bold">å„²å€¼æ™‚é–“ï¼š</span>{new Date(item.created_at).toLocaleString('zh-TW')}</p>
                                                {item.processed_at && (
                                                    <p><span className="font-bold">è™•ç†æ™‚é–“ï¼š</span>{new Date(item.processed_at).toLocaleString('zh-TW')}</p>
                                                )}
                                                {item.notes && (
                                                    <p><span className="font-bold">å‚™è¨»ï¼š</span>{item.notes}</p>
                                                )}
                                            </div>
                                            {item.status === 'pending' && (
                                                <div className="mt-3 pt-3 border-t border-stone-200">
                                                    <div className="bg-yellow-50 border-l-4 border-yellow-500 p-3 rounded space-y-2">
                                                        <p className="text-sm text-stone-700 font-bold">
                                                            â³ å¾…è™•ç†ï¼šè«‹ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿå®Œæˆ
                                                        </p>
                                                        
                                                        {/* æ ¹æ“šæ”¯ä»˜æ–¹å¼é¡¯ç¤ºä¸åŒèªªæ˜ */}
                                                        {item.payment_method === 'linepay' && (
                                                            <div className="text-sm text-stone-700 space-y-1">
                                                                <p className="font-bold text-stone-800">ğŸ“± LINE Pay ä»˜æ¬¾æµç¨‹ï¼š</p>
                                                                <ol className="list-decimal ml-5 space-y-0.5">
                                                                    <li>æƒæ QR Code å®Œæˆ LINE Pay æ”¯ä»˜</li>
                                                                    <li>æˆªåœ–æ”¯ä»˜æˆåŠŸç•«é¢</li>
                                                                    <li>å°‡æˆªåœ–èˆ‡è¨‚å–®ç·¨è™Ÿå‚³é€çµ¦å®¢æœæ ¸å°</li>
                                                                </ol>
                                                            </div>
                                                        )}
                                                        
                                                        {item.payment_method === 'shopline' && (
                                                            <div className="text-sm text-stone-700 space-y-1">
                                                                <p className="font-bold text-stone-800">ğŸ’³ SHOPLINE ä»˜æ¬¾æµç¨‹ï¼š</p>
                                                                <ol className="list-decimal ml-5 space-y-0.5">
                                                                    <li>å‰å¾€å¤–éƒ¨æ”¯ä»˜é é¢å®Œæˆä»˜æ¬¾</li>
                                                                    <li>æˆªåœ–æ”¯ä»˜æˆåŠŸç•«é¢</li>
                                                                    <li>å°‡æˆªåœ–èˆ‡è¨‚å–®ç·¨è™Ÿå‚³é€çµ¦å®¢æœæ ¸å°</li>
                                                                </ol>
                                                            </div>
                                                        )}
                                                        
                                                        {!item.payment_method || (item.payment_method !== 'linepay' && item.payment_method !== 'shopline') && (
                                                            <div className="text-sm text-stone-700 space-y-1">
                                                                <p className="font-bold text-stone-800">ğŸ’¬ æ­¤æ–¹å¼éœ€è¯ç¹«å®¢æœç´¢å–ä»˜æ¬¾è³‡è¨Šï¼š</p>
                                                                <ol className="list-decimal ml-5 space-y-0.5">
                                                                    <li>åŠ å…¥å®˜æ–¹ LINE å¸³è™Ÿï¼ˆID: @939yjtdjï¼‰</li>
                                                                    <li>å‘ŠçŸ¥å®¢æœæ‚¨æ¬²ä½¿ç”¨ {item.payment_method || 'å…¶ä»–'} æ”¯ä»˜</li>
                                                                    <li>æä¾›æ‚¨çš„è´ŠåŠ©é‡‘é¡ NT$ {item.amount?.toLocaleString()}</li>
                                                                    <li>å®Œæˆè½‰å¸³å¾Œå›å‚³æˆªåœ–èˆ‡è¨‚å–®ç·¨è™Ÿ</li>
                                                                </ol>
                                                            </div>
                                                        )}
                                                        
                                                        <div className="flex items-center gap-2 pt-2 border-t border-yellow-200">
                                                            <a href="https://lin.ee/3vSihiH" target="_blank" rel="noopener noreferrer" 
                                                               className="inline-flex items-center gap-2 px-3 py-2 bg-line-500 text-white rounded-lg text-sm font-bold hover:bg-line-600 transition-colors">
                                                                <MessageSquare size={16} />
                                                                ç«‹å³è¯ç¹« LINE å®¢æœ
                                                                <ExternalLink size={12} />
                                                            </a>
                                                            <span className="text-xs text-stone-500">â° äººå·¥å®¢æœæ™‚é–“ï¼š10:00 - 22:00</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </motion.div>
            );
        };
        
        const HomePage = () => {
            const handleDownload = () => window.location.href = '/download';
            const handleDiscord = () => window.open('https://discord.gg/dS2p7j5yMZ', '_blank');
            const handleLineCommunity = () => window.open('https://line.me/ti/g2/k7x6Y9Y0BkSAAQm6LD-UuG1ihCORUPeCfoixMg?utm_source=invitation&utm_medium=link_copy&utm_campaign=default', '_blank'); // FIXED: LINE ç¤¾ç¾¤
            
            const [events, setEvents] = useState([]);
            const [banners, setBanners] = useState([]);
            const [onlinePlayers, setOnlinePlayers] = useState(1247);
            
            // æ¨¡æ“¬ç·šä¸Šäººæ•¸è®ŠåŒ–
            useEffect(() => {
                const interval = setInterval(() => {
                    setOnlinePlayers(prev => {
                        const change = Math.floor(Math.random() * 20) - 10; // -10 åˆ° +10
                        const newValue = prev + change;
                        return Math.max(1200, Math.min(1500, newValue)); // ä¿æŒåœ¨ 1200-1500 ä¹‹é–“
                    });
                }, 5000); // æ¯ 5 ç§’æ›´æ–°
                return () => clearInterval(interval);
            }, []);
            
            // Load Events for Marqueeï¼ˆåƒ…è¼‰å…¥æ¨™é¡Œç­‰ï¼Œä¸è¼‰å…¥ content ä»¥åŠ é€Ÿï¼‰
            useEffect(() => {
                const loadEvents = async () => {
                    const loadedEvents = await getSupabaseData(DB_TABLES.EVENTS, { columns: 'id, title, tag, timestamp', limit: 15 });
                    setEvents(loadedEvents.sort((a, b) => b.timestamp - a.timestamp));
                };
                
                loadEvents();
                
                const handleStorageChange = () => loadEvents();
                window.addEventListener('storage-update', handleStorageChange);
                return () => window.removeEventListener('storage-update', handleStorageChange);
            }, []);

            // Load Announcement Banners
            useEffect(() => {
                const loadBanners = async () => {
                    const data = await getSupabaseData(DB_TABLES.ANNOUNCEMENTS, { columns: 'id, title, subtitle, link, icon, badge, is_active, sort_order' });
                    const active = (data || []).filter(b => b.is_active).sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));
                    setBanners(active);
                };
                loadBanners();
                const handleBannerRefresh = () => loadBanners();
                window.addEventListener('banner-updated', handleBannerRefresh);
                return () => window.removeEventListener('banner-updated', handleBannerRefresh);
            }, []);

            return (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} transition={{ duration: 0.5 }}>
                    <section className="relative h-screen min-h-[700px] flex items-center justify-center overflow-hidden bg-gradient-tribal">
                        <div className="absolute inset-0 z-0 opacity-100">
                            <motion.div initial={{ scale: 1.05 }} animate={{ scale: 1 }} transition={{ duration: 20, repeat: Infinity, repeatType: "reverse", ease: "linear" }} className="w-full h-full">
                                <SmartImage src={getAssetUrl(ASSETS.HERO)} alt="Hero" className="w-full h-full object-cover" />
                            </motion.div>
                            <div className="absolute inset-0 bg-gradient-to-b from-[#fbf6e9]/40 via-transparent to-[#fbf6e9]/50 z-10"></div>
                        </div>

                        <div className="relative z-20 text-center max-w-7xl px-6 pt-12 md:pt-20">
                            <motion.div initial={{ y: 30, opacity: 0 }} animate={{ y: 0, opacity: 1 }} transition={{ duration: 1, ease: "easeOut" }} className="-mt-16 md:-mt-24">
                                <div className="mb-8 md:mb-10 animate-float drop-shadow-lg">
                                    <SmartImage src={getAssetUrl(ASSETS.LOGO)} fallbackType="logo" className="h-32 md:h-80 w-auto mx-auto object-contain" alt="è˜‡æ‰“çŸ³å™¨" />
                                </div>

                                <div className="inline-flex items-center gap-3 md:gap-4 px-5 md:px-7 py-2.5 rounded-full bg-white/90 border border-stone-200/80 text-stone-600 font-bold mb-6 md:mb-10 shadow-md shadow-stone-200/30 backdrop-blur-md text-base md:text-lg tracking-wide">
                                    <span className="w-2 h-2 md:w-2.5 md:h-2.5 rounded-full bg-green-500 animate-pulse ring-2 ring-green-200"></span>
                                    <span>2.5 ç¶“å…¸ç‰ˆæœ¬</span>
                                    <span className="text-stone-300">|</span>
                                    <span>ç«ç†±å…¬æ¸¬ä¸­</span>
                                </div>

                                <p className="text-4xl sm:text-5xl md:text-6xl lg:text-7xl text-[#8B1538] font-display font-black mb-8 md:mb-10 max-w-4xl mx-auto tracking-tight leading-[1.15] px-2 [text-shadow:0_0_2px_#fff,0_0_4px_#fff,0_0_8px_rgba(255,255,255,0.6),0_2px_8px_rgba(0,0,0,0.4)]">
                                    æœ€åˆçš„æ„Ÿå‹•ï¼Œæœ€ç´”ç²¹çš„å†’éšª
                                </p>
                                
                                <p className="text-base md:text-lg text-stone-800 font-bold mb-10 md:mb-12 px-4 py-2.5 rounded-full bg-white/90 shadow-md border border-stone-200/80 inline-block [text-shadow:0_1px_2px_rgba(255,255,255,0.9)]">
                                    â¤ï¸ æ‰¿è«¾å°‡ 1% ç‡Ÿæ”¶æè´ˆå…¬ç›Šï¼Œè®“éŠæˆ²æ›´æœ‰æº«åº¦
                                </p>
                                
                                {/* ä¸»è¦ CTAï¼šæ¸…æ¥šå¥½è®€ */}
                                <div className="px-5 py-6 md:py-8 rounded-2xl bg-black/25 backdrop-blur-md border border-white/20 shadow-xl max-w-md mx-auto">
                                    <div className="flex flex-col items-center gap-5">
                                        <Button 
                                            variant="gold" 
                                            className="w-full min-w-[260px] text-xl md:text-2xl py-5 px-8 rounded-2xl font-black shadow-xl shadow-black/20 hover:opacity-95 transition-opacity duration-200 text-white" 
                                            icon={Download} 
                                            onClick={handleDownload}
                                        >
                                            å…è²»ä¸‹è¼‰éŠæˆ²
                                        </Button>
                                        <p className="text-white/95 text-base font-semibold drop-shadow-md">Windows / Android / iOS</p>
                                    </div>
                                    <div className="flex flex-wrap justify-center gap-3 mt-6 pt-5 border-t border-white/30">
                                        <Button variant="line" className="min-w-[140px] py-3.5 rounded-xl text-base font-bold shadow-lg" icon={LineIcon} onClick={handleLineCommunity}>LINE ç¤¾ç¾¤</Button>
                                        <Button variant="discord" className="min-w-[140px] py-3.5 rounded-xl text-base font-bold shadow-lg" icon={DiscordIcon} onClick={handleDiscord}>Discord</Button>
                                    </div>
                                </div>

                                {/* ç·šä¸Šç©å®¶è¨ˆæ•¸å™¨ */}
                                <motion.div 
                                    initial={{ opacity: 0, y: 10 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    transition={{ delay: 0.8, duration: 0.5 }}
                                    className="mt-10 md:mt-14"
                                >
                                    <div className="inline-flex items-center gap-3 px-5 py-3 rounded-2xl bg-white/80 backdrop-blur-md border border-stone-200/80 shadow-lg">
                                        <div className="flex items-center gap-2">
                                            <div className="relative">
                                                <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                                <div className="absolute inset-0 w-3 h-3 bg-green-500 rounded-full animate-ping opacity-75"></div>
                                            </div>
                                            <User size={20} className="text-stone-500" />
                                        </div>
                                        <div className="flex items-baseline gap-1.5">
                                            <motion.span 
                                                key={onlinePlayers}
                                                initial={{ y: -5, opacity: 0 }}
                                                animate={{ y: 0, opacity: 1 }}
                                                className="text-2xl font-black text-gold-600 font-mono"
                                            >
                                                {onlinePlayers.toLocaleString()}
                                            </motion.span>
                                            <span className="text-sm font-bold text-stone-500">ä½ç©å®¶æ­£åœ¨å†’éšª</span>
                                        </div>
                                    </div>
                                </motion.div>

                                <div className="absolute bottom-10 left-1/2 -translate-x-1/2 animate-bounce-slow opacity-40 hidden md:block">
                                    <ChevronDown className="text-stone-400 w-10 h-10"/>
                                </div>
                            </motion.div>
                        </div>
                    </section>

                    {/* æ–°åŠŸèƒ½å…¬å‘Š - æ´»å‹•æ”»ç•¥ */}
                    {banners.length > 0 && banners.map(banner => {
                        const IconComp = BANNER_ICONS[banner.icon] || Megaphone;
                        return (
                            <section key={banner.id} className="bg-gradient-to-r from-gold-50 via-amber-50 to-orange-50 border-y-2 border-gold-200 py-4 relative z-20">
                                <div className="max-w-7xl mx-auto px-4 md:px-6">
                                    <Link to={banner.link || '/events'} className="flex items-center justify-center gap-3 group">
                                        <div className="bg-gold-500 text-white p-2 rounded-xl shrink-0 group-hover:bg-gold-600 transition-colors shadow-md">
                                            <IconComp size={20} />
                                        </div>
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2">
                                                {banner.badge && <span className="bg-fire-500 text-white text-xs font-bold px-2 py-1 rounded-full">{banner.badge}</span>}
                                                <span className="font-black text-stone-800 text-base md:text-lg group-hover:text-gold-600 transition-colors">
                                                    {banner.title}
                                                </span>
                                            </div>
                                            {banner.subtitle && (
                                                <p className="text-xs md:text-sm text-stone-600 mt-1">
                                                    {banner.subtitle} â†’
                                                </p>
                                            )}
                                        </div>
                                    </Link>
                                </div>
                            </section>
                        );
                    })}

                    {/* News Section (Powered by Events) */}
                    <section className="bg-white/95 border-b border-stone-100 py-4 relative z-20 shadow-sm backdrop-blur-sm">
                        <div className="max-w-7xl mx-auto px-4 md:px-6 flex items-center gap-4 md:gap-6 overflow-hidden">
                            <Link to="/events" className="bg-stone-800 text-white text-sm font-bold px-4 py-2 rounded-xl whitespace-nowrap flex items-center gap-2 shrink-0 hover:bg-stone-700 transition-colors shadow-sm">
                                <Megaphone size={18} /> æœ€æ–°æƒ…å ±
                            </Link>
                            <div className="flex-1 overflow-hidden min-w-0">
                                <Link to="/events" className="block text-stone-600 text-sm md:text-base font-medium hover:text-stone-800 transition-colors py-1">
                                    {events.length > 0 ? (
                                        <div className="flex overflow-hidden">
                                            <div className={`flex gap-12 ${events.length >= 2 ? 'marquee-content' : ''}`}>
                                                {(events.length >= 2 ? [...events, ...events] : events).map((item, idx) => {
                                                    const tag = EVENT_TAGS.find(t => t.id === item.tag)?.label || 'ğŸ“¢';
                                                    return <span key={`${item.id}-${idx}`} className="flex items-center gap-2 shrink-0"><span className="text-xs opacity-70">{tag}</span> {item.title}</span>
                                                })}
                                            </div>
                                        </div>
                                    ) : (
                                        <span className="text-stone-400">æš«ç„¡æœ€æ–°å…¬å‘Š...</span>
                                    )}
                                </Link>
                            </div>
                        </div>
                    </section>

                    <section className="py-24 md:py-32 px-6 relative mb-20 md:mb-0">
                        <div className="max-w-7xl mx-auto">
                            <div className="text-center mb-16 md:mb-24">
                                <h2 className="text-3xl md:text-5xl font-display font-black text-stone-800 mb-4 inline-block relative">
                                    éƒ¨è½ç”Ÿå­˜æ³•å‰‡
                                    <span className="absolute -bottom-2 left-0 w-full h-3 bg-yellow-200/50 -z-10 rounded-full"></span>
                                </h2>
                                <p className="text-stone-500 font-medium text-lg md:text-xl mt-4">å››å¤§å±¬æ€§åŠ æŒï¼Œæ‰“é€ æœ€å¹³è¡¡çš„å°¼æ–¯å¤§é™¸ã€‚</p>
                            </div>
                            <div className="grid md:grid-cols-3 gap-8 md:gap-10">
                                {[
                                    { t: "ç´”æ·¨ç’°å¢ƒ", d: "æ‹’çµ•å°å¹£æˆ°å£«ï¼Œå•†åŸåƒ…å”®ä¾¿åˆ©é“å…·ï¼Œæ¥µå“è£å‚™å…¨é é›™æ‰‹ç²å¾—ã€‚", i: ShieldCheck, color: "text-wind-600", bg: "bg-wind-50", border: "border-wind-200" },
                                    { t: "ç¶“å…¸è¨­å®š", d: "å®Œç¾å¾©åˆ» 2.5 ç‰ˆæœ¬æ•¸å€¼ã€‚åœ°æ°´ç«é¢¨å±¬æ€§ç›¸å‰‹ï¼Œç­–ç•¥æ‰æ˜¯ç‹é“ã€‚", i: Flame, color: "text-fire-500", bg: "bg-fire-50", border: "border-fire-200" },
                                    { t: "é•·ä¹…ç©©å®š", d: "æ¡ç”¨å•†æ¥­ç´šåˆ†ä½ˆå¼æ¶æ§‹ï¼Œæ•¸æ“šç•°åœ°å‚™ä»½ï¼Œæ‰¿è«¾æ°¸ä¹…ä¿å­˜ã€‚", i: Home, color: "text-earth-600", bg: "bg-earth-50", border: "border-earth-200" }
                                ].map((item, idx) => (
                                    <motion.div key={idx} whileHover={{ y: -6 }} transition={{ duration: 0.2 }} className="stone-panel p-8 md:p-10 text-center group bg-white cursor-default">
                                        <div className={`w-16 h-16 md:w-20 md:h-20 mx-auto rounded-2xl ${item.bg} flex items-center justify-center mb-6 md:mb-8 group-hover:scale-110 transition-transform duration-300`}>
                                            <item.i size={36} className={item.color} />
                                        </div>
                                        <h3 className="text-xl md:text-2xl font-bold mb-3 text-stone-700 tracking-wide">{item.t}</h3>
                                        <p className="text-stone-500 font-medium text-sm md:text-base leading-relaxed">{item.d}</p>
                                    </motion.div>
                                ))}
                            </div>
                        </div>
                    </section>
                </motion.div>
            );
        };

        const TermsPage = () => {
            return (
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    className="min-h-screen bg-gradient-to-b from-stone-50 via-white to-stone-50 pt-32 pb-20"
                >
                    <div className="max-w-4xl mx-auto px-4 md:px-6">
                        {/* é é¢æ¨™é¡Œ */}
                        <div className="text-center mb-12">
                            <h1 className="text-4xl md:text-5xl font-black text-stone-800 mb-4 flex items-center justify-center gap-3">
                                <ScrollText size={48} className="text-gold-500" />
                                æœå‹™æ¢æ¬¾èˆ‡å…è²¬è²æ˜
                            </h1>
                            <p className="text-stone-600 text-lg">è«‹ä»”ç´°é–±è®€ä»¥ä¸‹æ¢æ¬¾</p>
                        </div>

                        <div className="space-y-8">
                            {/* ç‰ˆæ¬Šè²æ˜ */}
                            <div className="stone-panel p-8 md:p-10 bg-white">
                                <h2 className="text-2xl font-black text-stone-800 mb-6 flex items-center gap-3">
                                    <AlertCircle size={28} className="text-gold-500" />
                                    ç‰ˆæ¬Šè²æ˜
                                </h2>
                                <div className="space-y-4 text-stone-700 leading-relaxed">
                                    <p className="font-bold">
                                        æœ¬ä¼ºæœå™¨ç‚º<strong className="text-red-600">éç‡Ÿåˆ©æ€§è³ªçš„ç²‰çµ²ç§äººä¼ºæœå™¨</strong>ï¼Œèˆ‡åŸå» å…¬å¸ç„¡ä»»ä½•é—œè¯ã€‚
                                    </p>
                                    <ul className="space-y-2 ml-6 list-disc">
                                        <li>æœ¬æœå‹™ç‚º<strong>éå®˜æ–¹</strong>çš„ç©å®¶è‡ªæ¶ä¼ºæœå™¨ï¼Œåƒ…ä¾›å€‹äººå¨›æ¨‚äº¤æµ</li>
                                        <li>ç‚ºç¶­æŒä¼ºæœå™¨é‹ä½œæˆæœ¬ï¼ˆä¸»æ©Ÿã€é »å¯¬ç­‰ï¼‰ï¼Œ<strong>æ¥å—ç©å®¶è‡ªé¡˜è´ŠåŠ©</strong></li>
                                        <li>æ‰€æœ‰è´ŠåŠ©æ¬¾é …ç”¨æ–¼æ”¯ä»˜ä¼ºæœå™¨ç›¸é—œè²»ç”¨ï¼Œä¸ä»¥ç‡Ÿåˆ©ç‚ºç›®çš„</li>
                                        <li>æœ¬ä¼ºæœå™¨ä¸ä»£è¡¨åŸå» ç«‹å ´ï¼Œæ‰€æœ‰ç‡Ÿé‹ç”±ç©å®¶ç¤¾ç¾¤è‡ªè¡Œç¶­è­·</li>
                                    </ul>
                                </div>
                            </div>

                            {/* æœå‹™æ¢æ¬¾ */}
                            <div className="stone-panel p-8 md:p-10 bg-white">
                                <h2 className="text-2xl font-black text-stone-800 mb-6 flex items-center gap-3">
                                    <CheckCircle size={28} className="text-wind-500" />
                                    æœå‹™æ¢æ¬¾
                                </h2>
                                <div className="space-y-6">
                                    <div>
                                        <h3 className="font-black text-stone-800 text-lg mb-3">1. å¸³è™Ÿä½¿ç”¨è¦ç¯„</h3>
                                        <ul className="space-y-2 text-stone-700 ml-6 list-disc">
                                            <li>æ‚¨å¿…é ˆæä¾›çœŸå¯¦ä¸”æ­£ç¢ºçš„è¨»å†Šè³‡è¨Š</li>
                                            <li>å¸³è™Ÿå¯†ç¢¼è«‹å¦¥å–„ä¿ç®¡ï¼Œä¸å¾—è½‰è®“æˆ–å‡ºå€Ÿä»–äºº</li>
                                            <li>ä¸€å€‹ Email æœ€å¤šå¯è¨»å†Š 5 å€‹éŠæˆ²å¸³è™Ÿ</li>
                                            <li>å› å€‹äººç–å¤±å°è‡´çš„å¸³è™Ÿéºå¤±ï¼Œæœ¬æœå‹™ä¸è² ä»»ä½•è²¬ä»»</li>
                                        </ul>
                                    </div>

                                    <div>
                                        <h3 className="font-black text-stone-800 text-lg mb-3">2. ç¦æ­¢äº‹é …</h3>
                                        <ul className="space-y-2 text-stone-700 ml-6 list-disc">
                                            <li className="text-red-600 font-bold">ç¦æ­¢ä½¿ç”¨ä»»ä½•å¤–æ›ã€è…³æœ¬ã€ä¿®æ”¹å™¨ç­‰ç¬¬ä¸‰æ–¹ç¨‹å¼</li>
                                            <li className="text-red-600 font-bold">ç¦æ­¢åˆ©ç”¨éŠæˆ²æ¼æ´é€²è¡Œä¸ç•¶ç²åˆ©</li>
                                            <li className="text-red-600 font-bold">ç¦æ­¢é€²è¡ŒéŠæˆ²å¹£ã€è™›å¯¶çš„çœŸå¯¦é‡‘éŒ¢äº¤æ˜“</li>
                                            <li>ç¦æ­¢ç™¼è¡¨ä¸ç•¶è¨€è«–ã€é¨·æ“¾ã€è©é¨™å…¶ä»–ç©å®¶</li>
                                            <li>ç¦æ­¢ä½¿ç”¨ä¸é›…ã€æ”»æ“Šæ€§çš„è§’è‰²åç¨±</li>
                                        </ul>
                                    </div>

                                    <div>
                                        <h3 className="font-black text-stone-800 text-lg mb-3">3. é•è¦è™•ç†</h3>
                                        <ul className="space-y-2 text-stone-700 ml-6 list-disc">
                                            <li>ç¶“æŸ¥è­‰é•åè¦å®šè€…ï¼Œå°‡è™•ä»¥<strong className="text-red-600">æš«æ™‚åœæ¬Šæˆ–æ°¸ä¹…å°é–</strong></li>
                                            <li>é•è¦æ‰€ç²å¾—çš„è™›æ“¬ç‰©å“ã€éŠæˆ²å¹£å°‡äºˆä»¥<strong>æ²’æ”¶</strong></li>
                                            <li>åš´é‡é•è¦è€…å°‡<strong>ä¸äºˆé€€é‚„ä»»ä½•å·²ä»˜è²»ç”¨</strong></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            {/* ç©å®¶è´ŠåŠ©èªªæ˜ï¼ˆæ•´åˆå„ªåŒ–ï¼‰ */}
                            <div className="stone-panel p-8 md:p-10 bg-gradient-to-br from-orange-50 to-red-50 border-2 border-orange-300">
                                <h2 className="text-2xl font-black text-stone-800 mb-6 flex items-center gap-3">
                                    <Coins size={28} className="text-orange-500" />
                                    ç©å®¶è´ŠåŠ©èªªæ˜
                                </h2>
                                <div className="space-y-6 text-stone-700 leading-relaxed">
                                    <div className="bg-white rounded-xl p-6 border-2 border-red-400">
                                        <h3 className="font-black text-red-700 text-lg mb-4">ğŸš¨ é‡è¦æé†’ï¼ˆè«‹å‹™å¿…è©³é–±ï¼‰</h3>
                                        <div className="space-y-3">
                                            <p className="font-bold text-red-600">
                                                âš ï¸ è´ŠåŠ©ç‚º<strong>è‡ªé¡˜è¡Œç‚º</strong>ï¼Œä¸€ç¶“å®Œæˆ<strong>æ•ä¸é€€æ¬¾æˆ–æ›è²¨</strong>
                                            </p>
                                            <p className="font-bold">
                                                â€¢ è™›æ“¬ç‰©å“<strong className="text-orange-700">åƒ…é™éŠæˆ²å…§ä½¿ç”¨</strong>ï¼Œç„¡å¯¦è³ªåƒ¹å€¼ï¼Œä¸å¯å…Œæ›ç¾é‡‘
                                            </p>
                                            <p className="font-bold">
                                                â€¢ è™›å¯¶ç”±ç®¡ç†å“¡<strong className="text-orange-700">äººå·¥å¯©æ ¸å¾Œç™¼æ”¾</strong>ï¼Œéå³æ™‚åˆ°å¸³
                                            </p>
                                            <p className="font-bold">
                                                â€¢ éŠæˆ²å¸³è™Ÿ<strong className="text-red-600">å‹™å¿…å¡«å¯«æ­£ç¢º</strong>ï¼ˆæ³¨æ„ï¼šæ˜¯éŠæˆ²å¸³è™Ÿï¼Œä¸¦éè§’è‰²IDï¼‰ï¼ŒéŒ¯èª¤æ•ä¸è£œç™¼
                                            </p>
                                        </div>
                                    </div>
                                    <p className="text-sm">
                                        ğŸ’° æ‰€æœ‰è´ŠåŠ©æ¬¾é …å°‡å…¨æ•¸ç”¨æ–¼ä¼ºæœå™¨ç¶­è­·è²»ç”¨ï¼ˆä¸»æ©Ÿç§Ÿè³ƒã€é »å¯¬æˆæœ¬ç­‰ï¼‰
                                    </p>
                                </div>
                            </div>

                            {/* å…è²¬è²æ˜ */}
                            <div className="stone-panel p-8 md:p-10 bg-white">
                                <h2 className="text-2xl font-black text-stone-800 mb-6 flex items-center gap-3">
                                    <ShieldCheck size={28} className="text-fire-500" />
                                    å…è²¬è²æ˜
                                </h2>
                                <div className="space-y-4 text-stone-700 leading-relaxed">
                                    <div>
                                        <h3 className="font-black text-stone-800 text-lg mb-3">1. æœå‹™ä¸­æ–·</h3>
                                        <p>
                                            æœ¬æœå‹™å¯èƒ½å› ç¶­è­·ã€æ›´æ–°ã€ä¸å¯æŠ—åŠ›ç­‰å› ç´ è€Œä¸­æ–·ã€‚å°æ–¼æœå‹™ä¸­æ–·æ‰€é€ æˆçš„ä»»ä½•æå¤±ï¼Œ
                                            <strong className="text-red-600">æœ¬æœå‹™ä¸è² ä»»ä½•è³ å„Ÿè²¬ä»»</strong>ã€‚
                                        </p>
                                    </div>

                                    <div>
                                        <h3 className="font-black text-stone-800 text-lg mb-3">2. è³‡æ–™éºå¤±</h3>
                                        <p>
                                            æœ¬æœå‹™å°‡ç›¡åŠ›ç¶­è­·è³‡æ–™å®‰å…¨ï¼Œä½†ç„¡æ³•ä¿è­‰çµ•å°ä¸æœƒç™¼ç”Ÿè³‡æ–™éºå¤±ã€‚
                                            å°æ–¼å› ç³»çµ±æ•…éšœã€é§­å®¢æ”»æ“Šç­‰åŸå› å°è‡´çš„è³‡æ–™éºå¤±ï¼Œ
                                            <strong className="text-red-600">æœ¬æœå‹™ä¸æ‰¿æ“”ä»»ä½•è²¬ä»»</strong>ã€‚
                                        </p>
                                    </div>

                                    <div>
                                        <h3 className="font-black text-stone-800 text-lg mb-3">3. æœå‹™çµ‚æ­¢</h3>
                                        <p>
                                            æœ¬æœå‹™ä¿ç•™éš¨æ™‚çµ‚æ­¢ç‡Ÿé‹çš„æ¬Šåˆ©ã€‚è‹¥æ±ºå®šçµ‚æ­¢ç‡Ÿé‹ï¼Œå°‡æå‰<strong>30 å¤©å…¬å‘Š</strong>ã€‚
                                            æœå‹™çµ‚æ­¢å¾Œï¼Œæ‰€æœ‰è™›æ“¬ç‰©å“åŠéŠæˆ²ç´€éŒ„å°‡æ°¸ä¹…å¤±æ•ˆï¼Œ<strong className="text-red-600">ä¸äºˆé€€æ¬¾</strong>ã€‚
                                        </p>
                                    </div>

                                    <div>
                                        <h3 className="font-black text-stone-800 text-lg mb-3">4. æå®³è³ å„Ÿé™åˆ¶</h3>
                                        <p>
                                            åœ¨ä»»ä½•æƒ…æ³ä¸‹ï¼Œæœ¬æœå‹™å°ä½¿ç”¨è€…çš„æå®³è³ å„Ÿè²¬ä»»ï¼Œ
                                            æœ€é«˜ä»¥<strong className="text-orange-600">ä½¿ç”¨è€…éå» 3 å€‹æœˆå…§çš„å„²å€¼ç¸½é¡</strong>ç‚ºä¸Šé™ã€‚
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* éš±ç§æ¬Šæ”¿ç­– */}
                            <div className="stone-panel p-8 md:p-10 bg-white">
                                <h2 className="text-2xl font-black text-stone-800 mb-6 flex items-center gap-3">
                                    <Lock size={28} className="text-wind-500" />
                                    éš±ç§æ¬Šæ”¿ç­–
                                </h2>
                                <div className="space-y-4 text-stone-700 leading-relaxed">
                                    <div>
                                        <h3 className="font-black text-stone-800 text-lg mb-3">è³‡æ–™æ”¶é›†ç¯„åœ</h3>
                                        <ul className="space-y-2 ml-6 list-disc">
                                            <li>Email å¸³è™Ÿã€éŠæˆ²å¸³è™Ÿåç¨±</li>
                                            <li>å„²å€¼ç´€éŒ„ã€éŠæˆ²æ•¸æ“š</li>
                                            <li>IP ä½å€ã€ç€è¦½å™¨è³‡è¨Šï¼ˆç”¨æ–¼å®‰å…¨é˜²è­·ï¼‰</li>
                                        </ul>
                                    </div>

                                    <div>
                                        <h3 className="font-black text-stone-800 text-lg mb-3">è³‡æ–™ä½¿ç”¨ç›®çš„</h3>
                                        <ul className="space-y-2 ml-6 list-disc">
                                            <li>æä¾›éŠæˆ²æœå‹™ã€è™›å¯¶ç™¼æ”¾</li>
                                            <li>å¸³è™Ÿå®‰å…¨ç¶­è­·ã€é•è¦æŸ¥è­‰</li>
                                            <li>å®¢æœè¯ç¹«ã€é‡è¦å…¬å‘Šé€šçŸ¥</li>
                                        </ul>
                                    </div>

                                    <div>
                                        <h3 className="font-black text-stone-800 text-lg mb-3">è³‡æ–™ä¿è­·</h3>
                                        <p>
                                            æˆ‘å€‘æ‰¿è«¾<strong className="text-wind-600">ä¸æœƒå°‡æ‚¨çš„å€‹äººè³‡æ–™è²©å”®æˆ–æä¾›çµ¦ç¬¬ä¸‰æ–¹</strong>ã€‚
                                            æ‰€æœ‰è³‡æ–™å‡æ¡ç”¨åŠ å¯†å„²å­˜ï¼Œåƒ…ä¾›æœ¬æœå‹™å…§éƒ¨ä½¿ç”¨ã€‚
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* å¹´é½¡é™åˆ¶ */}
                            <div className="stone-panel p-8 md:p-10 bg-gradient-to-br from-gold-50 to-yellow-50 border-2 border-gold-300">
                                <h2 className="text-2xl font-black text-stone-800 mb-6 flex items-center gap-3">
                                    <User size={28} className="text-gold-500" />
                                    å¹´é½¡é™åˆ¶èˆ‡å®¶é•·åŒæ„
                                </h2>
                                <div className="space-y-4 text-stone-700 leading-relaxed">
                                    <p className="font-bold text-lg">
                                        æœ¬æœå‹™é©ç”¨å¹´é½¡ï¼š<strong className="text-gold-600">12 æ­²ä»¥ä¸Š</strong>
                                    </p>
                                    <ul className="space-y-2 ml-6 list-disc">
                                        <li><strong>æœªæ»¿ 18 æ­²</strong>çš„ç©å®¶é€²è¡Œå„²å€¼å‰ï¼Œ<strong className="text-red-600">å¿…é ˆå–å¾—æ³•å®šä»£ç†äººï¼ˆå®¶é•·ï¼‰åŒæ„</strong></li>
                                        <li>è‹¥ç™¼ç¾æœªæˆå¹´äººæœªç¶“å®¶é•·åŒæ„é€²è¡Œå„²å€¼ï¼Œå®¶é•·å¯è¯ç¹«å®¢æœç”³è«‹é€€æ¬¾</li>
                                        <li>é€€æ¬¾ç”³è«‹éœ€æä¾›<strong>å®¶é•·èº«åˆ†è­‰æ˜</strong>åŠ<strong>æœªæˆå¹´äººè­‰æ˜</strong></li>
                                    </ul>
                                </div>
                            </div>

                            {/* æ¢æ¬¾ä¿®æ”¹ */}
                            <div className="bg-stone-100 rounded-2xl p-6 text-center">
                                <p className="text-stone-600 font-bold text-sm">
                                    æœ¬æœå‹™æ¢æ¬¾æœ€å¾Œæ›´æ–°æ—¥æœŸï¼š<strong className="text-stone-800">2026 å¹´ 2 æœˆ 1 æ—¥</strong>
                                    <br />
                                    æˆ‘å€‘ä¿ç•™éš¨æ™‚ä¿®æ”¹æœ¬æ¢æ¬¾çš„æ¬Šåˆ©ï¼Œä¿®æ”¹å¾Œå°‡æ–¼ç¶²ç«™å…¬å‘Š
                                </p>
                            </div>

                            {/* åŒæ„æŒ‰éˆ• */}
                            <div className="text-center pt-4">
                                <a
                                    href="/"
                                    className="inline-flex items-center gap-2 px-8 py-4 bg-gold-500 hover:bg-gold-600 text-white font-bold rounded-xl transition-all shadow-lg hover:shadow-xl"
                                >
                                    <CheckCircle size={20} />
                                    æˆ‘å·²é–±è®€ä¸¦åŒæ„
                                </a>
                            </div>
                        </div>
                    </div>
                </motion.div>
            );
        };

        // ============================================
        // æ´»å‹•æ”»ç•¥ç³»çµ±çµ„ä»¶
        // ============================================

        // æ”»ç•¥å¡ç‰‡çµ„ä»¶ï¼šå·´å“ˆé¢¨æ ¼ã€èˆ’é©æ’ç‰ˆ
        const GuideCard = ({ guide, onClick }) => {
            const getCategoryInfo = (category) => {
                const categories = {
                    event: { label: 'æ´»å‹•', color: 'bg-orange-500', icon: 'ğŸ‰' },
                    pve: { label: 'PVE', color: 'bg-blue-500', icon: 'âš”ï¸' },
                    pvp: { label: 'PVP', color: 'bg-emerald-500', icon: 'ğŸ›¡ï¸' },
                    beginner: { label: 'æ–°æ‰‹', color: 'bg-amber-500', icon: 'ğŸŒŸ' },
                    general: { label: 'ç¶œåˆ', color: 'bg-stone-500', icon: 'ğŸ“–' }
                };
                return categories[category] || categories.general;
            };

            const catInfo = getCategoryInfo(guide.category);

            return (
                <motion.div
                    whileHover={{ y: -6, boxShadow: '0 20px 40px -12px rgba(0,0,0,0.15)' }}
                    onClick={onClick}
                    className="bg-white rounded-2xl overflow-hidden border border-stone-200 cursor-pointer group transition-all duration-300 shadow-sm hover:border-stone-300"
                >
                    {/* ç¸®åœ–ï¼šå·´å“ˆé¢¨æ ¼å¤§åœ– */}
                    {guide.thumbnail ? (
                        <div className="h-44 md:h-48 bg-stone-100 overflow-hidden relative">
                            <img src={guide.thumbnail} alt={guide.title} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
                        </div>
                    ) : (
                        <div className="h-44 md:h-48 bg-gradient-to-br from-stone-100 via-stone-50 to-amber-50 flex items-center justify-center">
                            <span className="text-5xl opacity-30">{catInfo.icon}</span>
                        </div>
                    )}

                    <div className="p-5 space-y-3">
                        <div className="flex items-center gap-2 flex-wrap">
                            {guide.is_pinned && (
                                <span className="inline-flex items-center gap-1 bg-orange-500 text-white px-2.5 py-1 rounded-lg text-xs font-bold">ç½®é ‚</span>
                            )}
                            <span className={`inline-flex items-center gap-1.5 ${catInfo.color} text-white px-2.5 py-1 rounded-lg text-xs font-semibold`}>
                                {catInfo.icon} {catInfo.label}
                            </span>
                        </div>

                        <h3 className="font-bold text-stone-800 text-lg leading-snug line-clamp-2 group-hover:text-amber-600 transition-colors min-h-[3.5rem]">
                            {guide.title}
                        </h3>

                        <div className="flex items-center justify-between pt-3 border-t border-stone-100 text-sm text-stone-500">
                            <div className="flex items-center gap-4">
                                <span className="flex items-center gap-1.5">
                                    <User size={14} className="text-stone-400" />
                                    {guide.author_name || 'ç®¡ç†å“¡'}
                                </span>
                                <span className="flex items-center gap-1.5">
                                    <Eye size={14} />
                                    {guide.views || 0}
                                </span>
                                <span className="flex items-center gap-1.5">
                                    <Heart size={14} />
                                    {guide.likes || 0}
                                </span>
                            </div>
                            <span className="text-stone-400 tabular-nums">
                                {new Date(guide.publish_date || guide.created_at).toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' })}
                            </span>
                        </div>
                    </div>
                </motion.div>
            );
        };

        // æ”»ç•¥è©³ç´°é é¢ï¼šå·´å“ˆé¢¨æ ¼ã€å°é¢ã€ä½œè€…å€ã€ç›®éŒ„ã€èˆ’é©æ’ç‰ˆ
        const GuideDetailView = ({ guide, onBack }) => {
            const contentRef = useRef(null);
            const [tocItems, setTocItems] = useState([]);

            useEffect(() => {
                if (!contentRef.current || !guide.content) return;
                const root = contentRef.current;
                const headings = root.querySelectorAll('h1, h2, h3');
                const items = [];
                headings.forEach((el, i) => {
                    const id = `heading-${i}`;
                    el.id = id;
                    const level = parseInt(el.tagName[1]);
                    items.push({ id, text: el.textContent?.slice(0, 40) || '', level });
                });
                root.querySelectorAll('img').forEach((img) => {
                    img.loading = 'lazy';
                    img.decoding = 'async';
                });
                setTocItems(items);
            }, [guide.content]);

            const getCategoryInfo = (category) => {
                const categories = {
                    event: { label: 'æ´»å‹•', color: 'bg-orange-500', icon: 'ğŸ‰' },
                    pve: { label: 'PVE', color: 'bg-blue-500', icon: 'âš”ï¸' },
                    pvp: { label: 'PVP', color: 'bg-emerald-500', icon: 'ğŸ›¡ï¸' },
                    beginner: { label: 'æ–°æ‰‹', color: 'bg-amber-500', icon: 'ğŸŒŸ' },
                    general: { label: 'ç¶œåˆ', color: 'bg-stone-500', icon: 'ğŸ“–' }
                };
                return categories[category] || categories.general;
            };

            const catInfo = getCategoryInfo(guide.category);

            return (
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    className="pt-24 md:pt-32 pb-36 md:pb-32 px-4 md:px-6 lg:px-8 min-h-screen bg-stone-50"
                >
                    <div className="max-w-4xl mx-auto">
                        {/* éºµåŒ…å±‘ */}
                        <nav className="flex items-center gap-2 text-sm text-stone-500 mb-6">
                            <button onClick={onBack} className="hover:text-amber-600 font-medium transition-colors">æ´»å‹•æ”»ç•¥</button>
                            <span>/</span>
                            <span className={`${catInfo.color} text-white px-2 py-0.5 rounded text-xs font-semibold`}>{catInfo.icon} {catInfo.label}</span>
                        </nav>

                        <motion.div initial={{ y: 20 }} animate={{ y: 0 }} className="space-y-8">
                            {/* å°é¢åœ–ï¼ˆå·´å“ˆé¢¨æ ¼ï¼‰ */}
                            {guide.thumbnail && (
                                <div className="rounded-2xl overflow-hidden shadow-xl aspect-video bg-stone-200">
                                    <img src={guide.thumbnail} alt={guide.title} className="w-full h-full object-cover" />
                                </div>
                            )}

                            {/* æ¨™é¡Œ + ä½œè€…å€ */}
                            <div className="bg-white rounded-2xl p-6 md:p-8 shadow-sm border border-stone-100">
                                <div className="flex items-center gap-2 mb-4">
                                    <span className={`${catInfo.color} text-white px-3 py-1.5 rounded-lg text-sm font-semibold`}>{catInfo.icon} {catInfo.label}</span>
                                    {guide.is_pinned && <Star size={16} fill="#f97316" className="text-orange-500" />}
                                </div>
                                <h1 className="text-3xl md:text-4xl font-black text-stone-900 mb-6 leading-snug">
                                    {guide.title}
                                </h1>
                                <div className="flex flex-wrap items-center gap-4 py-4 border-y border-stone-100">
                                    <div className="flex items-center gap-3">
                                        <div className="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center shrink-0">
                                            <User size={24} className="text-amber-600" />
                                        </div>
                                        <div>
                                            <p className="font-bold text-stone-800">{guide.author_name || 'ç®¡ç†å“¡'}</p>
                                            <p className="text-sm text-stone-500">{new Date(guide.publish_date || guide.created_at).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-4 text-sm text-stone-500 ml-auto flex-wrap">
                                        <span className="flex items-center gap-1.5"><Eye size={18} />{guide.views || 0} æ¬¡ç€è¦½</span>
                                        <span className="flex items-center gap-1.5"><Heart size={18} />{guide.likes || 0} äººè¦ºå¾—æœ‰å¹«åŠ©</span>
                                        <button
                                            onClick={() => {
                                                const url = `${window.location.origin}/guides/${guide.id}`;
                                                navigator.clipboard?.writeText(url).then(() => showToast('é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success')).catch(() => showToast('ç„¡æ³•è¤‡è£½ï¼Œè«‹æ‰‹å‹•è¤‡è£½ç¶²å€åˆ—', 'error'));
                                            }}
                                            className="flex items-center gap-1.5 text-stone-500 hover:text-amber-600 transition-colors font-medium"
                                            title="è¤‡è£½åˆ†äº«é€£çµ"
                                        >
                                            <Share2 size={18} />
                                            åˆ†äº«
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* ç›®éŒ„ + å…§å®¹å€åŸŸï¼šå·´å“ˆé¢¨æ ¼ã€èˆ’é©æ’ç‰ˆ */}
                            <div className="flex flex-col lg:flex-row gap-8">
                                {tocItems.length > 0 && (
                                    <aside className="lg:w-64 shrink-0">
                                        <div className="lg:sticky lg:top-24 bg-white rounded-2xl p-5 border border-stone-100 shadow-sm">
                                            <h3 className="font-bold text-stone-800 mb-3 text-sm">ç›®éŒ„</h3>
                                            <nav className="space-y-2">
                                                {tocItems.map((item, i) => (
                                                    <button
                                                        key={item.id}
                                                        type="button"
                                                        onClick={() => {
                                                            const el = document.getElementById(item.id);
                                                            el?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                                        }}
                                                        className={`block w-full text-left text-stone-600 hover:text-amber-600 transition-colors leading-snug truncate ${item.level === 1 ? 'font-semibold' : item.level === 2 ? 'pl-3 text-sm' : 'pl-5 text-sm'}`}
                                                        style={{ paddingLeft: item.level > 1 ? `${(item.level - 1) * 0.75}rem` : 0 }}
                                                    >
                                                        {item.text}{item.text.length >= 40 ? 'â€¦' : ''}
                                                    </button>
                                                ))}
                                            </nav>
                                        </div>
                                    </aside>
                                )}
                                <article className="flex-1 min-w-0 overflow-x-auto" style={{ WebkitOverflowScrolling: 'touch' }}>
                                    {(function() {
                                        const html = (guide.content || '').trim();
                                        const isEmpty = !html || html === '<p><br></p>' || html === '<p></p>';
                                        if (isEmpty) {
                                            return (
                                                <div className="bg-white rounded-2xl px-4 sm:px-6 md:px-10 py-12 md:py-16 shadow-sm border border-stone-100 text-center">
                                                    <p className="text-stone-500 text-lg mb-2">æ­¤æ”»ç•¥å°šç„¡å…§å®¹</p>
                                                    <p className="text-stone-400 text-sm">è‹¥æ‚¨å·²ä¸Šå‚³å…§å®¹å»æœªé¡¯ç¤ºï¼Œè«‹ç”¨é›»è…¦ç‰ˆå¾Œå°ç¢ºèªæ˜¯å¦å·²å„²å­˜ä¸¦æ”¹ç‚ºã€Œç™¼å¸ƒã€</p>
                                                </div>
                                            );
                                        }
                                        return (
                                            <div
                                                ref={contentRef}
                                                className="bg-white rounded-2xl px-4 sm:px-6 md:px-10 py-8 md:py-14 shadow-sm border border-stone-100 guide-content"
                                                style={{ overflowWrap: 'break-word', minHeight: '120px' }}
                                                dangerouslySetInnerHTML={{ __html: guide.content }}
                                            />
                                        );
                                    })()}
                                </article>
                            </div>
                            <style>{`
                                .guide-content {
                                    font-size: 1.125rem;
                                    line-height: 2.2;
                                    color: #2d2520;
                                    letter-spacing: 0.02em;
                                }
                                .guide-content p {
                                    margin-bottom: 2em;
                                    color: #44403c;
                                }
                                .guide-content h1, .guide-content h2, .guide-content h3 {
                                    scroll-margin-top: 6rem;
                                }
                                .guide-content h1 {
                                    font-size: 2.25em;
                                    font-weight: 900;
                                    color: #1a1614;
                                    margin-top: 2.5em;
                                    margin-bottom: 1.2em;
                                    border-bottom: 3px solid #fdcb6e;
                                    padding-bottom: 0.75em;
                                }
                                .guide-content h2 {
                                    font-size: 1.875em;
                                    font-weight: 800;
                                    color: #2d2520;
                                    margin-top: 2.25em;
                                    margin-bottom: 1em;
                                }
                                .guide-content h3 {
                                    font-size: 1.5em;
                                    font-weight: 700;
                                    color: #44403c;
                                    margin-top: 2em;
                                    margin-bottom: 1em;
                                }
                                .guide-content img {
                                    border-radius: 16px;
                                    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
                                    margin: 3em auto;
                                    max-width: 100%;
                                    display: block;
                                }
                                .guide-content ul, .guide-content ol {
                                    margin: 2em 0;
                                    padding-left: 2.5em;
                                }
                                .guide-content li {
                                    margin-bottom: 1em;
                                    color: #44403c;
                                    line-height: 1.8;
                                }
                                .guide-content strong {
                                    color: #1a1614;
                                    font-weight: 700;
                                }
                                .guide-content .guide-excel-table {
                                    overflow-x: auto;
                                    margin: 2em 0;
                                    border-radius: 12px;
                                    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
                                }
                                .guide-content table {
                                    width: 100%;
                                    border-collapse: collapse;
                                    margin: 0;
                                    font-size: 0.95em;
                                    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
                                    border-radius: 12px;
                                    overflow: hidden;
                                }
                                .guide-content th, .guide-content td {
                                    border: 1px solid #e7e5e4;
                                    padding: 0.75em 1em;
                                    text-align: left;
                                    color: #44403c;
                                }
                                .guide-content th {
                                    background: #fef3c7;
                                    font-weight: 700;
                                    color: #1a1614;
                                }
                                .guide-content tr:nth-child(even) { background: #fafaf9; }
                                .guide-content blockquote {
                                    border-left: 5px solid #fdcb6e;
                                    background: #fffbf0;
                                    padding: 1.5em 2em;
                                    margin: 2.5em 0;
                                    border-radius: 12px;
                                    color: #57534e;
                                    font-style: italic;
                                }
                                @media (max-width: 768px) {
                                    .guide-content {
                                        font-size: 16px;
                                        line-height: 2;
                                        overflow-wrap: break-word;
                                        word-break: break-word;
                                    }
                                    .guide-content h1 {
                                        font-size: 1.75em;
                                        margin-top: 2em;
                                    }
                                    .guide-content h2 {
                                        font-size: 1.5em;
                                        margin-top: 1.75em;
                                    }
                                    .guide-content img {
                                        margin: 2em auto;
                                        max-width: 100%;
                                        height: auto;
                                    }
                                    .guide-content table {
                                        display: block;
                                        overflow-x: auto;
                                        -webkit-overflow-scrolling: touch;
                                    }
                                }
                            `}</style>

                            {/* åº•éƒ¨ï¼šè¿”å›æŒ‰éˆ• */}
                            <div className="flex justify-center pt-6">
                                <button
                                    onClick={onBack}
                                    className="inline-flex items-center gap-2 text-stone-700 hover:text-amber-600 font-bold px-8 py-4 rounded-2xl bg-white hover:bg-stone-50 border-2 border-stone-200 hover:border-amber-300 transition-all duration-300 shadow-sm hover:shadow-md min-h-[52px]"
                                >
                                    <ArrowLeft size={20} />
                                    <span>è¿”å›æ”»ç•¥åˆ—è¡¨</span>
                                </button>
                            </div>
                        </motion.div>
                    </div>
                </motion.div>
            );
        };

        // æ¢åˆ—å¼æ”»ç•¥é …ç›®ï¼šå·´å“ˆé¢¨æ ¼ã€èˆ’é©æ’ç‰ˆ
        const GuideListItem = ({ guide, onClick }) => {
            const getCategoryInfo = (category) => {
                const categories = {
                    event: { label: 'æ´»å‹•', color: 'bg-orange-500', icon: 'ğŸ‰' },
                    pve: { label: 'PVE', color: 'bg-blue-500', icon: 'âš”ï¸' },
                    pvp: { label: 'PVP', color: 'bg-emerald-500', icon: 'ğŸ›¡ï¸' },
                    beginner: { label: 'æ–°æ‰‹', color: 'bg-amber-500', icon: 'ğŸŒŸ' },
                    general: { label: 'ç¶œåˆ', color: 'bg-stone-500', icon: 'ğŸ“–' }
                };
                return categories[category] || categories.general;
            };

            const catInfo = getCategoryInfo(guide.category);

            return (
                <motion.div
                    whileHover={{ x: 6 }}
                    onClick={onClick}
                    className="bg-white rounded-2xl p-5 border border-stone-200 cursor-pointer hover:border-stone-300 hover:shadow-lg transition-all duration-300 flex gap-5 items-center group min-h-[100px]"
                >
                    {/* ç¸®åœ– */}
                    <div className="w-24 h-24 md:w-28 md:h-28 rounded-xl overflow-hidden shrink-0 bg-stone-100 flex-shrink-0">
                        {guide.thumbnail ? (
                            <img src={guide.thumbnail} alt={guide.title} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" />
                        ) : (
                            <div className="w-full h-full flex items-center justify-center bg-gradient-to-br from-stone-100 to-amber-50">
                                <span className="text-3xl opacity-50">{catInfo.icon}</span>
                            </div>
                        )}
                    </div>

                    <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-2">
                            {guide.is_pinned && (
                                <Star size={14} fill="#f97316" className="text-orange-500 shrink-0" />
                            )}
                            <span className={`${catInfo.color} text-white px-2.5 py-1 rounded-lg text-xs font-semibold`}>
                                {catInfo.icon} {catInfo.label}
                            </span>
                        </div>
                        <h3 className="font-bold text-stone-800 text-lg mb-2 line-clamp-2 group-hover:text-amber-600 transition-colors leading-snug">
                            {guide.title}
                        </h3>
                        <div className="flex items-center gap-4 text-sm text-stone-500">
                            <span className="flex items-center gap-1.5"><User size={14} />{guide.author_name || 'ç®¡ç†å“¡'}</span>
                            <span className="flex items-center gap-1.5"><Eye size={14} />{guide.views || 0}</span>
                            <span className="flex items-center gap-1.5"><Heart size={14} />{guide.likes || 0}</span>
                            <span className="ml-auto tabular-nums">{new Date(guide.publish_date || guide.created_at).toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' })}</span>
                        </div>
                    </div>
                </motion.div>
            );
        };

        // æ”»ç•¥å‰å°é é¢
        const GuidesPage = () => {
            const { id: guideIdFromUrl } = useParams();
            const navigate = useNavigate();
            const [guides, setGuides] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedGuide, setSelectedGuide] = useState(null);
            const [loadingDetail, setLoadingDetail] = useState(false);
            const [loadingGuideId, setLoadingGuideId] = useState(null);
            const [category, setCategory] = useState('all');
            const [viewMode, setViewMode] = useState(localStorage.getItem('guidesViewMode') || 'grid');
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                loadGuides();
            }, [category]);

            // å¾ URL è¼‰å…¥æŒ‡å®šæ”»ç•¥ï¼ˆå€‹åˆ¥é€£çµåˆ†äº«ç”¨ï¼‰
            useEffect(() => {
                if (!guideIdFromUrl) return;
                const loadFromUrl = async () => {
                    setLoadingGuideId(guideIdFromUrl);
                    const fullGuide = await fetchGuideDetail(guideIdFromUrl);
                    setLoadingGuideId(null);
                    if (fullGuide) {
                        setSelectedGuide(fullGuide);
                        incrementViews(guideIdFromUrl);
                    } else {
                        navigate('/guides', { replace: true });
                    }
                };
                loadFromUrl();
            }, [guideIdFromUrl]);

            const handleViewModeChange = (mode) => {
                setViewMode(mode);
                localStorage.setItem('guidesViewMode', mode);
            };

            const loadGuides = async (retries = 2) => {
                setLoading(true);
                try {
                    for (let attempt = 0; attempt <= retries; attempt++) {
                        try {
                            let query = supabase
                                .from('guides')
                                .select('id, title, thumbnail, category, author_name, views, likes, publish_date, created_at, is_pinned')
                                .eq('status', 'published')
                                .order('is_pinned', { ascending: false })
                                .order('publish_date', { ascending: false });

                            if (category !== 'all') {
                                query = query.eq('category', category);
                            }

                            const { data, error } = await query;

                            if (error) throw error;
                            setGuides(data || []);
                            return;
                        } catch (error) {
                            console.error('è¼‰å…¥æ”»ç•¥å¤±æ•—:', error);
                            if (attempt === retries) {
                                const msg = error?.message || '';
                                showToast('è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦' + (msg ? 'ï¼š' + msg.slice(0, 40) : ''), 'error');
                            } else {
                                await new Promise(r => setTimeout(r, 800));
                            }
                        }
                    }
                } finally {
                    setLoading(false);
                }
            };

            const fetchGuideDetail = async (guideId, retries = 2) => {
                setLoadingDetail(true);
                for (let attempt = 0; attempt <= retries; attempt++) {
                    try {
                        const { data, error } = await supabase.from('guides').select('*').eq('id', guideId).single();
                        if (error) throw error;
                        setLoadingDetail(false);
                        return data;
                    } catch (err) {
                        console.error('è¼‰å…¥æ”»ç•¥å…§å®¹å¤±æ•—:', err);
                        if (attempt === retries) {
                            showToast('è¼‰å…¥å…§å®¹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦', 'error');
                            setLoadingDetail(false);
                            return null;
                        }
                        await new Promise(r => setTimeout(r, 600));
                    }
                }
                setLoadingDetail(false);
                return null;
            };

            useEffect(() => {
                const handler = () => loadGuides();
                window.addEventListener('storage-update', handler);
                return () => window.removeEventListener('storage-update', handler);
            }, [category]);

            const filteredGuides = guides.filter(g => {
                if (!searchTerm.trim()) return true;
                const term = searchTerm.toLowerCase();
                return (g.title && g.title.toLowerCase().includes(term)) ||
                       (g.author_name && g.author_name.toLowerCase().includes(term));
            });

            const incrementViews = async (guideId) => {
                try {
                    await supabase.rpc('increment_guide_views', { guide_id: guideId });
                } catch (error) {
                    console.error('æ›´æ–°ç€è¦½æ¬¡æ•¸å¤±æ•—:', error);
                }
            };

            const handleGuideClick = (guide) => {
                navigate(`/guides/${guide.id}`);
            };

            const retryLoadDetail = async () => {
                const id = guideIdFromUrl || loadingGuideId;
                if (!id) return;
                setLoadingGuideId(id);
                const fullGuide = await fetchGuideDetail(id);
                setLoadingGuideId(null);
                if (fullGuide) {
                    setSelectedGuide(fullGuide);
                    incrementViews(id);
                }
            };

            if (loadingDetail) {
                return (
                    <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="pt-32 md:pt-44 pb-36 min-h-screen flex flex-col items-center justify-center gap-6 px-4">
                        <LoadingSpinner message="è¼‰å…¥æ”»ç•¥å…§å®¹ä¸­..." />
                        <p className="text-sm text-stone-500">è‹¥è¼‰å…¥è¼ƒä¹…ï¼Œå¯èƒ½æ˜¯å…§å®¹è¼ƒå¤§æˆ–ç¶²è·¯è¼ƒæ…¢</p>
                        <button onClick={retryLoadDetail} className="px-5 py-2.5 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-bold text-sm transition-colors">
                            é‡è©¦è¼‰å…¥
                        </button>
                    </motion.div>
                );
            }
            if (selectedGuide) {
                return <GuideDetailView guide={selectedGuide} onBack={() => { setSelectedGuide(null); navigate('/guides'); }} />;
            }

            return (
                <motion.div
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0 }}
                    className="pt-32 md:pt-44 pb-36 md:pb-24 px-4 md:px-6 min-h-screen bg-gradient-to-b from-stone-50 via-white to-stone-50"
                >
                    {/* æ¨™é¡Œå€ï¼šå·´å“ˆé¢¨æ ¼ã€èˆ’é©é–“è· */}
                    <div className="max-w-7xl mx-auto mb-12">
                        <div className="text-center mb-10">
                            <h1 className="text-4xl md:text-5xl font-black text-stone-800 mb-3 tracking-tight">æ´»å‹•æ”»ç•¥</h1>
                            <p className="text-lg text-stone-600 font-medium max-w-2xl mx-auto leading-relaxed">
                                æœ€æ–°æ´»å‹•ã€éŠæˆ²æŠ€å·§ã€æ”»ç•¥å¿ƒå¾—ä¸€æ¬¡æŒæ¡
                            </p>
                        </div>

                        {/* æœå°‹ + åˆ†é¡ + æª¢è¦–åˆ‡æ›ï¼šå·´å“ˆé¢¨æ ¼ */}
                        <div className="space-y-4">
                            <div className="flex flex-col sm:flex-row gap-4">
                                <div className="relative flex-1">
                                    <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-stone-400" size={20} />
                                    <input
                                        type="text"
                                        placeholder="æœå°‹æ”»ç•¥æ¨™é¡Œã€å…§å®¹ã€ä½œè€…..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full pl-12 pr-4 py-3.5 rounded-2xl border-2 border-stone-200 bg-white text-stone-800 placeholder-stone-400 focus:border-gold-500 focus:ring-2 focus:ring-gold-500/20 outline-none transition-all text-base"
                                    />
                                </div>
                                <div className="flex items-center gap-2 bg-stone-100/80 p-1.5 rounded-2xl shrink-0">
                                    <button
                                        onClick={() => handleViewModeChange('grid')}
                                        className={`px-5 py-3 rounded-xl font-semibold text-sm transition-all flex items-center gap-2 min-h-[48px] ${viewMode === 'grid' ? 'bg-white text-stone-800 shadow-md' : 'text-stone-500 hover:text-stone-700'}`}
                                        title="å¡ç‰‡æª¢è¦–"
                                    >
                                        <LayoutGrid size={18} />
                                        å¡ç‰‡
                                    </button>
                                    <button
                                        onClick={() => handleViewModeChange('list')}
                                        className={`px-5 py-3 rounded-xl font-semibold text-sm transition-all flex items-center gap-2 min-h-[48px] ${viewMode === 'list' ? 'bg-white text-stone-800 shadow-md' : 'text-stone-500 hover:text-stone-700'}`}
                                        title="æ¢åˆ—æª¢è¦–"
                                    >
                                        <List size={18} />
                                        æ¢åˆ—
                                    </button>
                                </div>
                            </div>
                            <div className="flex flex-wrap gap-2">
                                {[
                                    { id: 'all', label: 'å…¨éƒ¨', icon: 'ğŸ“š' },
                                    { id: 'event', label: 'æ´»å‹•', icon: 'ğŸ‰' },
                                    { id: 'pve', label: 'PVE', icon: 'âš”ï¸' },
                                    { id: 'pvp', label: 'PVP', icon: 'ğŸ›¡ï¸' },
                                    { id: 'beginner', label: 'æ–°æ‰‹', icon: 'ğŸŒŸ' },
                                    { id: 'general', label: 'ç¶œåˆ', icon: 'ğŸ“–' }
                                ].map(cat => (
                                    <button
                                        key={cat.id}
                                        onClick={() => setCategory(cat.id)}
                                        className={`px-5 py-2.5 rounded-xl font-semibold text-sm transition-all min-h-[44px] ${
                                            category === cat.id
                                                ? 'bg-stone-800 text-white shadow-md'
                                                : 'bg-white/80 text-stone-600 hover:bg-stone-100 border border-stone-200'
                                        }`}
                                    >
                                        <span className="mr-1.5">{cat.icon}</span>
                                        {cat.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {loading ? (
                        <LoadingSpinner message="è¼‰å…¥æ”»ç•¥ä¸­..." />
                    ) : guides.length === 0 ? (
                        <div className="max-w-2xl mx-auto text-center py-20">
                            <div className="bg-white rounded-3xl p-16 border-2 border-stone-200 shadow-xl">
                                <div className="w-24 h-24 mx-auto bg-stone-100 rounded-full flex items-center justify-center mb-6">
                                    <BookOpen size={48} className="text-stone-300" />
                                </div>
                                <p className="text-stone-700 font-black text-2xl mb-3">ç›®å‰æ²’æœ‰æ”»ç•¥</p>
                                <p className="text-stone-500 text-base">æ•¬è«‹æœŸå¾…ç²¾å½©å…§å®¹ï¼</p>
                            </div>
                        </div>
                    ) : filteredGuides.length === 0 ? (
                        <div className="max-w-2xl mx-auto text-center py-20">
                            <div className="bg-white rounded-3xl p-16 border-2 border-stone-200 shadow-lg">
                                <Search size={48} className="mx-auto text-stone-300 mb-4" />
                                <p className="text-stone-700 font-bold text-xl mb-2">æŸ¥ç„¡ç¬¦åˆã€Œ{searchTerm}ã€çš„æ”»ç•¥</p>
                                <p className="text-stone-500 text-base">è«‹å˜—è©¦å…¶ä»–é—œéµå­—æˆ–èª¿æ•´åˆ†é¡</p>
                            </div>
                        </div>
                    ) : (
                        <div className="max-w-7xl mx-auto">
                            {viewMode === 'grid' ? (
                                <div className="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                    {filteredGuides.map(guide => (
                                        <GuideCard key={guide.id} guide={guide} onClick={() => handleGuideClick(guide)} />
                                    ))}
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {filteredGuides.map(guide => (
                                        <GuideListItem key={guide.id} guide={guide} onClick={() => handleGuideClick(guide)} />
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                </motion.div>
            );
        };

        // å¯Œæ–‡æœ¬ç·¨è¼¯å™¨çµ„ä»¶ï¼ˆQuill.jsï¼‰
        const GuideEditor = ({ guide, currentUser, onClose }) => {
            const [title, setTitle] = useState(guide?.title || '');
            const [authorName, setAuthorName] = useState(guide?.author_name || 'ç®¡ç†å“¡');
            const [category, setCategory] = useState(guide?.category || 'general');
            const [status, setStatus] = useState(guide?.status || 'published');
            const [isPinned, setIsPinned] = useState(guide?.is_pinned || false);
            const [saving, setSaving] = useState(false);
            const quillRef = useRef(null);
            const editorRef = useRef(null);
            const lastExcelHtmlRef = useRef(null);

            useEffect(() => {
                if (!editorRef.current && quillRef.current && window.Quill) {
                    if (!window.__excelTableBlotRegistered) {
                        var BlockEmbed = window.Quill.import('blots/block/embed');
                        class ExcelTableBlot extends BlockEmbed {
                            static create(value) {
                                var node = super.create();
                                node.setAttribute('contenteditable', 'false');
                                node.classList.add('guide-excel-table');
                                node.innerHTML = value || '';
                                return node;
                            }
                            static value(node) { return node.innerHTML; }
                        }
                        ExcelTableBlot.blotName = 'excelTable';
                        ExcelTableBlot.tagName = 'div';
                        window.Quill.register(ExcelTableBlot);
                        window.__excelTableBlotRegistered = true;
                    }
                    const quill = new window.Quill(quillRef.current, {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'color': [] }, { 'background': [] }],
                                [{ 'align': [] }],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                ['blockquote', 'code-block'],
                                ['link', 'image'],
                                ['clean']
                            ]
                        },
                        placeholder: 'åœ¨æ­¤è²¼ä¸Šæ‚¨çš„å…§å®¹...\næ”¯æ´å¾ Word ç›´æ¥è¤‡è£½è²¼ä¸Šï¼ˆCtrl+Vï¼‰'
                    });

                    if (guide?.content) {
                        quill.setSelection(0);
                        quill.deleteText(0, quill.getLength());
                        if (guide.content.includes('<table')) {
                            quill.root.innerHTML = guide.content;
                        } else {
                            quill.clipboard.dangerouslyPasteHTML(0, guide.content);
                        }
                    }

                    quill.getModule('toolbar').addHandler('image', () => {
                        const input = document.createElement('input');
                        input.setAttribute('type', 'file');
                        input.setAttribute('accept', 'image/*');
                        input.click();

                        input.onchange = async () => {
                            const file = input.files[0];
                            if (!file) return;
                            const maxW = 1200;
                            const quality = 0.82;
                            const isPng = file.type === 'image/png';
                            const compressImage = (blob) => new Promise((resolve) => {
                                const img = new Image();
                                const url = URL.createObjectURL(blob);
                                img.onload = () => {
                                    URL.revokeObjectURL(url);
                                    if (img.width <= maxW && file.size < 250000) {
                                        resolve(blob);
                                        return;
                                    }
                                    const c = document.createElement('canvas');
                                    const scale = Math.min(1, maxW / img.width);
                                    c.width = Math.round(img.width * scale);
                                    c.height = Math.round(img.height * scale);
                                    const ctx = c.getContext('2d');
                                    ctx.drawImage(img, 0, 0, c.width, c.height);
                                    const mime = isPng ? 'image/png' : 'image/jpeg';
                                    c.toBlob((b) => resolve(b || blob), mime, isPng ? 0.9 : quality);
                                };
                                img.onerror = () => { URL.revokeObjectURL(url); resolve(blob); };
                                img.src = url;
                            });
                            try {
                                const compressed = await compressImage(file);
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    const range = quill.getSelection();
                                    quill.insertEmbed(range?.index ?? 0, 'image', e.target.result);
                                };
                                reader.readAsDataURL(compressed);
                            } catch (err) {
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    const range = quill.getSelection();
                                    quill.insertEmbed(range?.index ?? 0, 'image', e.target.result);
                                };
                                reader.readAsDataURL(file);
                            }
                        };
                    });

                    quill.root.addEventListener('paste', async (e) => {
                        const cd = e.clipboardData;
                        if (!cd) return;
                        for (let i = 0; i < cd.items.length; i++) {
                            const item = cd.items[i];
                            if (item.type.indexOf('image') !== 0) continue;
                            e.preventDefault();
                            const file = item.getAsFile();
                            if (!file) return;
                            const maxW = 1200, quality = 0.82;
                            const compressBlob = (blob) => new Promise((resolve) => {
                                const img = new Image();
                                const url = URL.createObjectURL(blob);
                                img.onload = () => {
                                    URL.revokeObjectURL(url);
                                    if (img.width <= maxW && blob.size < 250000) return resolve(blob);
                                    const c = document.createElement('canvas');
                                    const scale = Math.min(1, maxW / img.width);
                                    c.width = Math.round(img.width * scale);
                                    c.height = Math.round(img.height * scale);
                                    const ctx = c.getContext('2d');
                                    ctx.drawImage(img, 0, 0, c.width, c.height);
                                    c.toBlob((b) => resolve(b || blob), 'image/jpeg', quality);
                                };
                                img.onerror = () => { URL.revokeObjectURL(url); resolve(blob); };
                                img.src = url;
                            });
                            try {
                                const compressed = await compressBlob(file);
                                const reader = new FileReader();
                                reader.onload = (ev) => {
                                    const idx = quill.getSelection(true)?.index ?? quill.getLength();
                                    quill.insertEmbed(idx, 'image', ev.target.result);
                                };
                                reader.readAsDataURL(compressed);
                            } catch (err) {
                                const reader = new FileReader();
                                reader.onload = (ev) => {
                                    const idx = quill.getSelection(true)?.index ?? quill.getLength();
                                    quill.insertEmbed(idx, 'image', ev.target.result);
                                };
                                reader.readAsDataURL(file);
                            }
                            return;
                        }
                        const text = cd.getData('text/plain') || '';
                        if (!text || text.indexOf('\t') === -1) return;
                        var rows = text.split(/\r?\n/).filter(function(r) { return r.length; });
                        if (rows.length === 0) return;
                        var cells = rows.map(function(row) { return row.split('\t'); });
                        var maxCols = Math.max.apply(null, cells.map(function(r) { return r.length; }));
                        var html = '<div class="guide-excel-table"><table><tbody>';
                        cells.forEach(function(row, rowIndex) {
                            html += '<tr>';
                            for (var i = 0; i < maxCols; i++) {
                                var cell = (row[i] || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                                var isHead = rowIndex === 0;
                                html += (isHead ? '<th>' : '<td>') + cell + (isHead ? '</th>' : '</td>');
                            }
                            html += '</tr>';
                        });
                        html += '</tbody></table></div>';
                        e.preventDefault();
                        quill.clipboard.dangerouslyPasteHTML(quill.getSelection(true).index, html);
                    });

                    editorRef.current = quill;
                }
            }, [guide]);

            const setEditorHtml = (html) => {
                const q = editorRef.current;
                if (!q || !q.root) return;
                lastExcelHtmlRef.current = null;
                q.focus();
                q.setSelection(0);
                q.deleteText(0, q.getLength());
                q.clipboard.dangerouslyPasteHTML(0, html || '<p><br></p>');
                setTimeout(function() { q.root.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
            };

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const name = file.name.toLowerCase();

                if (name.endsWith('.docx')) {
                    try {
                        showToast('æ­£åœ¨è™•ç† Word æ–‡ä»¶â€¦', 'info');
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await window.mammoth.convertToHtml({ arrayBuffer });
                        setTimeout(function() { setEditorHtml(result.value); }, 0);
                        showToast('Word å·²æˆåŠŸè¼‰å…¥', 'success');
                        if (result.messages?.length) console.log('è½‰æ›è¨Šæ¯:', result.messages);
                    } catch (err) {
                        console.error(err);
                        showToast('Word ä¸Šå‚³å¤±æ•—ï¼š' + (err.message || String(err)), 'error');
                    }
                } else if (name.endsWith('.pdf')) {
                    try {
                        showToast('æ­£åœ¨è™•ç† PDFï¼ˆè½‰æˆåœ–ç‰‡ä¿ç•™ç‰ˆé¢ï¼‰â€¦', 'info');
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        const numPages = Math.min(pdf.numPages, 30);
                        const scale = 1.5;
                        const imgHtml = [];
                        for (let i = 1; i <= numPages; i++) {
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale });
                            const canvas = document.createElement('canvas');
                            canvas.width = viewport.width;
                            canvas.height = viewport.height;
                            const ctx = canvas.getContext('2d');
                            await page.render({ canvasContext: ctx, viewport }).promise;
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
                            imgHtml.push('<p class="pdf-page"><img src="' + dataUrl + '" alt="PDF ç¬¬' + i + 'é " style="max-width:100%;height:auto;display:block;margin:1em 0;" /></p>');
                        }
                        const html = imgHtml.join('');
                        setTimeout(function() { setEditorHtml(html); }, 0);
                        showToast('PDF å·²æˆåŠŸè¼‰å…¥ï¼ˆ' + numPages + ' é ï¼Œä¿ç•™åŸæ¨£ï¼‰', 'success');
                    } catch (err) {
                        console.error(err);
                        showToast('PDF ä¸Šå‚³å¤±æ•—ï¼š' + (err.message || String(err)), 'error');
                    }
                } else if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
                    try {
                        showToast('æ­£åœ¨è™•ç† Excelï¼ˆè½‰æˆåœ–ç‰‡ä¿ç•™è¡¨æ ¼ï¼‰â€¦', 'info');
                        const arrayBuffer = await file.arrayBuffer();
                        const wb = window.XLSX.read(arrayBuffer, { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const tableHtml = window.XLSX.utils.sheet_to_html(ws, { id: 'xlsx-table', editable: false });
                        var q = editorRef.current;
                        if (!q || !q.root || !tableHtml) {
                            showToast('Excel å·²æˆåŠŸè¼‰å…¥ï¼ˆä¿ç•™åŸæ¨£ï¼‰', 'success');
                            return;
                        }
                        var wrap = document.createElement('div');
                        wrap.style.cssText = 'position:fixed;left:-9999px;top:0;width:800px;padding:12px;background:#fff;font-size:14px;';
                        wrap.innerHTML = '<style>table{border-collapse:collapse;width:100%;} th,td{border:1px solid #ddd;padding:6px 10px;text-align:left;} th{background:#fef3c7;font-weight:700;}</style><div class="guide-excel-table">' + tableHtml + '</div>';
                        document.body.appendChild(wrap);
                        if (typeof html2canvas !== 'undefined') {
                            html2canvas(wrap, { scale: 2, useCORS: true, logging: false }).then(function(canvas) {
                                document.body.removeChild(wrap);
                                var dataUrl = canvas.toDataURL('image/jpeg', 0.85);
                                lastExcelHtmlRef.current = '<p class="pdf-page"><img src="' + dataUrl + '" alt="Excel è¡¨æ ¼" style="max-width:100%;height:auto;display:block;margin:1em 0;" /></p>';
                                q.focus();
                                q.setSelection(0);
                                q.deleteText(0, q.getLength());
                                q.clipboard.dangerouslyPasteHTML(0, lastExcelHtmlRef.current);
                                setTimeout(function() { q.root.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
                                showToast('Excel å·²æˆåŠŸè¼‰å…¥ï¼ˆè¡¨æ ¼å·²è½‰ç‚ºåœ–ç‰‡ï¼‰', 'success');
                            }).catch(function(e) {
                                document.body.removeChild(wrap);
                                var wrapped = '<div class="guide-excel-table">' + tableHtml + '</div>';
                                lastExcelHtmlRef.current = wrapped;
                                q.root.innerHTML = wrapped;
                                q.focus();
                                showToast('Excel å·²æˆåŠŸè¼‰å…¥ï¼ˆè‹¥æœªè¦‹è¡¨æ ¼è«‹å†è©¦ä¸€æ¬¡ï¼‰', 'success');
                            });
                        } else {
                            document.body.removeChild(wrap);
                            var wrapped = '<div class="guide-excel-table">' + tableHtml + '</div>';
                            lastExcelHtmlRef.current = wrapped;
                            q.root.innerHTML = wrapped;
                            q.focus();
                            setTimeout(function() { q.root.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
                            showToast('Excel å·²æˆåŠŸè¼‰å…¥', 'success');
                        }
                    } catch (err) {
                        console.error(err);
                        showToast('Excel ä¸Šå‚³å¤±æ•—ï¼š' + (err.message || String(err)), 'error');
                    }
                } else {
                    showToast('è«‹ä¸Šå‚³ .docxã€.pdfã€.xlsx æˆ– .xls æ ¼å¼', 'warning');
                }
                event.target.value = '';
            };

            const handleSave = async () => {
                if (!title.trim()) {
                    showToast('è«‹è¼¸å…¥æ¨™é¡Œ', 'warning');
                    return;
                }
                if (!editorRef.current || !quillRef.current) {
                    showToast('ç·¨è¼¯å™¨å°šæœªå°±ç·’ï¼Œè«‹ç¨å¾Œå†è©¦', 'warning');
                    return;
                }
                let content = editorRef.current.root.innerHTML;
                if (lastExcelHtmlRef.current && !content.includes('<table')) {
                    content = lastExcelHtmlRef.current;
                }
                if (!content.trim() || content === '<p><br></p>') {
                    showToast('è«‹è¼¸å…¥å…§å®¹', 'warning');
                    return;
                }

                setSaving(true);

                try {
                    const guideData = {
                        title: title.trim(),
                        content,
                        category,
                        status,
                        is_pinned: isPinned,
                        author_id: currentUser.id,
                        author_name: authorName.trim() || 'ç®¡ç†å“¡'
                    };

                    if (guide) {
                        const { error } = await supabase
                            .from('guides')
                            .update(guideData)
                            .eq('id', guide.id);

                        if (error) throw error;
                        showToast(status === 'published' ? 'æ›´æ–°æˆåŠŸ' : 'å·²å„²å­˜ç‚ºè‰ç¨¿ï¼ˆå‰å°ä¸é¡¯ç¤ºï¼‰', 'success');
                    } else {
                        const { error } = await supabase
                            .from('guides')
                            .insert([guideData]);

                        if (error) throw error;
                        showToast(status === 'published' ? 'æ–°å¢æˆåŠŸï¼Œå‰å°å¯è¦‹' : 'å·²å„²å­˜ç‚ºè‰ç¨¿ï¼ˆè«‹æ”¹ç‚ºã€Œç™¼å¸ƒã€å¾Œå†å„²å­˜æ‰æœƒé¡¯ç¤ºï¼‰', status === 'draft' ? 'warning' : 'success');
                    }

                    onClose();
                } catch (error) {
                    console.error('å„²å­˜å¤±æ•—:', error);
                    const code = error?.code || error?.status;
                    const msg = error?.message || error?.details || (typeof error === 'string' ? error : '');
                    if (code === 403 || code === '403' || (msg && String(msg).includes('403'))) {
                        showToast('æ¬Šé™ä¸è¶³ (403)ï¼Œè«‹ç¢ºèªå·²ç™»å…¥å¾Œå°ä¸”å…·å‚™æ”»ç•¥ç·¨è¼¯æ¬Šé™', 'error');
                    } else if (code === '42501' || (msg && String(msg).includes('row-level security'))) {
                        showToast('æ¬Šé™ä¸è¶³ï¼šé•åè³‡æ–™è¡¨æ¬Šé™æ”¿ç­–ã€‚è«‹åŸ·è¡Œ database/migrations/030_guides_rls_use_jwt_metadata.sql ä¸¦ç¢ºèªå¸³è™Ÿ role ç‚º admin æˆ– super_admin å¾Œé‡æ–°ç™»å…¥', 'error');
                    } else {
                        showToast('å„²å­˜å¤±æ•—ï¼š' + (msg || 'è«‹ç¨å¾Œå†è©¦'), 'error');
                    }
                } finally {
                    setSaving(false);
                }
            };

            return (
                <div className="bg-stone-900 rounded-2xl p-6 border border-stone-700">
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-2xl font-black text-white">
                            {guide ? 'ç·¨è¼¯æ”»ç•¥' : 'æ–°å¢æ”»ç•¥'}
                        </h2>
                        <button
                            onClick={onClose}
                            className="text-stone-500 hover:text-stone-300"
                        >
                            <X size={24} />
                        </button>
                    </div>

                    <div className="space-y-6">
                        <div>
                            <label className="block text-stone-300 font-bold mb-2">æ¨™é¡Œ *</label>
                            <input
                                type="text"
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                placeholder="è«‹è¼¸å…¥æ”»ç•¥æ¨™é¡Œ"
                                className="w-full p-4 rounded-2xl bg-stone-800 border-2 border-stone-700 text-white placeholder-stone-500 focus:border-gold-400 focus:outline-none"
                            />
                        </div>

                        <div>
                            <label className="block text-stone-300 font-bold mb-2">ä½œè€…æš±ç¨± *</label>
                            <input
                                type="text"
                                value={authorName}
                                onChange={(e) => setAuthorName(e.target.value)}
                                placeholder="ä¾‹å¦‚ï¼šç®¡ç†å“¡ã€è‡ªå–ã€å®˜æ–¹ç­‰"
                                className="w-full p-4 rounded-2xl bg-stone-800 border-2 border-stone-700 text-white placeholder-stone-500 focus:border-gold-400 focus:outline-none"
                            />
                            <p className="text-xs text-stone-500 mt-2">
                                ğŸ’¡ é€™å€‹åç¨±æœƒé¡¯ç¤ºåœ¨æ”»ç•¥é é¢ä¸Š
                            </p>
                        </div>

                        <div>
                            <label className="block text-stone-300 font-bold mb-2">åˆ†é¡ *</label>
                            <select
                                value={category}
                                onChange={(e) => setCategory(e.target.value)}
                                className="w-full p-4 rounded-2xl bg-stone-800 border-2 border-stone-700 text-white focus:border-gold-400 focus:outline-none"
                            >
                                <option value="general">ğŸ“– ç¶œåˆ</option>
                                <option value="event">ğŸ‰ æ´»å‹•</option>
                                <option value="pve">âš”ï¸ PVE</option>
                                <option value="pvp">ğŸ›¡ï¸ PVP</option>
                                <option value="beginner">ğŸŒŸ æ–°æ‰‹</option>
                            </select>
                        </div>

                        <div>
                            <div className="flex items-center justify-between mb-2 flex-wrap gap-2">
                                <label className="block text-stone-300 font-bold w-full md:w-auto">å…§å®¹ *</label>
                                <label className="cursor-pointer">
                                    <input
                                        type="file"
                                        accept=".docx,.pdf,.xlsx,.xls"
                                        onChange={handleFileUpload}
                                        className="hidden"
                                    />
                                    <span className="inline-flex items-center gap-2 px-5 py-2.5 bg-stone-600 hover:bg-stone-500 text-white rounded-xl font-bold text-sm transition-colors border border-stone-500">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                        ä¸Šå‚³ Word / PDF / Excel
                                    </span>
                                </label>
                            </div>
                            <div className="bg-white border-2 border-stone-700 rounded-2xl overflow-hidden">
                                <div ref={quillRef} style={{ minHeight: '400px', backgroundColor: 'white', color: '#000000' }} />
                            </div>
                            <style>{`
                                .ql-editor {
                                    color: #1a1614 !important;
                                    font-size: 16px;
                                    line-height: 1.6;
                                }
                                .ql-editor p,
                                .ql-editor ol,
                                .ql-editor ul {
                                    color: #1a1614 !important;
                                }
                            `}</style>
                            <p className="text-xs text-stone-500 mt-2">
                                ğŸ’¡ ä¸éœ€ä¸Šå‚³ HTMLï¼Œç›´æ¥åœ¨ç·¨è¼¯å™¨è¼¸å…¥æˆ–ä¸Šå‚³ Word / PDF / Excel å³å¯ï¼Œç³»çµ±æœƒè‡ªå‹•è½‰æˆç¶²é æ ¼å¼
                            </p>
                        </div>

                        <div className="flex gap-6">
                            <label className="flex items-center gap-2 cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={isPinned}
                                    onChange={(e) => setIsPinned(e.target.checked)}
                                    className="w-5 h-5 text-gold-600 rounded focus:ring-2 focus:ring-gold-500"
                                />
                                <span className="text-stone-300 font-bold">ç½®é ‚</span>
                            </label>

                            <label className="flex items-center gap-2">
                                <span className="text-stone-300 font-bold">ç‹€æ…‹ï¼š</span>
                                <select
                                    value={status}
                                    onChange={(e) => setStatus(e.target.value)}
                                    className="p-2 rounded-xl bg-stone-800 border-2 border-stone-700 text-white focus:border-gold-400"
                                    title="é¸ã€Œç™¼å¸ƒã€å‰å°æ‰çœ‹å¾—åˆ°"
                                >
                                    <option value="draft">è‰ç¨¿ï¼ˆå‰å°ä¸é¡¯ç¤ºï¼‰</option>
                                    <option value="published">ç™¼å¸ƒï¼ˆå‰å°å¯è¦‹ï¼‰</option>
                                    <option value="archived">å°å­˜</option>
                                </select>
                                {status === 'draft' && (
                                    <span className="text-amber-400 text-xs font-bold">âš ï¸ è‰ç¨¿ä¸æœƒé¡¯ç¤ºåœ¨æ”»ç•¥é </span>
                                )}
                            </label>
                        </div>

                        <div className="flex gap-4">
                            <Button
                                onClick={handleSave}
                                disabled={saving}
                                variant="gold"
                                className="flex-1"
                            >
                                {saving ? 'å„²å­˜ä¸­...' : 'å„²å­˜'}
                            </Button>
                            <Button
                                onClick={onClose}
                                variant="secondary"
                                className="flex-1"
                            >
                                å–æ¶ˆ
                            </Button>
                        </div>
                    </div>
                </div>
            );
        };

        // ç®¡ç†å“¡å¾Œå° - æ”»ç•¥ç®¡ç†çµ„ä»¶
        const GuideManagementTab = () => {
            const [guides, setGuides] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showEditor, setShowEditor] = useState(false);
            const [editingGuide, setEditingGuide] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);

            useEffect(() => {
                loadCurrentUser();
                loadGuides();
            }, []);

            useEffect(() => {
                const handler = () => loadGuides();
                window.addEventListener('storage-update', handler);
                return () => window.removeEventListener('storage-update', handler);
            }, []);

            const loadCurrentUser = async () => {
                const user = await authHelpers.getCurrentUser();
                setCurrentUser(user);
            };

            const loadGuides = async () => {
                try {
                    const { data, error } = await supabase
                        .from('guides')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    setGuides(data || []);
                } catch (error) {
                    console.error('è¼‰å…¥æ”»ç•¥å¤±æ•—:', error);
                    showToast('è¼‰å…¥æ”»ç•¥å¤±æ•—', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleCreate = () => {
                setEditingGuide(null);
                setShowEditor(true);
            };

            const handleEdit = (guide) => {
                setEditingGuide(guide);
                setShowEditor(true);
            };

            const handleDelete = async (guideId) => {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æ”»ç•¥å—ï¼Ÿ')) return;

                try {
                    const { error } = await supabase
                        .from('guides')
                        .delete()
                        .eq('id', guideId);

                    if (error) throw error;

                    showToast('åˆªé™¤æˆåŠŸ', 'success');
                    loadGuides();
                } catch (error) {
                    console.error('åˆªé™¤å¤±æ•—:', error);
                    showToast('åˆªé™¤å¤±æ•—', 'error');
                }
            };

            const handleEditorClose = () => {
                setShowEditor(false);
                setEditingGuide(null);
                loadGuides();
            };

            const compressDataUrlImage = (dataUrl, maxW = 1200, quality = 0.82) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        if (img.width <= maxW && dataUrl.length < 200000) return resolve(dataUrl);
                        const c = document.createElement('canvas');
                        const scale = Math.min(1, maxW / img.width);
                        c.width = Math.round(img.width * scale);
                        c.height = Math.round(img.height * scale);
                        const ctx = c.getContext('2d');
                        ctx.drawImage(img, 0, 0, c.width, c.height);
                        c.toBlob((b) => {
                            if (!b) return resolve(dataUrl);
                            const r = new FileReader();
                            r.onload = () => resolve(r.result);
                            r.readAsDataURL(b);
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = () => resolve(dataUrl);
                    img.src = dataUrl;
                });
            };

            const handleCompressAllGuides = async () => {
                if (!confirm('å°‡æ‰¹æ¬¡å£“ç¸®æ‰€æœ‰æ”»ç•¥ä¸­çš„åœ–ç‰‡ï¼Œéœ€æ™‚è¼ƒä¹…ï¼Œç¢ºå®šç¹¼çºŒï¼Ÿ')) return;
                showToast('é–‹å§‹å£“ç¸®æ”»ç•¥åœ–ç‰‡...', 'info');
                let done = 0, updated = 0;
                for (const guide of guides) {
                    const html = guide.content || '';
                    const dataUrlRegex = /<img[^>]+src="(data:image\/[^"]+)"[^>]*>/gi;
                    let match;
                    const replacements = [];
                    while ((match = dataUrlRegex.exec(html)) !== null) {
                        const original = match[1];
                        if (original.length > 50000) {
                            try {
                                const compressed = await compressDataUrlImage(original);
                                if (compressed.length < original.length) replacements.push({ from: original, to: compressed });
                            } catch (e) { /* skip */ }
                        }
                    }
                    if (replacements.length > 0) {
                        let newContent = html;
                        replacements.forEach(r => { newContent = newContent.split(r.from).join(r.to); });
                        try {
                            const { error } = await supabase.from('guides').update({ content: newContent }).eq('id', guide.id);
                            if (!error) updated++;
                        } catch (e) { /* skip */ }
                    }
                    done++;
                    if (done % 2 === 0) showToast(`è™•ç†ä¸­ ${done}/${guides.length}...`, 'info');
                }
                showToast(`å®Œæˆï¼å…±æ›´æ–° ${updated} ç¯‡æ”»ç•¥çš„åœ–ç‰‡`, 'success');
                loadGuides();
            };

            if (showEditor) {
                return <GuideEditor guide={editingGuide} currentUser={currentUser} onClose={handleEditorClose} />;
            }

            return (
                <div>
                    <div className="flex flex-wrap items-center justify-between gap-3 mb-6">
                        <h2 className="text-2xl font-black text-white">æ´»å‹•æ”»ç•¥ç®¡ç†</h2>
                        <div className="flex gap-2">
                            {guides.length > 0 && (
                                <button onClick={handleCompressAllGuides} className="px-4 py-2.5 rounded-xl bg-stone-600 hover:bg-stone-500 text-white font-bold text-sm border border-stone-500 transition-colors flex items-center gap-2" title="å£“ç¸®æ‰€æœ‰æ”»ç•¥ä¸­å·²ä¸Šå‚³çš„åœ–ç‰‡ï¼Œæ¸›å°è¼‰å…¥é«”ç©">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                    å£“ç¸®ç¾æœ‰åœ–ç‰‡
                                </button>
                            )}
                            <Button onClick={handleCreate} variant="gold" icon={Plus}>
                                æ–°å¢æ”»ç•¥
                            </Button>
                        </div>
                    </div>

                    {loading ? (
                        <LoadingSpinner message="è¼‰å…¥ä¸­..." />
                    ) : guides.length === 0 ? (
                        <div className="text-center py-20 bg-stone-800 rounded-2xl border border-stone-700">
                            <BookOpen size={48} className="mx-auto text-stone-600 mb-4" />
                            <p className="text-stone-400 font-bold">ç›®å‰æ²’æœ‰æ”»ç•¥</p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {guides.map(guide => (
                                <div key={guide.id} className="bg-stone-800 rounded-2xl p-6 border-2 border-stone-700">
                                    <div className="flex items-start justify-between">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2 mb-2">
                                                <h3 className="text-lg font-bold text-white">{guide.title}</h3>
                                                {guide.is_pinned && (
                                                    <span className="bg-fire-500 text-white px-2 py-1 rounded text-xs">ç½®é ‚</span>
                                                )}
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                    guide.status === 'published' ? 'bg-wind-500 text-white' :
                                                    guide.status === 'draft' ? 'bg-stone-600 text-stone-300' :
                                                    'bg-stone-700 text-stone-400'
                                                }`}>
                                                    {guide.status === 'published' ? 'å·²ç™¼å¸ƒ' : guide.status === 'draft' ? 'è‰ç¨¿' : 'å·²å°å­˜'}
                                                </span>
                                            </div>
                                            <div className="flex items-center gap-4 text-sm text-stone-400">
                                                <span>ç€è¦½: {guide.views || 0}</span>
                                                <span>æŒ‰è®š: {guide.likes || 0}</span>
                                                <span>{new Date(guide.created_at).toLocaleString('zh-TW')}</span>
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => handleEdit(guide)}
                                                className="px-4 py-2 bg-water-500 text-white rounded-xl hover:bg-water-600 transition-colors"
                                            >
                                                ç·¨è¼¯
                                            </button>
                                            <button
                                                onClick={() => handleDelete(guide.id)}
                                                className="px-4 py-2 bg-fire-500 text-white rounded-xl hover:bg-fire-600 transition-colors"
                                            >
                                                åˆªé™¤
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // ä¸‹è¼‰é é¢
        const DownloadPage = () => {
            const handlePcDownload = () => {
                // PC ä¸‹è¼‰é€£çµï¼ˆGoogle Driveï¼‰
                window.open('https://drive.google.com/file/d/1HSlSO9RKpKunxLY72LxvSYu3M558ixYx/view?usp=sharing', '_blank');
                showToast("æ­£åœ¨é–‹å•Ÿä¸‹è¼‰é é¢...", "success");
            };

            const handleAndroidDownload = () => {
                // Android APK ä¸‹è¼‰é€£çµï¼ˆGoogle Driveï¼‰
                window.open('https://drive.google.com/file/d/1bp75L9i4YlcQvWVO82tFCnmXL9WutG2B/view?usp=sharing', '_blank');
                showToast("æ­£åœ¨é–‹å•Ÿ Android ä¸‹è¼‰é é¢...", "success");
            };

            const handleIosDownload = () => {
                // iOS ä¸‹è¼‰é€£çµ
                window.open('https://lgydo.tvuimx.com:1443/api/c/kjr41dc7', '_blank');
                showToast("æ­£åœ¨é–‹å•Ÿ iOS ä¸‹è¼‰é é¢...", "success");
            };

            return (
                <motion.div
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0 }}
                    className="pt-28 md:pt-40 pb-24 md:pb-32 px-4 md:px-6 min-h-screen bg-gradient-to-b from-stone-100 via-amber-50/30 to-stone-100 relative overflow-hidden"
                >
                    {/* èƒŒæ™¯è£é£¾ */}
                    <div className="absolute inset-0 pointer-events-none opacity-[0.03]" aria-hidden="true">
                        <div className="absolute top-20 left-10 w-72 h-72 rounded-full bg-gold-400 blur-3xl" />
                        <div className="absolute bottom-40 right-10 w-96 h-96 rounded-full bg-amber-400 blur-3xl" />
                    </div>

                    {/* æ¨™é¡Œå€ */}
                    <div className="max-w-4xl mx-auto text-center mb-12 md:mb-16 relative">
                        <div className="inline-flex items-center justify-center w-20 h-20 md:w-24 md:h-24 bg-gradient-to-br from-gold-400 to-amber-500 rounded-2xl md:rounded-3xl shadow-xl shadow-gold-300/50 mb-6">
                            <Download size={40} className="text-white md:w-14 md:h-14" strokeWidth={2} />
                        </div>
                        <h1 className="text-4xl md:text-5xl lg:text-6xl font-black text-stone-800 mb-4 tracking-tight">éŠæˆ²ä¸‹è¼‰</h1>
                        <p className="text-lg md:text-xl text-stone-600 font-medium max-w-2xl mx-auto leading-relaxed">
                            é¸æ“‡æ‚¨çš„è£ç½®å¹³å°ï¼Œä¸€éµå–å¾—éŠæˆ²å®¢æˆ¶ç«¯
                        </p>
                        <p className="text-sm text-stone-500 mt-2">é»æ“ŠæŒ‰éˆ•å¾Œå°‡æ–¼æ–°åˆ†é é–‹å•Ÿä¸‹è¼‰é é¢</p>
                    </div>

                    {/* ä¸‹è¼‰é¸é … */}
                    <div className="max-w-6xl mx-auto relative">
                        <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                            {/* PC ç«¯ */}
                            <motion.div
                                whileHover={{ y: -6, scale: 1.02 }}
                                transition={{ type: 'spring', stiffness: 300, damping: 20 }}
                                className="bg-white rounded-2xl md:rounded-3xl overflow-hidden border-2 border-stone-200 shadow-lg hover:shadow-xl hover:border-water-300 transition-all duration-300 h-full flex flex-col"
                            >
                                <div className="bg-gradient-to-br from-water-500 to-water-600 p-6 md:p-8 text-center">
                                    <div className="w-16 h-16 md:w-20 md:h-20 mx-auto bg-white/95 rounded-xl md:rounded-2xl flex items-center justify-center mb-3 md:mb-4 shadow-lg">
                                        <svg className="w-10 h-10 md:w-12 md:h-12 text-water-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                            <path d="M0 3.449L9.75 2.1v9.451H0m10.949-9.602L24 0v11.4H10.949M0 12.6h9.75v9.451L0 20.699M10.949 12.6H24V24l-12.9-1.801"/>
                                        </svg>
                                    </div>
                                    <h2 className="text-2xl md:text-3xl font-black text-white mb-1">Windows PC</h2>
                                    <p className="text-water-100 text-sm md:text-base font-medium">æ¡Œä¸Šå‹é›»è…¦ç‰ˆ</p>
                                </div>
                                <div className="p-6 md:p-8 flex-1 flex flex-col">
                                    <ul className="space-y-2 md:space-y-3 mb-6 md:mb-8 text-stone-700 text-sm md:text-base">
                                        <li className="flex items-center gap-2">
                                            <CheckCircle size={18} className="text-water-500 shrink-0" />
                                            <span className="font-medium">å®Œæ•´éŠæˆ²é«”é©—</span>
                                        </li>
                                        <li className="flex items-center gap-2">
                                            <CheckCircle size={18} className="text-water-500 shrink-0" />
                                            <span className="font-medium">é«˜ç•«è³ªé¡¯ç¤º</span>
                                        </li>
                                        <li className="flex items-center gap-2">
                                            <CheckCircle size={18} className="text-water-500 shrink-0" />
                                            <span className="font-medium">éµç›¤æ»‘é¼ æ“ä½œ</span>
                                        </li>
                                    </ul>
                                    <Button
                                        onClick={handlePcDownload}
                                        variant="primary"
                                        className="w-full py-3.5 md:py-4 mt-auto bg-water-500 hover:bg-water-600 shadow-lg shadow-water-200 font-bold"
                                        aria-label="ä¸‹è¼‰ Windows PC ç‰ˆ"
                                    >
                                        <Download size={20} className="shrink-0" />
                                        <span>ä¸‹è¼‰ PC ç‰ˆ</span>
                                    </Button>
                                    <p className="text-xs text-stone-500 text-center mt-3">Windows 7 ä»¥ä¸Š</p>
                                </div>
                            </motion.div>

                            {/* Android ç«¯ */}
                            <motion.div
                                whileHover={{ y: -6, scale: 1.02 }}
                                transition={{ type: 'spring', stiffness: 300, damping: 20 }}
                                className="bg-white rounded-2xl md:rounded-3xl overflow-hidden border-2 border-stone-200 shadow-lg hover:shadow-xl hover:border-wind-300 transition-all duration-300 h-full flex flex-col"
                            >
                                <div className="bg-gradient-to-br from-wind-500 to-wind-600 p-6 md:p-8 text-center">
                                    <div className="w-16 h-16 md:w-20 md:h-20 mx-auto bg-white/95 rounded-xl md:rounded-2xl flex items-center justify-center mb-3 md:mb-4 shadow-lg">
                                        <svg className="w-10 h-10 md:w-12 md:h-12 text-wind-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                            <path d="M17.523 15.3414c-.5511 0-.9993-.4486-.9993-.9997s.4483-.9993.9993-.9993c.5511 0 .9993.4483.9993.9993.0001.5511-.4482.9997-.9993.9997m-11.046 0c-.5511 0-.9993-.4486-.9993-.9997s.4482-.9993.9993-.9993c.5511 0 .9993.4483.9993.9993 0 .5511-.4483.9997-.9993.9997m11.4045-6.02l1.9973-3.4592a.416.416 0 00-.1521-.5676.416.416 0 00-.5676.1521l-2.0223 3.503C15.5902 8.2439 13.8533 7.8508 12 7.8508s-3.5902.3931-5.1367 1.0989L4.841 5.4467a.4161.4161 0 00-.5677-.1521.4157.4157 0 00-.1521.5676l1.9973 3.4592C2.6889 11.1867.3432 14.6589 0 18.761h24c-.3435-4.1021-2.6892-7.5743-6.1185-9.4396"/>
                                        </svg>
                                    </div>
                                    <h2 className="text-2xl md:text-3xl font-black text-white mb-1">Android</h2>
                                    <p className="text-wind-100 text-sm md:text-base font-medium">å®‰å“æ‰‹æ©Ÿç‰ˆ</p>
                                </div>
                                <div className="p-6 md:p-8 flex-1 flex flex-col">
                                    <ul className="space-y-2 md:space-y-3 mb-6 md:mb-8 text-stone-700 text-sm md:text-base">
                                        <li className="flex items-center gap-2">
                                            <CheckCircle size={18} className="text-wind-500 shrink-0" />
                                            <span className="font-medium">éš¨æ™‚éš¨åœ°éŠç©</span>
                                        </li>
                                        <li className="flex items-center gap-2">
                                            <CheckCircle size={18} className="text-wind-500 shrink-0" />
                                            <span className="font-medium">è§¸æ§æ“ä½œå„ªåŒ–</span>
                                        </li>
                                        <li className="flex items-center gap-2">
                                            <CheckCircle size={18} className="text-wind-500 shrink-0" />
                                            <span className="font-medium">ä½è€—é›»æ¨¡å¼</span>
                                        </li>
                                    </ul>
                                    <Button
                                        onClick={handleAndroidDownload}
                                        variant="primary"
                                        className="w-full py-3.5 md:py-4 mt-auto bg-wind-500 hover:bg-wind-600 shadow-lg shadow-wind-200 font-bold"
                                        aria-label="ä¸‹è¼‰ Android ç‰ˆ"
                                    >
                                        <Download size={20} className="shrink-0" />
                                        <span>ä¸‹è¼‰ Android ç‰ˆ</span>
                                    </Button>
                                    <p className="text-xs text-stone-500 text-center mt-3">Android 5.0 ä»¥ä¸Š</p>
                                </div>
                            </motion.div>

                            {/* iOS ç«¯ */}
                            <motion.div
                                whileHover={{ y: -6, scale: 1.02 }}
                                transition={{ type: 'spring', stiffness: 300, damping: 20 }}
                                className="bg-white rounded-2xl md:rounded-3xl overflow-hidden border-2 border-stone-200 shadow-lg hover:shadow-xl hover:border-stone-300 transition-all duration-300 h-full flex flex-col sm:col-span-2 lg:col-span-1"
                            >
                                <div className="bg-gradient-to-br from-stone-500 to-stone-600 p-6 md:p-8 text-center">
                                    <div className="w-16 h-16 md:w-20 md:h-20 mx-auto bg-white/95 rounded-xl md:rounded-2xl flex items-center justify-center mb-3 md:mb-4 shadow-lg">
                                        <svg className="w-10 h-10 md:w-12 md:h-12 text-stone-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                            <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                                        </svg>
                                    </div>
                                    <h2 className="text-2xl md:text-3xl font-black text-white mb-1">iOS</h2>
                                    <p className="text-stone-100 text-sm md:text-base font-medium">è˜‹æœæ‰‹æ©Ÿç‰ˆ</p>
                                </div>
                                <div className="p-6 md:p-8 flex-1 flex flex-col">
                                    <ul className="space-y-2 md:space-y-3 mb-6 md:mb-8 text-stone-700 text-sm md:text-base">
                                        <li className="flex items-center gap-2">
                                            <CheckCircle size={18} className="text-stone-500 shrink-0" />
                                            <span className="font-medium">æµæš¢éŠæˆ²é«”é©—</span>
                                        </li>
                                        <li className="flex items-center gap-2">
                                            <CheckCircle size={18} className="text-stone-500 shrink-0" />
                                            <span className="font-medium">å®Œç¾é©é… iPhone / iPad</span>
                                        </li>
                                        <li className="flex items-center gap-2">
                                            <CheckCircle size={18} className="text-stone-500 shrink-0" />
                                            <span className="font-medium">çœé›»å„ªåŒ–</span>
                                        </li>
                                    </ul>
                                    <Button
                                        onClick={handleIosDownload}
                                        variant="secondary"
                                        className="w-full py-3.5 md:py-4 mt-auto bg-gradient-to-r from-stone-500 to-stone-600 hover:from-stone-600 hover:to-stone-700 text-white font-bold shadow-lg hover:shadow-xl transition-all duration-300"
                                        aria-label="ä¸‹è¼‰ iOS ç‰ˆ"
                                    >
                                        <Download size={20} className="shrink-0" />
                                        <span>ä¸‹è¼‰ iOS ç‰ˆ</span>
                                    </Button>
                                    <p className="text-xs text-stone-500 text-center mt-3">iPhoneã€iPad</p>
                                </div>
                            </motion.div>
                        </div>

                        {/* ä¸‹è¼‰é ˆçŸ¥ - åˆ†å¹³å°èªªæ˜ */}
                        <div className="mt-12 md:mt-16 max-w-4xl mx-auto">
                            <div className="bg-white rounded-2xl md:rounded-3xl p-6 md:p-10 border-2 border-gold-200 shadow-lg overflow-hidden">
                                <h3 className="text-xl md:text-2xl font-black text-stone-800 mb-6 flex items-center gap-3">
                                    <div className="w-10 h-10 bg-gold-100 rounded-xl flex items-center justify-center shrink-0">
                                        <AlertCircle size={22} className="text-gold-600" />
                                    </div>
                                    ä¸‹è¼‰èˆ‡å®‰è£é ˆçŸ¥
                                </h3>
                                <div className="grid sm:grid-cols-1 md:grid-cols-3 gap-6 md:gap-8">
                                    <div className="bg-water-50 rounded-xl p-4 border border-water-200">
                                        <h4 className="font-bold text-water-700 mb-2 flex items-center gap-2">
                                            <span className="w-6 h-6 bg-water-200 rounded-full flex items-center justify-center text-xs">PC</span>
                                            Windows
                                        </h4>
                                        <ul className="text-sm text-stone-700 space-y-1.5">
                                            <li>â€¢ å®‰è£å‰å¯æš«æ™‚é—œé–‰é˜²æ¯’ï¼Œé¿å…èª¤åˆ¤</li>
                                            <li>â€¢ ä¸‹è¼‰å¾Œå»ºè­°å°‡éŠæˆ²è³‡æ–™å¤¾åŠ å…¥ä¿¡ä»»æ¸…å–®</li>
                                            <li>â€¢ æ”¯æ´ Windows 7 ä»¥ä¸Š</li>
                                        </ul>
                                    </div>
                                    <div className="bg-wind-50 rounded-xl p-4 border border-wind-200">
                                        <h4 className="font-bold text-wind-700 mb-2 flex items-center gap-2">
                                            <span className="w-6 h-6 bg-wind-200 rounded-full flex items-center justify-center text-xs">A</span>
                                            Android
                                        </h4>
                                        <ul className="text-sm text-stone-700 space-y-1.5">
                                            <li>â€¢ è‹¥ç„¡æ³•å®‰è£ï¼Œè«‹è‡³ã€Œè¨­å®šã€å…è¨±æœªçŸ¥ä¾†æº</li>
                                            <li>â€¢ å»ºè­°ä½¿ç”¨ Chrome é–‹å•Ÿä¸‹è¼‰é€£çµ</li>
                                            <li>â€¢ æ”¯æ´ Android 5.0 ä»¥ä¸Š</li>
                                        </ul>
                                    </div>
                                    <div className="bg-stone-100 rounded-xl p-4 border border-stone-200">
                                        <h4 className="font-bold text-stone-700 mb-2 flex items-center gap-2">
                                            <span className="w-6 h-6 bg-stone-300 rounded-full flex items-center justify-center text-xs">i</span>
                                            iOS
                                        </h4>
                                        <ul className="text-sm text-stone-700 space-y-1.5">
                                            <li>â€¢ é»æ“Šä¸‹è¼‰å¾Œä¾ç¶²é æŒ‡ç¤ºå®‰è£</li>
                                            <li>â€¢ è‹¥éœ€ä¿¡ä»»é–‹ç™¼è€…ï¼šè¨­å®š â†’ ä¸€èˆ¬ â†’ è£ç½®ç®¡ç†</li>
                                            <li>â€¢ æ”¯æ´ iPhoneã€iPad</li>
                                        </ul>
                                    </div>
                                </div>
                                <p className="text-stone-600 text-sm md:text-base mt-6 pt-6 border-t border-stone-200 font-medium">
                                    é‡åˆ°ç„¡æ³•ä¸‹è¼‰æˆ–å®‰è£å•é¡Œï¼Ÿè«‹é€éå®˜æ–¹ LINE è¯ç¹«å®¢æœï¼Œæˆ‘å€‘æœƒå”åŠ©æ‚¨æ’é™¤ã€‚
                                </p>
                            </div>
                        </div>

                        {/* CTA å€åŸŸ */}
                        <div className="mt-10 md:mt-14 text-center">
                            <p className="text-stone-600 font-medium mb-4">ä¸‹è¼‰æˆ–å®‰è£é‡åˆ°å•é¡Œï¼Ÿ</p>
                            <Link to="/support">
                                <Button variant="secondary" className="px-6 py-3.5 md:px-8 md:py-4 font-bold shadow-md hover:shadow-lg transition-shadow">
                                    <MessageCircle size={20} className="shrink-0" />
                                    <span>è¯ç¹«å®¢æœ</span>
                                </Button>
                            </Link>
                        </div>
                    </div>
                </motion.div>
            );
        };

        const EventsPage = () => {
            const [events, setEvents] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const loadEvents = async () => {
                    setLoading(true);
                    try {
                        const loadedEvents = await getSupabaseData(DB_TABLES.EVENTS, { limit: 50 });
                        setEvents(loadedEvents.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)));
                    } finally {
                        setLoading(false);
                    }
                };

                loadEvents();
                
                const handleStorageChange = () => loadEvents();
                window.addEventListener('storage-update', handleStorageChange);
                return () => window.removeEventListener('storage-update', handleStorageChange);
            }, []);

            return (
                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className="pt-32 md:pt-44 pb-36 md:pb-24 px-4 md:px-6 min-h-screen">
                    <PageHeader title="æœ€æ–°æ´»å‹•" subtitle="å³æ™‚æŒæ¡éƒ¨è½æœ€æ–°å‹•æ…‹èˆ‡ç¦åˆ©æ´»å‹•ã€‚" icon={Calendar} color="text-fire-500" />
                    
                    <div className="max-w-4xl mx-auto space-y-6">
                        {loading ? (
                            <LoadingSpinner message="è¼‰å…¥æ´»å‹•ä¸­..." />
                        ) : events.length === 0 ? (
                            <div className="stone-panel p-16 text-center text-stone-400">
                                <div className="bg-stone-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <Megaphone size={32} className="opacity-30"/>
                                </div>
                                <p className="text-xl font-bold">ç›®å‰æ²’æœ‰æ´»å‹•å…¬å‘Š...</p>
                            </div>
                        ) : (
                            events.map((event) => {
                                const tag = EVENT_TAGS.find(t => t.id === event.tag) || EVENT_TAGS[0];
                                const firstImg = (event.content || '').match(/<img[^>]+src=["']([^"']+)["']/i);
                                const coverImg = firstImg ? firstImg[1] : null;
                                return (
                                    <div key={event.id} className="stone-panel overflow-hidden hover:shadow-lg transition-all duration-300 group">
                                        {coverImg && (
                                            <div className="aspect-video w-full overflow-hidden rounded-t-2xl bg-stone-100">
                                                <img src={coverImg} alt={event.title} className="w-full h-full object-cover" loading="lazy" />
                                            </div>
                                        )}
                                        <div className="p-8 md:p-10">
                                            <div className="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                                                <div className="flex items-center gap-3">
                                                    <span className={`${tag.color} px-3 py-1 rounded-lg text-sm font-bold tracking-wide shadow-sm`}>
                                                        {tag.label}
                                                    </span>
                                                    <span className="text-stone-400 font-mono text-sm">
                                                        {new Date(event.timestamp || event.created_at).toLocaleDateString()}
                                                    </span>
                                                </div>
                                            </div>
                                            <h3 className="text-2xl font-bold text-stone-800 mb-4 group-hover:text-wood-600 transition-colors">
                                                {event.title}
                                            </h3>
                                            <div className="text-stone-600 text-base sm:text-lg leading-loose font-medium prose prose-stone max-w-none overflow-x-auto break-words event-content" style={{ WebkitOverflowScrolling: 'touch' }} dangerouslySetInnerHTML={{ __html: event.content || '' }} />
                                        </div>
                                    </div>
                                );
                            })
                        )}
                    </div>
                </motion.div>
            );
        };

        const RechargePage = () => {
            const navigate = useNavigate();
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(false); // æ”¹ç‚º falseï¼Œå¿«é€Ÿé¡¯ç¤ºé é¢
            const [gameAccounts, setGameAccounts] = useState([]);
            const [selectedAccountId, setSelectedAccountId] = useState('');
            const [selectedMethod, setSelectedMethod] = useState(null);
            const [selectedPlan, setSelectedPlan] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [orderNumber, setOrderNumber] = useState(''); // æ–°å¢ï¼šè¨‚å–®ç·¨è™Ÿ
            const [lineName, setLineName] = useState(''); // æ–°å¢ï¼šLINE åç¨±
            const [formErrors, setFormErrors] = useState({ gameAccount: '', method: '', plan: '', lineName: '' });
            const [confirmModal, setConfirmModal] = useState({ show: false, title: '', message: null, onConfirm: null, confirmLabel: 'ç¢ºèª' });
            
            const showConfirm = (title, message, onConfirm, confirmLabel = 'ç¢ºèª') => {
                setConfirmModal({ show: true, title, message, onConfirm, confirmLabel });
            };
            const hideConfirm = () => setConfirmModal({ show: false, title: '', message: null, onConfirm: null, confirmLabel: 'ç¢ºèª' });
            const accountRef = useRef(null);
            const methodRef = useRef(null);
            const planRef = useRef(null);
            const lineNameRef = useRef(null);
            
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹ä¸¦è¼‰å…¥éŠæˆ²å¸³è™Ÿ
            useEffect(() => {
                let isMounted = true;
                
                const checkAuth = async () => {
                    try {
                        console.log('é–‹å§‹æª¢æŸ¥ç™»å…¥ç‹€æ…‹...');
                        const currentUser = await authHelpers.getCurrentUser();
                        console.log('getCurrentUser çµæœ:', currentUser);
                        
                        if (!isMounted) return;
                        
                        if (!currentUser) {
                            console.log('æœªç™»å…¥ï¼Œè·³è½‰åˆ°ç™»å…¥é ');
                            showToast('è«‹å…ˆç™»å…¥æ‰èƒ½è´ŠåŠ©', 'warning');
                            setTimeout(() => {
                                window.location.href = '/auth';
                            }, 500);
                            return;
                        }
                        
                        console.log('å·²ç™»å…¥ï¼Œè¼‰å…¥éŠæˆ²å¸³è™Ÿ...');
                        setUser(currentUser);
                        
                        // è®€å–éŠæˆ²å¸³è™Ÿåˆ—è¡¨ï¼ˆæ”¯æ´èˆŠæ ¼å¼å’Œæ–°æ ¼å¼ï¼‰
                        const accounts = currentUser.user_metadata?.game_accounts || 
                                       (currentUser.user_metadata?.game_account ? [{
                                           id: '1',
                                           name: currentUser.user_metadata.game_account,
                                           is_primary: true,
                                           created_at: Date.now()
                                       }] : []);
                        
                        console.log('éŠæˆ²å¸³è™Ÿåˆ—è¡¨:', accounts);
                        setGameAccounts(accounts);
                        
                        // é è¨­é¸æ“‡ç¬¬ä¸€å€‹ï¼ˆä¸»å¸³è™Ÿï¼‰
                        if (accounts.length > 0) {
                            setSelectedAccountId(accounts[0].id);
                        }
                        
                        console.log('è¼‰å…¥å®Œæˆ');
                    } catch (error) {
                        console.error('è¼‰å…¥å¤±æ•—:', error);
                        if (isMounted) {
                            showToast('è¼‰å…¥å¤±æ•—ï¼š' + error.message, 'error');
                        }
                    }
                };
                
                // ç§»é™¤è¶…æ™‚ä¿è­·ï¼Œè®“é é¢ç«‹å³é¡¯ç¤º
                const timeout = setTimeout(() => {
                    console.warn('èƒŒæ™¯è¼‰å…¥é€¾æ™‚');
                }, 3000); // æ¸›å°‘ç‚º 3 ç§’
                
                checkAuth().finally(() => {
                    clearTimeout(timeout);
                });
                
                return () => {
                    isMounted = false;
                    clearTimeout(timeout);
                };
            }, []);

            const saveSponsorshipRecord = async () => {
                const selectedAccount = gameAccounts.find(acc => acc.id === selectedAccountId);
                
                try {
                    // å–å¾— IP ä½ç½®è³‡è¨Š
                    const ipData = await getIpLocation();
                    
                    // æº–å‚™æ’å…¥è³‡æ–™
                    const insertData = {
                        user_id: user.id,
                        email: user.email,
                        game_account: selectedAccount?.name || '',
                        line_name: (lineName || '').trim() || null,
                        amount: selectedPlan.amount,
                        coins: selectedPlan.total,
                        plan_name: `é‡‘å¹£ ${selectedPlan.total.toLocaleString()} æ–¹æ¡ˆ`,
                        payment_method: selectedMethod,
                        status: 'pending',
                        ip_address: ipData?.ip || null
                    };
                    
                    // åªæœ‰ç•¶ ipData å­˜åœ¨ä¸”æœ‰æ•ˆæ™‚æ‰åŠ å…¥ ip_location
                    if (ipData && ipData.country) {
                        insertData.ip_location = JSON.stringify({
                            country: ipData.country,
                            city: ipData.city || '',
                            region: ipData.region || ''
                        });
                    }
                    
                    // å„²å­˜åˆ°æ–°çš„ donations è¡¨
                    const { data, error } = await supabase
                        .from('donations')
                        .insert([insertData])
                        .select();
                    
                    if (error) {
                        console.error('å„²å­˜è´ŠåŠ©ç´€éŒ„å¤±æ•—:', error);
                        showToast('å„²å­˜ç´€éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹è¯ç¹«å®¢æœ', 'error');
                        return false;
                    }
                    window.dispatchEvent(new Event('storage-update'));
                    
                    // å„²å­˜è©³ç´°çš„ IP ä½ç½®è³‡è¨Šåˆ° ip_locations è¡¨
                    if (ipData && ipData.country) {
                        await saveIpLocation(ipData);
                    }
                    
                    console.log('è´ŠåŠ©ç´€éŒ„å·²å„²å­˜:', data);
                    
                    // å„²å­˜è¨‚å–®ç·¨è™Ÿåˆ°ç‹€æ…‹ä¸¦è¿”å›
                    if (data && data[0] && data[0].order_number) {
                        setOrderNumber(data[0].order_number);
                        return data[0].order_number; // è¿”å›è¨‚å–®ç·¨è™Ÿ
                    }
                    
                    return true;
                } catch (err) {
                    console.error('å„²å­˜è´ŠåŠ©ç´€éŒ„ç•°å¸¸:', err);
                    showToast('ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                    return false;
                }
            };

            const handlePayment = async () => {
                const errors = { gameAccount: '', method: '', plan: '', lineName: '' };
                
                // é©—è­‰éŠæˆ²å¸³è™Ÿ
                if (!selectedAccountId) {
                    errors.gameAccount = 'è«‹é¸æ“‡éŠæˆ²å¸³è™Ÿ';
                }
                
                if (!selectedMethod) errors.method = 'è«‹é¸æ“‡æ”¯ä»˜æ–¹å¼';
                if (!selectedPlan) errors.plan = 'è«‹é¸æ“‡è´ŠåŠ©æ–¹æ¡ˆ';
                const trimmedLineName = (lineName || '').trim();
                if (!trimmedLineName) {
                    errors.lineName = 'è«‹å¡«å¯« LINE åç¨±æˆ– Discord åç¨±';
                }
                setFormErrors(errors);

                if (errors.gameAccount || errors.method || errors.plan || errors.lineName) {
                    const first = errors.gameAccount ? accountRef : errors.method ? methodRef : errors.plan ? planRef : lineNameRef;
                    first.current?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                
                // SHOPLINEï¼šå…ˆç”Ÿæˆè¨‚å–®ç·¨è™Ÿï¼ˆå› ç‚ºæ˜¯å¤–éƒ¨é€£çµï¼Œç„¡æ³•ä¸²æ¥ï¼‰
                if (selectedMethod === 'shopline') {
                    showToast('æ­£åœ¨ç”Ÿæˆè¨‚å–®ç·¨è™Ÿ...', 'info');
                    const result = await saveSponsorshipRecord();
                    const newOrderNumber = typeof result === 'string' ? result : null;
                    
                    if (result && newOrderNumber) {
                        // é¡¯ç¤ºè¨‚å–®ç·¨è™Ÿå’Œæé†’
                        setTimeout(() => {
                            showConfirm(
                                'âœ… è¨‚å–®å·²å»ºç«‹',
                                <div className="text-left space-y-4">
                                    <div className="bg-purple-50 border-2 border-purple-500 p-4 rounded-lg">
                                        <p className="text-sm text-stone-600 font-bold mb-2">æ‚¨çš„è¨‚å–®ç·¨è™Ÿ</p>
                                        <div className="flex items-center gap-3 justify-center">
                                            <code className="text-xl font-black text-purple-600 bg-white px-4 py-2 rounded-lg border-2 border-purple-300">
                                                {newOrderNumber}
                                            </code>
                                            <button
                                                onClick={() => {
                                                    navigator.clipboard.writeText(newOrderNumber);
                                                    showToast('è¨‚å–®ç·¨è™Ÿå·²è¤‡è£½', 'success');
                                                }}
                                                className="p-2 hover:bg-purple-100 rounded-lg transition-colors"
                                                title="è¤‡è£½è¨‚å–®ç·¨è™Ÿ"
                                            >
                                                <Copy size={20} className="text-purple-600" />
                                            </button>
                                        </div>
                                        <p className="text-xs text-stone-500 text-center mt-2">è«‹å‹™å¿…æˆªåœ–ä¿å­˜æ­¤è¨‚å–®ç·¨è™Ÿ</p>
                                    </div>
                                    <div className="bg-yellow-50 border-2 border-yellow-500 p-4 rounded-lg">
                                        <p className="text-xl text-red-600 font-black mb-3">âš ï¸ å¿…é ˆæˆªåœ–å…©å€‹ç•«é¢ï¼</p>
                                        <ol className="text-base text-stone-800 font-bold space-y-2 ml-4 list-decimal">
                                            <li>ğŸ“¸ æœ¬å°è©±æ¡†ï¼ˆå«è¨‚å–®ç·¨è™Ÿï¼‰</li>
                                            <li>ğŸ“¸ æ”¯ä»˜æˆåŠŸç•«é¢</li>
                                        </ol>
                                        <p className="text-sm text-stone-600 mt-3">ä½œç‚ºæ”¯ä»˜æ†‘è­‰ï¼Œæ–¹ä¾¿æŸ¥å¸³æ ¸å°</p>
                                    </div>
                                    <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded space-y-3">
                                        <p className="text-base text-stone-800 font-black">ğŸ’¬ å®Œæˆæ”¯ä»˜å¾Œï¼Œè«‹ç«‹å³å°‡æˆªåœ–å‚³é€çµ¦ LINE å®¢æœ</p>
                                        <a href="https://lin.ee/3vSihiH" target="_blank" rel="noopener noreferrer" 
                                           className="inline-flex items-center gap-2 px-4 py-3 bg-line-500 text-white rounded-lg text-base font-bold hover:bg-line-600 transition-colors shadow-lg w-full justify-center">
                                            <MessageSquare size={20} />
                                            ç«‹å³è¯ç¹« LINE å®¢æœ
                                            <ExternalLink size={16} />
                                        </a>
                                        <p className="text-sm text-stone-600 font-bold text-center">â° äººå·¥å®¢æœæ™‚é–“ï¼š10:00 - 22:00</p>
                                    </div>
                                    <div className="bg-red-50 border border-red-300 rounded-lg p-3">
                                        <p className="text-sm text-red-700 font-bold">ğŸ’¡ å®¢æœæœƒæ ¹æ“šè¨‚å–®ç·¨è™Ÿå’Œæ”¯ä»˜æ†‘è­‰ç‚ºæ‚¨æŸ¥å¸³æ ¸å°</p>
                                    </div>
                                </div>,
                                () => {
                                    // é–‹å•Ÿå¤–éƒ¨æ”¯ä»˜é é¢
                                    window.open(selectedPlan.url, '_blank');
                                    // è·³è½‰åˆ°æœƒå“¡å¾Œå°
                                    setTimeout(() => {
                                        window.location.href = '/member';
                                        showToast('è¨‚å–®å·²å»ºç«‹ï¼Œè«‹å®Œæˆæ”¯ä»˜å¾Œè¯ç¹«å®¢æœ', 'success');
                                    }, 500);
                                },
                                'æˆ‘å·²æˆªåœ–ï¼Œå‰å¾€æ”¯ä»˜'
                            );
                        }, 500);
                    }
                } else {
                    // LINE Payï¼šå…ˆå»ºç«‹è´ŠåŠ©ç´€éŒ„ï¼ˆé¿å…å®¢äººæƒç¢¼å¾Œç›´æ¥é—œé–‰å°è‡´å¾Œå°ç„¡ç´€éŒ„ï¼‰ï¼Œå†é¡¯ç¤ºæ”¯ä»˜å½ˆçª—
                    showToast('æ­£åœ¨å»ºç«‹è¨‚å–®...', 'info');
                    const result = await saveSponsorshipRecord();
                    const newOrderNumber = typeof result === 'string' ? result : null;
                    if (result && newOrderNumber) {
                        setOrderNumber(newOrderNumber);
                        setShowModal(true);
                    }
                    // è‹¥å»ºç«‹å¤±æ•—ï¼ŒsaveSponsorshipRecord å·²é¡¯ç¤ºéŒ¯èª¤ toastï¼Œä¸é–‹å•Ÿå½ˆçª—
                }
            };

            if (loading) {
                return (
                    <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="pt-32 md:pt-44 pb-28 md:pb-24 px-4 md:px-6 min-h-screen">
                        <LoadingSpinner message="é©—è­‰ç™»å…¥ä¸­..." />
                    </motion.div>
                );
            }
            
            return (
                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className="pt-32 md:pt-44 pb-28 md:pb-24 px-4 md:px-6 min-h-screen">
                    <PageHeader title="é‡‘å¹£è´ŠåŠ©" subtitle="æ‚¨çš„æ¯ä¸€æ¬¡è´ŠåŠ©ï¼Œéƒ½æ˜¯ç¶­æŒéƒ¨è½é‹è½‰çš„ç¥è–ç«ç¨®ã€‚" icon={Crown} color="text-gold-500" />
                    
                    {/* å…è²¬è²æ˜æç¤º */}
                    <div className="max-w-7xl mx-auto mb-8">
                        <div className="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-300 rounded-2xl p-6">
                            <div className="flex items-start gap-4">
                                <div className="bg-orange-500 p-2 rounded-xl shrink-0">
                                    <AlertCircle size={24} className="text-white" />
                                </div>
                                <div className="flex-1">
                                    <h3 className="font-black text-orange-800 mb-2 flex items-center gap-2">
                                        âš ï¸ é‡è¦æé†’
                                    </h3>
                                    <div className="text-stone-700 text-sm space-y-1">
                                        <p className="font-bold">
                                            â€¢ ç©å®¶è´ŠåŠ©ç‚º<strong className="text-orange-700">è‡ªé¡˜è¡Œç‚º</strong>ï¼Œä¸€ç¶“å®Œæˆ<strong className="text-red-600">æ•ä¸é€€æ¬¾æˆ–æ›è²¨</strong>
                                        </p>
                                        <p className="font-bold">
                                            â€¢ è™›æ“¬ç‰©å“å›é¥‹ç”±ç®¡ç†å“¡<strong className="text-orange-700">äººå·¥å¯©æ ¸å¾Œç™¼æ”¾</strong>ï¼Œéå³æ™‚åˆ°å¸³
                                        </p>
                                        <p className="font-bold">
                                            â€¢ æœ¬æœå‹™ç‚º<strong className="text-orange-700">éç‡Ÿåˆ©æ€§è³ªçš„ç²‰çµ²ç§æœ</strong>ï¼Œèˆ‡åŸå» å…¬å¸ç„¡é—œ
                                        </p>
                                    </div>
                                    <Link 
                                        to="/terms" 
                                        className="inline-flex items-center gap-1 text-orange-600 hover:text-orange-700 font-bold text-sm mt-3 transition-colors"
                                    >
                                        æŸ¥çœ‹å®Œæ•´æœå‹™æ¢æ¬¾
                                        <ArrowRight size={14} />
                                    </Link>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {showModal && selectedPlan && (
                        <PaymentModal 
                            method={selectedMethod}
                            plan={selectedPlan} 
                            gameAccount={gameAccounts.find(acc => acc.id === selectedAccountId)?.name || ''}
                            lineName={lineName}
                            orderNumber={orderNumber}
                            onClose={() => setShowModal(false)}
                            onSaveRecord={saveSponsorshipRecord}
                            showConfirm={showConfirm}
                        />
                    )}

                    {/* SHOPLINE è¨‚å–®ç¢ºèªå°è©±æ¡† */}
                    {confirmModal.show && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-stone-900/70 backdrop-blur-md">
                            <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} className="bg-white rounded-[2rem] shadow-2xl max-w-md w-full overflow-hidden border-2 border-gold-200">
                                <div className="p-6 border-b border-stone-100">
                                    <h3 className="text-xl font-black text-stone-800">{confirmModal.title}</h3>
                                </div>
                                <div className="p-6 max-h-[60vh] overflow-y-auto">{confirmModal.message}</div>
                                <div className="p-6 bg-stone-50 flex gap-3">
                                    <button onClick={hideConfirm} className="flex-1 py-3 rounded-xl border-2 border-stone-300 text-stone-600 font-bold hover:bg-stone-100 transition-colors">
                                        å–æ¶ˆ
                                    </button>
                                    <button onClick={() => { if (confirmModal.onConfirm) { confirmModal.onConfirm(); hideConfirm(); } }} className="flex-1 py-3 rounded-xl bg-gold-500 hover:bg-gold-600 text-white font-bold transition-colors">
                                        {confirmModal.confirmLabel}
                                    </button>
                                </div>
                            </motion.div>
                        </div>
                    )}

                    {/* æ„Ÿè¬è¨Šæ¯ */}
                    <div className="max-w-7xl mx-auto mb-8">
                        <div className="bg-gradient-to-r from-gold-50 via-amber-50 to-orange-50 border-2 border-gold-300 rounded-2xl p-6 md:p-8">
                            <div className="flex flex-col md:flex-row items-center gap-4 md:gap-6">
                                <div className="bg-gradient-to-br from-gold-400 to-orange-500 p-4 rounded-full shrink-0">
                                    <Heart size={32} className="text-white" />
                                </div>
                                <div className="flex-1 text-center md:text-left">
                                    <h3 className="text-xl md:text-2xl font-black text-stone-800 mb-2">
                                        ğŸ’ æ„Ÿè¬æ‚¨çš„æ”¯æŒï¼
                                    </h3>
                                    <p className="text-stone-700 font-bold text-base md:text-lg leading-relaxed">
                                        æ‚¨çš„æ¯ä¸€ç­†è´ŠåŠ©ï¼Œéƒ½æ˜¯æ”¯æŒæˆ‘å€‘<strong className="text-gold-600">æ©Ÿæˆ¿ç‡Ÿé‹</strong>èˆ‡<strong className="text-gold-600">æŒçºŒé€²æ­¥</strong>çš„æœ€å¤§å‹•åŠ›ï¼
                                        <span className="block mt-2 text-stone-600 text-sm md:text-base">
                                            è®“æˆ‘å€‘ä¸€èµ·æ‰“é€ æ›´å¥½çš„éŠæˆ²é«”é©— ğŸ®âœ¨
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto grid lg:grid-cols-3 gap-10 md:gap-12">
                        <div className="lg:col-span-2 space-y-8 md:space-y-10">
                             <div ref={accountRef} className="stone-panel p-8 md:p-10 border-stone-200 bg-white">
                                <div className="flex items-center gap-4 mb-6 border-b border-stone-100 pb-6">
                                    <div className="p-3 bg-stone-50 rounded-2xl text-stone-500"><User size={28} /></div>
                                    <div className="flex-1">
                                        <h3 className="text-2xl font-bold text-stone-700">é¸æ“‡è´ŠåŠ©å¸³è™Ÿ</h3>
                                        <p className="text-stone-500 text-sm font-medium mt-1">é¸æ“‡è¦æ¥æ”¶è™›å¯¶çå‹µçš„éŠæˆ²å¸³è™Ÿ <span className="text-fire-500 font-bold">(å¿…å¡«)</span> <span className="text-fire-600 text-xs">æ³¨æ„ï¼šæ˜¯éŠæˆ²å¸³è™Ÿï¼Œä¸¦éè§’è‰²ID</span></p>
                                    </div>
                                </div>
                                
                                {gameAccounts.length === 0 ? (
                                    <div className="bg-gold-50 border-2 border-gold-300 rounded-xl p-6 text-center">
                                        <AlertCircle size={32} className="mx-auto text-gold-600 mb-3" />
                                        <p className="text-gold-800 font-bold mb-2">å°šæœªè¨­å®šéŠæˆ²å¸³è™Ÿ</p>
                                        <p className="text-gold-700 text-sm mb-4">è«‹å…ˆåˆ°æœƒå“¡ä¸­å¿ƒæ–°å¢éŠæˆ²å¸³è™Ÿ</p>
                                        <a 
                                            href="/member" 
                                            className="inline-flex items-center gap-2 px-4 py-2 bg-gold-500 hover:bg-gold-600 text-white font-bold rounded-xl transition-colors"
                                        >
                                            å‰å¾€æœƒå“¡ä¸­å¿ƒ
                                            <ArrowRight size={16} />
                                        </a>
                                    </div>
                                ) : (
                                    <>
                                        {/* å¸³è™Ÿé¸æ“‡ä¸‹æ‹‰é¸å–® */}
                                        <div className="mb-4">
                                            <label className="block text-stone-700 font-bold mb-3 text-sm">è«‹é¸æ“‡éŠæˆ²å¸³è™Ÿ *</label>
                                            <select
                                                value={selectedAccountId}
                                                onChange={(e) => {
                                                    setSelectedAccountId(e.target.value);
                                                    setFormErrors(prev => ({ ...prev, gameAccount: '' }));
                                                }}
                                                className={`w-full text-lg font-bold p-4 rounded-2xl border-2 focus:ring-4 focus:ring-gold-100/50 focus:outline-none bg-white transition-all duration-200 ${
                                                    formErrors.gameAccount 
                                                        ? 'border-fire-400 focus:border-fire-400 text-fire-700' 
                                                        : 'border-stone-200 focus:border-gold-400 text-stone-700'
                                                }`}
                                            >
                                                <option value="">è«‹é¸æ“‡...</option>
                                                {gameAccounts.map((account) => (
                                                    <option key={account.id} value={account.id}>
                                                        {account.name} {account.is_primary ? '(ä¸»å¸³è™Ÿ)' : ''}
                                                    </option>
                                                ))}
                                            </select>
                                            
                                            {/* é‡è¦æé†’ */}
                                            <div className="bg-fire-50 border-2 border-fire-400 rounded-xl p-4 mt-3">
                                                <p className="text-fire-800 font-bold text-sm flex items-start gap-2">
                                                    <AlertCircle size={18} className="mt-0.5 shrink-0 text-fire-600" />
                                                    <span>
                                                        <strong className="text-base">âš ï¸ è«‹ç‰¹åˆ¥æ³¨æ„ï¼</strong>
                                                        <br />
                                                        <span className="text-fire-700 mt-1.5 inline-block">
                                                            è«‹å¡«å¯«<strong className="underline">éŠæˆ²å¸³è™Ÿ</strong>ï¼ˆç™»å…¥ç”¨ï¼‰ï¼Œ<strong className="text-fire-800">ä¸¦éè§’è‰²ID</strong>ï¼<br />
                                                            å¿…é ˆèˆ‡éŠæˆ²å…§å¸³è™Ÿå®Œå…¨ä¸€è‡´ï¼Œè™›å¯¶å°‡ç”±ç®¡ç†å“¡äººå·¥ç™¼æ”¾è‡³æ­¤å¸³è™Ÿã€‚
                                                        </span>
                                                    </span>
                                                </p>
                                            </div>
                                        </div>
                                        
                                        {/* éŒ¯èª¤è¨Šæ¯ */}
                                        {formErrors.gameAccount && (
                                            <div className="bg-fire-50 border-2 border-fire-300 rounded-xl p-4 mb-4">
                                                <p className="text-fire-700 font-bold text-sm flex items-center gap-2">
                                                    <AlertCircle size={16}/> 
                                                    {formErrors.gameAccount}
                                                </p>
                                            </div>
                                        )}
                                        
                                        {/* é¸ä¸­å¸³è™Ÿçš„æç¤º */}
                                        {selectedAccountId && (
                                            <div className="bg-wind-50 border-2 border-wind-300 rounded-xl p-4 mt-4">
                                                <p className="text-wind-700 font-bold text-sm flex items-start gap-2">
                                                    <CheckCircle size={16} className="mt-0.5 shrink-0"/> 
                                                    <span>
                                                        å·²é¸æ“‡è´ŠåŠ©å¸³è™Ÿï¼š<strong className="text-wind-800">ã€Œ{gameAccounts.find(acc => acc.id === selectedAccountId)?.name}ã€</strong>
                                                        <br />
                                                        <span className="text-xs text-wind-600 mt-1 inline-block">
                                                            è«‹ç¢ºèªæ­¤å¸³è™Ÿèˆ‡éŠæˆ²å…§å®Œå…¨ç›¸åŒï¼Œè™›å¯¶å°‡ç”±ç®¡ç†å“¡äººå·¥å¯©æ ¸å¾Œç™¼æ”¾
                                                        </span>
                                                    </span>
                                                </p>
                                            </div>
                                        )}
                                        
                                        {/* æç¤ºï¼šå¦‚ä½•æ–°å¢æ›´å¤šå¸³è™Ÿ */}
                                        {gameAccounts.length < 5 && (
                                            <div className="mt-4 p-3 bg-stone-50 rounded-xl">
                                                <p className="text-stone-600 text-xs">
                                                    ğŸ’¡ æ‚¨é‚„å¯ä»¥æ–°å¢ {5 - gameAccounts.length} å€‹éŠæˆ²å¸³è™Ÿã€‚
                                                    <a href="/member" className="text-gold-600 hover:text-gold-700 font-bold ml-1">å‰å¾€æœƒå“¡ä¸­å¿ƒç®¡ç†</a>
                                                </p>
                                            </div>
                                        )}
                                        
                                        {/* LINE åç¨± æˆ– Discord åç¨±ï¼ˆå¿…å¡«ï¼‰ */}
                                        <div ref={lineNameRef} className="mt-6 pt-6 border-t border-stone-200">
                                            <label className="block text-stone-700 font-bold mb-3 text-sm flex items-center gap-2">
                                                <span className="text-green-600">ğŸ“±</span>
                                                LINE åç¨± æˆ– Discord åç¨±
                                                <span className="text-fire-500 text-xs font-bold">(å¿…å¡«)</span>
                                            </label>
                                            <input
                                                type="text"
                                                value={lineName}
                                                onChange={(e) => {
                                                    setLineName(e.target.value);
                                                    if (formErrors.lineName) setFormErrors(prev => ({ ...prev, lineName: '' }));
                                                }}
                                                placeholder="è«‹è¼¸å…¥æ‚¨çš„ LINE é¡¯ç¤ºåç¨±æˆ– Discord åç¨±"
                                                className={`w-full text-lg font-bold p-4 rounded-2xl border-2 focus:ring-4 focus:outline-none bg-white text-stone-700 placeholder-stone-400 transition-all duration-200 ${
                                                    formErrors.lineName ? 'border-fire-400 focus:border-fire-400 focus:ring-fire-100/50' : 'border-stone-200 focus:border-green-400 focus:ring-green-100/50'
                                                }`}
                                            />
                                            {formErrors.lineName && (
                                                <p className="text-fire-500 text-sm font-bold mt-2 flex items-center gap-1">
                                                    <AlertCircle size={14} /> {formErrors.lineName}
                                                </p>
                                            )}
                                            <p className="text-stone-500 text-xs mt-2 flex items-start gap-1">
                                                <span>ğŸ’¡</span>
                                                <span>è«‹å¡«å¯«æ‚¨çš„ LINE æˆ– Discord åç¨±ï¼Œä»¥ä¾¿å®¢æœè¯ç¹«èˆ‡ç™¼æ”¾è™›å¯¶</span>
                                            </p>
                                        </div>
                                    </>
                                )}
                            </div>

                            <div ref={methodRef} className="stone-panel p-8 md:p-10 border-gold-300/50 shadow-sm">
                                <div className="flex items-center gap-4 mb-8 pb-6 border-b border-stone-100">
                                    <div className="p-3 bg-gold-50 rounded-2xl text-gold-600"><CreditCard size={28} /></div>
                                    <h3 className="text-2xl font-bold text-stone-700">1. é¸æ“‡æ”¯ä»˜æ–¹å¼</h3>
                                </div>
                                {formErrors.method && <p className="text-fire-500 font-bold mb-4 text-sm flex items-center gap-1"><AlertCircle size={14}/> {formErrors.method}</p>}
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-6">
                                    {PAYMENT_METHODS.map((method, i) => {
                                        let ShoplineIcon1, ShoplineIcon2;
                                        if (method.id === 'shopline') {
                                            ShoplineIcon1 = method.icons[0];
                                            ShoplineIcon2 = method.icons[1];
                                        }
                                        const isSelected = selectedMethod === method.id;

                                        return (
                                            <div 
                                                key={i} 
                                                onClick={() => { setSelectedMethod(method.id); setFormErrors(prev => ({ ...prev, method: '' })); }}
                                                role="button"
                                                tabIndex={0}
                                                onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); setSelectedMethod(method.id); setFormErrors(prev => ({ ...prev, method: '' })); } }}
                                                className={`relative flex flex-col items-center justify-center p-6 md:p-8 rounded-2xl border-2 cursor-pointer transition-all duration-300 min-h-[140px]
                                                ${isSelected ? 'border-gold-400 bg-gradient-to-br from-gold-50 to-amber-50 shadow-xl shadow-gold-200/40 ring-2 ring-gold-300/50 scale-[1.02]' : 'border-stone-200 bg-white hover:border-gold-300 hover:bg-stone-50/80 hover:shadow-lg active:scale-[0.98]'}`}
                                            >
                                                {isSelected && <div className="absolute top-4 right-4 w-7 h-7 rounded-full bg-gold-400 flex items-center justify-center animate-fade-in"><CheckCircle size={18} className="text-white" strokeWidth={3}/></div>}
                                                {method.id === 'shopline' ? (
                                                    <>
                                                        <div className="flex items-center justify-center gap-2 flex-wrap mb-3 bg-gradient-to-br from-stone-50 to-amber-50/50 px-3 py-2 rounded-xl w-full border border-stone-100">
                                                            <ShoplineIcon1 size={16} className="text-stone-500 shrink-0"/>
                                                            <ShoplineIcon2 size={16} className="text-stone-500 shrink-0"/>
                                                            {method.imgs?.map((logo, idx) => (
                                                                <img key={idx} src={getAssetUrl(logo)} alt="" className="h-4 w-auto object-contain" />
                                                            ))}
                                                        </div>
                                                        <span className="text-stone-700 font-bold text-base mb-0.5 text-center leading-tight">{method.name}</span>
                                                        <span className="text-stone-500 text-xs font-medium text-center">{method.subLabel}</span>
                                                    </>
                                                ) : (
                                                    <>
                                                        <div className="h-14 flex items-center justify-center mb-3 p-2 bg-stone-50 rounded-xl w-full">
                                                            <img src={getAssetUrl(method.img)} alt={method.name} className="h-full w-auto object-contain drop-shadow-sm" />
                                                        </div>
                                                        <span className="text-stone-700 font-bold text-base mb-0.5">{method.name}</span>
                                                        {method.subLabel && <span className="text-stone-500 text-xs font-medium">{method.subLabel}</span>}
                                                    </>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                <div ref={planRef}>
                                    <div className="flex items-center gap-6 mb-8 mt-12 pb-6 border-b border-stone-100">
                                        <div className="p-3 bg-gold-50 rounded-2xl text-gold-600"><Coins size={28} /></div>
                                        <h3 className="text-2xl font-bold text-stone-700">2. é¸æ“‡è´ŠåŠ©æ–¹æ¡ˆ</h3>
                                    </div>
                                    {formErrors.plan && <p className="text-fire-500 font-bold mb-4 text-sm flex items-center gap-1"><AlertCircle size={14}/> {formErrors.plan}</p>}
                                    <div className="grid sm:grid-cols-2 gap-5 md:gap-6">
                                    {PLANS.map((plan, i) => {
                                        const isSelected = selectedPlan === plan;
                                        return (
                                            <div 
                                                key={i} 
                                                onClick={() => { setSelectedPlan(plan); setFormErrors(prev => ({ ...prev, plan: '' })); }}
                                                role="button"
                                                tabIndex={0}
                                                onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); setSelectedPlan(plan); setFormErrors(prev => ({ ...prev, plan: '' })); } }}
                                                className={`relative p-5 md:p-6 rounded-2xl bg-white border-2 cursor-pointer group transition-all duration-300
                                                ${isSelected ? 'border-gold-400 ring-2 ring-gold-200/50 bg-gradient-to-br from-gold-50/80 to-amber-50/60 shadow-lg' : 'border-stone-200 hover:border-gold-300 hover:shadow-md hover:bg-stone-50/50'}`}
                                            >
                                                {plan.popular && (
                                                    <div className="absolute top-0 left-0 bg-gold-400 text-white text-[10px] font-bold px-3 py-1 rounded-br-xl z-10 tracking-wider">
                                                        ç†±é–€
                                                    </div>
                                                )}
                                                {isSelected && <div className="absolute top-4 right-4 text-gold-500"><CheckCircle size={24} fill="currentColor" className="text-white"/></div>}

                                                {plan.bonus > 0 && !isSelected && (
                                                    <div className="absolute top-4 right-4 bg-red-100 text-red-500 text-xs font-bold px-2 py-1 rounded-lg">
                                                        +{plan.rate}
                                                    </div>
                                                )}
                                                <div className="relative z-10 mt-1">
                                                    <div className="text-2xl md:text-3xl font-black text-stone-700 mb-3">NT$ {plan.amount.toLocaleString()}</div>
                                                    <div className="space-y-2">
                                                        <div className="flex items-baseline gap-2">
                                                            <span className="text-stone-400 text-sm font-bold">å¯¦æ‹¿</span>
                                                            <span className="text-xl md:text-2xl font-bold text-gold-600">{plan.total.toLocaleString()}</span>
                                                            <span className="text-gold-600 text-xs font-bold uppercase">Gold</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="space-y-8">
                            <div className="stone-panel p-8 bg-white border-2 border-stone-200 sticky top-32 shadow-xl shadow-stone-200/50">
                                <h3 className="text-xl font-bold mb-6 text-stone-700 flex items-center gap-2"><ScrollText size={20} className="text-stone-400"/> è¨‚å–®ç¢ºèª</h3>
                                
                                <div className="bg-stone-50/50 p-5 rounded-2xl border border-stone-100 mb-6 space-y-3">
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="text-stone-400 font-bold">æ”¯ä»˜æ–¹å¼</span>
                                        <span className={`font-bold ${selectedMethod ? 'text-stone-700' : 'text-stone-300'}`}>
                                            {selectedMethod ? PAYMENT_METHODS.find(m => m.id === selectedMethod).name : 'å°šæœªé¸æ“‡'}
                                        </span>
                                    </div>
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="text-stone-400 font-bold">è´ŠåŠ©é‡‘é¡</span>
                                        <span className={`font-bold ${selectedPlan ? 'text-gold-600' : 'text-stone-300'}`}>
                                            {selectedPlan ? `NT$ ${selectedPlan.amount.toLocaleString()}` : 'å°šæœªé¸æ“‡'}
                                        </span>
                                    </div>
                                    <div className="flex justify-between items-center pt-3 border-t border-stone-200/50 border-dashed text-sm">
                                        <span className="text-stone-400 font-bold">éŠæˆ²å¸³è™Ÿ</span>
                                        <span className={`font-bold ${selectedAccountId ? 'text-stone-700' : 'text-red-400'}`}>
                                            {gameAccounts.find(acc => acc.id === selectedAccountId)?.name || 'å°šæœªé¸æ“‡'}
                                        </span>
                                    </div>
                                </div>

                                <div className="mt-6 pt-0">
                                    <Button 
                                        variant="gold" 
                                        className="w-full text-lg py-5 rounded-2xl shadow-xl shadow-gold-200/50 hover:shadow-2xl hover:shadow-gold-300/40 transition-all duration-300 font-black tracking-wide" 
                                        icon={ExternalLink} 
                                        onClick={handlePayment}
                                    >
                                        å‰å¾€æ”¯ä»˜
                                    </Button>
                                    <p className="text-center text-stone-400 text-xs mt-4 font-medium flex items-center justify-center gap-1">
                                        <span className="inline-block w-4 h-4 rounded-full bg-green-400/20 flex items-center justify-center"><span className="text-green-600 text-[10px]">ğŸ”’</span></span>
                                        å®‰å…¨æ”¯ä»˜ç”± SHOPLINE / LINE é‡‘æµæä¾›
                                    </p>
                                </div>
                                
                                <ul className="space-y-2 text-stone-400 font-medium text-xs mt-6 border-t border-stone-100 pt-6">
                                    <li className="flex gap-2 items-start"><CheckCircle className="text-stone-300 shrink-0 mt-0.5" size={14}/> <span>è´ŠåŠ©æ¬¾é …å…¨æ•¸ç”¨æ–¼ä¼ºæœå™¨ç‡Ÿé‹æˆæœ¬</span></li>
                                    <li className="flex gap-2 items-start"><CheckCircle className="text-stone-300 shrink-0 mt-0.5" size={14}/> <span>è´ŠåŠ©ç‚ºè‡ªé¡˜è¡Œç‚ºï¼Œå®Œæˆå¾Œç„¡æ³•é€€é‚„</span></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    {/* å®¢æœè¯ç¹« - å„²å€¼å•é¡Œ */}
                    <div className="max-w-7xl mx-auto mt-12">
                        <div className="bg-gradient-to-br from-fire-50 via-red-50 to-orange-50 border-2 border-fire-300 rounded-3xl p-8 md:p-12 shadow-lg">
                            <div className="flex flex-col md:flex-row gap-6 items-start md:items-center">
                                <div className="bg-fire-100 p-4 rounded-2xl shrink-0">
                                    <AlertCircle size={40} className="text-fire-600" />
                                </div>
                                <div className="flex-1">
                                    <h3 className="text-2xl font-black text-fire-800 mb-3 flex items-center gap-2">
                                        å„²å€¼é‡åˆ°å•é¡Œï¼Ÿ
                                    </h3>
                                    <div className="space-y-2 text-stone-700 font-medium">
                                        <p className="text-base leading-relaxed">
                                            <strong className="text-fire-700">âš ï¸ é‡è¦æé†’ï¼š</strong>å¦‚å„²å€¼æœ‰ä»»ä½•å•é¡Œï¼Œè«‹å‹™å¿…ä¿ç•™ä»¥ä¸‹è³‡æ–™ä¸¦è¯ç¹«å®¢æœï¼š
                                        </p>
                                        <ul className="space-y-1.5 ml-6 text-sm">
                                            <li className="flex items-start gap-2">
                                                <CheckCircle size={16} className="text-fire-500 mt-0.5 shrink-0" />
                                                <span><strong className="text-fire-700">å®˜ç¶²é é¢æˆªåœ–</strong>ï¼ˆåŒ…å«è¨‚å–®è³‡è¨Šï¼‰</span>
                                            </li>
                                            <li className="flex items-start gap-2">
                                                <CheckCircle size={16} className="text-fire-500 mt-0.5 shrink-0" />
                                                <span><strong className="text-fire-700">è½‰å¸³/ä»˜æ¬¾ç´€éŒ„æˆªåœ–</strong>ï¼ˆå«æ™‚é–“ã€é‡‘é¡ï¼‰</span>
                                            </li>
                                            <li className="flex items-start gap-2">
                                                <CheckCircle size={16} className="text-fire-500 mt-0.5 shrink-0" />
                                                <span><strong className="text-fire-700">éŠæˆ²å¸³è™Ÿ</strong>èˆ‡<strong className="text-fire-700">è¨»å†Šä¿¡ç®±</strong></span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div className="shrink-0">
                                    <a 
                                        href="https://lin.ee/3vSihiH"
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="inline-flex items-center gap-2 px-6 py-3 bg-[#06C755] hover:bg-[#05B34C] text-white font-bold rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl hover:scale-105"
                                    >
                                        <MessageSquare size={20} />
                                        è¯ç¹«å®˜æ–¹ LINE
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* å…¬ç›Šæ‰¿è«¾ */}
                    <div className="max-w-7xl mx-auto mt-24 md:mt-32">
                        <div 
                            className="stone-panel p-10 md:p-20 relative overflow-hidden shadow-2xl border-0"
                            style={{ 
                                backgroundImage: `linear-gradient(to bottom, rgba(255,255,255,0.9), rgba(255,255,255,0.95)), url(${getAssetUrl(ASSETS.LOVE_BG)})`,
                                backgroundSize: 'cover',
                                backgroundPosition: 'center'
                            }}
                        >
                            <div className="text-center mb-16 relative z-10">
                                <div className="inline-flex items-center gap-2 px-5 py-2 rounded-full bg-red-50 text-red-500 font-bold mb-6 text-sm tracking-wide">
                                    <Heart className="fill-red-500" size={16} />
                                    <span>å…¬ç›Šæ‰¿è«¾</span>
                                </div>
                                <h2 className="text-4xl md:text-5xl font-display font-black text-stone-800 mb-6">ç‡Ÿæ”¶ 1% æçµ¦å…¬ç›Š</h2>
                                <p className="text-lg md:text-xl text-stone-500 font-medium max-w-2xl mx-auto leading-relaxed">
                                    è®“éŠæˆ²çš„æ­¡æ¨‚å»¶ä¼¸åˆ°ç¾å¯¦ä¸–ç•Œï¼Œå¹«åŠ©æ›´å¤šéœ€è¦çš„äººã€‚
                                </p>
                            </div>

                            <div className="grid md:grid-cols-3 gap-8 md:gap-12 mb-16 relative z-10">
                                {[
                                    {t: "é€æ˜å…¬é–‹", d: "ä¸å®šæœŸå…¬ä½ˆææ¬¾æ˜ç´°ï¼Œæœ‰è·¡å¯å¾ª", i: Eye, c: "text-water-500", b: "bg-water-50"},
                                    {t: "æŒçºŒæ‰¿è«¾", d: "é•·æœŸç©©å®šçš„è¨ˆç•«ï¼Œéä¸€æ™‚å™±é ­", i: Star, c: "text-gold-500", b: "bg-gold-50"},
                                    {t: "å…±åŒåƒèˆ‡", d: "æ¯ä½ç©å®¶çš„æ”¯æŒï¼Œéƒ½æ˜¯ä¸€ä»½æ„›å¿ƒ", i: HeartHandshake, c: "text-fire-500", b: "bg-fire-50"}
                                ].map((item, i) => (
                                    <div key={i} className="bg-white/80 p-8 rounded-3xl border border-stone-100 text-center hover:shadow-lg transition-all duration-500 backdrop-blur-sm">
                                        <div className={`w-16 h-16 mx-auto ${item.b} rounded-2xl flex items-center justify-center mb-6 ${item.c}`}>
                                            <item.i size={32} />
                                        </div>
                                        <h3 className="text-xl font-bold text-stone-700 mb-3">{item.t}</h3>
                                        <p className="text-stone-500 text-sm font-medium leading-relaxed">{item.d}</p>
                                    </div>
                                ))}
                            </div>

                            <div className="bg-stone-900 p-10 md:p-14 rounded-[2.5rem] relative z-10 text-white shadow-2xl">
                                <div className="flex flex-col md:flex-row gap-10 items-center">
                                    <div className="flex-1 space-y-6">
                                        <h3 className="text-2xl md:text-3xl font-display font-bold flex items-center gap-3 text-gold-400">
                                            <ScrollText className="text-stone-500" /> æˆ‘å€‘çš„å…¬ç›Šç†å¿µ
                                        </h3>
                                        <div className="space-y-4 text-stone-300 font-medium leading-loose text-base md:text-lg">
                                            <p>è˜‡æ‰“çŸ³å™¨å§‹çµ‚ç›¸ä¿¡ï¼ŒéŠæˆ²ä¸åƒ…æ˜¯å¨›æ¨‚ï¼Œæ›´æ˜¯ä¸€ç¨®é€£çµäººå¿ƒçš„æ–¹å¼ã€‚ æˆ‘å€‘å¸Œæœ›é€éé€™å€‹å¹³å°ï¼Œè®“ç©å®¶åœ¨äº«å—éŠæˆ²æ¨‚è¶£çš„åŒæ™‚ï¼Œä¹Ÿèƒ½ç‚ºç¤¾æœƒå¸¶ä¾†æ­£é¢çš„å½±éŸ¿ã€‚</p>
                                            <p>æˆ‘å€‘æ‰¿è«¾å°‡éŠæˆ²å•†åŸç‡Ÿæ”¶çš„ 1% æè´ˆçµ¦åˆæ ¼çš„å…¬ç›Šæ©Ÿæ§‹ï¼Œ åŒ…æ‹¬å…’ç«¥ç¦åˆ©ã€æ•™è‚²æ´åŠ©ã€å¼±å‹¢é—œæ‡·ç­‰é ˜åŸŸã€‚</p>
                                            <p className="text-white/90 border-l-4 border-gold-500 pl-4 py-1 mt-4">æ„Ÿè¬æ¯ä¸€ä½é¦´ç¸å¸«çš„æ”¯æŒï¼Œæ‚¨çš„æ¯ä¸€æ¬¡å„²å€¼ï¼Œéƒ½åœ¨ç‚ºé€™å€‹ä¸–ç•Œå¸¶ä¾†ä¸€é»æº«æš–ã€‚</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </motion.div>
            );
        };

        const SupportPage = () => {
            const handleLine = () => window.open('https://lin.ee/3vSihiH', '_blank'); // FIXED: Support LINE

            return (
                <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0 }} className="pt-32 md:pt-44 pb-28 md:pb-24 px-4 md:px-6 min-h-screen">
                    <div className="max-w-4xl mx-auto w-full space-y-8">
                        <PageHeader title="éƒ¨è½å®¢æœä¸­å¿ƒ" subtitle="ä¿è­·æ‚¨çš„å¸³è™Ÿå®‰å…¨ï¼Œé é›¢è©é¨™" icon={ShieldCheck} color="text-gold-500" />
                        
                        {/* å®˜æ–¹ LINE å€å¡Š */}
                        <div className="stone-panel p-10 md:p-16 text-center shadow-xl bg-white">
                            <div className="w-28 h-28 md:w-36 md:h-36 mx-auto mb-8 drop-shadow-xl hover:scale-105 transition-transform duration-500">
                                <SmartImage src={getAssetUrl(ASSETS.LINE_LOGO)} fallbackType="logo" className="w-full h-full object-contain rounded-[2rem] border-4 border-white shadow-lg" alt="LINE" />
                            </div>
                            
                            <h3 className="text-3xl md:text-4xl font-display font-black text-stone-800 mb-4">åŠ å…¥å®˜æ–¹ LINE</h3>
                            <p className="text-stone-500 font-medium text-lg mb-10 max-w-md mx-auto leading-relaxed">
                                å°ˆäººä¸€å°ä¸€æœå‹™ï¼Œè§£æ±ºæ‚¨çš„éŠæˆ²å•é¡Œã€å„²å€¼ç•°å¸¸æˆ–é•è¦æª¢èˆ‰ã€‚
                            </p>

                            <div className="bg-stone-50 rounded-3xl p-8 mb-10 border border-stone-100 inline-block w-full max-w-sm">
                                <p className="text-stone-400 text-xs font-bold mb-2 uppercase tracking-widest">å®˜æ–¹ LINE ID</p>
                                <p className="text-3xl md:text-4xl font-black text-stone-700 tracking-wider font-mono">@939yjtdj</p>
                            </div>

                            <div className="flex justify-center">
                                <Button variant="line" className="w-full md:w-auto min-w-[280px] py-4 text-xl rounded-2xl shadow-lg shadow-green-100" icon={LineIcon} onClick={handleLine}>
                                    ç«‹å³åŠ å…¥å¥½å‹
                                </Button>
                            </div>
                            
                            <p className="text-stone-400 text-xs font-medium mt-10 bg-stone-50 inline-block px-4 py-1.5 rounded-full">
                                æœå‹™æ™‚é–“ï¼šæ¯æ—¥ 10:00 - 22:00
                            </p>
                        </div>

                        {/* é˜²è©é¨™è­¦å‘Š */}
                        <div className="bg-gradient-to-br from-red-50 via-orange-50 to-red-50 border-4 border-red-400 rounded-3xl p-8 md:p-10 shadow-2xl">
                            <div className="flex items-start gap-4 mb-6">
                                <div className="bg-red-500 p-3 md:p-4 rounded-2xl shrink-0">
                                    <AlertCircle size={36} className="text-white" />
                                </div>
                                <div>
                                    <h2 className="text-2xl md:text-3xl font-black text-red-700 mb-2">ğŸš¨ é˜²è©é¨™è­¦å‘Š</h2>
                                    <p className="text-red-600 font-bold text-base md:text-lg">è«‹å‹™å¿…ä»”ç´°é–±è®€ï¼Œä¿è­·æ‚¨çš„å¸³è™Ÿèˆ‡è²¡ç”¢å®‰å…¨ï¼</p>
                                </div>
                            </div>
                            
                            <div className="bg-white rounded-2xl p-6 md:p-8 space-y-6">
                                <div className="space-y-4">
                                    <h3 className="font-black text-red-700 text-lg md:text-xl flex items-center gap-2">
                                        <CheckCircle size={24} />
                                        å®˜æ–¹å”¯ä¸€å„²å€¼ç®¡é“
                                    </h3>
                                    <ul className="space-y-2 text-stone-700 font-bold text-sm md:text-base ml-4">
                                        <li>âœ… æœ¬ç¶²ç«™ç‚ºå®˜æ–¹å”¯ä¸€å„²å€¼ç¶²ç«™</li>
                                        <li>âœ… åªæ¥å— LINE Payã€SHOPLINE ç­‰ç¬¬ä¸‰æ–¹é‡‘æµ</li>
                                        <li>âœ… å®˜æ–¹ LINE IDï¼š<span className="text-green-600">@939yjtdj</span></li>
                                    </ul>
                                </div>

                                <div className="border-t border-red-200 pt-6 space-y-4">
                                    <h3 className="font-black text-red-700 text-lg md:text-xl flex items-center gap-2">
                                        <X size={24} />
                                        å®˜æ–¹çµ•ä¸æœƒè¦æ±‚æ‚¨
                                    </h3>
                                    <ul className="space-y-2 text-stone-700 font-bold text-sm md:text-base ml-4">
                                        <li>ğŸš« ç§ä¸‹é€éå€‹äººå¸³è™Ÿè½‰å¸³ã€åŒ¯æ¬¾</li>
                                        <li>ğŸš« æä¾›éŠæˆ²å¸³è™Ÿå¯†ç¢¼</li>
                                        <li>ğŸš« é€éä¾†è·¯ä¸æ˜çš„ç¶²ç«™å„²å€¼</li>
                                        <li>ğŸš« é€²è¡Œã€Œä»£å„²ã€ã€ã€Œä½åƒ¹å„²å€¼ã€</li>
                                        <li>ğŸš« é»æ“Šå¯ç–‘é€£çµæˆ–æƒæä¸æ˜ QR Code</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        {/* å¸¸è¦‹è©é¨™æ‰‹æ³• */}
                        <div className="stone-panel p-8 md:p-10 bg-white">
                            <h2 className="text-xl md:text-2xl font-black text-stone-800 mb-6 flex items-center gap-3">
                                <Eye size={28} className="text-orange-500" />
                                å¸¸è¦‹è©é¨™æ‰‹æ³•
                            </h2>
                            
                            <div className="grid md:grid-cols-2 gap-4 md:gap-6">
                                <div className="bg-orange-50 border-2 border-orange-300 rounded-xl p-5">
                                    <h3 className="font-black text-orange-700 text-base md:text-lg mb-2 flex items-center gap-2">
                                        <User size={18} />
                                        å‡å®¢æœè©é¨™
                                    </h3>
                                    <p className="text-stone-700 text-sm leading-relaxed">
                                        å‡å†’å®˜æ–¹å®¢æœç´¢å–<strong className="text-orange-700">å¸³è™Ÿå¯†ç¢¼</strong>
                                        <br />
                                        <strong className="text-orange-700">âš ï¸ å®˜æ–¹çµ•ä¸ç´¢å–å¯†ç¢¼ï¼</strong>
                                    </p>
                                </div>

                                <div className="bg-orange-50 border-2 border-orange-300 rounded-xl p-5">
                                    <h3 className="font-black text-orange-700 text-base md:text-lg mb-2 flex items-center gap-2">
                                        <Coins size={18} />
                                        ä½åƒ¹ä»£å„²è©é¨™
                                    </h3>
                                    <p className="text-stone-700 text-sm leading-relaxed">
                                        å®£ç¨±æ¯”å®˜æ–¹ä¾¿å®œçš„ä»£å„²æœå‹™
                                        <br />
                                        <strong className="text-orange-700">âš ï¸ è²ªå°ä¾¿å®œæ˜“ä¸Šç•¶ï¼</strong>
                                    </p>
                                </div>

                                <div className="bg-orange-50 border-2 border-orange-300 rounded-xl p-5">
                                    <h3 className="font-black text-orange-700 text-base md:text-lg mb-2 flex items-center gap-2">
                                        <ExternalLink size={18} />
                                        é‡£é­šç¶²ç«™è©é¨™
                                    </h3>
                                    <p className="text-stone-700 text-sm leading-relaxed">
                                        å»ºç«‹å‡å®˜ç¶²èª˜å°è¼¸å…¥å¸³å¯†
                                        <br />
                                        <strong className="text-orange-700">âš ï¸ ä»”ç´°æª¢æŸ¥ç¶²å€ï¼</strong>
                                    </p>
                                </div>

                                <div className="bg-orange-50 border-2 border-orange-300 rounded-xl p-5">
                                    <h3 className="font-black text-orange-700 text-base md:text-lg mb-2 flex items-center gap-2">
                                        <MessageSquare size={18} />
                                        å‡å®˜æ–¹å¸³è™Ÿè©é¨™
                                    </h3>
                                    <p className="text-stone-700 text-sm leading-relaxed">
                                        å»ºç«‹å‡ LINE ç™¼é€è©é¨™è¨Šæ¯
                                        <br />
                                        <strong className="text-orange-700">âš ï¸ èªæ˜å®˜æ–¹å¸³è™Ÿï¼</strong>
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* é‡åˆ°è©é¨™æ€éº¼è¾¦ */}
                        <div className="bg-gradient-to-br from-fire-50 to-red-50 border-2 border-fire-400 rounded-3xl p-8">
                            <h2 className="text-xl md:text-2xl font-black text-fire-700 mb-4 flex items-center gap-2">
                                <AlertCircle size={26} />
                                é‡åˆ°è©é¨™æ€éº¼è¾¦ï¼Ÿ
                            </h2>
                            <div className="space-y-3">
                                <p className="text-stone-700 font-bold text-sm md:text-base flex items-start gap-2">
                                    <span className="text-fire-600 font-black shrink-0">1.</span>
                                    <span><strong className="text-fire-700">ç«‹å³åœæ­¢</strong>èˆ‡å°æ–¹çš„ä¸€åˆ‡è¯ç¹«</span>
                                </p>
                                <p className="text-stone-700 font-bold text-sm md:text-base flex items-start gap-2">
                                    <span className="text-fire-600 font-black shrink-0">2.</span>
                                    <span><strong className="text-fire-700">ä¿ç•™è­‰æ“š</strong>ï¼šæˆªåœ–å°è©±ã€äº¤æ˜“ç´€éŒ„</span>
                                </p>
                                <p className="text-stone-700 font-bold text-sm md:text-base flex items-start gap-2">
                                    <span className="text-fire-600 font-black shrink-0">3.</span>
                                    <span><strong className="text-fire-700">è¯ç¹«å®˜æ–¹</strong>ï¼šé€éå®˜æ–¹ LINEï¼ˆ@939yjtdjï¼‰å›å ±</span>
                                </p>
                                <p className="text-stone-700 font-bold text-sm md:text-base flex items-start gap-2">
                                    <span className="text-fire-600 font-black shrink-0">4.</span>
                                    <span><strong className="text-fire-700">å ±è­¦è™•ç†</strong>ï¼šé‡‘é¡è¼ƒå¤§æ™‚å»ºè­°å ±æ¡ˆ</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </motion.div>
            );
        };

        const NotFoundPage = () => {
            const navigate = useNavigate();
            return (
                <div className="min-h-screen flex items-center justify-center px-4 pt-20">
                    <div className="text-center max-w-md">
                        <div className="text-8xl font-black text-stone-200 mb-4">404</div>
                        <h1 className="text-2xl font-black text-stone-800 mb-3">æ‰¾ä¸åˆ°é é¢</h1>
                        <p className="text-stone-500 mb-8">ä½ è¦æ‰¾çš„é é¢ä¸å­˜åœ¨æˆ–å·²è¢«ç§»é™¤ã€‚</p>
                        <div className="flex gap-3 justify-center">
                            <button onClick={() => navigate(-1)} className="px-6 py-3 bg-stone-100 hover:bg-stone-200 text-stone-700 font-bold rounded-xl transition-colors">
                                è¿”å›ä¸Šä¸€é 
                            </button>
                            <Link to="/" className="px-6 py-3 bg-gradient-to-r from-gold-500 to-orange-500 hover:from-gold-600 hover:to-orange-600 text-white font-bold rounded-xl transition-colors">
                                å›é¦–é 
                            </Link>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminPage = () => {
            // âœ… å·²é·ç§»åˆ° Supabase Auth èªè­‰ç³»çµ±
            const [adminScriptsReady, setAdminScriptsReady] = useState(() => !!(window.Chart && window.Quill));
            useEffect(() => {
                if (window.Chart && window.Quill) {
                    setAdminScriptsReady(true);
                    return;
                }
                if (window.loadAdminScripts) {
                    const timer = setTimeout(() => setAdminScriptsReady(true), 8000); // 8 ç§’è¶…æ™‚ï¼Œé¿å… CDN å¤±æ•—æ™‚å¡ä½
                    window.loadAdminScripts().then(() => { clearTimeout(timer); setAdminScriptsReady(true); });
                    return () => clearTimeout(timer);
                } else {
                    setAdminScriptsReady(true);
                }
            }, []);
            // ç‹€æ…‹ç®¡ç†
            const [data, setData] = useState([]);
            const [events, setEvents] = useState([]);
            const [admins, setAdmins] = useState([]);
            const [playlist, setPlaylist] = useState([]);
            const [adminUsers, setAdminUsers] = useState([]);
            const [allUsers, setAllUsers] = useState([]);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [supabaseUser, setSupabaseUser] = useState(null);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [rememberAdminMe, setRememberAdminMe] = useState(false); // ç®¡ç†å“¡è¨˜ä½æˆ‘
            const [error, setError] = useState('');
            
            // å®‰å…¨ç·¨ç¢¼/è§£ç¢¼å¯†ç¢¼ï¼ˆæ”¯æ´ Unicodeï¼‰
            const safeBtoa = (str) => {
                try {
                    return btoa(unescape(encodeURIComponent(str)));
                } catch (e) {
                    return btoa(str);
                }
            };
            const safeAtob = (str) => {
                try {
                    return decodeURIComponent(escape(atob(str)));
                } catch (e) {
                    try { return atob(str); } catch (e2) { return ''; }
                }
            };

            // è¼‰å…¥ç®¡ç†å“¡è¨˜ä½çš„å¸³è™Ÿå¯†ç¢¼ï¼ˆåˆæ¬¡è¼‰å…¥ + æ¯æ¬¡é¡¯ç¤ºç™»å…¥è¡¨å–®æ™‚ï¼‰
            const loadRememberedAdmin = () => {
                const savedAdminEmail = localStorage.getItem('rememberedAdminEmail');
                const savedAdminPassword = localStorage.getItem('rememberedAdminPassword');
                if (savedAdminEmail) {
                    setUsername(savedAdminEmail);
                    setRememberAdminMe(true);
                }
                if (savedAdminPassword) {
                    setPassword(safeAtob(savedAdminPassword));
                }
                if (savedAdminEmail || savedAdminPassword) {
                    console.log('[å¾Œå°] å·²è¼‰å…¥è¨˜ä½çš„å¸³è™Ÿå¯†ç¢¼');
                }
            };

            // åˆå§‹åŒ–æ™‚æª¢æŸ¥ Supabase Sessionï¼ˆä¿æŒç™»å…¥ï¼‰
            useEffect(() => {
                const checkSession = async () => {
                    try {
                        const { data: { user } } = await supabase.auth.getUser();
                        if (user) {
                            const userRole = user.user_metadata?.role;
                            if (userRole && ['admin', 'super_admin'].includes(userRole)) {
                                setIsLoggedIn(true);
                                setCurrentUser({
                                    id: user.id,
                                    email: user.email,
                                    role: userRole,
                                    display_name: user.user_metadata?.display_name || user.email
                                });
                                setSupabaseUser(user);
                                console.log('[å¾Œå°] å·²å¾ Session æ¢å¾©ç™»å…¥ç‹€æ…‹');
                                return;
                            }
                        }
                    } catch (err) {
                        console.warn('[å¾Œå°] Session æª¢æŸ¥å¤±æ•—', err);
                    }
                    // æ²’æœ‰ session æˆ–ä¸æ˜¯ç®¡ç†å“¡ï¼Œè¼‰å…¥è¨˜ä½çš„å¸³è™Ÿå¯†ç¢¼
                    loadRememberedAdmin();
                };
                
                checkSession();
            }, []);

            // ç™»å‡ºå¾Œå†æ¬¡é¡¯ç¤ºç™»å…¥è¡¨å–®æ™‚ï¼Œé‡æ–°è¼‰å…¥è¨˜ä½çš„å¸³è™Ÿå¯†ç¢¼
            useEffect(() => {
                if (!isLoggedIn) {
                    loadRememberedAdmin();
                }
            }, [isLoggedIn]);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');
            const [currentTab, setCurrentTab] = useState('donations');
            
            // å…¬å‘Šæ©«å¹…ç®¡ç†
            const [adminBanners, setAdminBanners] = useState([]);
            const [editingBanner, setEditingBanner] = useState(null);
            const [bannerForm, setBannerForm] = useState({ title: '', subtitle: '', link: '/events', icon: 'megaphone', badge: 'NEW', is_active: true, sort_order: 0 });

            const loadAdminBanners = async () => {
                const data = await getSupabaseData(DB_TABLES.ANNOUNCEMENTS, { columns: 'id, title, subtitle, link, icon, badge, is_active, sort_order, created_at' });
                setAdminBanners((data || []).sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0)));
            };

            useEffect(() => {
                if (isLoggedIn && currentTab === 'events') loadAdminBanners();
            }, [isLoggedIn, currentTab]);

            const handleSaveBanner = async () => {
                if (!bannerForm.title.trim()) { showToast('è«‹è¼¸å…¥æ¨™é¡Œ', 'error'); return; }
                try {
                    if (editingBanner) {
                        const { error } = await supabase.from(DB_TABLES.ANNOUNCEMENTS).update(bannerForm).eq('id', editingBanner.id);
                        if (error) throw error;
                        showToast('å…¬å‘Šæ©«å¹…å·²æ›´æ–°');
                    } else {
                        const { error } = await supabase.from(DB_TABLES.ANNOUNCEMENTS).insert(bannerForm);
                        if (error) throw error;
                        showToast('å…¬å‘Šæ©«å¹…å·²æ–°å¢');
                    }
                    setEditingBanner(null);
                    setBannerForm({ title: '', subtitle: '', link: '/events', icon: 'megaphone', badge: 'NEW', is_active: true, sort_order: 0 });
                    loadAdminBanners();
                    window.dispatchEvent(new Event('banner-updated'));
                } catch (e) { showToast('å„²å­˜å¤±æ•—: ' + e.message, 'error'); }
            };

            const handleDeleteBanner = async (id) => {
                if (!confirm('ç¢ºå®šåˆªé™¤æ­¤å…¬å‘Šæ©«å¹…ï¼Ÿ')) return;
                try {
                    const { error } = await supabase.from(DB_TABLES.ANNOUNCEMENTS).delete().eq('id', id);
                    if (error) throw error;
                    showToast('å·²åˆªé™¤');
                    loadAdminBanners();
                    window.dispatchEvent(new Event('banner-updated'));
                } catch (e) { showToast('åˆªé™¤å¤±æ•—: ' + e.message, 'error'); }
            };

            const handleToggleBannerActive = async (banner) => {
                try {
                    const { error } = await supabase.from(DB_TABLES.ANNOUNCEMENTS).update({ is_active: !banner.is_active }).eq('id', banner.id);
                    if (error) throw error;
                    showToast(banner.is_active ? 'å·²åœç”¨' : 'å·²å•Ÿç”¨');
                    loadAdminBanners();
                    window.dispatchEvent(new Event('banner-updated'));
                } catch (e) { showToast('æ“ä½œå¤±æ•—: ' + e.message, 'error'); }
            };

            const startEditBanner = (banner) => {
                setEditingBanner(banner);
                setBannerForm({ title: banner.title, subtitle: banner.subtitle || '', link: banner.link || '/events', icon: banner.icon || 'megaphone', badge: banner.badge || '', is_active: banner.is_active, sort_order: banner.sort_order || 0 });
            };

            const cancelEditBanner = () => {
                setEditingBanner(null);
                setBannerForm({ title: '', subtitle: '', link: '/events', icon: 'megaphone', badge: 'NEW', is_active: true, sort_order: 0 });
            };

            // é€²éšæœå°‹
            const [showAdvancedSearch, setShowAdvancedSearch] = useState(false);
            const [dateFrom, setDateFrom] = useState('');
            const [dateTo, setDateTo] = useState('');
            const [amountMin, setAmountMin] = useState('');
            const [amountMax, setAmountMax] = useState('');
            const [filterPaymentMethod, setFilterPaymentMethod] = useState('all');
            const [filterTag, setFilterTag] = useState('all');
            
            // æ‰¹æ¬¡æ“ä½œ
            const [selectedIds, setSelectedIds] = useState([]);
            const [showBatchActions, setShowBatchActions] = useState(false);
            // è´ŠåŠ©åˆ—è¡¨æª¢è¦–ï¼šå¡ç‰‡ / æ¢åˆ—
            const [donationListView, setDonationListView] = useState('cards');
            
            // åœ–è¡¨ refs
            const trendChartRef = useRef(null);
            const paymentChartRef = useRef(null);
            const planChartRef = useRef(null);
            const trendChartInstance = useRef(null);
            const paymentChartInstance = useRef(null);
            const planChartInstance = useRef(null);
            
            // Donations ç›¸é—œï¼ˆç®¡ç†å“¡å¯ç·¨è¼¯è¨‚å–®ä»»ä½•è³‡è¨Šï¼‰
            const [editingId, setEditingId] = useState(null);
            const [editNotes, setEditNotes] = useState('');
            const [editGameAccount, setEditGameAccount] = useState('');
            const [editLineName, setEditLineName] = useState('');
            const [editEmail, setEditEmail] = useState('');
            const [editAmount, setEditAmount] = useState('');
            const [editCoins, setEditCoins] = useState('');
            const [editPlanName, setEditPlanName] = useState('');
            const [editPaymentMethod, setEditPaymentMethod] = useState('');
            const [editStatus, setEditStatus] = useState('');
            const [editingTags, setEditingTags] = useState(null);
            const [newTag, setNewTag] = useState('');
            
            // åˆ†é ç›¸é—œ
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(20);
            
            // ç¢ºèªå°è©±æ¡†ç›¸é—œ
            const [confirmModal, setConfirmModal] = useState({ show: false, title: '', message: '', onConfirm: null });
            
            // Settings State
            const [oldPassword, setOldPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [newAdminUsername, setNewAdminUsername] = useState('');
            const [newAdminPassword, setNewAdminPassword] = useState('');
            const [newAdminRoleType, setNewAdminRoleType] = useState('admin');
            
            // Events Form State
            const [eventTitle, setEventTitle] = useState('');
            const [eventContent, setEventContent] = useState('');
            const [eventTag, setEventTag] = useState(EVENT_TAGS[0].id);
            const [eventPopupAspect, setEventPopupAspect] = useState('1:1');
            const [editingEventId, setEditingEventId] = useState(null);
            const eventQuillRef = useRef(null);
            const eventEditorRef = useRef(null);

            // Music Form State
            const [newTrackTitle, setNewTrackTitle] = useState('');
            const [newTrackUrl, setNewTrackUrl] = useState('');
            
            // è¶…ç´šç®¡ç†å“¡ç®¡ç†ç›¸é—œ
            const [showAddAdminModal, setShowAddAdminModal] = useState(false);
            const [editingAdmin, setEditingAdmin] = useState(null);
            const [newAdminEmail, setNewAdminEmail] = useState('');
            const [newAdminRole, setNewAdminRole] = useState('admin');
            
            // æ“ä½œæ—¥èªŒè¼”åŠ©å‡½æ•¸
            const logAction = async (action, resourceType, resourceId, description, changes = null) => {
                try {
                    const logData = {
                        admin_id: currentUser?.id || supabaseUser?.id || 'unknown',
                        admin_username: currentUser?.username || supabaseUser?.email || 'unknown',
                        admin_role: currentUser?.role || supabaseUser?.user_metadata?.role || 'admin',
                        action,
                        resource_type: resourceType,
                        resource_id: resourceId,
                        description,
                        changes: changes ? JSON.stringify(changes) : null,
                        ip_address: null, // å¯é¸ï¼šå‰ç«¯ç„¡æ³•å–å¾—çœŸå¯¦ IP
                        user_agent: navigator.userAgent
                    };
                    
                    await supabase.from('audit_logs').insert([logData]);
                } catch (err) {
                    console.error('è¨˜éŒ„æ“ä½œæ—¥èªŒå¤±æ•—:', err);
                }
            };
            
            // ç¢ºèªå°è©±æ¡†è¼”åŠ©å‡½æ•¸
            const showConfirm = (title, message, onConfirm) => {
                setConfirmModal({ show: true, title, message, onConfirm });
            };
            
            const hideConfirm = () => {
                setConfirmModal({ show: false, title: '', message: '', onConfirm: null });
            };
            
            // CSV åŒ¯å‡ºå‡½æ•¸
            const exportToCSV = () => {
                try {
                    // æº–å‚™ CSV æ¨™é ­
                    const headers = ['è¨‚å–®ç·¨è™Ÿ', 'æ™‚é–“', 'éŠæˆ²å¸³è™Ÿ', 'Email', 'LINEæˆ–Discordåç¨±', 'æ–¹æ¡ˆåç¨±', 'é‡‘é¡', 'é‡‘å¹£', 'æ”¯ä»˜æ–¹å¼', 'ç‹€æ…‹', 'å‚™è¨»'];
                    
                    // æº–å‚™ CSV è³‡æ–™
                    const csvData = filteredData.map(item => [
                        item.order_number || '',
                        new Date(item.created_at).toLocaleString('zh-TW'),
                        item.game_account || '',
                        item.email || '',
                        item.line_name || '',
                        item.plan_name || '',
                        item.amount || 0,
                        item.coins || 0,
                        item.payment_method === 'shopline' ? 'SHOPLINE' : 
                        item.payment_method === 'linepay' ? 'LINE Pay' : item.payment_method || '',
                        item.status === 'pending' ? 'å¾…è™•ç†' : 
                        item.status === 'completed' ? 'å·²å®Œæˆ' : 
                        item.status === 'cancelled' ? 'å·²å–æ¶ˆ' : item.status,
                        (item.notes || '').replace(/"/g, '""') // è™•ç†å‚™è¨»ä¸­çš„é›™å¼•è™Ÿ
                    ]);
                    
                    // çµ„åˆ CSV å…§å®¹
                    const csvContent = [
                        headers.join(','),
                        ...csvData.map(row => row.map(cell => `"${cell}"`).join(','))
                    ].join('\n');
                    
                    // åŠ å…¥ BOM ä»¥æ”¯æ´ä¸­æ–‡
                    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', `è´ŠåŠ©ç´€éŒ„_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showToast('CSV åŒ¯å‡ºæˆåŠŸ', 'success');
                    logAction('view', 'donation', null, `åŒ¯å‡º ${filteredData.length} ç­†è´ŠåŠ©ç´€éŒ„ç‚º CSV`);
                } catch (err) {
                    console.error('CSV åŒ¯å‡ºå¤±æ•—:', err);
                    showToast('CSV åŒ¯å‡ºå¤±æ•—', 'error');
                }
            };

            // è¨»ï¼šå·²ç§»é™¤ admins è¡¨è¼‰å…¥é‚è¼¯ï¼Œå®Œå…¨ä½¿ç”¨ Supabase Auth
            
            // è¼‰å…¥ Supabase Auth ç”¨æˆ¶ï¼ˆç”¨æ–¼è¶…ç´šç®¡ç†å“¡åŠŸèƒ½ï¼‰
            useEffect(() => {
                const loadUser = async () => {
                    const user = await authHelpers.getCurrentUser();
                    setSupabaseUser(user);
                };
                loadUser();
            }, []);
            
            // è¼‰å…¥æ‰€æœ‰ç®¡ç†å“¡ï¼ˆåƒ…è¶…ç´šç®¡ç†å“¡å¯è¦‹ï¼‰
            useEffect(() => {
                if (!supabaseUser || supabaseUser.user_metadata?.role !== 'super_admin') return;
                if (currentTab !== 'super_admins') return;
                
                const loadAdminUsers = async () => {
                    try {
                        const { data, error } = await supabase.rpc('get_all_users');
                        
                        if (error) {
                            console.error('è¼‰å…¥ç®¡ç†å“¡å¤±æ•—:', error);
                            return;
                        }
                        
                        const admins = data.filter(u => 
                            u.role === 'admin' || 
                            u.role === 'super_admin'
                        );
                        setAdminUsers(admins);
                    } catch (err) {
                        console.error('è¼‰å…¥ç®¡ç†å“¡ç•°å¸¸:', err);
                    }
                };
                
                loadAdminUsers();
            }, [supabaseUser, currentTab]);
            
            // è¼‰å…¥æ‰€æœ‰è¨»å†Šç”¨æˆ¶ï¼ˆåƒ…è¶…ç´šç®¡ç†å“¡å¯è¦‹ï¼‰
            useEffect(() => {
                console.log('[è¨»å†Šç”¨æˆ¶] supabaseUser:', supabaseUser);
                console.log('[è¨»å†Šç”¨æˆ¶] role:', supabaseUser?.user_metadata?.role);
                console.log('[è¨»å†Šç”¨æˆ¶] currentTab:', currentTab);
                
                if (!supabaseUser || supabaseUser.user_metadata?.role !== 'super_admin') {
                    console.log('[è¨»å†Šç”¨æˆ¶] æ¬Šé™ä¸è¶³æˆ–éè¶…ç®¡');
                    return;
                }
                if (currentTab !== 'registered_users') {
                    console.log('[è¨»å†Šç”¨æˆ¶] æœªåœ¨è¨»å†Šç”¨æˆ¶é é¢');
                    return;
                }
                
                const loadAllUsers = async () => {
                    try {
                        console.log('[è¨»å†Šç”¨æˆ¶] é–‹å§‹è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨...');
                        const { data, error } = await supabase.rpc('get_all_users');
                        
                        if (error) {
                            console.error('è¼‰å…¥ç”¨æˆ¶å¤±æ•—:', error);
                            return;
                        }
                        
                        console.log('[è¨»å†Šç”¨æˆ¶] æˆåŠŸè¼‰å…¥ç”¨æˆ¶:', data?.length, 'ä½');
                        
                        // æŒ‰è¨»å†Šæ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                        const sortedUsers = data.sort((a, b) => 
                            new Date(b.created_at) - new Date(a.created_at)
                        );
                        setAllUsers(sortedUsers);
                    } catch (err) {
                        console.error('è¼‰å…¥ç”¨æˆ¶ç•°å¸¸:', err);
                    }
                };
                
                loadAllUsers();
            }, [supabaseUser, currentTab]);
            
            // ç™»å…¥è™•ç†
            const handleLogin = async (e) => {
                e.preventDefault();
                const form = e.target;
                // ç›´æ¥å¾ DOM è®€å– checkboxï¼Œé¿å… React state å°šæœªæ›´æ–°
                const rememberChecked = form && form.querySelector('#rememberAdminMe');
                const shouldRemember = rememberChecked ? rememberChecked.checked : rememberAdminMe;

                try {
                    // ä½¿ç”¨ Supabase Auth ç™»å…¥
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: username,
                        password: password
                    });
                    
                    if (error) {
                        const msg = error.message || '';
                        let errText = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
                        if (msg.includes('Email not confirmed')) errText = 'è«‹å…ˆåˆ°ä¿¡ç®±é»æ“Šé©—è­‰é€£çµ';
                        else if (msg.includes('Invalid login credentials')) errText = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
                        else if (msg.includes('fetch') || msg.includes('network') || msg.includes('Failed to fetch')) errText = 'ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦';
                        else if (msg.length > 0 && msg.length < 80) errText = msg;
                        setError(errText);
                        showToast(errText, 'error');
                        return;
                    }
                    
                    // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
                    const userRole = data.user?.user_metadata?.role;
                    if (!userRole || !['admin', 'super_admin'].includes(userRole)) {
                        await supabase.auth.signOut();
                        setError('æ­¤å¸³è™Ÿæ²’æœ‰ç®¡ç†å“¡æ¬Šé™');
                        showToast('æ­¤å¸³è™Ÿæ²’æœ‰ç®¡ç†å“¡æ¬Šé™', 'error');
                        return;
                    }
                    
                    // ç™»å…¥æˆåŠŸ
                    setIsLoggedIn(true);
                    setCurrentUser({
                        id: data.user.id,
                        email: data.user.email,
                        role: userRole,
                        display_name: data.user.user_metadata?.display_name || data.user.email
                    });
                    setSupabaseUser(data.user);
                    setError('');
                    
                    // è™•ç†è¨˜ä½ç®¡ç†å“¡å¸³è™Ÿå¯†ç¢¼ï¼ˆä»¥é€å‡ºç•¶ä¸‹ checkbox ç‚ºæº–ï¼‰
                    try {
                        if (shouldRemember) {
                            localStorage.setItem('rememberedAdminEmail', username);
                            localStorage.setItem('rememberedAdminPassword', safeBtoa(password));
                            console.log('[å¾Œå°] å·²å„²å­˜è¨˜ä½çš„å¸³è™Ÿå¯†ç¢¼');
                            showToast('å·²è¨˜ä½å¸³è™Ÿå¯†ç¢¼', 'success');
                        } else {
                            localStorage.removeItem('rememberedAdminEmail');
                            localStorage.removeItem('rememberedAdminPassword');
                        }
                    } catch (storageErr) {
                        console.warn('[å¾Œå°] å„²å­˜è¨˜ä½å¸³è™Ÿå¤±æ•—', storageErr);
                        showToast('ç„¡æ³•å„²å­˜è¨˜ä½å¸³è™Ÿï¼ˆè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šï¼‰', 'warning');
                    }
                    
                    // è¨˜éŒ„ç™»å…¥æ—¥èªŒ
                    await logAction('login', 'admin', data.user.id, `ç®¡ç†å“¡ ${data.user.email} ç™»å…¥ç³»çµ±`);
                    showToast('ç™»å…¥æˆåŠŸ', 'success');
                } catch (err) {
                    console.error('ç™»å…¥éŒ¯èª¤:', err);
                    setError('ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                    showToast('ç™»å…¥å¤±æ•—', 'error');
                }
            };

            // ç™»å‡ºè™•ç†
            const handleLogout = async () => {
                try {
                    // è¨˜éŒ„ç™»å‡ºæ—¥èªŒ
                    if (currentUser) {
                        await logAction('logout', 'admin', currentUser.id, `ç®¡ç†å“¡ ${currentUser.email} ç™»å‡ºç³»çµ±`);
                    }
                    
                    // Supabase Auth ç™»å‡º
                    await supabase.auth.signOut();
                    
                    setIsLoggedIn(false);
                    setCurrentUser(null);
                    setSupabaseUser(null);
                    setUsername('');
                    setPassword('');
                    showToast('å·²ç™»å‡º', 'success');
                } catch (err) {
                    console.error('ç™»å‡ºéŒ¯èª¤:', err);
                    showToast('ç™»å‡ºå¤±æ•—', 'error');
                }
            };

            // è¼‰å…¥æ‰€æœ‰è³‡æ–™ + donations å³æ™‚åŒæ­¥ï¼ˆå«æ‰‹æ©Ÿç‰ˆï¼‰
            useEffect(() => {
                if (!isLoggedIn) return;

                const loadData = async () => {
                    const [donationsRes, loadedEvents, loadedPlaylist] = await Promise.all([
                        supabase.from('donations').select('*').order('created_at', { ascending: false }),
                        getSupabaseData(DB_TABLES.EVENTS),
                        getSupabaseData(DB_TABLES.PLAYLIST)
                    ]);
                    setData(donationsRes.data || []);
                    setEvents((loadedEvents || []).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)));
                    setPlaylist(loadedPlaylist || []);
                };

                loadData();
                window.addEventListener('storage-update', loadData);
                return () => window.removeEventListener('storage-update', loadData);
            }, [isLoggedIn]);

            // æ‰‹å‹•é‡æ–°è¼‰å…¥ donationsï¼ˆä¾›æ‰‹æ©Ÿç‰ˆã€Œé‡æ–°æ•´ç†ã€æŒ‰éˆ•ä½¿ç”¨ï¼‰
            const refreshDonations = async () => {
                try {
                    const { data: loaded } = await supabase.from('donations').select('*').order('created_at', { ascending: false });
                    setData(loaded || []);
                    showToast('å·²æ›´æ–°', 'success');
                } catch (e) {
                    showToast('æ›´æ–°å¤±æ•—', 'error');
                }
            };

            // ä¿®æ”¹å¯†ç¢¼
            const handleChangePassword = async () => {
                try {
                    // é©—è­‰è¼¸å…¥
                    if (!oldPassword || !newPassword || !confirmPassword) {
                        showToast("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½", 'error');
                        return;
                    }
                    
                    if (newPassword.length < 6) {
                        showToast("æ–°å¯†ç¢¼é•·åº¦éœ€è‡³å°‘ 6 å€‹å­—å…ƒ", 'error');
                        return;
                    }
                    
                    if (newPassword !== confirmPassword) {
                        showToast("å…©æ¬¡æ–°å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´", 'error');
                        return;
                    }
                    
                    // é©—è­‰èˆŠå¯†ç¢¼ï¼ˆé€éé‡æ–°ç™»å…¥é©—è­‰ï¼‰
                    const { error: signInError } = await supabase.auth.signInWithPassword({
                        email: currentUser.email,
                        password: oldPassword
                    });
                    
                    if (signInError) {
                        showToast("èˆŠå¯†ç¢¼éŒ¯èª¤", 'error');
                        return;
                    }
                    
                    // æ›´æ–°å¯†ç¢¼
                    const { error: updateError } = await supabase.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (updateError) {
                        console.error('æ›´æ–°å¯†ç¢¼éŒ¯èª¤:', updateError);
                        showToast("å¯†ç¢¼æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", 'error');
                        return;
                    }
                    
                    // è¨˜éŒ„æ—¥èªŒ
                    await logAction('update', 'admin', currentUser.id, `ç®¡ç†å“¡ ${currentUser.email} ä¿®æ”¹å¯†ç¢¼`);
                    
                    // æ¸…ç©ºè¼¸å…¥
                    setOldPassword('');
                    setNewPassword('');
                    setConfirmPassword('');
                    
                    showToast("å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼è«‹ä½¿ç”¨æ–°å¯†ç¢¼é‡æ–°ç™»å…¥", 'success');
                    
                    // 3 ç§’å¾Œè‡ªå‹•ç™»å‡º
                    setTimeout(async () => {
                        await handleLogout();
                    }, 3000);
                    
                } catch (err) {
                    console.error('ä¿®æ”¹å¯†ç¢¼ç•°å¸¸:', err);
                    showToast("ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦", 'error');
                }
            };

            // è¨»ï¼šå·²ç§»é™¤ handleAddAdmin å’Œ handleDeleteAdmin å‡½æ•¸
            // ç®¡ç†å“¡ç®¡ç†æ”¹åœ¨ã€Œè¶…ç®¡ã€åˆ†é è™•ç†ï¼Œä½¿ç”¨ Supabase Auth çš„ admin API

            // æ´»å‹•ç®¡ç†ï¼šäº‹ä»¶ç·¨è¼¯å™¨å…§å®¹ï¼ˆå¾ Quill è®€å–ï¼‰
            const getEventEditorContent = () => {
                if (eventEditorRef.current?.root) return eventEditorRef.current.root.innerHTML;
                return eventContent;
            };
            const setEventEditorHtml = (html) => {
                const q = eventEditorRef.current;
                if (!q?.root) return;
                q.focus();
                q.setSelection(0);
                q.deleteText(0, q.getLength());
                q.clipboard.dangerouslyPasteHTML(0, html || '<p><br></p>');
            };

            const handleSaveEvent = async () => {
                const content = getEventEditorContent();
                const trimmed = (content || '').trim();
                if (!eventTitle.trim()) {
                    showToast('è«‹å¡«å¯«æ¨™é¡Œ', 'error');
                    return;
                }
                if (!trimmed || trimmed === '<p><br></p>') {
                    showToast('è«‹å¡«å¯«å…§å®¹', 'error');
                    return;
                }

                if (editingEventId) {
                    await updateSupabaseData(DB_TABLES.EVENTS, editingEventId, {
                        title: eventTitle,
                        content: trimmed,
                        tag: eventTag,
                        popup_aspect_ratio: eventPopupAspect
                    });
                    setEvents(events.map(ev => 
                        ev.id === editingEventId 
                            ? { ...ev, title: eventTitle, content: trimmed, tag: eventTag, popup_aspect_ratio: eventPopupAspect }
                            : ev
                    ));
                    await logAction('update', 'event', editingEventId, `ä¿®æ”¹æ´»å‹•ï¼š${eventTitle}`);
                    showToast('æ´»å‹•å·²æ›´æ–°', 'success');
                } else {
                    const newEvent = {
                        id: Date.now().toString(),
                        title: eventTitle,
                        content: trimmed,
                        tag: eventTag,
                        popup_aspect_ratio: eventPopupAspect,
                        timestamp: Date.now()
                    };
                    const inserted = await insertSupabaseData(DB_TABLES.EVENTS, newEvent);
                    if (inserted) {
                        setEvents([inserted, ...events]);
                        await logAction('create', 'event', inserted.id, `æ–°å¢æ´»å‹•ï¼š${eventTitle}`);
                        showToast('æ´»å‹•å·²æ–°å¢', 'success');
                    }
                }

                window.dispatchEvent(new Event('storage-update'));
                setEventTitle('');
                setEventContent('');
                setEventTag(EVENT_TAGS[0].id);
                setEventPopupAspect('1:1');
                setEditingEventId(null);
                if (eventEditorRef.current?.root) eventEditorRef.current.root.innerHTML = '<p><br></p>';
            };

            const startEditingEvent = (ev) => {
                setEventTitle(ev.title);
                setEventContent(ev.content || '');
                setEventTag(ev.tag);
                setEventPopupAspect(ev.popup_aspect_ratio || '1:1');
                setEditingEventId(ev.id);
                document.querySelector('.admin-content')?.scrollTo(0,0);
            };

            useEffect(function initEventQuill() {
                if (currentTab !== 'events') return;
                var t = setTimeout(function() {
                    if (!eventQuillRef.current || eventEditorRef.current || !window.Quill) return;
                    var quill = new window.Quill(eventQuillRef.current, {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                ['link', 'image'],
                                ['clean']
                            ]
                        },
                        placeholder: 'æ´»å‹•å…§å®¹â€¦ å¯å¾ Word è²¼ä¸Šæˆ–ä½¿ç”¨ä¸‹æ–¹ä¸Šå‚³'
                    });
                    var compressAndInsert = function(file) {
                        var maxW = 960, quality = 0.75;
                        var compressBlob = function(blob) {
                            return new Promise(function(resolve) {
                                var img = new Image();
                                var url = URL.createObjectURL(blob);
                                img.onload = function() {
                                    URL.revokeObjectURL(url);
                                    if (img.width <= maxW && blob.size < 180000) return resolve(blob);
                                    var c = document.createElement('canvas');
                                    var scale = Math.min(1, maxW / img.width);
                                    c.width = Math.round(img.width * scale);
                                    c.height = Math.round(img.height * scale);
                                    c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
                                    c.toBlob(function(b) { resolve(b || blob); }, 'image/jpeg', quality);
                                };
                                img.onerror = function() { URL.revokeObjectURL(url); resolve(blob); };
                                img.src = url;
                            });
                        };
                        compressBlob(file).then(function(compressed) {
                            var r = new FileReader();
                            r.onload = function(e) {
                                var idx = quill.getSelection(true);
                                quill.insertEmbed(idx ? idx.index : quill.getLength(), 'image', e.target.result);
                            };
                            r.readAsDataURL(compressed);
                        }).catch(function() {
                            var r = new FileReader();
                            r.onload = function(e) {
                                var idx = quill.getSelection(true);
                                quill.insertEmbed(idx ? idx.index : quill.getLength(), 'image', e.target.result);
                            };
                            r.readAsDataURL(file);
                        });
                    };
                    quill.getModule('toolbar').addHandler('image', function() {
                        var input = document.createElement('input');
                        input.type = 'file';
                        input.accept = 'image/*';
                        input.onchange = function() {
                            var f = input.files[0];
                            if (f) compressAndInsert(f);
                        };
                        input.click();
                    });
                    quill.root.addEventListener('paste', function(e) {
                        var cd = e.clipboardData;
                        if (!cd) return;
                        for (var i = 0; i < cd.items.length; i++) {
                            if (cd.items[i].type.indexOf('image') !== 0) continue;
                            e.preventDefault();
                            var f = cd.items[i].getAsFile();
                            if (f) compressAndInsert(f);
                            return;
                        }
                    });
                    quill.root.addEventListener('drop', function(e) {
                        var f = e.dataTransfer?.files?.[0];
                        if (f && f.type.indexOf('image') === 0) {
                            e.preventDefault();
                            compressAndInsert(f);
                        }
                    });
                    quill.root.addEventListener('dragover', function(e) {
                        if (e.dataTransfer?.types?.includes('Files')) e.preventDefault();
                    });
                    eventEditorRef.current = quill;
                    if (eventContent) quill.root.innerHTML = eventContent;
                }, 150);
                return function() { clearTimeout(t); };
            }, [currentTab]);

            useEffect(function syncEventContentToQuill() {
                if (currentTab !== 'events' || !eventEditorRef.current?.root) return;
                eventEditorRef.current.root.innerHTML = eventContent || '<p><br></p>';
            }, [eventContent, editingEventId]);

            const handleEventFileUpload = async (e) => {
                var file = e.target.files[0];
                if (!file) return;
                var name = file.name.toLowerCase();
                if (name.endsWith('.docx')) {
                    try {
                        showToast('æ­£åœ¨è™•ç† Wordâ€¦', 'info');
                        var ab = await file.arrayBuffer();
                        var result = await window.mammoth.convertToHtml({ arrayBuffer: ab });
                        setEventEditorHtml(result.value);
                        showToast('Word å·²è¼‰å…¥', 'success');
                    } catch (err) {
                        showToast('Word ä¸Šå‚³å¤±æ•—', 'error');
                    }
                } else if (name.endsWith('.pdf')) {
                    try {
                        showToast('æ­£åœ¨è™•ç† PDFâ€¦', 'info');
                        var ab = await file.arrayBuffer();
                        var pdf = await window.pdfjsLib.getDocument({ data: ab }).promise;
                        var numPages = Math.min(pdf.numPages, 20);
                        var scale = 1.5;
                        var imgHtml = [];
                        for (var i = 1; i <= numPages; i++) {
                            var page = await pdf.getPage(i);
                            var vp = page.getViewport({ scale: scale });
                            var canvas = document.createElement('canvas');
                            canvas.width = vp.width; canvas.height = vp.height;
                            var ctx = canvas.getContext('2d');
                            await page.render({ canvasContext: ctx, viewport: vp }).promise;
                            imgHtml.push('<p><img src="' + canvas.toDataURL('image/jpeg', 0.85) + '" alt="PDFé ' + i + '" style="max-width:100%;height:auto;display:block;margin:1em 0;" /></p>');
                        }
                        setEventEditorHtml(imgHtml.join(''));
                        showToast('PDF å·²è¼‰å…¥ï¼ˆ' + numPages + ' é ï¼‰', 'success');
                    } catch (err) {
                        showToast('PDF ä¸Šå‚³å¤±æ•—', 'error');
                    }
                } else if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
                    try {
                        showToast('æ­£åœ¨è™•ç† Excelâ€¦', 'info');
                        var ab = await file.arrayBuffer();
                        var wb = window.XLSX.read(ab, { type: 'array' });
                        var ws = wb.Sheets[wb.SheetNames[0]];
                        var tableHtml = window.XLSX.utils.sheet_to_html(ws, { editable: false });
                        var q = eventEditorRef.current;
                        if (!q?.root || !tableHtml) { showToast('Excel å·²è¼‰å…¥', 'success'); e.target.value = ''; return; }
                        var wrap = document.createElement('div');
                        wrap.style.cssText = 'position:fixed;left:-9999px;width:800px;padding:12px;background:#fff;font-size:14px;';
                        wrap.innerHTML = '<style>table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ddd;padding:6px 10px;}th{background:#fef3c7;}</style><div>' + tableHtml + '</div>';
                        document.body.appendChild(wrap);
                        if (typeof html2canvas !== 'undefined') {
                            html2canvas(wrap, { scale: 2, logging: false }).then(function(canvas) {
                                document.body.removeChild(wrap);
                                var dataUrl = canvas.toDataURL('image/jpeg', 0.85);
                                setEventEditorHtml('<p><img src="' + dataUrl + '" alt="Excelè¡¨æ ¼" style="max-width:100%;height:auto;display:block;margin:1em 0;" /></p>');
                                showToast('Excel å·²è¼‰å…¥ï¼ˆè¡¨æ ¼åœ–ç‰‡ï¼‰', 'success');
                            }).catch(function() {
                                document.body.removeChild(wrap);
                                setEventEditorHtml('<div class="guide-excel-table">' + tableHtml + '</div>');
                                showToast('Excel å·²è¼‰å…¥', 'success');
                            });
                        } else {
                            document.body.removeChild(wrap);
                            setEventEditorHtml('<div class="guide-excel-table">' + tableHtml + '</div>');
                            showToast('Excel å·²è¼‰å…¥', 'success');
                        }
                    } catch (err) {
                        showToast('Excel ä¸Šå‚³å¤±æ•—', 'error');
                    }
                } else {
                    showToast('è«‹é¸æ“‡ .docxã€.pdfã€.xlsx æˆ– .xls', 'warning');
                }
                e.target.value = '';
            };

            const refreshEvents = async () => {
                const loaded = await getSupabaseData(DB_TABLES.EVENTS, { limit: 100 });
                setEvents(loaded.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)));
            };

            const handleSetPopupFeatured = async (eventId) => {
                try {
                    await supabase.from(DB_TABLES.EVENTS).update({ is_popup_featured: false });
                    const { error } = await supabase.from(DB_TABLES.EVENTS).update({ is_popup_featured: true }).eq('id', eventId).select();
                    if (error) {
                        console.error('è¨­ç‚ºä¸»æ‰“é‡æ•—:', error);
                        showToast('è¨­å®šå¤±æ•—ï¼š' + (error.message || ''), 'error');
                        return;
                    }
                    await refreshEvents();
                    window.dispatchEvent(new Event('storage-update'));
                    localStorage.setItem('popup-events-updated', Date.now().toString());
                    await logAction('update', 'event', eventId, 'è¨­ç‚ºå½ˆçª—ä¸»æ‰“');
                    showToast('å·²è¨­ç‚ºå½ˆçª—ä¸»æ‰“', 'success');
                } catch (e) {
                    console.error('è¨­å®šä¸»æ‰“ç•°å¸¸:', e);
                    showToast('è¨­å®šå¤±æ•—', 'error');
                }
            };

            const compressEventDataUrlImage = (dataUrl, maxW = 960, quality = 0.75) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        if (img.width <= maxW && dataUrl.length < 150000) return resolve(dataUrl);
                        const c = document.createElement('canvas');
                        const scale = Math.min(1, maxW / img.width);
                        c.width = Math.round(img.width * scale);
                        c.height = Math.round(img.height * scale);
                        c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
                        c.toBlob((b) => {
                            if (!b) return resolve(dataUrl);
                            const r = new FileReader();
                            r.onload = () => resolve(r.result);
                            r.readAsDataURL(b);
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = () => resolve(dataUrl);
                    img.src = dataUrl;
                });
            };

            const handleCompressAllEvents = async () => {
                if (!confirm('å°‡æ‰¹æ¬¡å£“ç¸®æ‰€æœ‰æ´»å‹•ä¸­çš„åœ–ç‰‡ï¼Œéœ€æ™‚è¼ƒä¹…ï¼Œç¢ºå®šç¹¼çºŒï¼Ÿ')) return;
                showToast('é–‹å§‹å£“ç¸®æ´»å‹•åœ–ç‰‡...', 'info');
                let done = 0, updated = 0;
                for (const ev of events) {
                    const html = ev.content || '';
                    const dataUrlRegex = /<img[^>]+src="(data:image\/[^"]+)"[^>]*>/gi;
                    let match;
                    const replacements = [];
                    while ((match = dataUrlRegex.exec(html)) !== null) {
                        const original = match[1];
                        if (original.length > 40000) {
                            try {
                                const compressed = await compressEventDataUrlImage(original);
                                if (compressed.length < original.length) replacements.push({ from: original, to: compressed });
                            } catch (e) { /* skip */ }
                        }
                    }
                    if (replacements.length > 0) {
                        let newContent = html;
                        replacements.forEach(r => { newContent = newContent.split(r.from).join(r.to); });
                        try {
                            const { error } = await supabase.from(DB_TABLES.EVENTS).update({ content: newContent }).eq('id', ev.id);
                            if (!error) updated++;
                        } catch (e) { /* skip */ }
                    }
                    done++;
                    if (done % 2 === 0) showToast(`è™•ç†ä¸­ ${done}/${events.length}...`, 'info');
                }
                showToast(`å®Œæˆï¼å…±æ›´æ–° ${updated} ç¯‡æ´»å‹•çš„åœ–ç‰‡`, 'success');
                await refreshEvents();
                window.dispatchEvent(new Event('storage-update'));
            };

            const handleCancelPopupFeatured = async (eventId) => {
                try {
                    const { error } = await supabase.from(DB_TABLES.EVENTS).update({ is_popup_featured: false }).eq('id', eventId).select();
                    if (error) {
                        console.error('å–æ¶ˆä¸»æ‰“å¤±æ•—:', error);
                        showToast('å–æ¶ˆå¤±æ•—ï¼š' + (error.message || 'è«‹ç¢ºèªå·²åŸ·è¡Œ 040 migration'), 'error');
                        return;
                    }
                    await refreshEvents();
                    window.dispatchEvent(new Event('storage-update'));
                    localStorage.setItem('popup-events-updated', Date.now().toString());
                    await logAction('update', 'event', eventId, 'å–æ¶ˆå½ˆçª—ä¸»æ‰“');
                    showToast('å·²å–æ¶ˆä¸»æ‰“', 'success');
                } catch (e) {
                    console.error('å–æ¶ˆä¸»æ‰“ç•°å¸¸:', e);
                    showToast('å–æ¶ˆå¤±æ•—', 'error');
                }
            };

            const handleToggleShowInPopup = async (eventId) => {
                const ev = events.find(e => e.id === eventId);
                if (!ev) return;
                const next = !(ev.show_in_popup !== false);
                try {
                    const { error } = await supabase.from(DB_TABLES.EVENTS).update({ show_in_popup: next }).eq('id', eventId).select();
                    if (error) {
                        console.error('åˆ‡æ›é¡¯ç¤ºå¤±æ•—:', error);
                        showToast('æ“ä½œå¤±æ•—ï¼š' + (error.message || 'è«‹ç¢ºèªå·²åŸ·è¡Œ 042 migration'), 'error');
                        return;
                    }
                    await refreshEvents();
                    window.dispatchEvent(new Event('storage-update'));
                    localStorage.setItem('popup-events-updated', Date.now().toString());
                    await logAction('update', 'event', eventId, next ? 'é¡¯ç¤ºæ–¼å½ˆçª—' : 'éš±è—æ–¼å½ˆçª—');
                    showToast(next ? 'å·²é¡¯ç¤ºæ–¼å½ˆçª—' : 'å·²éš±è—æ–¼å½ˆçª—', 'success');
                } catch (e) {
                    console.error('åˆ‡æ›é¡¯ç¤ºç•°å¸¸:', e);
                    showToast('æ“ä½œå¤±æ•—', 'error');
                }
            };

            const handleDeleteEvent = async (eventId) => {
                const event = events.find(e => e.id === eventId);
                if (!event) return;
                
                showConfirm(
                    'åˆªé™¤æ´»å‹•',
                    `ç¢ºå®šè¦åˆªé™¤æ´»å‹•ã€Œ${event.title}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`,
                    async () => {
                        await deleteSupabaseData(DB_TABLES.EVENTS, eventId);
                        setEvents(events.filter(e => e.id !== eventId));
                        window.dispatchEvent(new Event('storage-update'));
                        await logAction('delete', 'event', eventId, `åˆªé™¤æ´»å‹•ï¼š${event.title}`);
                        showToast('æ´»å‹•å·²åˆªé™¤', 'success');
                        hideConfirm();
                    }
                );
            };

            // éŸ³æ¨‚ç®¡ç†
            const handleAddMusic = async () => {
                if (!newTrackTitle.trim() || !newTrackUrl.trim()) {
                    showToast('è«‹è¼¸å…¥æ­Œåèˆ‡é€£çµ', 'error');
                    return;
                }
                const newTrack = { id: Date.now().toString(), title: newTrackTitle, url: newTrackUrl };
                const inserted = await insertSupabaseData(DB_TABLES.PLAYLIST, newTrack);
                if (inserted) {
                    setPlaylist([...playlist, inserted]);
                    window.dispatchEvent(new Event('storage-update'));
                    await logAction('create', 'music', inserted.id, `æ–°å¢éŸ³æ¨‚ï¼š${newTrackTitle}`);
                    showToast('éŸ³æ¨‚å·²æ–°å¢', 'success');
                    setNewTrackTitle('');
                    setNewTrackUrl('');
                }
            };

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setNewTrackUrl(file.name);
                    setNewTrackTitle(file.name.replace(/\.[^/.]+$/, ""));
                }
            };

            const handleDeleteMusic = async (musicId) => {
                const track = playlist.find(t => t.id === musicId);
                if (!track) return;
                
                showConfirm(
                    'åˆªé™¤éŸ³æ¨‚',
                    `ç¢ºå®šè¦åˆªé™¤ã€Œ${track.title}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`,
                    async () => {
                        await deleteSupabaseData(DB_TABLES.PLAYLIST, musicId);
                        setPlaylist(playlist.filter(t => t.id !== musicId));
                        window.dispatchEvent(new Event('storage-update'));
                        await logAction('delete', 'music', musicId, `åˆªé™¤éŸ³æ¨‚ï¼š${track.title}`);
                        showToast('éŸ³æ¨‚å·²åˆªé™¤', 'success');
                        hideConfirm();
                    }
                );
            };

            // æ–°å¢/ç·¨è¼¯è¶…ç´šç®¡ç†å“¡ï¼ˆSupabase Authï¼‰
            const handleSaveAdmin = async () => {
                if (!newAdminEmail.trim()) {
                    showToast('è«‹è¼¸å…¥ Email', 'error');
                    return;
                }
                
                try {
                    if (editingAdmin) {
                        // ç·¨è¼¯ç¾æœ‰ç®¡ç†å“¡
                        const { error } = await supabase.rpc('update_user_role', {
                            target_user_id: editingAdmin.id,
                            new_role: newAdminRole
                        });
                        
                        if (error) {
                            console.error('æ›´æ–°ç®¡ç†å“¡å¤±æ•—:', error);
                            showToast('æ›´æ–°å¤±æ•—', 'error');
                            return;
                        }
                        
                        showToast('ç®¡ç†å“¡å·²æ›´æ–°', 'success');
                    } else {
                        // æ–°å¢ç®¡ç†å“¡
                        // å…ˆæª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å­˜åœ¨
                        const { data: existingUsers } = await supabase.rpc('get_all_users');
                        const existingUser = existingUsers?.find(u => u.email === newAdminEmail);
                        
                        if (existingUser) {
                            // ç”¨æˆ¶å­˜åœ¨ï¼Œç›´æ¥è¨­å®šè§’è‰²
                            const { error } = await supabase.rpc('update_user_role', {
                                target_user_id: existingUser.id,
                                new_role: newAdminRole
                            });
                            
                            if (error) {
                                console.error('è¨­å®šç®¡ç†å“¡å¤±æ•—:', error);
                                showToast('è¨­å®šå¤±æ•—', 'error');
                                return;
                            }
                            
                            showToast('å·²å°‡è©²ç”¨æˆ¶è¨­ç‚ºç®¡ç†å“¡', 'success');
                        } else {
                            showToast('è©² Email å°šæœªè¨»å†Šï¼Œè«‹å…ˆè®“ç”¨æˆ¶è¨»å†Šå¸³è™Ÿ', 'error');
                            return;
                        }
                    }
                    
                    // é‡æ–°è¼‰å…¥ç®¡ç†å“¡åˆ—è¡¨
                    const { data } = await supabase.rpc('get_all_users');
                    const admins = data.filter(u => 
                        u.role === 'admin' || 
                        u.role === 'super_admin'
                    );
                    setAdminUsers(admins);
                    
                    // é‡ç½®è¡¨å–®
                    setShowAddAdminModal(false);
                    setEditingAdmin(null);
                    setNewAdminEmail('');
                    setNewAdminRole('admin');
                } catch (err) {
                    console.error('è™•ç†ç®¡ç†å“¡ç•°å¸¸:', err);
                    showToast('ç™¼ç”ŸéŒ¯èª¤', 'error');
                }
            };
            
            // ç§»é™¤ç®¡ç†å“¡æ¬Šé™
            const handleRemoveAdmin = async (adminUser) => {
                if (adminUser.id === supabaseUser?.id) {
                    showToast('ç„¡æ³•ç§»é™¤è‡ªå·±çš„ç®¡ç†å“¡æ¬Šé™', 'error');
                    return;
                }
                
                showConfirm(
                    'ç§»é™¤ç®¡ç†å“¡',
                    `ç¢ºå®šè¦ç§»é™¤ã€Œ${adminUser.email}ã€çš„ç®¡ç†å“¡æ¬Šé™å—ï¼Ÿ`,
                    async () => {
                        try {
                            const { error } = await supabase.rpc('update_user_role', {
                                target_user_id: adminUser.id,
                                new_role: null
                            });
                            
                            if (error) {
                                console.error('ç§»é™¤ç®¡ç†å“¡å¤±æ•—:', error);
                                showToast('ç§»é™¤å¤±æ•—', 'error');
                                return;
                            }
                            
                            setAdminUsers(adminUsers.filter(a => a.id !== adminUser.id));
                            await logAction('delete', 'admin', adminUser.id, `ç§»é™¤ç®¡ç†å“¡æ¬Šé™ï¼š${adminUser.email}`);
                            showToast('ç®¡ç†å“¡æ¬Šé™å·²ç§»é™¤', 'success');
                            hideConfirm();
                        } catch (err) {
                            console.error('ç§»é™¤ç®¡ç†å“¡ç•°å¸¸:', err);
                            showToast('ç™¼ç”ŸéŒ¯èª¤', 'error');
                            hideConfirm();
                        }
                    }
                );
            };
            
            // é–‹å§‹ç·¨è¼¯è¶…ç´šç®¡ç†å“¡
            const startEditAdmin = (adminUser) => {
                setEditingAdmin(adminUser);
                setNewAdminEmail(adminUser.email);
                setNewAdminRole(adminUser.role || 'admin');
                setShowAddAdminModal(true);
            };
            
            // Donations æ›´æ–°ç‹€æ…‹
            const updateStatus = async (id, newStatus) => {
                try {
                    const donation = data.find(d => d.id === id);
                    const oldStatus = donation?.status;
                    
                    const updateData = { 
                        status: newStatus,
                        updated_at: new Date().toISOString()
                    };
                    
                    // å¦‚æœæ¨™è¨˜ç‚ºå·²å®Œæˆï¼ŒåŒæ™‚æ›´æ–° processed_at
                    if (newStatus === 'completed') {
                        updateData.processed_at = new Date().toISOString();
                    }
                    
                    const { error } = await supabase
                        .from('donations')
                        .update(updateData)
                        .eq('id', id);
                    
                    if (error) {
                        console.error('æ›´æ–°ç‹€æ…‹å¤±æ•—:', error);
                        showToast('æ›´æ–°å¤±æ•—', 'error');
                        return;
                    }
                    
                    setData(data.map(item => 
                        item.id === id ? { ...item, ...updateData } : item
                    ));
                    
                    const statusText = newStatus === 'completed' ? 'å·²å®Œæˆ' : newStatus === 'pending' ? 'å¾…è™•ç†' : 'å·²å–æ¶ˆ';
                    await logAction('update', 'donation', id, `æ›´æ–°è´ŠåŠ©ç‹€æ…‹ï¼š${oldStatus} â†’ ${statusText}`, {
                        old: { status: oldStatus },
                        new: { status: newStatus }
                    });
                    showToast('ç‹€æ…‹å·²æ›´æ–°', 'success');
                } catch (err) {
                    console.error('æ›´æ–°ç‹€æ…‹ç•°å¸¸:', err);
                    showToast('ç™¼ç”ŸéŒ¯èª¤', 'error');
                }
            };
            
            // Donations æ›´æ–°æ”¯ä»˜æ–¹å¼ï¼ˆç®¡ç†å“¡å¯ä¿®æ”¹ï¼åˆ‡æ›ï¼‰
            const updatePaymentMethod = async (id, newMethod) => {
                try {
                    const donation = data.find(d => d.id === id);
                    const oldMethod = donation?.payment_method || '';
                    if (oldMethod === newMethod) return;
                    
                    const updateData = {
                        payment_method: newMethod,
                        updated_at: new Date().toISOString()
                    };
                    
                    const { error } = await supabase
                        .from('donations')
                        .update(updateData)
                        .eq('id', id);
                    
                    if (error) {
                        console.error('æ›´æ–°æ”¯ä»˜æ–¹å¼å¤±æ•—:', error);
                        showToast('æ›´æ–°å¤±æ•—', 'error');
                        return;
                    }
                    
                    setData(data.map(item =>
                        item.id === id ? { ...item, ...updateData } : item
                    ));
                    
                    const methodLabel = (m) => m === 'shopline' ? 'SHOPLINE' : m === 'linepay' ? 'LINE Pay' : m || 'å…¶ä»–';
                    await logAction('update', 'donation', id, `æ›´æ–°æ”¯ä»˜æ–¹å¼ï¼š${methodLabel(oldMethod)} â†’ ${methodLabel(newMethod)}`, {
                        old: { payment_method: oldMethod },
                        new: { payment_method: newMethod }
                    });
                    showToast('æ”¯ä»˜æ–¹å¼å·²æ›´æ–°', 'success');
                } catch (err) {
                    console.error('æ›´æ–°æ”¯ä»˜æ–¹å¼ç•°å¸¸:', err);
                    showToast('ç™¼ç”ŸéŒ¯èª¤', 'error');
                }
            };
            
            // Donations é–‹å§‹ç·¨è¼¯ï¼ˆç®¡ç†å“¡å¯æ”¹è¨‚å–®ä»»ä½•è³‡è¨Šï¼‰
            const startEditNotes = (donation) => {
                setEditingId(donation.id);
                setEditNotes(donation.notes || '');
                setEditGameAccount(donation.game_account || '');
                setEditLineName(donation.line_name || '');
                setEditEmail(donation.email || '');
                setEditAmount(String(donation.amount ?? ''));
                setEditCoins(String(donation.coins ?? ''));
                setEditPlanName(donation.plan_name || '');
                setEditPaymentMethod(donation.payment_method || '');
                setEditStatus(donation.status || 'pending');
            };
            
            // Donations å„²å­˜å®Œæ•´è¨‚å–®è³‡è¨Šï¼ˆèˆ‡å¾Œå°ã€è¨»å†Šç”¨æˆ¶ç´¯è¨ˆåŒæ­¥ï¼‰
            const saveNotes = async (id) => {
                try {
                    const donation = data.find(d => d.id === id);
                    const amountNum = parseInt(editAmount, 10);
                    const coinsNum = parseInt(editCoins, 10);
                    const payload = {
                        game_account: (editGameAccount || '').trim() || donation?.game_account || '',
                        line_name: (editLineName || '').trim() || null,
                        email: (editEmail || '').trim() || donation?.email || '',
                        amount: isNaN(amountNum) ? donation?.amount : amountNum,
                        coins: isNaN(coinsNum) ? donation?.coins : coinsNum,
                        plan_name: (editPlanName || '').trim() || donation?.plan_name || '',
                        payment_method: editPaymentMethod || donation?.payment_method || null,
                        status: editStatus || donation?.status || 'pending',
                        notes: editNotes,
                        updated_at: new Date().toISOString()
                    };
                    if (payload.status === 'completed' && donation?.status !== 'completed') {
                        payload.processed_at = new Date().toISOString();
                    }
                    
                    const { error } = await supabase
                        .from('donations')
                        .update(payload)
                        .eq('id', id);
                    
                    if (error) {
                        console.error('å„²å­˜å¤±æ•—:', error);
                        showToast('å„²å­˜å¤±æ•—', 'error');
                        return;
                    }
                    
                    setData(data.map(item => 
                        item.id === id ? { ...item, ...payload } : item
                    ));
                    
                    await logAction('update', 'donation', id, `æ›´æ–°è¨‚å–®å®Œæ•´è³‡è¨Š`, {
                        old: { game_account: donation?.game_account, line_name: donation?.line_name, email: donation?.email, amount: donation?.amount, coins: donation?.coins, plan_name: donation?.plan_name, payment_method: donation?.payment_method, status: donation?.status, notes: donation?.notes },
                        new: payload
                    });
                    
                    setEditingId(null);
                    setEditNotes(''); setEditGameAccount(''); setEditLineName('');
                    setEditEmail(''); setEditAmount(''); setEditCoins(''); setEditPlanName(''); setEditPaymentMethod(''); setEditStatus('');
                    showToast('å·²å„²å­˜ï¼Œè¨»å†Šç”¨æˆ¶ç´¯è¨ˆå°‡è‡ªå‹•åŒæ­¥', 'success');
                } catch (err) {
                    console.error('å„²å­˜ç•°å¸¸:', err);
                    showToast('ç™¼ç”ŸéŒ¯èª¤', 'error');
                }
            };
            
            // Donations åˆªé™¤ç´€éŒ„
            const handleDelete = async (id) => {
                const donation = data.find(d => d.id === id);
                if (!donation) return;
                
                showConfirm(
                    'åˆªé™¤è´ŠåŠ©ç´€éŒ„',
                    `ç¢ºå®šè¦åˆªé™¤ã€Œ${donation.game_account}ã€çš„è´ŠåŠ©ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`,
                    async () => {
                        try {
                            const { error } = await supabase
                                .from('donations')
                                .delete()
                                .eq('id', id);
                            
                            if (error) {
                                console.error('åˆªé™¤å¤±æ•—:', error);
                                showToast('åˆªé™¤å¤±æ•—', 'error');
                                return;
                            }
                            
                            setData(data.filter(item => item.id !== id));
                            await logAction('delete', 'donation', id, `åˆªé™¤è´ŠåŠ©ç´€éŒ„ï¼š${donation.game_account} - NT$ ${donation.amount}`);
                            showToast('ç´€éŒ„å·²åˆªé™¤', 'success');
                            hideConfirm();
                        } catch (err) {
                            console.error('åˆªé™¤ç•°å¸¸:', err);
                            showToast('ç™¼ç”ŸéŒ¯èª¤', 'error');
                            hideConfirm();
                        }
                    }
                );
            };
            
            // Donations æ¨™ç±¤ç®¡ç†
            const addTag = async (donationId, tag) => {
                try {
                    const donation = data.find(d => d.id === donationId);
                    if (!donation) return;
                    
                    const currentTags = donation.tags || [];
                    if (currentTags.includes(tag)) {
                        showToast('æ¨™ç±¤å·²å­˜åœ¨', 'error');
                        return;
                    }
                    
                    const newTags = [...currentTags, tag];
                    
                    const { error } = await supabase
                        .from('donations')
                        .update({ 
                            tags: newTags,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', donationId);
                    
                    if (error) {
                        console.error('åŠ å…¥æ¨™ç±¤å¤±æ•—:', error);
                        showToast('åŠ å…¥æ¨™ç±¤å¤±æ•—', 'error');
                        return;
                    }
                    
                    setData(data.map(item => 
                        item.id === donationId ? { ...item, tags: newTags, updated_at: new Date().toISOString() } : item
                    ));
                    
                    await logAction('update', 'donation', donationId, `åŠ å…¥æ¨™ç±¤ï¼š${tag}`);
                    showToast('æ¨™ç±¤å·²åŠ å…¥', 'success');
                    setNewTag('');
                } catch (err) {
                    console.error('åŠ å…¥æ¨™ç±¤ç•°å¸¸:', err);
                    showToast('ç™¼ç”ŸéŒ¯èª¤', 'error');
                }
            };
            
            const removeTag = async (donationId, tag) => {
                try {
                    const donation = data.find(d => d.id === donationId);
                    if (!donation) return;
                    
                    const newTags = (donation.tags || []).filter(t => t !== tag);
                    
                    const { error } = await supabase
                        .from('donations')
                        .update({ 
                            tags: newTags,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', donationId);
                    
                    if (error) {
                        console.error('ç§»é™¤æ¨™ç±¤å¤±æ•—:', error);
                        showToast('ç§»é™¤æ¨™ç±¤å¤±æ•—', 'error');
                        return;
                    }
                    
                    setData(data.map(item => 
                        item.id === donationId ? { ...item, tags: newTags, updated_at: new Date().toISOString() } : item
                    ));
                    
                    await logAction('update', 'donation', donationId, `ç§»é™¤æ¨™ç±¤ï¼š${tag}`);
                    showToast('æ¨™ç±¤å·²ç§»é™¤', 'success');
                } catch (err) {
                    console.error('ç§»é™¤æ¨™ç±¤ç•°å¸¸:', err);
                    showToast('ç™¼ç”ŸéŒ¯èª¤', 'error');
                }
            };
            
            // é è¨­æ¨™ç±¤é¸é …
            const TAG_OPTIONS = [
                { value: 'vip', label: 'VIP', color: 'text-gold-400 bg-gold-500/20 border-gold-500/50' },
                { value: 'regular', label: 'å¸¸å®¢', color: 'text-wind-400 bg-wind-500/20 border-wind-500/50' },
                { value: 'whale', label: 'å¤§æˆ¶', color: 'text-fire-400 bg-fire-500/20 border-fire-500/50' },
                { value: 'new', label: 'æ–°æ‰‹', color: 'text-water-400 bg-water-500/20 border-water-500/50' },
                { value: 'monthly', label: 'æœˆè¨‚', color: 'text-purple-400 bg-purple-500/20 border-purple-500/50' },
            ];
            
            const getTagColor = (tag) => {
                const option = TAG_OPTIONS.find(opt => opt.value === tag);
                return option ? option.color : 'text-stone-400 bg-stone-500/20 border-stone-500/50';
            };
            
            // æ‰¹æ¬¡æ“ä½œï¼šå…¨é¸/å–æ¶ˆå…¨é¸
            const toggleSelectAll = () => {
                if (selectedIds.length === paginatedData.length) {
                    setSelectedIds([]);
                } else {
                    setSelectedIds(paginatedData.map(d => d.id));
                }
            };
            
            // æ‰¹æ¬¡æ“ä½œï¼šåˆ‡æ›å–®å€‹é¸æ“‡
            const toggleSelect = (id) => {
                setSelectedIds(prev => 
                    prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]
                );
            };
            
            // æ‰¹æ¬¡æ›´æ–°ç‹€æ…‹
            const batchUpdateStatus = async (newStatus) => {
                if (selectedIds.length === 0) {
                    showToast('è«‹å…ˆé¸æ“‡é …ç›®', 'error');
                    return;
                }
                
                showConfirm(
                    'æ‰¹æ¬¡æ›´æ–°ç‹€æ…‹',
                    `ç¢ºå®šè¦å°‡ ${selectedIds.length} ç­†ç´€éŒ„æ›´æ–°ç‚ºã€Œ${newStatus === 'completed' ? 'å·²å®Œæˆ' : newStatus === 'pending' ? 'å¾…è™•ç†' : 'å·²å–æ¶ˆ'}ã€å—ï¼Ÿ`,
                    async () => {
                        try {
                            const updateData = { 
                                status: newStatus,
                                updated_at: new Date().toISOString()
                            };
                            
                            if (newStatus === 'completed') {
                                updateData.processed_at = new Date().toISOString();
                            }
                            
                            const { error } = await supabase
                                .from('donations')
                                .update(updateData)
                                .in('id', selectedIds);
                            
                            if (error) {
                                console.error('æ‰¹æ¬¡æ›´æ–°å¤±æ•—:', error);
                                showToast('æ‰¹æ¬¡æ›´æ–°å¤±æ•—', 'error');
                                return;
                            }
                            
                            setData(data.map(item => 
                                selectedIds.includes(item.id) ? { ...item, ...updateData } : item
                            ));
                            
                            await logAction('update', 'donation', null, `æ‰¹æ¬¡æ›´æ–° ${selectedIds.length} ç­†ç´€éŒ„ç‹€æ…‹ç‚ºï¼š${newStatus}`);
                            showToast(`å·²æ›´æ–° ${selectedIds.length} ç­†ç´€éŒ„`, 'success');
                            setSelectedIds([]);
                            hideConfirm();
                        } catch (err) {
                            console.error('æ‰¹æ¬¡æ›´æ–°ç•°å¸¸:', err);
                            showToast('ç™¼ç”ŸéŒ¯èª¤', 'error');
                            hideConfirm();
                        }
                    }
                );
            };
            
            // æ‰¹æ¬¡åˆªé™¤
            const batchDelete = async () => {
                if (selectedIds.length === 0) {
                    showToast('è«‹å…ˆé¸æ“‡é …ç›®', 'error');
                    return;
                }
                
                showConfirm(
                    'æ‰¹æ¬¡åˆªé™¤',
                    `ç¢ºå®šè¦åˆªé™¤ ${selectedIds.length} ç­†ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`,
                    async () => {
                        try {
                            const { error } = await supabase
                                .from('donations')
                                .delete()
                                .in('id', selectedIds);
                            
                            if (error) {
                                console.error('æ‰¹æ¬¡åˆªé™¤å¤±æ•—:', error);
                                showToast('æ‰¹æ¬¡åˆªé™¤å¤±æ•—', 'error');
                                return;
                            }
                            
                            setData(data.filter(item => !selectedIds.includes(item.id)));
                            await logAction('delete', 'donation', null, `æ‰¹æ¬¡åˆªé™¤ ${selectedIds.length} ç­†ç´€éŒ„`);
                            showToast(`å·²åˆªé™¤ ${selectedIds.length} ç­†ç´€éŒ„`, 'success');
                            setSelectedIds([]);
                            hideConfirm();
                        } catch (err) {
                            console.error('æ‰¹æ¬¡åˆªé™¤ç•°å¸¸:', err);
                            showToast('ç™¼ç”ŸéŒ¯èª¤', 'error');
                            hideConfirm();
                        }
                    }
                );
            };
            
            // æ‰¹æ¬¡æ·»åŠ æ¨™ç±¤
            const batchAddTag = async (tag) => {
                if (selectedIds.length === 0) {
                    showToast('è«‹å…ˆé¸æ“‡é …ç›®', 'error');
                    return;
                }
                
                try {
                    let updatedCount = 0;
                    
                    for (const id of selectedIds) {
                        const donation = data.find(d => d.id === id);
                        if (!donation) continue;
                        
                        const currentTags = donation.tags || [];
                        if (!currentTags.includes(tag)) {
                            const newTags = [...currentTags, tag];
                            
                            const { error } = await supabase
                                .from('donations')
                                .update({ 
                                    tags: newTags,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', id);
                            
                            if (!error) {
                                updatedCount++;
                                setData(prevData => prevData.map(item => 
                                    item.id === id ? { ...item, tags: newTags, updated_at: new Date().toISOString() } : item
                                ));
                            }
                        }
                    }
                    
                    if (updatedCount > 0) {
                        await logAction('update', 'donation', null, `æ‰¹æ¬¡ç‚º ${updatedCount} ç­†ç´€éŒ„åŠ å…¥æ¨™ç±¤ï¼š${tag}`);
                        showToast(`å·²ç‚º ${updatedCount} ç­†ç´€éŒ„åŠ å…¥æ¨™ç±¤`, 'success');
                    } else {
                        showToast('æ‰€æœ‰é¸ä¸­çš„ç´€éŒ„å·²æœ‰æ­¤æ¨™ç±¤', 'info');
                    }
                    
                    setSelectedIds([]);
                    setShowBatchActions(false);
                } catch (err) {
                    console.error('æ‰¹æ¬¡æ·»åŠ æ¨™ç±¤ç•°å¸¸:', err);
                    showToast('ç™¼ç”ŸéŒ¯èª¤', 'error');
                }
            };
            
            // ç¯©é¸è³‡æ–™ï¼ˆåŒ…å«é€²éšç¯©é¸ï¼‰
            const filteredData = data.filter(item => {
                // åŸºæœ¬æœå°‹
                const matchSearch = (item.game_account || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    (item.email || '').toLowerCase().includes(searchTerm.toLowerCase());
                const matchStatus = filterStatus === 'all' || item.status === filterStatus;
                
                // é€²éšæœå°‹ï¼šæ—¥æœŸç¯„åœ
                let matchDate = true;
                if (dateFrom) {
                    matchDate = matchDate && new Date(item.created_at) >= new Date(dateFrom);
                }
                if (dateTo) {
                    matchDate = matchDate && new Date(item.created_at) <= new Date(dateTo + 'T23:59:59');
                }
                
                // é€²éšæœå°‹ï¼šé‡‘é¡ç¯„åœ
                let matchAmount = true;
                if (amountMin !== '') {
                    matchAmount = matchAmount && item.amount >= Number(amountMin);
                }
                if (amountMax !== '') {
                    matchAmount = matchAmount && item.amount <= Number(amountMax);
                }
                
                // é€²éšæœå°‹ï¼šæ”¯ä»˜æ–¹å¼
                const matchPayment = filterPaymentMethod === 'all' || item.payment_method === filterPaymentMethod;
                
                // é€²éšæœå°‹ï¼šæ¨™ç±¤
                const matchTag = filterTag === 'all' || (item.tags || []).includes(filterTag);
                
                return matchSearch && matchStatus && matchDate && matchAmount && matchPayment && matchTag;
            });
            
            // æ¸…é™¤é€²éšæœå°‹
            const clearAdvancedSearch = () => {
                setDateFrom('');
                setDateTo('');
                setAmountMin('');
                setAmountMax('');
                setFilterPaymentMethod('all');
                setFilterTag('all');
            };
            
            // åˆ†é é‚è¼¯
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = filteredData.slice(startIndex, endIndex);
            
            // ç•¶ç¯©é¸æ¢ä»¶æ”¹è®Šæ™‚ï¼Œé‡ç½®åˆ°ç¬¬ä¸€é 
            useEffect(() => {
                setCurrentPage(1);
            }, [searchTerm, filterStatus]);
            
            // Chart.js åœ–è¡¨åˆå§‹åŒ– - è¶¨å‹¢åœ–
            useEffect(() => {
                if (currentTab !== 'stats' || !trendChartRef.current || data.length === 0) return;
                
                // è¨ˆç®—è¶¨å‹¢æ•¸æ“š
                const now = Date.now();
                const last30Days = [];
                const trendData = {};
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(now - i * 24 * 60 * 60 * 1000);
                    const dateStr = date.toISOString().split('T')[0];
                    last30Days.push(dateStr);
                    trendData[dateStr] = 0;
                }
                data.forEach(item => {
                    const dateStr = new Date(item.created_at).toISOString().split('T')[0];
                    if (trendData[dateStr] !== undefined) {
                        trendData[dateStr] += item.amount || 0;
                    }
                });
                
                // éŠ·æ¯€èˆŠåœ–è¡¨
                if (trendChartInstance.current) {
                    trendChartInstance.current.destroy();
                }
                
                const ctx = trendChartRef.current.getContext('2d');
                trendChartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last30Days.map(d => d.slice(5)),
                        datasets: [{
                            label: 'æ¯æ—¥è´ŠåŠ©é‡‘é¡',
                            data: last30Days.map(d => trendData[d]),
                            borderColor: '#fdcb6e',
                            backgroundColor: 'rgba(253, 203, 110, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#fdcb6e',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fdcb6e',
                                padding: 12,
                                displayColors: false,
                                callbacks: {
                                    label: (context) => `NT$ ${context.parsed.y.toLocaleString()}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#a8a29e',
                                    callback: (value) => `$${value / 1000}k`
                                },
                                grid: {
                                    color: 'rgba(168, 162, 158, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#a8a29e',
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                
                return () => {
                    if (trendChartInstance.current) {
                        trendChartInstance.current.destroy();
                    }
                };
            }, [data, currentTab]);
            
            // Chart.js åœ–è¡¨åˆå§‹åŒ– - æ”¯ä»˜æ–¹å¼åœ“é¤…åœ–
            useEffect(() => {
                if (currentTab !== 'stats' || !paymentChartRef.current || data.length === 0) return;
                
                // è¨ˆç®—æ”¯ä»˜æ–¹å¼çµ±è¨ˆ
                const methodStats = {};
                data.forEach(item => {
                    const method = item.payment_method || 'unknown';
                    methodStats[method] = (methodStats[method] || 0) + (item.amount || 0);
                });
                
                if (paymentChartInstance.current) {
                    paymentChartInstance.current.destroy();
                }
                
                const ctx = paymentChartRef.current.getContext('2d');
                const methodLabels = Object.keys(methodStats).map(m => 
                    m === 'shopline' ? 'SHOPLINE' : 
                    m === 'linepay' ? 'LINE Pay' : m
                );
                const methodValues = Object.values(methodStats);
                
                paymentChartInstance.current = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: methodLabels,
                        datasets: [{
                            data: methodValues,
                            backgroundColor: ['#4fc3dc', '#42ca9f', '#ff6b6b', '#fdcb6e'],
                            borderColor: '#1a1614',
                            borderWidth: 3,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#fff',
                                    padding: 15,
                                    font: { size: 12, weight: 'bold' }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                callbacks: {
                                    label: (context) => `${context.label}: NT$ ${context.parsed.toLocaleString()}`
                                }
                            }
                        }
                    }
                });
                
                return () => {
                    if (paymentChartInstance.current) {
                        paymentChartInstance.current.destroy();
                    }
                };
            }, [data, currentTab]);
            
            // Chart.js åœ–è¡¨åˆå§‹åŒ– - ç†±é–€æ–¹æ¡ˆæŸ±ç‹€åœ–
            useEffect(() => {
                if (currentTab !== 'stats' || !planChartRef.current || data.length === 0) return;
                
                // è¨ˆç®—æ–¹æ¡ˆçµ±è¨ˆ
                const planStats = {};
                data.forEach(item => {
                    const plan = item.plan_name || 'æœªçŸ¥æ–¹æ¡ˆ';
                    planStats[plan] = (planStats[plan] || 0) + 1;
                });
                
                if (planChartInstance.current) {
                    planChartInstance.current.destroy();
                }
                
                const ctx = planChartRef.current.getContext('2d');
                const sortedPlans = Object.entries(planStats).sort((a, b) => b[1] - a[1]).slice(0, 10);
                
                planChartInstance.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedPlans.map(p => p[0]),
                        datasets: [{
                            label: 'è¨‚å–®æ•¸é‡',
                            data: sortedPlans.map(p => p[1]),
                            backgroundColor: [
                                '#fdcb6e', '#4fc3dc', '#42ca9f', '#ff6b6b', 
                                '#f6b93b', '#7ed4e6', '#6ce0ba', '#ff8e8e',
                                '#fad390', '#d4b483'
                            ],
                            borderColor: '#1a1614',
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                callbacks: {
                                    label: (context) => `${context.parsed.y} ç­†è¨‚å–®`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#a8a29e',
                                    stepSize: 1
                                },
                                grid: {
                                    color: 'rgba(168, 162, 158, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#a8a29e'
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                
                return () => {
                    if (planChartInstance.current) {
                        planChartInstance.current.destroy();
                    }
                };
            }, [data, currentTab]);
            
            // çµ±è¨ˆè³‡æ–™
            const totalAmount = data.reduce((acc, curr) => acc + (Number(curr.amount) || 0), 0);
            const pendingCount = data.filter(d => d.status === 'pending').length;
            const completedCount = data.filter(d => d.status === 'completed').length;
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºè¶…ç´šç®¡ç†å“¡
            const isSuperAdmin = supabaseUser?.user_metadata?.role === 'super_admin';
            
            // ç™»å…¥ç•«é¢
            if (!isLoggedIn) {
                return (
                    <div className="pt-20 md:pt-32 pb-20 px-4 min-h-screen bg-gradient-to-br from-stone-900 via-stone-800 to-stone-900 flex items-center justify-center">
                        <div className="bg-stone-800/50 backdrop-blur-xl p-6 md:p-8 rounded-3xl shadow-2xl max-w-sm w-full border border-stone-700/50">
                            <div className="text-center mb-8">
                                <div className="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-gold-500 to-orange-500 rounded-2xl flex items-center justify-center shadow-lg shadow-gold-900/30">
                                    <Shield size={40} className="text-white" />
                                </div>
                                <h2 className="text-2xl md:text-3xl font-black text-white mb-2">å¾Œå°ç®¡ç†ç³»çµ±</h2>
                                <p className="text-stone-200 text-sm font-medium">è«‹ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥</p>
                            </div>
                            
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div>
                                    <label className="block text-stone-300 font-bold mb-2 text-sm flex items-center gap-2">
                                        <Mail size={16} />
                                        Email
                                    </label>
                                    <input 
                                        type="email" 
                                        value={username} 
                                        onChange={e => setUsername(e.target.value)} 
                                        className="w-full p-3 md:p-4 bg-stone-900/80 border border-stone-600 rounded-xl text-white font-bold focus:border-gold-500 outline-none transition-all" 
                                        placeholder="è¼¸å…¥ç®¡ç†å“¡ Email"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-stone-300 font-bold mb-2 text-sm flex items-center gap-2">
                                        <Lock size={16} />
                                        å¯†ç¢¼
                                    </label>
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={e => setPassword(e.target.value)} 
                                        className="w-full p-3 bg-stone-900 border border-stone-600 rounded-xl text-white font-bold focus:border-gold-500 outline-none transition-colors" 
                                        placeholder="è¼¸å…¥å¯†ç¢¼"
                                        required
                                    />
                                </div>
                                
                                {/* è¨˜ä½ç®¡ç†å“¡å¸³è™Ÿå¯†ç¢¼ */}
                                <div className="flex items-center gap-2">
                                    <input
                                        type="checkbox"
                                        id="rememberAdminMe"
                                        checked={rememberAdminMe}
                                        onChange={(e) => setRememberAdminMe(e.target.checked)}
                                        className="w-4 h-4 text-gold-600 bg-stone-900 border-stone-600 rounded focus:ring-gold-500 focus:ring-2"
                                    />
                                    <label htmlFor="rememberAdminMe" className="text-stone-200 text-sm font-medium cursor-pointer select-none">
                                        è¨˜ä½å¸³è™Ÿå¯†ç¢¼
                                    </label>
                                </div>
                                
                                {error && (
                                    <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-3 flex items-center gap-2">
                                        <AlertCircle size={18} className="text-red-400 flex-shrink-0" />
                                        <p className="text-red-400 font-bold text-sm">{error}</p>
                                    </div>
                                )}
                                
                                <button type="submit" className="w-full bg-gradient-to-r from-gold-600 to-orange-600 hover:from-gold-500 hover:to-orange-500 text-white font-black py-3 md:py-4 rounded-xl transition-all shadow-lg shadow-gold-900/30 flex items-center justify-center gap-2 text-base">
                                    <Lock size={20} />
                                    ç™»å…¥å¾Œå°
                                </button>
                            </form>
                            
                            <div className="mt-6 pt-6 border-t border-stone-700/50">
                                <div className="flex items-center justify-center gap-2 text-stone-300 text-xs font-medium">
                                    <Shield size={14} />
                                    <p>å·²å‡ç´šè‡³ Supabase Auth å®‰å…¨èªè­‰ç³»çµ±</p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (isLoggedIn && !adminScriptsReady) {
                return (
                    <div className="pt-32 pb-24 min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-stone-900 via-stone-800 to-stone-900">
                        <LoadingSpinner message="è¼‰å…¥å¾Œå°ä¸­..." />
                    </div>
                );
            }
            
            return (
                <div className="pt-20 md:pt-32 pb-24 md:pb-20 px-3 md:px-6 min-h-screen bg-gradient-to-br from-amber-950/30 via-stone-900 to-slate-900 text-white">
                    <div className="max-w-7xl mx-auto">
                        {/* é é¢æ¨™é¡Œ - æ‰‹æ©Ÿç‰ˆå„ªåŒ– */}
                        <div className="mb-6 md:mb-8">
                            <h1 className="text-2xl md:text-3xl font-black text-white mb-2">å¾Œå°ç®¡ç†ç³»çµ±</h1>
                            <p className="text-stone-300 text-sm">
                                æ­¡è¿å›ä¾†ï¼Œ
                                <span className="text-white font-bold">{currentUser?.username || supabaseUser?.email}</span>
                                {(currentUser?.role === 'super_admin' || isSuperAdmin) && <span className="ml-2 px-2 py-0.5 bg-gold-500/20 text-gold-400 text-xs font-bold rounded border border-gold-500/30">è¶…ç®¡</span>}
                                {currentUser?.role === 'admin' && !isSuperAdmin && <span className="ml-2 px-2 py-0.5 bg-blue-500/20 text-blue-400 text-xs font-bold rounded border border-blue-500/30">ç®¡ç†å“¡</span>}
                            </p>
                        </div>
                        
                        {/* çµ±è¨ˆå¡ç‰‡ - æ‰‹æ©Ÿç‰ˆå„ªåŒ– */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6 md:mb-8">
                            <div className="bg-gradient-to-br from-gold-900/40 to-stone-800 p-4 md:p-5 rounded-2xl border border-gold-700/30 shadow-lg">
                                <div className="flex items-center gap-2 mb-2">
                                    <Coins size={16} className="text-gold-400" />
                                    <p className="text-white/95 text-xs font-bold">æœ¬æœˆç¸½ç‡Ÿæ”¶</p>
                                </div>
                                <p className="text-xl md:text-2xl font-black text-gold-400">NT$ {totalAmount.toLocaleString()}</p>
                            </div>
                            <div className="bg-gradient-to-br from-fire-900/40 to-stone-800 p-4 md:p-5 rounded-2xl border border-fire-700/30 shadow-lg">
                                <div className="flex items-center gap-2 mb-2">
                                    <AlertCircle size={16} className="text-fire-400" />
                                    <p className="text-white/95 text-xs font-bold">å¾…è™•ç†</p>
                                </div>
                                <p className="text-xl md:text-2xl font-black text-fire-400">{pendingCount}</p>
                            </div>
                            <div className="bg-gradient-to-br from-green-900/40 to-stone-800 p-4 md:p-5 rounded-2xl border border-green-700/30 shadow-lg">
                                <div className="flex items-center gap-2 mb-2">
                                    <CheckCircle size={16} className="text-green-400" />
                                    <p className="text-white/95 text-xs font-bold">å·²å®Œæˆ</p>
                                </div>
                                <p className="text-xl md:text-2xl font-black text-green-400">{completedCount}</p>
                            </div>
                            <div className="bg-gradient-to-br from-blue-900/40 to-stone-800 p-4 md:p-5 rounded-2xl border border-blue-700/30 shadow-lg">
                                <div className="flex items-center gap-2 mb-2">
                                    <Heart size={16} className="text-blue-400" />
                                    <p className="text-white/95 text-xs font-bold">ç¸½è´ŠåŠ©æ•¸</p>
                                </div>
                                <p className="text-xl md:text-2xl font-black text-blue-400">{data.length}</p>
                            </div>
                        </div>
                        
                        {/* åˆ†é åˆ‡æ› - æ‰‹æ©Ÿç‰ˆæ©«å‘æ»¾å‹• */}
                        <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 md:mb-8 gap-4">
                            <div className="w-full lg:w-auto overflow-x-auto pb-2 -mx-3 px-3 md:mx-0 md:px-0">
                                <div className="flex gap-2 min-w-max">
                                    <button onClick={() => setCurrentTab('donations')} className={`px-4 md:px-5 py-2.5 rounded-xl font-bold text-sm transition-colors whitespace-nowrap ${currentTab === 'donations' ? 'bg-amber-500 text-amber-950 shadow-lg shadow-amber-900/30' : 'bg-amber-950/50 text-amber-200/90 hover:bg-amber-900/50 hover:text-amber-100 border border-amber-800/40'}`}>
                                        è´ŠåŠ©ç®¡ç†
                                    </button>
                                    <button onClick={() => setCurrentTab('guides')} className={`px-4 md:px-5 py-2.5 rounded-xl font-bold text-sm transition-colors flex items-center gap-2 whitespace-nowrap ${currentTab === 'guides' ? 'bg-purple-500 text-white shadow-lg shadow-purple-900/20' : 'bg-purple-950/50 text-purple-200/90 hover:bg-purple-900/50 hover:text-purple-100 border border-purple-800/40'}`}>
                                        <BookOpen size={16}/>
                                        <span>æ´»å‹•æ”»ç•¥</span>
                                    </button>
                                    <button onClick={() => setCurrentTab('stats')} className={`px-4 md:px-5 py-2.5 rounded-xl font-bold text-sm transition-colors flex items-center gap-2 whitespace-nowrap ${currentTab === 'stats' ? 'bg-cyan-500 text-white shadow-lg shadow-cyan-900/20' : 'bg-cyan-950/50 text-cyan-200/90 hover:bg-cyan-900/50 hover:text-cyan-100 border border-cyan-800/40'}`}>
                                        <Coins size={16}/>
                                        <span>å ±è¡¨çµ±è¨ˆ</span>
                                    </button>
                                    <button onClick={() => setCurrentTab('events')} className={`px-4 md:px-5 py-2.5 rounded-xl font-bold text-sm transition-colors whitespace-nowrap ${currentTab === 'events' ? 'bg-sky-500 text-white shadow-lg shadow-sky-900/20' : 'bg-sky-950/50 text-sky-200/90 hover:bg-sky-900/50 hover:text-sky-100 border border-sky-800/40'}`}>
                                        æ´»å‹•ç®¡ç†
                                    </button>
                                    <button onClick={() => setCurrentTab('music')} className={`px-4 md:px-5 py-2.5 rounded-xl font-bold text-sm transition-colors flex items-center gap-2 whitespace-nowrap ${currentTab === 'music' ? 'bg-rose-500 text-white shadow-lg shadow-rose-900/20' : 'bg-rose-950/50 text-rose-200/90 hover:bg-rose-900/50 hover:text-rose-100 border border-rose-800/40'}`}>
                                        <Music size={16}/>
                                        <span>éŸ³æ¨‚</span>
                                    </button>
                                    <button onClick={() => setCurrentTab('settings')} className={`px-4 md:px-5 py-2.5 rounded-xl font-bold text-sm transition-colors flex items-center gap-2 whitespace-nowrap ${currentTab === 'settings' ? 'bg-stone-600 text-white shadow-lg' : 'bg-stone-800/80 text-stone-300 hover:bg-stone-700 hover:text-white border border-stone-600/50'}`}>
                                        <Settings size={16}/>
                                        <span>è¨­å®š</span>
                                    </button>
                                    {(isSuperAdmin || supabaseUser?.user_metadata?.role === 'admin') && (
                                        <button onClick={() => setCurrentTab('registered_users')} className={`px-4 md:px-5 py-2.5 rounded-xl font-bold text-sm transition-colors flex items-center gap-2 whitespace-nowrap ${currentTab === 'registered_users' ? 'bg-blue-500 text-white shadow-lg shadow-blue-900/20' : 'bg-blue-950/50 text-blue-200/90 hover:bg-blue-900/50 hover:text-blue-100 border border-blue-800/40'}`}>
                                            <Users size={16}/>
                                            <span>è¨»å†Šç”¨æˆ¶</span>
                                        </button>
                                    )}
                                    {isSuperAdmin && (
                                        <button onClick={() => setCurrentTab('super_admins')} className={`px-4 md:px-5 py-2.5 rounded-xl font-bold text-sm transition-colors flex items-center gap-2 whitespace-nowrap ${currentTab === 'super_admins' ? 'bg-violet-500 text-white shadow-lg shadow-violet-900/20' : 'bg-violet-950/50 text-violet-200/90 hover:bg-violet-900/50 hover:text-violet-100 border border-violet-800/40'}`}>
                                            <UserPlus size={16}/>
                                            <span>è¶…ç®¡</span>
                                        </button>
                                    )}
                                </div>
                            </div>
                            
                            {currentTab === 'donations' && (
                                <div className="flex gap-2 w-full lg:w-auto flex-wrap">
                                    <button onClick={refreshDonations} className="px-4 py-2 rounded-xl font-semibold text-sm transition-colors flex items-center gap-2 border bg-amber-600/40 hover:bg-amber-500/50 text-amber-100 border-amber-500/40" title="é‡æ–°è¼‰å…¥è³‡æ–™ï¼ˆæ‰‹æ©Ÿç‰ˆè‹¥ä¸åŒæ­¥è«‹é»æ­¤ï¼‰">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                                        <span className="md:inline">é‡æ–°æ•´ç†</span>
                                    </button>
                                    {selectedIds.length > 0 && (
                                        <button 
                                            onClick={() => setShowBatchActions(!showBatchActions)} 
                                            className="px-4 py-2 rounded-xl font-semibold text-sm transition-colors flex items-center gap-2 border bg-stone-600/60 hover:bg-stone-500/60 text-white border-stone-500/50"
                                        >
                                            <Check size={16}/>
                                            æ‰¹æ¬¡æ“ä½œ ({selectedIds.length})
                                        </button>
                                    )}
                                    <button onClick={exportToCSV} className="px-4 py-2 rounded-xl font-semibold text-sm transition-colors flex items-center gap-2 border bg-stone-600/60 hover:bg-stone-500/60 text-white border-stone-500/50" title="åŒ¯å‡º CSV">
                                        <Download size={16}/>
                                        <span className="hidden md:inline">åŒ¯å‡º CSV</span>
                                    </button>
                                    <button onClick={handleLogout} className="px-3 py-2 rounded-xl font-semibold text-sm transition-colors flex items-center gap-2 border bg-stone-600/60 hover:bg-red-500/30 text-stone-100 hover:text-red-300 border-stone-500/50"><LogOut size={16}/></button>
                                </div>
                            )}
                             {currentTab !== 'donations' && (
                                 <button onClick={handleLogout} className="px-3 py-2 bg-red-500/20 hover:bg-red-500 text-red-500 hover:text-white rounded-xl font-bold transition-colors flex items-center gap-2 border border-red-500/30 self-end lg:self-auto"><LogOut size={18}/></button>
                             )}
                        </div>
                        
                        
                        {/* è´ŠåŠ©ç®¡ç†åˆ†é  */}
                        {currentTab === 'donations' && (
                            <>
                                {/* æ‰‹æ©Ÿç‰ˆæç¤ºï¼šè³‡æ–™åŒæ­¥ */}
                                <div className="md:hidden mb-3 px-3 py-2 rounded-xl bg-amber-900/30 border border-amber-700/30 text-amber-200/90 text-xs">
                                    ğŸ’¡ æ‰‹æ©Ÿç‰ˆè‹¥è³‡æ–™æœªåŒæ­¥ï¼Œè«‹é»ä¸Šæ–¹ã€Œé‡æ–°æ•´ç†ã€
                                </div>
                                {/* æœå°‹èˆ‡ç¯©é¸ï¼ˆèˆ’é©é–“è·èˆ‡å°æ¯”ï¼‰ */}
                                <div className="space-y-4 mb-6">
                                    <div className="flex flex-col md:flex-row gap-3 p-4 rounded-2xl bg-gradient-to-r from-amber-950/25 via-stone-800/60 to-stone-800/60 border border-amber-800/30">
                                        <div className="relative flex-1">
                                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-amber-400/80" size={16}/>
                                            <input type="text" placeholder="æœå°‹éŠæˆ²å¸³è™Ÿæˆ– Email..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full bg-stone-800/80 border border-stone-600/50 rounded-xl pl-10 pr-4 py-2.5 text-sm text-white placeholder-stone-400 focus:border-amber-500/50 outline-none transition-colors"/>
                                        </div>
                                        <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className="bg-stone-800/80 border border-stone-600/50 rounded-xl px-4 py-2.5 text-sm text-stone-100 outline-none cursor-pointer focus:border-amber-500/50 transition-colors">
                                            <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
                                            <option value="pending">å¾…è™•ç†</option>
                                            <option value="completed">å·²å®Œæˆ</option>
                                            <option value="cancelled">å·²å–æ¶ˆ</option>
                                        </select>
                                        <button
                                            onClick={() => setShowAdvancedSearch(!showAdvancedSearch)}
                                            className={`px-4 py-2.5 rounded-xl font-medium text-sm transition-colors flex items-center gap-2 border ${showAdvancedSearch ? 'bg-stone-600 text-white border-stone-500/50' : 'bg-stone-800/60 text-stone-100 hover:text-white border-stone-600/50 hover:border-stone-500/50'}`}
                                        >
                                            <Settings size={16} />
                                            é€²éšæœå°‹
                                        </button>
                                    </div>
                                    
                                    {/* é€²éšæœå°‹é¸é … */}
                                    {showAdvancedSearch && (
                                        <div className="bg-slate-900/50 border border-sky-800/40 rounded-2xl p-4 space-y-3">
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                                                <div>
                                                    <label className="block text-stone-100 text-xs font-semibold mb-1.5">é–‹å§‹æ—¥æœŸ</label>
                                                    <input type="date" value={dateFrom} onChange={(e) => setDateFrom(e.target.value)} className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-sm text-stone-100 focus:border-stone-500 outline-none" />
                                                </div>
                                                <div>
                                                    <label className="block text-stone-100 text-xs font-semibold mb-1.5">çµæŸæ—¥æœŸ</label>
                                                    <input type="date" value={dateTo} onChange={(e) => setDateTo(e.target.value)} className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-sm text-stone-100 focus:border-stone-500 outline-none" />
                                                </div>
                                                <div>
                                                    <label className="block text-stone-100 text-xs font-semibold mb-1.5">æœ€ä½é‡‘é¡</label>
                                                    <input type="number" placeholder="NT$ 0" value={amountMin} onChange={(e) => setAmountMin(e.target.value)} className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-sm text-stone-100 placeholder-stone-500 focus:border-stone-500 outline-none" />
                                                </div>
                                                <div>
                                                    <label className="block text-stone-100 text-xs font-semibold mb-1.5">æœ€é«˜é‡‘é¡</label>
                                                    <input type="number" placeholder="ç„¡ä¸Šé™" value={amountMax} onChange={(e) => setAmountMax(e.target.value)} className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-sm text-stone-100 placeholder-stone-500 focus:border-stone-500 outline-none" />
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                <div>
                                                    <label className="block text-stone-100 text-xs font-semibold mb-1.5">æ”¯ä»˜æ–¹å¼</label>
                                                    <select value={filterPaymentMethod} onChange={(e) => setFilterPaymentMethod(e.target.value)} className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-sm text-stone-100 focus:border-stone-500 outline-none cursor-pointer">
                                                        <option value="all">å…¨éƒ¨</option>
                                                        <option value="shopline">SHOPLINE</option>
                                                        <option value="linepay">LINE Pay</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-stone-100 text-xs font-semibold mb-1.5">æ¨™ç±¤</label>
                                                    <select value={filterTag} onChange={(e) => setFilterTag(e.target.value)} className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-sm text-stone-100 focus:border-stone-500 outline-none cursor-pointer">
                                                        <option value="all">å…¨éƒ¨</option>
                                                        {TAG_OPTIONS.map(tag => (
                                                            <option key={tag.value} value={tag.value}>{tag.label}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            </div>
                                            <div className="flex justify-end gap-2 pt-2">
                                                <button onClick={clearAdvancedSearch} className="px-4 py-2 bg-stone-600/50 hover:bg-stone-600 text-stone-200 font-medium rounded-lg text-sm transition-colors border border-stone-600/50">
                                                    æ¸…é™¤ç¯©é¸
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* æ‰¹æ¬¡æ“ä½œé¢æ¿ */}
                                    {showBatchActions && selectedIds.length > 0 && (
                                        <div className="bg-amber-950/30 border border-amber-700/40 rounded-2xl p-4">
                                            <div className="flex flex-col md:flex-row gap-4">
                                                <div className="flex-1">
                                                    <p className="text-stone-100 text-sm font-semibold mb-2">æ‰¹æ¬¡æ›´æ–°ç‹€æ…‹</p>
                                                    <div className="flex flex-wrap gap-2">
                                                        <button onClick={() => batchUpdateStatus('completed')} className="px-3 py-2 bg-emerald-500/15 text-emerald-400 border border-emerald-500/40 rounded-lg font-medium text-sm hover:bg-emerald-500/25 transition-colors">å·²å®Œæˆ</button>
                                                        <button onClick={() => batchUpdateStatus('pending')} className="px-3 py-2 bg-amber-500/15 text-amber-400 border border-amber-500/40 rounded-lg font-medium text-sm hover:bg-amber-500/25 transition-colors">å¾…è™•ç†</button>
                                                        <button onClick={() => batchUpdateStatus('cancelled')} className="px-3 py-2 bg-red-500/15 text-red-400 border border-red-500/40 rounded-lg font-medium text-sm hover:bg-red-500/25 transition-colors">å·²å–æ¶ˆ</button>
                                                    </div>
                                                </div>
                                                <div className="flex-1">
                                                    <p className="text-stone-100 text-sm font-semibold mb-2">æ‰¹æ¬¡åŠ å…¥æ¨™ç±¤</p>
                                                    <div className="flex flex-wrap gap-2">
                                                        {TAG_OPTIONS.map(tag => (
                                                            <button key={tag.value} onClick={() => batchAddTag(tag.value)} className={`px-2.5 py-1.5 rounded-lg text-xs font-medium ${tag.color} hover:opacity-90 transition-opacity`}>+ {tag.label}</button>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div className="flex items-end gap-2">
                                                    <button onClick={batchDelete} className="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 font-medium rounded-lg text-sm border border-red-500/40 transition-colors">åˆªé™¤</button>
                                                    <button onClick={() => { setShowBatchActions(false); setSelectedIds([]); }} className="px-4 py-2 bg-stone-600 hover:bg-stone-500 text-stone-200 font-medium rounded-lg text-sm transition-colors">å–æ¶ˆ</button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                        
                        {/* è´ŠåŠ©ç´€éŒ„åˆ—è¡¨ */}
                        {filteredData.length === 0 ? (
                            <div className="rounded-2xl border border-amber-800/30 bg-gradient-to-br from-amber-950/20 to-stone-800/50 p-16 md:p-20">
                                <div className="text-stone-100 text-center flex flex-col items-center">
                                    <Clipboard size={40} className="mb-3 text-amber-400/70"/>
                                    <p className="text-lg font-semibold text-white">æš«ç„¡è´ŠåŠ©ç´€éŒ„</p>
                                    <p className="text-sm mt-1 text-stone-200">ç­‰å¾…ç©å®¶é€²è¡Œè´ŠåŠ©</p>
                                </div>
                            </div>
                        ) : (
                            <>
                                {/* å·¥å…·åˆ—ï¼šå…¨é¸ + æª¢è¦–åˆ‡æ›ï¼ˆèˆ’é©é–“è·èˆ‡è¦–è¦ºï¼‰ */}
                                <div className="px-4 py-3 mb-1 flex flex-wrap items-center gap-5 rounded-2xl bg-amber-950/25 border border-amber-700/30">
                                    <label className="flex items-center gap-2.5 cursor-pointer text-stone-100 hover:text-white text-sm font-semibold transition-colors">
                                        <input type="checkbox" checked={selectedIds.length === paginatedData.length && paginatedData.length > 0} onChange={toggleSelectAll} className="w-4 h-4 rounded border-stone-500 text-water-500 focus:ring-water-500/50 focus:ring-2 cursor-pointer" />
                                        å…¨é¸æœ¬é 
                                    </label>
                                    {selectedIds.length > 0 && <span className="text-amber-200 text-sm font-semibold">å·²é¸ {selectedIds.length} ç­†</span>}
                                    <div className="flex rounded-xl overflow-hidden border border-stone-600/50 bg-stone-900/50 p-0.5">
                                        <button type="button" onClick={() => setDonationListView('cards')} className={`flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg transition-all duration-200 ${donationListView === 'cards' ? 'bg-stone-600 text-white shadow-sm' : 'text-stone-200 hover:text-white hover:bg-stone-800/50'}`}>
                                            <LayoutGrid size={16} strokeWidth={2} />
                                            å¡ç‰‡
                                        </button>
                                        <button type="button" onClick={() => setDonationListView('list')} className={`flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg transition-all duration-200 ${donationListView === 'list' ? 'bg-stone-600 text-white shadow-sm' : 'text-stone-200 hover:text-white hover:bg-stone-800/50'}`}>
                                            <List size={16} strokeWidth={2} />
                                            æ¢åˆ—å¼
                                        </button>
                                    </div>
                                </div>
                                {/* æ¢åˆ—å¼ï¼šè¡¨æ ¼ï¼ˆç²¾ç°¡æ¬„ä½ã€æ‰‹æ©Ÿç‰ˆå¯æ©«å‘æ»‘å‹•ï¼‰ */}
                                {donationListView === 'list' && (
                                <div className="rounded-2xl border border-amber-800/30 bg-gradient-to-b from-amber-950/15 to-stone-800/50 overflow-hidden shadow-inner">
                                    <div className="overflow-x-auto overscroll-x-contain" style={{ WebkitOverflowScrolling: 'touch' }}>
                                    <table className="w-full min-w-[720px]">
                                        <thead className="bg-stone-800/60 border-b border-stone-600/40">
                                            <tr>
                                                <th className="w-10 px-2 py-3 text-center sticky left-0 bg-stone-800/95 backdrop-blur-sm z-10 border-r border-stone-600/40">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={selectedIds.length === paginatedData.length && paginatedData.length > 0}
                                                        onChange={toggleSelectAll}
                                                        className="w-4 h-4 rounded border-stone-500 text-water-500 focus:ring-water-500/50 cursor-pointer"
                                                    />
                                                </th>
                                                <th className="w-24 px-2 py-3 text-left text-xs font-semibold text-stone-100 sticky left-10 bg-stone-800/95 backdrop-blur-sm z-10 border-r border-stone-600/40">ç‹€æ…‹</th>
                                                <th className="w-20 px-2 py-3 text-left text-xs font-semibold text-stone-100 sticky left-[8.5rem] bg-stone-800/95 backdrop-blur-sm z-10 border-r border-stone-600/40">æ“ä½œ</th>
                                                <th className="min-w-[110px] px-2 py-3 text-left text-xs font-semibold text-stone-100">è¨‚å–®</th>
                                                <th className="w-20 px-2 py-3 text-left text-xs font-semibold text-stone-100">æ™‚é–“</th>
                                                <th className="min-w-[140px] px-2 py-3 text-left text-xs font-semibold text-stone-100 truncate">ç©å®¶</th>
                                                <th className="w-20 px-2 py-3 text-left text-xs font-semibold text-stone-100">é‡‘é¡</th>
                                                <th className="w-20 px-2 py-3 text-left text-xs font-semibold text-stone-100">é‡‘å¹£</th>
                                                <th className="w-20 px-2 py-3 text-left text-xs font-semibold text-stone-100 hidden lg:table-cell">æ”¯ä»˜</th>
                                                <th className="min-w-[90px] px-2 py-3 text-left text-xs font-semibold text-stone-100 max-w-[100px] truncate hidden xl:table-cell" title="å‚™è¨»">å‚™è¨»</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-stone-700/30">
                                            {paginatedData.map(donation => (
                                                <React.Fragment key={donation.id}>
                                                    <tr className="hover:bg-stone-700/20 transition-colors">
                                                        <td className="px-2 py-2.5 text-center sticky left-0 bg-stone-800/95 backdrop-blur-sm z-10 border-r border-stone-600/30">
                                                            <input 
                                                                type="checkbox" 
                                                                checked={selectedIds.includes(donation.id)}
                                                                onChange={() => toggleSelect(donation.id)}
                                                                className="w-4 h-4 rounded border-stone-500 text-water-500 focus:ring-water-500/50 cursor-pointer"
                                                            />
                                                        </td>
                                                        <td className="px-2 py-2.5 sticky left-10 bg-stone-800/95 backdrop-blur-sm z-10 border-r border-stone-600/30">
                                                            <select 
                                                                value={donation.status} 
                                                                onChange={(e) => updateStatus(donation.id, e.target.value)}
                                                                className={`text-xs font-medium px-2 py-1 rounded-lg outline-none cursor-pointer border transition-colors w-full max-w-[90px] ${
                                                                    donation.status === 'completed' ? 'bg-emerald-500/15 text-emerald-400 border-emerald-500/40' : 
                                                                    donation.status === 'pending' ? 'bg-amber-500/15 text-amber-400 border-amber-500/40' : 
                                                                    'bg-red-500/15 text-red-400 border-red-500/40'
                                                                }`}
                                                            >
                                                                <option value="pending">å¾…è™•ç†</option>
                                                                <option value="completed">å·²å®Œæˆ</option>
                                                                <option value="cancelled">å·²å–æ¶ˆ</option>
                                                            </select>
                                                            {donation.status === 'pending' && (
                                                                <button onClick={() => updateStatus(donation.id, 'completed')} className="mt-1 block w-full px-2 py-1 rounded text-[10px] font-semibold bg-emerald-500/30 text-emerald-300 border border-emerald-500/50 hover:bg-emerald-500/40" title="ä¸€éµæ¨™è¨˜å®Œæˆ"><CheckCircle size={10} className="inline mr-0.5" />å®Œæˆ</button>
                                                            )}
                                                        </td>
                                                        <td className="px-2 py-2.5 sticky left-[8.5rem] bg-stone-800/95 backdrop-blur-sm z-10 border-r border-stone-600/30">
                                                            <div className="flex items-center gap-1">
                                                                <button onClick={() => startEditNotes(donation)} className="p-1.5 text-stone-400 hover:text-water-400 hover:bg-stone-700/50 rounded-lg transition-colors" title="ç·¨è¼¯"><Edit2 size={14} /></button>
                                                                <button onClick={() => handleDelete(donation.id)} className="p-1.5 text-stone-400 hover:text-red-400 hover:bg-stone-700/50 rounded-lg transition-colors" title="åˆªé™¤"><Trash2 size={14} /></button>
                                                            </div>
                                                        </td>
                                                        <td className="px-2 py-2.5">
                                                            {donation.order_number ? (
                                                                <div className="flex items-center gap-1 min-w-0">
                                                                    <code className="text-xs font-medium text-stone-200 bg-stone-700/60 px-2 py-0.5 rounded truncate max-w-[90px]" title={donation.order_number}>{donation.order_number}</code>
                                                                    <button onClick={() => { navigator.clipboard.writeText(donation.order_number); showToast('å·²è¤‡è£½', 'success'); }} className="p-1 hover:bg-stone-700/50 rounded shrink-0 text-stone-400" title="è¤‡è£½"><Copy size={12} /></button>
                                                                </div>
                                                            ) : (
                                                                <span className="text-stone-500 text-xs">â€”</span>
                                                            )}
                                                        </td>
                                                        <td className="px-2 py-2.5">
                                                            <div className="text-xs text-stone-400 font-mono whitespace-nowrap">{new Date(donation.created_at).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</div>
                                                        </td>
                                                        <td className="px-2 py-2.5 min-w-0">
                                                            <div className="min-w-0 space-y-0.5">
                                                                <div className="text-stone-100 font-medium text-sm truncate" title={donation.game_account}>{donation.game_account}</div>
                                                                <div className="text-stone-500 text-xs truncate" title={donation.email}>{donation.email}</div>
                                                                <div className="text-stone-400 text-xs truncate" title={donation.plan_name}>{donation.plan_name || 'â€”'}</div>
                                                            </div>
                                                        </td>
                                                        <td className="px-2 py-2.5">
                                                            <div className="text-stone-100 font-semibold text-sm font-mono">NT$ {(donation.amount||0).toLocaleString()}</div>
                                                        </td>
                                                        <td className="px-2 py-2.5">
                                                            <div className="text-amber-400/90 font-medium text-sm font-mono flex items-center gap-0.5">
                                                                <Coins size={12} className="text-amber-500/80 shrink-0" />
                                                                {donation.coins ? donation.coins.toLocaleString() : (() => {
                                                                    const plan = PLANS.find(p => p.amount === donation.amount);
                                                                    return plan ? plan.total.toLocaleString() : '0';
                                                                })()}
                                                            </div>
                                                        </td>
                                                        <td className="px-2 py-2.5 hidden lg:table-cell">
                                                            <span className="text-xs text-stone-300">{donation.payment_method === 'shopline' ? 'SHOPLINE' : donation.payment_method === 'linepay' ? 'LINE' : donation.payment_method || 'â€”'}</span>
                                                        </td>
                                                        <td className="px-2 py-2.5 hidden xl:table-cell max-w-[100px]">
                                                            <span className="text-stone-400 text-xs truncate block" title={donation.notes || ''}>{donation.notes ? (donation.notes.length > 12 ? donation.notes.slice(0, 12) + 'â€¦' : donation.notes) : 'â€”'}</span>
                                                        </td>
                                                    </tr>
                                                    {/* æ¨™ç±¤ç·¨è¼¯è¡Œ */}
                                                    {editingTags === donation.id && (
                                                        <tr className="bg-stone-800/30">
                                                            <td colSpan="10" className="px-5 py-3">
                                                                <div className="flex items-center gap-3 flex-wrap">
                                                                    <span className="text-stone-500 text-sm font-medium">å¿«é€ŸåŠ å…¥æ¨™ç±¤</span>
                                                                    <div className="flex flex-wrap gap-2">
                                                                        {TAG_OPTIONS.map(tag => {
                                                                            const hasTag = (donation.tags || []).includes(tag.value);
                                                                            return !hasTag && (
                                                                                <button key={tag.value} onClick={() => addTag(donation.id, tag.value)} className={`px-2.5 py-1 rounded-lg text-xs font-medium ${tag.color} hover:opacity-90 transition-opacity`}>+ {tag.label}</button>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                    <button onClick={() => { setEditingTags(null); setNewTag(''); }} className="ml-auto px-3 py-1.5 bg-stone-600 hover:bg-stone-500 text-stone-200 font-medium rounded-lg text-sm transition-colors">é—œé–‰</button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )}
                                                    
                                                    {/* è¨‚å–®å®Œæ•´ç·¨è¼¯è¡Œï¼ˆç®¡ç†å“¡å¯æ”¹ä»»ä½•è³‡è¨Šï¼ŒåŒæ­¥è‡³è¨»å†Šç”¨æˆ¶ç´¯è¨ˆï¼‰ */}
                                                    {editingId === donation.id && (
                                                        <tr className="bg-stone-800/40">
                                                            <td colSpan="10" className="px-5 py-4">
                                                                <div className="flex flex-wrap items-center justify-between gap-3 mb-3 p-3 bg-stone-700/30 border border-stone-600/40 rounded-xl">
                                                                    <p className="text-stone-300 text-sm font-medium">ç·¨è¼¯è¨‚å–® Â· å„²å­˜å¾ŒåŒæ­¥è‡³è¨»å†Šç”¨æˆ¶ç´¯è¨ˆ</p>
                                                                    <div className="flex gap-2">
                                                                        <button onClick={() => saveNotes(donation.id)} className="px-5 py-2.5 bg-water-600 hover:bg-water-500 text-white font-semibold rounded-xl text-sm transition-colors">
                                                                            âœ“ ç¢ºèªå„²å­˜
                                                                        </button>
                                                                        <button onClick={() => { setEditingId(null); setEditNotes(''); setEditGameAccount(''); setEditLineName(''); setEditEmail(''); setEditAmount(''); setEditCoins(''); setEditPlanName(''); setEditPaymentMethod(''); setEditStatus(''); }} className="px-4 py-2 bg-stone-600 hover:bg-stone-500 text-stone-200 font-medium rounded-lg text-sm transition-colors">
                                                                            å–æ¶ˆ
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-3">
                                                                    <div><label className="block text-stone-500 text-xs font-medium mb-1">Email</label><input type="text" value={editEmail} onChange={(e) => setEditEmail(e.target.value)} placeholder="å®¢æˆ¶ Email" className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm placeholder-stone-500 focus:border-stone-500 outline-none" /></div>
                                                                    <div><label className="block text-stone-500 text-xs font-medium mb-1">éŠæˆ²å¸³è™Ÿ</label><input type="text" value={editGameAccount} onChange={(e) => setEditGameAccount(e.target.value)} placeholder="éŠæˆ²å¸³è™Ÿ" className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm placeholder-stone-500 focus:border-stone-500 outline-none" /></div>
                                                                    <div><label className="block text-stone-500 text-xs font-medium mb-1">LINE / Discord</label><input type="text" value={editLineName} onChange={(e) => setEditLineName(e.target.value)} placeholder="LINE / Discord" className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm placeholder-stone-500 focus:border-stone-500 outline-none" /></div>
                                                                    <div><label className="block text-stone-500 text-xs font-medium mb-1">é‡‘é¡ (NT$)</label><input type="number" min="0" value={editAmount} onChange={(e) => setEditAmount(e.target.value)} className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm focus:border-stone-500 outline-none" /></div>
                                                                    <div><label className="block text-stone-500 text-xs font-medium mb-1">é‡‘å¹£</label><input type="number" min="0" value={editCoins} onChange={(e) => setEditCoins(e.target.value)} className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm focus:border-stone-500 outline-none" /></div>
                                                                    <div><label className="block text-stone-500 text-xs font-medium mb-1">æ–¹æ¡ˆåç¨±</label><input type="text" value={editPlanName} onChange={(e) => setEditPlanName(e.target.value)} className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm focus:border-stone-500 outline-none" /></div>
                                                                    <div><label className="block text-stone-500 text-xs font-medium mb-1">æ”¯ä»˜æ–¹å¼</label><select value={editPaymentMethod} onChange={(e) => setEditPaymentMethod(e.target.value)} className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm focus:border-stone-500 outline-none"><option value="linepay">LINE Pay</option><option value="shopline">SHOPLINE</option></select></div>
                                                                    <div><label className="block text-stone-500 text-xs font-medium mb-1">ç‹€æ…‹</label><select value={editStatus} onChange={(e) => setEditStatus(e.target.value)} className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm focus:border-stone-500 outline-none"><option value="pending">å¾…è™•ç†</option><option value="completed">å·²å®Œæˆ</option><option value="cancelled">å·²å–æ¶ˆ</option></select></div>
                                                                </div>
                                                                <div className="mb-2"><label className="block text-stone-500 text-xs font-medium mb-1">ç®¡ç†å“¡å‚™è¨»</label><textarea value={editNotes} onChange={(e) => setEditNotes(e.target.value)} placeholder="è¼¸å…¥ç®¡ç†å“¡å‚™è¨»..." rows="2" className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm placeholder-stone-500 resize-none focus:border-stone-500 outline-none" /></div>
                                                                <div className="flex gap-2 pt-2 border-t border-stone-600/40">
                                                                    <button onClick={() => saveNotes(donation.id)} className="px-5 py-2.5 bg-water-600 hover:bg-water-500 text-white font-medium rounded-lg text-sm transition-colors">ç¢ºèªå„²å­˜</button>
                                                                    <button onClick={() => { setEditingId(null); setEditNotes(''); setEditGameAccount(''); setEditLineName(''); setEditEmail(''); setEditAmount(''); setEditCoins(''); setEditPlanName(''); setEditPaymentMethod(''); setEditStatus(''); }} className="px-5 py-2.5 bg-stone-600 hover:bg-stone-500 text-stone-200 font-medium rounded-lg text-sm transition-colors">å–æ¶ˆ</button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )}
                                                    {/* é¡¯ç¤ºç¾æœ‰å‚™è¨»ï¼ˆå¦‚æœæœ‰ä¸”ä¸åœ¨ç·¨è¼¯ä¸­ï¼‰ */}
                                                    {donation.notes && editingId !== donation.id && (
                                                        <tr className="bg-stone-800/20">
                                                            <td colSpan="10" className="px-5 py-2.5">
                                                                <div className="flex items-start gap-2 text-sm">
                                                                    <span className="text-stone-500 font-medium">å‚™è¨»</span>
                                                                    <span className="text-stone-400">{donation.notes}</span>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )}
                                                </React.Fragment>
                                            ))}
                                        </tbody>
                                    </table>
                                    </div>
                                </div>
                                )}
                                {/* å¡ç‰‡å¼ï¼šä¸€æ ¼ä¸€å¡ï¼ˆèˆ’é©åœ“è§’èˆ‡å°æ¯”ï¼‰ */}
                                {donationListView === 'cards' && (
                                <div className="p-4 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
                                    {paginatedData.map((item) => (
                                        <React.Fragment key={item.id}>
                                        <div className="bg-gradient-to-br from-amber-950/20 to-stone-800/70 rounded-2xl border border-amber-700/25 overflow-hidden flex flex-col shadow-sm hover:border-amber-600/40 transition-colors">
                                            {/* å¡ç‰‡é ­éƒ¨ */}
                                            <div className="px-4 py-3 border-b border-stone-600/30 bg-stone-800/30">
                                                <div className="flex items-center justify-between gap-2 mb-2">
                                                    <div className="flex items-center gap-2.5 flex-wrap">
                                                        <input type="checkbox" checked={selectedIds.includes(item.id)} onChange={() => toggleSelect(item.id)} className="w-4 h-4 rounded border-stone-500 text-water-500 focus:ring-water-500/50 cursor-pointer" />
                                                        <select 
                                                            value={item.status} 
                                                            onChange={(e) => updateStatus(item.id, e.target.value)}
                                                            className={`text-xs font-medium px-2.5 py-1.5 rounded-lg border cursor-pointer outline-none transition-colors ${
                                                                item.status === 'completed' ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/40' : 
                                                                item.status === 'pending' ? 'bg-amber-500/20 text-amber-400 border-amber-500/40' : 
                                                                'bg-red-500/20 text-red-400 border-red-500/40'
                                                            }`}
                                                            title="é»æ“Šå¯è®Šæ›´ç‹€æ…‹"
                                                        >
                                                            <option value="pending">å¾…è™•ç†</option>
                                                            <option value="completed">å·²å®Œæˆ</option>
                                                            <option value="cancelled">å·²å–æ¶ˆ</option>
                                                        </select>
                                                        {item.status === 'pending' && (
                                                            <button onClick={() => updateStatus(item.id, 'completed')} className="px-2.5 py-1.5 rounded-lg text-xs font-semibold bg-emerald-500/30 text-emerald-300 border border-emerald-500/50 hover:bg-emerald-500/40 transition-colors flex items-center gap-1">
                                                                <CheckCircle size={12} /> ç¢ºèªå®Œæˆ
                                                            </button>
                                                        )}
                                                    </div>
                                                    <span className="text-stone-100 text-xs font-medium tabular-nums">
                                                        {new Date(item.created_at).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}
                                                    </span>
                                                </div>
                                                {item.order_number && (
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-stone-100 text-xs font-semibold">è¨‚å–®</span>
                                                        <code className="text-sm font-medium text-stone-200 bg-stone-700/50 px-2 py-1 rounded-md border border-stone-600/40">{item.order_number}</code>
                                                        <button onClick={() => { navigator.clipboard.writeText(item.order_number); showToast('è¨‚å–®ç·¨è™Ÿå·²è¤‡è£½', 'success'); }} className="p-1.5 text-stone-400 hover:text-stone-200 hover:bg-stone-700/50 rounded-md transition-colors"><Copy size={14} /></button>
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* å¡ç‰‡ä¸»é«” */}
                                            <div className="p-4 space-y-4 flex-1">
                                                <div>
                                                    <div className="flex items-center gap-2 mb-1.5">
                                                        <User size={13} className="text-stone-200" />
                                                        <span className="text-xs text-stone-100 font-semibold">ç©å®¶</span>
                                                    </div>
                                                    <div className="pl-5 space-y-0.5">
                                                        {item.game_account && <div className="text-white font-medium text-sm">{item.game_account}</div>}
                                                        <div className="text-stone-200 text-xs break-all">{item.email}</div>
                                                        {item.line_name && <div className="text-stone-200 text-xs">LINE/Discord: {item.line_name}</div>}
                                                    </div>
                                                </div>
                                                
                                                <div className="rounded-xl p-3 bg-stone-700/30 border border-stone-600/30">
                                                    <div className="flex items-center justify-between mb-1.5">
                                                        <span className="text-stone-100 text-xs font-semibold">æ–¹æ¡ˆ</span>
                                                        <span className="text-white font-medium text-sm">{item.plan_name}</span>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-stone-100 font-semibold text-lg">NT$ {item.amount?.toLocaleString() || 0}</span>
                                                        <div className="flex items-center gap-1.5 text-amber-400/90 font-medium text-sm">
                                                            <Coins size={14} />
                                                            {item.coins?.toLocaleString() || (PLANS.find(p => p.total === item.amount)?.total || 0).toLocaleString()}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div className="flex flex-wrap items-center gap-3 text-xs">
                                                    <div className="flex items-center gap-2">
                                                        <CreditCard size={12} className="text-stone-200 shrink-0" />
                                                        <select value={item.payment_method || ''} onChange={(e) => updatePaymentMethod(item.id, e.target.value)} className="text-xs font-medium px-2 py-1.5 rounded-lg border bg-stone-700/50 text-stone-200 border-stone-600/50 focus:border-stone-500 outline-none cursor-pointer" title="æ”¯ä»˜æ–¹å¼">
                                                            <option value="linepay">LINE Pay</option>
                                                            <option value="shopline">SHOPLINE</option>
                                                            {item.payment_method && item.payment_method !== 'linepay' && item.payment_method !== 'shopline' && <option value={item.payment_method}>{item.payment_method}</option>}
                                                        </select>
                                                    </div>
                                                    {item.ip_address && <span className="text-stone-200 font-mono text-xs">{item.ip_address}</span>}
                                                </div>
                                                
                                                <div className="text-xs">
                                                    <span className="text-stone-100 font-semibold">å‚™è¨» </span>
                                                    <span className="text-stone-200" title={item.notes || ''}>{item.notes ? (item.notes.length > 36 ? item.notes.slice(0, 36) + 'â€¦' : item.notes) : 'â€”'}</span>
                                                </div>
                                                
                                                {item.tags && item.tags.length > 0 && (
                                                    <div className="flex flex-wrap gap-1.5">
                                                        {item.tags.map((tagValue, idx) => {
                                                            const tagOption = TAG_OPTIONS.find(t => t.value === tagValue);
                                                            return tagOption ? <span key={idx} className={`px-2 py-0.5 rounded-md text-xs font-medium ${tagOption.color}`}>{tagOption.label}</span> : null;
                                                        })}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* å¡ç‰‡åº•éƒ¨æ“ä½œ */}
                                            <div className="px-4 py-3 border-t border-stone-600/30 bg-stone-800/20 flex gap-2">
                                                <button onClick={() => startEditNotes(item)} className="flex-1 px-3 py-2 bg-stone-600/70 hover:bg-stone-500/70 text-white font-semibold rounded-xl text-xs transition-colors flex items-center justify-center gap-1.5">
                                                    <Edit size={14} />
                                                    ç·¨è¼¯
                                                </button>
                                                <button onClick={() => handleDelete(item.id)} className="px-3 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 font-medium rounded-xl text-xs border border-red-500/30 transition-colors flex items-center justify-center gap-1.5">
                                                    <Trash2 size={14} />
                                                    åˆªé™¤
                                                </button>
                                            </div>
                                        </div>
                                        {/* ç·¨è¼¯è¡¨å–®å¡ */}
                                        {editingId === item.id && (
                                            <div className="md:col-span-2 xl:col-span-3 rounded-2xl border border-stone-600/40 bg-stone-800/60 p-4 md:p-5">
                                                <div className="flex flex-wrap items-center justify-between gap-3 mb-4 p-3 rounded-xl bg-stone-700/30 border border-stone-600/30">
                                                    <p className="text-white text-sm font-semibold">ç·¨è¼¯æ­¤ç­†è¨‚å–® Â· å„²å­˜å¾ŒåŒæ­¥è‡³è¨»å†Šç”¨æˆ¶ç´¯è¨ˆ</p>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => saveNotes(item.id)} className="px-5 py-2.5 bg-water-600 hover:bg-water-500 text-white font-semibold rounded-xl text-sm transition-colors">âœ“ ç¢ºèªå„²å­˜</button>
                                                        <button onClick={() => { setEditingId(null); setEditNotes(''); setEditGameAccount(''); setEditLineName(''); setEditEmail(''); setEditAmount(''); setEditCoins(''); setEditPlanName(''); setEditPaymentMethod(''); setEditStatus(''); }} className="px-4 py-2 bg-stone-600 hover:bg-stone-500 text-white font-medium rounded-lg text-sm transition-colors">å–æ¶ˆ</button>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-3">
                                                    <div><label className="block text-stone-100 text-xs font-semibold mb-1">Email</label><input type="text" value={editEmail} onChange={(e) => setEditEmail(e.target.value)} placeholder="å®¢æˆ¶ Email" className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm placeholder-stone-500 focus:border-stone-500 outline-none" /></div>
                                                    <div><label className="block text-stone-500 text-xs font-medium mb-1">éŠæˆ²å¸³è™Ÿ</label><input type="text" value={editGameAccount} onChange={(e) => setEditGameAccount(e.target.value)} placeholder="éŠæˆ²å¸³è™Ÿ" className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm placeholder-stone-500 focus:border-stone-500 outline-none" /></div>
                                                    <div><label className="block text-stone-100 text-xs font-semibold mb-1">LINE/Discord</label><input type="text" value={editLineName} onChange={(e) => setEditLineName(e.target.value)} placeholder="LINE/Discord" className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm placeholder-stone-500 focus:border-stone-500 outline-none" /></div>
                                                    <div><label className="block text-stone-500 text-xs font-medium mb-1">é‡‘é¡ (NT$)</label><input type="number" min="0" value={editAmount} onChange={(e) => setEditAmount(e.target.value)} className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm focus:border-stone-500 outline-none" /></div>
                                                    <div><label className="block text-stone-500 text-xs font-medium mb-1">é‡‘å¹£</label><input type="number" min="0" value={editCoins} onChange={(e) => setEditCoins(e.target.value)} className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm focus:border-stone-500 outline-none" /></div>
                                                    <div><label className="block text-stone-500 text-xs font-medium mb-1">æ–¹æ¡ˆåç¨±</label><input type="text" value={editPlanName} onChange={(e) => setEditPlanName(e.target.value)} className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm focus:border-stone-500 outline-none" /></div>
                                                    <div><label className="block text-stone-500 text-xs font-medium mb-1">æ”¯ä»˜æ–¹å¼</label><select value={editPaymentMethod} onChange={(e) => setEditPaymentMethod(e.target.value)} className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm focus:border-stone-500 outline-none"><option value="linepay">LINE Pay</option><option value="shopline">SHOPLINE</option></select></div>
                                                    <div><label className="block text-stone-500 text-xs font-medium mb-1">ç‹€æ…‹</label><select value={editStatus} onChange={(e) => setEditStatus(e.target.value)} className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm focus:border-stone-500 outline-none"><option value="pending">å¾…è™•ç†</option><option value="completed">å·²å®Œæˆ</option><option value="cancelled">å·²å–æ¶ˆ</option></select></div>
                                                </div>
                                                <div className="mb-3"><label className="block text-stone-100 text-xs font-semibold mb-1">å‚™è¨»</label><textarea value={editNotes} onChange={(e) => setEditNotes(e.target.value)} placeholder="ç®¡ç†å“¡å‚™è¨»" rows="2" className="w-full bg-stone-700/50 border border-stone-600/50 rounded-lg px-3 py-2 text-stone-100 text-sm placeholder-stone-500 resize-none focus:border-stone-500 outline-none" /></div>
                                                <div className="flex gap-2"><button onClick={() => saveNotes(item.id)} className="px-5 py-2 bg-water-600 hover:bg-water-500 text-white font-medium rounded-lg text-sm transition-colors">ç¢ºèªå„²å­˜</button><button onClick={() => { setEditingId(null); setEditNotes(''); setEditGameAccount(''); setEditLineName(''); setEditEmail(''); setEditAmount(''); setEditCoins(''); setEditPlanName(''); setEditPaymentMethod(''); setEditStatus(''); }} className="px-4 py-2 bg-stone-600 hover:bg-stone-500 text-stone-200 font-medium rounded-lg text-sm transition-colors">å–æ¶ˆ</button></div>
                                            </div>
                                        )}
                                        </React.Fragment>
                                    ))}
                                </div>
                                )}
                            </>
                        )}
                        
                        {/* åˆ†é æ§åˆ¶ */}
                        {filteredData.length > 0 && (
                            <div className="mt-5 flex flex-col md:flex-row items-center justify-between gap-4 py-3 px-4 rounded-2xl bg-amber-950/20 border border-amber-700/25">
                                <div className="text-stone-100 text-sm font-semibold">
                                    é¡¯ç¤º {startIndex + 1}â€“{Math.min(endIndex, filteredData.length)} / å…± {filteredData.length} ç­†
                                    {filteredData.length !== data.length && <span className="text-stone-200"> (ç¯©é¸è‡ª {data.length} ç­†)</span>}
                                </div>
                                <div className="flex items-center gap-3">
                                    <div className="flex items-center gap-2">
                                        <span className="text-stone-100 text-sm font-medium">æ¯é </span>
                                        <select value={itemsPerPage} onChange={(e) => { setItemsPerPage(Number(e.target.value)); setCurrentPage(1); }} className="bg-stone-700/50 border border-stone-600/50 rounded-lg px-2.5 py-1.5 text-sm text-white font-medium outline-none cursor-pointer focus:border-stone-500 transition-colors">
                                            <option value={10}>10</option>
                                            <option value={20}>20</option>
                                            <option value={50}>50</option>
                                            <option value={100}>100</option>
                                        </select>
                                    </div>
                                    <div className="flex items-center gap-1.5">
                                        <button onClick={() => setCurrentPage(1)} disabled={currentPage === 1} className="p-2 rounded-lg bg-stone-700/50 text-stone-200 hover:text-white hover:bg-stone-600/50 transition-colors disabled:opacity-40 disabled:cursor-not-allowed" title="ç¬¬ä¸€é "><ChevronsLeft size={16} /></button>
                                        <button onClick={() => setCurrentPage(currentPage - 1)} disabled={currentPage === 1} className="p-2 rounded-lg bg-stone-700/50 text-stone-200 hover:text-white hover:bg-stone-600/50 transition-colors disabled:opacity-40 disabled:cursor-not-allowed" title="ä¸Šä¸€é "><ChevronLeft size={16} /></button>
                                        <div className="flex items-center gap-1">
                                            {[...Array(totalPages)].map((_, i) => {
                                                const pageNum = i + 1;
                                                if (pageNum === 1 || pageNum === totalPages || (pageNum >= currentPage - 1 && pageNum <= currentPage + 1)) {
                                                    return (
                                                        <button key={pageNum} onClick={() => setCurrentPage(pageNum)} className={`min-w-[2rem] px-2.5 py-1.5 rounded-lg font-semibold text-sm transition-colors ${currentPage === pageNum ? 'bg-stone-600 text-white' : 'bg-stone-700/50 text-stone-200 hover:text-white hover:bg-stone-600/50'}`}>
                                                            {pageNum}
                                                        </button>
                                                    );
                                                } else if (pageNum === currentPage - 2 || pageNum === currentPage + 2) {
                                                    return <span key={pageNum} className="text-stone-300 px-0.5">â€¦</span>;
                                                }
                                                return null;
                                            })}
                                        </div>
                                        <button onClick={() => setCurrentPage(currentPage + 1)} disabled={currentPage === totalPages} className="p-2 rounded-lg bg-stone-700/50 text-stone-200 hover:text-white hover:bg-stone-600/50 transition-colors disabled:opacity-40 disabled:cursor-not-allowed" title="ä¸‹ä¸€é "><ChevronRight size={16} /></button>
                                        <button onClick={() => setCurrentPage(totalPages)} disabled={currentPage === totalPages} className="p-2 rounded-lg bg-stone-700/50 text-stone-200 hover:text-white hover:bg-stone-600/50 transition-colors disabled:opacity-40 disabled:cursor-not-allowed" title="æœ€å¾Œä¸€é "><ChevronsRight size={16} /></button>
                                    </div>
                                </div>
                            </div>
                        )}
                            </>
                        )}
                        
                        {/* Stats åˆ†é  */}
                        {currentTab === 'stats' && (() => {
                            const now = Date.now();
                            const today = new Date(now).setHours(0, 0, 0, 0);
                            const weekAgo = now - 7 * 24 * 60 * 60 * 1000;
                            const monthAgo = now - 30 * 24 * 60 * 60 * 1000;
                            
                            const stats = {
                                total: data.reduce((sum, item) => sum + (item.amount || 0), 0),
                                totalCompleted: data.filter(item => item.status === 'completed').reduce((sum, item) => sum + (item.amount || 0), 0),
                                today: data.filter(item => new Date(item.created_at).getTime() >= today).reduce((sum, item) => sum + (item.amount || 0), 0),
                                week: data.filter(item => new Date(item.created_at).getTime() >= weekAgo).reduce((sum, item) => sum + (item.amount || 0), 0),
                                month: data.filter(item => new Date(item.created_at).getTime() >= monthAgo).reduce((sum, item) => sum + (item.amount || 0), 0),
                                count: data.length,
                                pending: data.filter(item => item.status === 'pending').length,
                                completed: data.filter(item => item.status === 'completed').length,
                                cancelled: data.filter(item => item.status === 'cancelled').length,
                            };
                            
                            const methodStats = {};
                            data.forEach(item => {
                                const method = item.payment_method || 'unknown';
                                methodStats[method] = (methodStats[method] || 0) + (item.amount || 0);
                            });
                            
                            // æº–å‚™è¶¨å‹¢åœ–è¡¨æ•¸æ“šï¼ˆæœ€è¿‘ 30 å¤©ï¼‰
                            const last30Days = [];
                            const trendData = {};
                            for (let i = 29; i >= 0; i--) {
                                const date = new Date(now - i * 24 * 60 * 60 * 1000);
                                const dateStr = date.toISOString().split('T')[0];
                                last30Days.push(dateStr);
                                trendData[dateStr] = 0;
                            }
                            
                            data.forEach(item => {
                                const dateStr = new Date(item.created_at).toISOString().split('T')[0];
                                if (trendData[dateStr] !== undefined) {
                                    trendData[dateStr] += item.amount || 0;
                                }
                            });
                            
                            // æº–å‚™æ–¹æ¡ˆçµ±è¨ˆæ•¸æ“š
                            const planStats = {};
                            data.forEach(item => {
                                const plan = item.plan_name || 'æœªçŸ¥æ–¹æ¡ˆ';
                                planStats[plan] = (planStats[plan] || 0) + 1;
                            });
                            
                            return (
                                <div className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                        <div className="bg-gradient-to-br from-gold-500 to-gold-600 rounded-2xl p-6 text-white shadow-xl">
                                            <div className="flex items-center justify-between mb-3">
                                                <Coins size={28} />
                                                <span className="text-xs font-bold bg-white/20 px-3 py-1 rounded-full">ç¸½è¨ˆ</span>
                                            </div>
                                            <p className="text-3xl font-black mb-1">NT$ {stats.total.toLocaleString()}</p>
                                            <p className="text-gold-100 text-sm font-medium">ç¸½è´ŠåŠ©é‡‘é¡</p>
                                        </div>
                                        
                                        <div className="bg-gradient-to-br from-wind-500 to-wind-600 rounded-2xl p-6 text-white shadow-xl">
                                            <div className="flex items-center justify-between mb-3">
                                                <CheckCircle size={28} />
                                                <span className="text-xs font-bold bg-white/20 px-3 py-1 rounded-full">å·²å®Œæˆ</span>
                                            </div>
                                            <p className="text-3xl font-black mb-1">NT$ {stats.totalCompleted.toLocaleString()}</p>
                                            <p className="text-wind-100 text-sm font-medium">{stats.completed} ç­†è¨‚å–®</p>
                                        </div>
                                        
                                        <div className="bg-gradient-to-br from-fire-500 to-fire-600 rounded-2xl p-6 text-white shadow-xl">
                                            <div className="flex items-center justify-between mb-3">
                                                <Flame size={28} />
                                                <span className="text-xs font-bold bg-white/20 px-3 py-1 rounded-full">æœ¬é€±</span>
                                            </div>
                                            <p className="text-3xl font-black mb-1">NT$ {stats.week.toLocaleString()}</p>
                                            <p className="text-fire-100 text-sm font-medium">è¿‘ 7 æ—¥ç‡Ÿæ”¶</p>
                                        </div>
                                        
                                        <div className="bg-gradient-to-br from-stone-700 to-stone-800 rounded-2xl p-6 text-white shadow-xl">
                                            <div className="flex items-center justify-between mb-3">
                                                <AlertCircle size={28} />
                                                <span className="text-xs font-bold bg-white/20 px-3 py-1 rounded-full">å¾…è™•ç†</span>
                                            </div>
                                            <p className="text-3xl font-black mb-1">{stats.pending}</p>
                                            <p className="text-stone-300 text-sm font-medium">ç­†è¨‚å–®ç­‰å¾…è™•ç†</p>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-gradient-to-br from-cyan-950/40 to-stone-800 rounded-2xl p-6 border border-cyan-700/30 shadow-xl">
                                        <h3 className="text-white font-black text-xl mb-6 flex items-center gap-2">
                                            <Calendar size={24} className="text-cyan-400" />
                                            æ™‚é–“çµ±è¨ˆ
                                        </h3>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div className="bg-gradient-to-br from-amber-900/40 to-stone-800/80 rounded-xl p-5 border border-amber-700/30">
                                                <p className="text-amber-100 text-sm font-semibold mb-2">ä»Šæ—¥</p>
                                                <p className="text-amber-50 text-2xl font-black">NT$ {stats.today.toLocaleString()}</p>
                                            </div>
                                            <div className="bg-gradient-to-br from-sky-900/40 to-stone-800/80 rounded-xl p-5 border border-sky-700/30">
                                                <p className="text-sky-100 text-sm font-semibold mb-2">æœ¬é€± (7å¤©)</p>
                                                <p className="text-sky-50 text-2xl font-black">NT$ {stats.week.toLocaleString()}</p>
                                            </div>
                                            <div className="bg-gradient-to-br from-emerald-900/40 to-stone-800/80 rounded-xl p-5 border border-emerald-700/30">
                                                <p className="text-emerald-100 text-sm font-semibold mb-2">æœ¬æœˆ (30å¤©)</p>
                                                <p className="text-emerald-50 text-2xl font-black">NT$ {stats.month.toLocaleString()}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* åœ–è¡¨è¦–è¦ºåŒ– */}
                                    {data.length > 0 && (
                                        <>
                                            {/* è´ŠåŠ©è¶¨å‹¢åœ– */}
                                            <div className="bg-gradient-to-br from-amber-950/30 to-stone-800 rounded-2xl p-6 border border-amber-700/30 shadow-xl">
                                                <h3 className="text-white font-black text-xl mb-6 flex items-center gap-2">
                                                    <TrendingUp size={24} className="text-amber-400" />
                                                    è´ŠåŠ©è¶¨å‹¢åˆ†æï¼ˆæœ€è¿‘ 30 å¤©ï¼‰
                                                </h3>
                                                <div className="relative h-80">
                                                    <canvas ref={trendChartRef}></canvas>
                                                </div>
                                            </div>
                                            
                                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                                {/* æ”¯ä»˜æ–¹å¼åˆ†å¸ƒ */}
                                                <div className="bg-gradient-to-br from-sky-950/30 to-stone-800 rounded-2xl p-6 border border-sky-700/30 shadow-xl">
                                                    <h3 className="text-white font-black text-xl mb-6 flex items-center gap-2">
                                                        <CreditCard size={24} className="text-sky-400" />
                                                        æ”¯ä»˜æ–¹å¼åˆ†å¸ƒ
                                                    </h3>
                                                    <div className="relative h-80">
                                                        <canvas ref={paymentChartRef}></canvas>
                                                    </div>
                                                </div>
                                                
                                                {/* æ–¹æ¡ˆé¸æ“‡çµ±è¨ˆ */}
                                                <div className="bg-gradient-to-br from-rose-950/30 to-stone-800 rounded-2xl p-6 border border-rose-700/30 shadow-xl">
                                                    <h3 className="text-white font-black text-xl mb-6 flex items-center gap-2">
                                                        <BarChart3 size={24} className="text-rose-400" />
                                                        ç†±é–€æ–¹æ¡ˆ TOP 10
                                                    </h3>
                                                    <div className="relative h-80">
                                                        <canvas ref={planChartRef}></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </>
                                    )}
                                    
                                    {data.length === 0 && (
                                        <div className="bg-gradient-to-br from-stone-800 to-slate-900 rounded-2xl p-12 border border-cyan-700/30 shadow-xl text-center">
                                            <div className="text-cyan-500/40 mb-4">
                                                <BarChart3 size={64} className="mx-auto" />
                                            </div>
                                            <p className="text-white font-bold text-lg mb-2">æš«ç„¡æ•¸æ“š</p>
                                            <p className="text-stone-200 text-sm font-medium">ç­‰å¾…è´ŠåŠ©ç´€éŒ„ç”¢ç”Ÿå¾Œå³å¯æŸ¥çœ‹åœ–è¡¨åˆ†æ</p>
                                        </div>
                                    )}
                                </div>
                            );
                        })()}
                        
                        {/* Events åˆ†é  */}
                        {/* æ´»å‹•æ”»ç•¥ç®¡ç†æ¨™ç±¤ */}
                        {currentTab === 'guides' && (
                            <GuideManagementTab />
                        )}

                        {currentTab === 'events' && (
                            <div className="space-y-8">
                                {/* é¦–é å…¬å‘Šæ©«å¹…ç®¡ç† */}
                                <div className="bg-gradient-to-br from-orange-950/30 to-stone-800 rounded-3xl p-6 border border-orange-700/30 shadow-xl">
                                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                        <Megaphone size={20} className="text-orange-400" />
                                        é¦–é å…¬å‘Šæ©«å¹…
                                        <span className="text-stone-400 text-sm font-normal ml-2">ï¼ˆé¡¯ç¤ºæ–¼é¦–é é ‚éƒ¨ï¼‰</span>
                                    </h3>

                                    {/* ç¾æœ‰å…¬å‘Šåˆ—è¡¨ */}
                                    {adminBanners.length > 0 && (
                                        <div className="space-y-2 mb-4">
                                            {adminBanners.map(banner => {
                                                const BIcon = BANNER_ICONS[banner.icon] || Megaphone;
                                                return (
                                                    <div key={banner.id} className={`rounded-xl p-3 border flex items-center justify-between gap-3 transition-colors ${banner.is_active ? 'bg-stone-800/80 border-orange-700/40' : 'bg-stone-800/40 border-stone-700 opacity-60'}`}>
                                                        <div className="flex items-center gap-3 flex-1 min-w-0">
                                                            <div className={`p-1.5 rounded-lg shrink-0 ${banner.is_active ? 'bg-orange-500/20 text-orange-400' : 'bg-stone-700 text-stone-500'}`}>
                                                                <BIcon size={16}/>
                                                            </div>
                                                            <div className="min-w-0 flex-1">
                                                                <div className="flex items-center gap-2 flex-wrap">
                                                                    {banner.badge && <span className={`text-xs font-bold px-1.5 py-0.5 rounded-full ${banner.is_active ? 'bg-fire-500 text-white' : 'bg-stone-600 text-stone-400'}`}>{banner.badge}</span>}
                                                                    <span className="font-bold text-white text-sm truncate">{banner.title}</span>
                                                                    {!banner.is_active && <span className="text-xs bg-stone-600 text-stone-400 px-1.5 py-0.5 rounded-full">å·²åœç”¨</span>}
                                                                </div>
                                                                {banner.subtitle && <p className="text-stone-500 text-xs truncate">{banner.subtitle}</p>}
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center gap-1.5 shrink-0">
                                                            <button onClick={() => handleToggleBannerActive(banner)} className={`p-1.5 rounded-lg transition-colors ${banner.is_active ? 'bg-green-600 hover:bg-green-500 text-white' : 'bg-stone-600 hover:bg-stone-500 text-stone-300'}`} title={banner.is_active ? 'åœç”¨' : 'å•Ÿç”¨'}>
                                                                {banner.is_active ? <Eye size={14}/> : <EyeOff size={14}/>}
                                                            </button>
                                                            <button onClick={() => startEditBanner(banner)} className="p-1.5 rounded-lg bg-orange-600/30 hover:bg-orange-600 text-orange-300 hover:text-white transition-colors" title="ç·¨è¼¯">
                                                                <Edit2 size={14}/>
                                                            </button>
                                                            <button onClick={() => handleDeleteBanner(banner.id)} className="p-1.5 rounded-lg bg-red-600/20 hover:bg-red-600 text-red-400 hover:text-white transition-colors" title="åˆªé™¤">
                                                                <Trash2 size={14}/>
                                                            </button>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                    {adminBanners.length === 0 && !editingBanner && (
                                        <p className="text-stone-500 text-sm mb-4">å°šç„¡å…¬å‘Šæ©«å¹…ï¼Œé¦–é ä¸æœƒé¡¯ç¤ºæ­¤å€å¡Šã€‚</p>
                                    )}

                                    {/* æ–°å¢/ç·¨è¼¯è¡¨å–® */}
                                    {editingBanner ? (
                                        <div className="bg-stone-900/60 rounded-2xl p-5 border border-orange-800/30">
                                            <p className="text-orange-300 font-bold text-sm mb-3">ç·¨è¼¯å…¬å‘Šæ©«å¹…</p>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                <input type="text" value={bannerForm.title} onChange={e => setBannerForm({...bannerForm, title: e.target.value})} className="bg-stone-800 border border-stone-600 rounded-xl px-3 py-2 text-sm text-white focus:border-orange-500 outline-none" placeholder="æ¨™é¡Œ *"/>
                                                <input type="text" value={bannerForm.subtitle} onChange={e => setBannerForm({...bannerForm, subtitle: e.target.value})} className="bg-stone-800 border border-stone-600 rounded-xl px-3 py-2 text-sm text-white focus:border-orange-500 outline-none" placeholder="å‰¯æ¨™é¡Œ"/>
                                                <input type="text" value={bannerForm.link} onChange={e => setBannerForm({...bannerForm, link: e.target.value})} className="bg-stone-800 border border-stone-600 rounded-xl px-3 py-2 text-sm text-white focus:border-orange-500 outline-none" placeholder="é€£çµ /events"/>
                                                <input type="text" value={bannerForm.badge} onChange={e => setBannerForm({...bannerForm, badge: e.target.value})} className="bg-stone-800 border border-stone-600 rounded-xl px-3 py-2 text-sm text-white focus:border-orange-500 outline-none" placeholder="å¾½ç«  NEW"/>
                                            </div>
                                            <div className="flex items-center gap-2 mt-3 flex-wrap">
                                                <span className="text-stone-400 text-xs">åœ–ç¤ºï¼š</span>
                                                {Object.entries(BANNER_ICONS).map(([key, Icon]) => (
                                                    <button key={key} onClick={() => setBannerForm({...bannerForm, icon: key})} className={`p-1.5 rounded-lg border transition-colors ${bannerForm.icon === key ? 'bg-orange-500 border-orange-400 text-white' : 'bg-stone-800 border-stone-600 text-stone-400 hover:text-orange-300'}`} title={key}>
                                                        <Icon size={14}/>
                                                    </button>
                                                ))}
                                                <span className="text-stone-400 text-xs ml-2">æ’åºï¼š</span>
                                                <input type="number" value={bannerForm.sort_order} onChange={e => setBannerForm({...bannerForm, sort_order: parseInt(e.target.value) || 0})} className="w-16 bg-stone-800 border border-stone-600 rounded-lg px-2 py-1 text-sm text-white focus:border-orange-500 outline-none"/>
                                                <label className="flex items-center gap-1.5 ml-2 cursor-pointer">
                                                    <input type="checkbox" checked={bannerForm.is_active} onChange={e => setBannerForm({...bannerForm, is_active: e.target.checked})} className="w-3.5 h-3.5 rounded accent-orange-500"/>
                                                    <span className="text-stone-300 text-xs">å•Ÿç”¨</span>
                                                </label>
                                            </div>
                                            {bannerForm.title && (
                                                <div className="mt-3 p-3 rounded-xl bg-gradient-to-r from-gold-50 via-amber-50 to-orange-50 border border-gold-200">
                                                    <p className="text-stone-500 text-xs font-bold mb-1">é è¦½ï¼š</p>
                                                    <div className="flex items-center gap-2">
                                                        <div className="bg-gold-500 text-white p-1.5 rounded-lg shrink-0">
                                                            {(() => { const IC = BANNER_ICONS[bannerForm.icon] || Megaphone; return <IC size={16}/>; })()}
                                                        </div>
                                                        <div>
                                                            <div className="flex items-center gap-1.5">
                                                                {bannerForm.badge && <span className="bg-fire-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full">{bannerForm.badge}</span>}
                                                                <span className="font-black text-stone-800 text-sm">{bannerForm.title}</span>
                                                            </div>
                                                            {bannerForm.subtitle && <p className="text-xs text-stone-600">{bannerForm.subtitle} â†’</p>}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                            <div className="flex gap-2 mt-3">
                                                <button onClick={handleSaveBanner} className="px-4 py-2 bg-orange-600 hover:bg-orange-500 text-white font-bold text-sm rounded-xl transition-colors flex items-center gap-1.5">
                                                    <Check size={14}/> æ›´æ–°
                                                </button>
                                                <button onClick={cancelEditBanner} className="px-4 py-2 bg-stone-700 hover:bg-stone-600 text-stone-300 font-bold text-sm rounded-xl transition-colors">
                                                    å–æ¶ˆ
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <details className="group">
                                            <summary className="cursor-pointer text-orange-400 hover:text-orange-300 text-sm font-bold flex items-center gap-1.5 select-none">
                                                <Plus size={14}/> æ–°å¢å…¬å‘Šæ©«å¹…
                                            </summary>
                                            <div className="mt-3 bg-stone-900/60 rounded-2xl p-5 border border-orange-800/30">
                                                {/* å¾ç¾æœ‰æ´»å‹•é¸æ“‡ */}
                                                <div className="mb-4">
                                                    <label className="block text-stone-400 text-xs font-bold mb-1.5">å¾ç¾æœ‰æ´»å‹•é¸æ“‡</label>
                                                    <select onChange={e => {
                                                        const ev = events.find(ev => ev.id === e.target.value);
                                                        if (ev) {
                                                            setBannerForm({...bannerForm, title: ev.title, subtitle: ev.tag ? `${ev.tag} æ´»å‹•é€²è¡Œä¸­ï¼Œé»æ“ŠæŸ¥çœ‹è©³æƒ…` : 'é»æ“ŠæŸ¥çœ‹æ´»å‹•è©³æƒ…', link: '/events'});
                                                        }
                                                        e.target.value = '';
                                                    }} className="w-full bg-stone-800 border border-stone-600 rounded-xl px-3 py-2 text-sm text-white focus:border-orange-500 outline-none cursor-pointer">
                                                        <option value="">-- é¸æ“‡æ´»å‹•è‡ªå‹•å¸¶å…¥æ¨™é¡Œ --</option>
                                                        {events.map(ev => (
                                                            <option key={ev.id} value={ev.id}>{ev.title}{ev.tag ? ` [${ev.tag}]` : ''}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div className="relative mb-3">
                                                    <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-stone-700"></div></div>
                                                    <div className="relative flex justify-center"><span className="bg-stone-900 px-2 text-stone-500 text-xs">æˆ–æ‰‹å‹•è¼¸å…¥</span></div>
                                                </div>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                    <input type="text" value={bannerForm.title} onChange={e => setBannerForm({...bannerForm, title: e.target.value})} className="bg-stone-800 border border-stone-600 rounded-xl px-3 py-2 text-sm text-white focus:border-orange-500 outline-none" placeholder="æ¨™é¡Œ *"/>
                                                    <input type="text" value={bannerForm.subtitle} onChange={e => setBannerForm({...bannerForm, subtitle: e.target.value})} className="bg-stone-800 border border-stone-600 rounded-xl px-3 py-2 text-sm text-white focus:border-orange-500 outline-none" placeholder="å‰¯æ¨™é¡Œ"/>
                                                    <input type="text" value={bannerForm.link} onChange={e => setBannerForm({...bannerForm, link: e.target.value})} className="bg-stone-800 border border-stone-600 rounded-xl px-3 py-2 text-sm text-white focus:border-orange-500 outline-none" placeholder="é€£çµè·¯å¾‘ /events"/>
                                                    <input type="text" value={bannerForm.badge} onChange={e => setBannerForm({...bannerForm, badge: e.target.value})} className="bg-stone-800 border border-stone-600 rounded-xl px-3 py-2 text-sm text-white focus:border-orange-500 outline-none" placeholder="å¾½ç« æ–‡å­— NEW"/>
                                                </div>
                                                <div className="flex items-center gap-2 mt-3 flex-wrap">
                                                    <span className="text-stone-400 text-xs">åœ–ç¤ºï¼š</span>
                                                    {Object.entries(BANNER_ICONS).map(([key, Icon]) => (
                                                        <button key={key} onClick={() => setBannerForm({...bannerForm, icon: key})} className={`p-1.5 rounded-lg border transition-colors ${bannerForm.icon === key ? 'bg-orange-500 border-orange-400 text-white' : 'bg-stone-800 border-stone-600 text-stone-400 hover:text-orange-300'}`} title={key}>
                                                            <Icon size={14}/>
                                                        </button>
                                                    ))}
                                                    <span className="text-stone-400 text-xs ml-2">æ’åºï¼š</span>
                                                    <input type="number" value={bannerForm.sort_order} onChange={e => setBannerForm({...bannerForm, sort_order: parseInt(e.target.value) || 0})} className="w-16 bg-stone-800 border border-stone-600 rounded-lg px-2 py-1 text-sm text-white focus:border-orange-500 outline-none"/>
                                                    <label className="flex items-center gap-1.5 ml-2 cursor-pointer">
                                                        <input type="checkbox" checked={bannerForm.is_active} onChange={e => setBannerForm({...bannerForm, is_active: e.target.checked})} className="w-3.5 h-3.5 rounded accent-orange-500"/>
                                                        <span className="text-stone-300 text-xs">å•Ÿç”¨</span>
                                                    </label>
                                                </div>
                                                {bannerForm.title && (
                                                    <div className="mt-3 p-3 rounded-xl bg-gradient-to-r from-gold-50 via-amber-50 to-orange-50 border border-gold-200">
                                                        <p className="text-stone-500 text-xs font-bold mb-1">é è¦½ï¼š</p>
                                                        <div className="flex items-center gap-2">
                                                            <div className="bg-gold-500 text-white p-1.5 rounded-lg shrink-0">
                                                                {(() => { const IC = BANNER_ICONS[bannerForm.icon] || Megaphone; return <IC size={16}/>; })()}
                                                            </div>
                                                            <div>
                                                                <div className="flex items-center gap-1.5">
                                                                    {bannerForm.badge && <span className="bg-fire-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full">{bannerForm.badge}</span>}
                                                                    <span className="font-black text-stone-800 text-sm">{bannerForm.title}</span>
                                                                </div>
                                                                {bannerForm.subtitle && <p className="text-xs text-stone-600">{bannerForm.subtitle} â†’</p>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                                <button onClick={handleSaveBanner} className="mt-3 px-4 py-2 bg-orange-600 hover:bg-orange-500 text-white font-bold text-sm rounded-xl transition-colors flex items-center gap-1.5">
                                                    <Plus size={14}/> æ–°å¢å…¬å‘Š
                                                </button>
                                            </div>
                                        </details>
                                    )}
                                </div>

                                <div className="bg-gradient-to-br from-sky-950/30 to-stone-800 rounded-3xl p-6 border border-sky-700/30 shadow-xl">
                                    <h3 className="text-lg font-bold text-white mb-6 flex items-center gap-2">
                                        {editingEventId ? <Edit2 size={20} className="text-sky-400"/> : <Plus size={20} className="text-rose-400"/>} 
                                        {editingEventId ? 'ç·¨è¼¯æ´»å‹•' : 'ç™¼å¸ƒæ–°æ´»å‹•'}
                                    </h3>
                                    <div className="space-y-4">
                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                            <div className="md:col-span-3">
                                                <input type="text" value={eventTitle} onChange={(e) => setEventTitle(e.target.value)} placeholder="æ´»å‹•æ¨™é¡Œ (å¯è¼¸å…¥ Emoji)" className="w-full bg-stone-900 border border-stone-600 rounded-xl px-4 py-3 text-white placeholder-stone-500 focus:border-water-500 outline-none text-base"/>
                                            </div>
                                            <div>
                                                <select value={eventTag} onChange={(e) => setEventTag(e.target.value)} className="w-full h-full bg-stone-900 border border-stone-600 rounded-xl px-4 text-white focus:border-water-500 outline-none text-base">
                                                    {EVENT_TAGS.map(tag => <option key={tag.id} value={tag.id}>{tag.label.replace(' ','')}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-stone-300 font-bold mb-1">å½ˆçª—åœ–ç‰‡æ¯”ä¾‹</label>
                                            <select value={eventPopupAspect} onChange={(e) => setEventPopupAspect(e.target.value)} className="w-full max-w-xs bg-stone-900 border border-stone-600 rounded-xl px-4 py-2.5 text-white focus:border-water-500 outline-none text-base">
                                                <option value="1:1">1:1 æ­£æ–¹</option>
                                                <option value="16:9">16:9 æ©«å¹…</option>
                                                <option value="9:16">9:16 ç›´å¹…</option>
                                            </select>
                                        </div>
                                        <div className="space-y-2">
                                            <div className="flex items-center justify-between flex-wrap gap-2">
                                                <label className="text-stone-300 font-bold">å…§å®¹ *</label>
                                                <label className="cursor-pointer">
                                                    <input type="file" accept=".docx,.pdf,.xlsx,.xls" onChange={handleEventFileUpload} className="hidden" />
                                                    <span className="inline-flex items-center gap-2 px-4 py-2 bg-stone-600 hover:bg-stone-500 text-white rounded-xl font-bold text-sm transition-colors">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                                        ä¸Šå‚³ Word / PDF / Excel
                                                    </span>
                                                </label>
                                            </div>
                                            <div className="event-editor-wrap rounded-xl overflow-hidden border border-stone-600">
                                                <style>{`.event-editor-wrap .ql-toolbar{background:#f5f5f4!important;border-color:#d6d3d1!important;}.event-editor-wrap .ql-container{background:#fff!important;border-color:#d6d3d1!important;}.event-editor-wrap .ql-editor{background:#fff!important;color:#1c1917!important;min-height:200px;caret-color:#1c1917!important;}.event-editor-wrap .ql-editor.ql-blank::before{color:#a8a29e!important;}`}</style>
                                                <div ref={eventQuillRef} />
                                            </div>
                                            <p className="text-stone-500 text-xs">å»ºè­°ç”¨ã€Œä¸Šå‚³ã€é¸æ“‡ .docxã€.pdfã€.xlsxã€.xlsï¼Œæˆ–å¾ Word è²¼ä¸Š</p>
                                        </div>
                                        <div className="flex justify-end gap-3">
                                            {editingEventId && <button onClick={() => { setEditingEventId(null); setEventTitle(''); setEventContent(''); setEventPopupAspect('1:1'); if (eventEditorRef.current?.root) eventEditorRef.current.root.innerHTML = '<p><br></p>'; }} className="px-6 py-2 rounded-xl text-stone-400 hover:text-white font-bold transition-colors">å–æ¶ˆ</button>}
                                            <button onClick={handleSaveEvent} className={`px-8 py-2.5 rounded-xl font-bold shadow-lg transition-transform active:scale-95 text-white ${editingEventId ? 'bg-water-600 hover:bg-water-500' : 'bg-fire-600 hover:bg-fire-500'}`}>
                                                {editingEventId ? 'å„²å­˜è®Šæ›´' : 'ç™¼å¸ƒæ´»å‹•'}
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    <div className="flex items-center justify-between flex-wrap gap-2">
                                        <h3 className="text-lg font-bold text-stone-100 px-2 uppercase tracking-wider">å·²ç™¼å¸ƒæ´»å‹• ({events.length})</h3>
                                        <div className="flex items-center gap-3 flex-wrap">
                                            {events.length > 0 && (
                                                <button onClick={handleCompressAllEvents} className="px-4 py-2 rounded-xl bg-stone-600 hover:bg-stone-500 text-white font-bold text-sm border border-stone-500 transition-colors flex items-center gap-2" title="å£“ç¸®æ‰€æœ‰æ´»å‹•ä¸­å·²ä¸Šå‚³çš„åœ–ç‰‡">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                                    å£“ç¸®ç¾æœ‰åœ–ç‰‡
                                                </button>
                                            )}
                                            <p className="text-stone-500 text-xs">â­ é»æ“Šæ˜Ÿæ˜Ÿè¨­ç‚ºï¼å–æ¶ˆä¸»æ‰“</p>
                                        </div>
                                    </div>
                                    {events.map((event) => {
                                        const tag = EVENT_TAGS.find(t => t.id === event.tag) || EVENT_TAGS[0];
                                        const contentPreview = (event.content || '').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
                                        return (
                                            <div key={event.id} className="bg-gradient-to-r from-slate-800/60 to-stone-800/80 p-6 rounded-2xl border border-sky-700/30 flex flex-col md:flex-row gap-6 relative group hover:border-sky-600/50 transition-colors">
                                                <div className="flex-1 space-y-2">
                                                    <div className="flex items-center gap-3 mb-2">
                                                        <span className={`text-xs px-2 py-0.5 rounded ${tag.color} bg-opacity-20 border border-current`}>{tag.label}</span>
                                                        <span className="text-stone-500 text-xs font-mono">{new Date(event.timestamp).toLocaleString()}</span>
                                                    </div>
                                                    <h4 className="text-xl font-bold text-white">{event.title}</h4>
                                                    <p className="text-stone-400 line-clamp-2 text-sm leading-relaxed">{(contentPreview.slice(0, 100) || '(ç„¡å…§å®¹)') + (contentPreview.length > 100 ? 'â€¦' : '')}</p>
                                                </div>
                                                <div className="flex md:flex-col gap-2 justify-end items-center">
                                                    <button
                                                        onClick={() => event.is_popup_featured ? handleCancelPopupFeatured(event.id) : handleSetPopupFeatured(event.id)}
                                                        className={`p-2 rounded-lg transition-colors ${event.is_popup_featured ? 'bg-gold-600 hover:bg-gold-500 text-white' : 'bg-stone-700 hover:bg-gold-600 text-stone-300 hover:text-white'}`}
                                                        title={event.is_popup_featured ? 'é»æ“Šå–æ¶ˆä¸»æ‰“' : 'é»æ“Šè¨­ç‚ºå½ˆçª—ä¸»æ‰“'}
                                                    >
                                                        <Star size={18} fill={event.is_popup_featured ? 'currentColor' : 'none'} strokeWidth={2} />
                                                    </button>
                                                    <button
                                                        onClick={() => handleToggleShowInPopup(event.id)}
                                                        className={`p-2 rounded-lg transition-colors ${event.show_in_popup !== false ? 'bg-water-600 hover:bg-water-500 text-white' : 'bg-stone-600 hover:bg-stone-500 text-stone-300'}`}
                                                        title={event.show_in_popup !== false ? 'é»æ“Šéš±è—æ–¼å½ˆçª—' : 'é»æ“Šé¡¯ç¤ºæ–¼å½ˆçª—'}
                                                    >
                                                        {event.show_in_popup !== false ? <Eye size={18} /> : <EyeOff size={18} />}
                                                    </button>
                                                    <button onClick={() => startEditingEvent(event)} className="bg-stone-700 hover:bg-water-600 text-white p-2 rounded-lg transition-colors"><Edit2 size={18}/></button>
                                                    <button onClick={() => handleDeleteEvent(event.id)} className="bg-stone-700 hover:bg-red-600 text-white p-2 rounded-lg transition-colors"><Trash2 size={18}/></button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* Music åˆ†é  */}
                        {currentTab === 'music' && (
                            <div className="space-y-8">
                                <div className="bg-stone-800 rounded-3xl p-6 border border-stone-700 shadow-xl">
                                    <h3 className="text-lg font-bold text-white mb-6 flex items-center gap-2"><Plus size={20} className="text-fire-500"/> æ–°å¢æ›²ç›®</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <input type="text" value={newTrackTitle} onChange={(e) => setNewTrackTitle(e.target.value)} placeholder="æ›²ç›®åç¨±" className="w-full bg-stone-900 border border-stone-600 rounded-xl px-4 py-3 text-white placeholder-stone-500 focus:border-fire-500 outline-none text-base"/>
                                        <input type="text" value={newTrackUrl} onChange={(e) => setNewTrackUrl(e.target.value)} placeholder="MP3 é€£çµ" className="w-full bg-stone-900 border border-stone-600 rounded-xl px-4 py-3 text-white placeholder-stone-500 focus:border-fire-500 outline-none text-base"/>
                                    </div>
                                    
                                    <div className="mt-2 flex items-center gap-2">
                                        <label className="bg-stone-700 hover:bg-stone-600 text-stone-300 text-sm px-4 py-2 rounded-xl cursor-pointer transition-colors flex items-center gap-2">
                                            <FolderOpen size={16}/>
                                            <span className="font-bold">é¸å–æª”æ¡ˆ</span>
                                            <input type="file" accept="audio/*" className="hidden" onChange={handleFileSelect} />
                                        </label>
                                        <span className="text-xs text-stone-500">æ”¯æ´ .mp3</span>
                                    </div>

                                    <div className="flex justify-end mt-4">
                                        <button onClick={handleAddMusic} className="bg-fire-600 hover:bg-fire-500 text-white px-8 py-2.5 rounded-xl font-bold shadow-lg transition-transform active:scale-95">æ–°å¢</button>
                                    </div>
                                </div>

                                <div className="bg-stone-800 rounded-3xl p-8 border border-stone-700 shadow-xl">
                                    <h3 className="text-lg font-bold text-white mb-4 uppercase tracking-wider">æ’­æ”¾æ¸…å–® ({playlist.length})</h3>
                                    <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                                        {playlist.map((track, idx) => (
                                            <div key={track.id} className="flex justify-between items-center bg-stone-900 p-4 rounded-xl border border-stone-700 hover:border-stone-600 transition-colors">
                                                <div className="flex items-center gap-4 overflow-hidden">
                                                    <div className="w-8 h-8 rounded-full bg-stone-700 flex items-center justify-center text-xs font-bold text-stone-400">{idx + 1}</div>
                                                    <span className="font-bold truncate text-base">{track.title}</span>
                                                </div>
                                                <button onClick={() => handleDeleteMusic(track.id)} className="text-stone-500 hover:text-red-500 p-2"><Trash2 size={18}/></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Settings åˆ†é  */}
                        {currentTab === 'settings' && (
                            <div className="max-w-2xl mx-auto">
                                <div className="bg-stone-800 rounded-3xl p-8 border border-stone-700 shadow-xl">
                                    <h3 className="text-lg font-bold text-white mb-6 flex items-center gap-3 border-b border-stone-700 pb-4">
                                        <Edit size={20} className="text-gold-500"/> ä¿®æ”¹æˆ‘çš„å¯†ç¢¼
                                    </h3>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-stone-400 text-sm font-bold mb-1">ç›®å‰å¯†ç¢¼</label>
                                            <input 
                                                type="password" 
                                                value={oldPassword} 
                                                onChange={e => setOldPassword(e.target.value)} 
                                                className="w-full bg-stone-900 border border-stone-600 rounded-xl px-4 py-2.5 text-white focus:border-gold-500 outline-none transition-colors"
                                                placeholder="è¼¸å…¥ç›®å‰å¯†ç¢¼"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-stone-400 text-sm font-bold mb-1">æ–°å¯†ç¢¼</label>
                                            <input 
                                                type="password" 
                                                value={newPassword} 
                                                onChange={e => setNewPassword(e.target.value)} 
                                                className="w-full bg-stone-900 border border-stone-600 rounded-xl px-4 py-2.5 text-white focus:border-gold-500 outline-none transition-colors"
                                                placeholder="è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘ 6 å€‹å­—å…ƒï¼‰"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-stone-400 text-sm font-bold mb-1">ç¢ºèªæ–°å¯†ç¢¼</label>
                                            <input 
                                                type="password" 
                                                value={confirmPassword} 
                                                onChange={e => setConfirmPassword(e.target.value)} 
                                                className="w-full bg-stone-900 border border-stone-600 rounded-xl px-4 py-2.5 text-white focus:border-gold-500 outline-none transition-colors"
                                                placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼"
                                            />
                                        </div>
                                        <button 
                                            onClick={handleChangePassword} 
                                            className="w-full bg-gold-600 hover:bg-gold-500 text-white font-bold py-3 rounded-xl transition-colors mt-4 flex items-center justify-center gap-2"
                                        >
                                            <Edit size={18} />
                                            ç¢ºèªä¿®æ”¹
                                        </button>
                                    </div>
                                    
                                    <div className="mt-6 pt-6 border-t border-stone-700">
                                        <p className="text-stone-400 text-sm mb-2">
                                            âš ï¸ <span className="font-bold">æ³¨æ„äº‹é …ï¼š</span>
                                        </p>
                                        <ul className="text-stone-500 text-xs space-y-1 list-disc list-inside">
                                            <li>æ–°å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ</li>
                                            <li>å»ºè­°ä½¿ç”¨å¤§å°å¯«å­—æ¯ã€æ•¸å­—å’Œç¬¦è™Ÿçš„çµ„åˆ</li>
                                            <li>ä¿®æ”¹å¯†ç¢¼å¾Œéœ€è¦é‡æ–°ç™»å…¥</li>
                                        </ul>
                                    </div>
                                    
                                    <div className="mt-6 p-4 bg-stone-900 rounded-xl border border-stone-700">
                                        <p className="text-stone-400 text-sm mb-2 flex items-center gap-2">
                                            <Shield size={16} className="text-gold-500" />
                                            <span className="font-bold">ç®¡ç†å“¡ç®¡ç†</span>
                                        </p>
                                        <p className="text-stone-500 text-xs">
                                            è‹¥éœ€è¦æ–°å¢æˆ–ç®¡ç†å…¶ä»–ç®¡ç†å“¡ï¼Œè«‹å‰å¾€ã€Œ<span className="text-purple-400 font-bold">è¶…ç®¡</span>ã€åˆ†é ï¼ˆåƒ…è¶…ç´šç®¡ç†å“¡å¯è¦‹ï¼‰
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* è¨»å†Šç”¨æˆ¶ç®¡ç†åˆ†é ï¼ˆåƒ…è¶…ç´šç®¡ç†å“¡å¯è¦‹ï¼‰ */}
                        {currentTab === 'registered_users' && isSuperAdmin && (
                            <div className="space-y-6">
                                {/* æ¨™é¡Œèˆ‡çµ±è¨ˆ */}
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h2 className="text-2xl font-black text-white mb-2">è¨»å†Šç”¨æˆ¶åˆ—è¡¨</h2>
                                        <p className="text-stone-400">å…± {allUsers.length} ä½è¨»å†Šç”¨æˆ¶ Â· å®¢äººè³‡æºå®Œæ•´å‘ˆé¡¯ï¼Œç´¯è¨ˆå„²å€¼/é‡‘å¹£ç”±è´ŠåŠ©ç´€éŒ„è‡ªå‹•åŒæ­¥</p>
                                    </div>
                                </div>
                                <div className="bg-water-900/30 border border-water-700/50 rounded-xl px-4 py-3 mb-4">
                                    <p className="text-water-200 text-sm font-bold">ğŸ’¡ è¨»å†Šç”¨æˆ¶çš„ç´¯è¨ˆå„²å€¼ã€ç´¯è¨ˆé‡‘å¹£ç”±ã€Œè´ŠåŠ©ç®¡ç†ã€çš„è¨‚å–®è‡ªå‹•è¨ˆç®—ä¸¦åŒæ­¥ã€‚ç®¡ç†å“¡åœ¨è´ŠåŠ©ç®¡ç†ç·¨è¼¯ä»»ä¸€è¨‚å–®å¾Œï¼Œæ­¤è™•æ•¸æ“šæœƒè‡ªå‹•æ›´æ–°ã€‚</p>
                                </div>
                                
                                {/* çµ±è¨ˆå¡ç‰‡ */}
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 md:gap-4">
                                    <div className="bg-gradient-to-br from-blue-900/40 to-blue-800/20 border border-blue-700/30 rounded-2xl p-3 md:p-4">
                                        <div className="flex items-center gap-2 md:gap-3">
                                            <div className="w-10 h-10 md:w-12 md:h-12 rounded-xl bg-blue-500/20 flex items-center justify-center flex-shrink-0">
                                                <Users className="text-blue-400" size={20} />
                                            </div>
                                            <div className="min-w-0">
                                                <p className="text-stone-400 text-xs md:text-sm truncate">ç¸½ç”¨æˆ¶æ•¸</p>
                                                <p className="text-white text-xl md:text-2xl font-black">{allUsers.length}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-gradient-to-br from-purple-900/40 to-purple-800/20 border border-purple-700/30 rounded-2xl p-3 md:p-4">
                                        <div className="flex items-center gap-2 md:gap-3">
                                            <div className="w-10 h-10 md:w-12 md:h-12 rounded-xl bg-purple-500/20 flex items-center justify-center flex-shrink-0">
                                                <Crown className="text-purple-400" size={20} />
                                            </div>
                                            <div className="min-w-0">
                                                <p className="text-stone-400 text-xs md:text-sm truncate">è¶…ç®¡</p>
                                                <p className="text-white text-xl md:text-2xl font-black">{allUsers.filter(u => u.role === 'super_admin').length}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-gradient-to-br from-gold-900/40 to-gold-800/20 border border-gold-700/30 rounded-2xl p-3 md:p-4">
                                        <div className="flex items-center gap-2 md:gap-3">
                                            <div className="w-10 h-10 md:w-12 md:h-12 rounded-xl bg-gold-500/20 flex items-center justify-center flex-shrink-0">
                                                <Shield className="text-gold-400" size={20} />
                                            </div>
                                            <div className="min-w-0">
                                                <p className="text-stone-400 text-xs md:text-sm truncate">ç®¡ç†å“¡</p>
                                                <p className="text-white text-xl md:text-2xl font-black">{allUsers.filter(u => u.role === 'admin').length}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-gradient-to-br from-green-900/40 to-green-800/20 border border-green-700/30 rounded-2xl p-3 md:p-4">
                                        <div className="flex items-center gap-2 md:gap-3">
                                            <div className="w-10 h-10 md:w-12 md:h-12 rounded-xl bg-green-500/20 flex items-center justify-center flex-shrink-0">
                                                <User className="text-green-400" size={20} />
                                            </div>
                                            <div className="min-w-0">
                                                <p className="text-stone-400 text-xs md:text-sm truncate">ç©å®¶</p>
                                                <p className="text-white text-xl md:text-2xl font-black">{allUsers.filter(u => !u.role || (u.role !== 'admin' && u.role !== 'super_admin')).length}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="col-span-2 md:col-span-3 lg:col-span-1 bg-gradient-to-br from-orange-900/40 to-orange-800/20 border border-orange-700/30 rounded-2xl p-3 md:p-4">
                                        <div className="flex items-center gap-2 md:gap-3">
                                            <div className="w-10 h-10 md:w-12 md:h-12 rounded-xl bg-orange-500/20 flex items-center justify-center flex-shrink-0">
                                                <Coins className="text-orange-400" size={20} />
                                            </div>
                                            <div className="min-w-0 flex-1">
                                                <p className="text-stone-400 text-xs md:text-sm">ç´¯è¨ˆå„²å€¼</p>
                                                <p className="text-white text-lg md:text-xl font-black truncate">{allUsers.reduce((sum, u) => sum + (u.total_amount || 0), 0).toLocaleString()} å…ƒ</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* ç”¨æˆ¶åˆ—è¡¨ */}
                                {allUsers.length === 0 ? (
                                    <div className="text-center py-12 bg-stone-800/50 rounded-2xl border border-stone-700">
                                        <Users size={48} className="mx-auto text-stone-600 mb-4" />
                                        <p className="text-stone-400">å°šç„¡è¨»å†Šç”¨æˆ¶</p>
                                    </div>
                                ) : (
                                    <>
                                        {/* æ¡Œé¢ç‰ˆï¼šè¡¨æ ¼ */}
                                        <div className="hidden lg:block bg-stone-800/50 rounded-2xl border border-stone-700 overflow-hidden">
                                            <div className="overflow-x-auto">
                                                <table className="w-full">
                                                <thead className="bg-stone-900/50">
                                                    <tr className="border-b border-stone-700">
                                                        <th className="text-left px-6 py-4 text-stone-400 font-bold text-sm">Email</th>
                                                        <th className="text-left px-6 py-4 text-stone-400 font-bold text-sm">è§’è‰²</th>
                                                        <th className="text-right px-6 py-4 text-stone-400 font-bold text-sm">ç´¯è¨ˆå„²å€¼</th>
                                                        <th className="text-left px-6 py-4 text-stone-400 font-bold text-sm">è¨»å†Šæ™‚é–“</th>
                                                        <th className="text-left px-6 py-4 text-stone-400 font-bold text-sm">ç”¨æˆ¶ ID</th>
                                                        <th className="text-center px-6 py-4 text-stone-400 font-bold text-sm">æ“ä½œ</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {allUsers.map((user, idx) => (
                                                        <tr key={user.id} className={`border-b border-stone-700/50 hover:bg-stone-700/30 transition-colors ${idx % 2 === 0 ? 'bg-stone-900/20' : ''}`}>
                                                            <td className="px-6 py-4">
                                                                <div className="flex items-center gap-3">
                                                                    <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-black text-sm">
                                                                        {(user.email || '?')[0].toUpperCase()}
                                                                    </div>
                                                                    <span className="text-white font-medium">{user.email}</span>
                                                                </div>
                                                            </td>
                                                            <td className="px-6 py-4">
                                                                {user.role === 'super_admin' ? (
                                                                    <span className="inline-block px-3 py-1 text-xs font-bold rounded-full bg-purple-500/20 text-purple-400 border border-purple-500/30">
                                                                        è¶…ç´šç®¡ç†å“¡
                                                                    </span>
                                                                ) : user.role === 'admin' ? (
                                                                    <span className="inline-block px-3 py-1 text-xs font-bold rounded-full bg-gold-500/20 text-gold-400 border border-gold-500/30">
                                                                        ç®¡ç†å“¡
                                                                    </span>
                                                                ) : (
                                                                    <span className="inline-block px-3 py-1 text-xs font-bold rounded-full bg-stone-700 text-stone-400">
                                                                        ä¸€èˆ¬ç©å®¶
                                                                    </span>
                                                                )}
                                                            </td>
                                                            <td className="px-6 py-4 text-right">
                                                                <div className="flex flex-col items-end gap-1">
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="text-gold-400 font-black text-lg">
                                                                            {user.total_amount?.toLocaleString() || '0'}
                                                                        </span>
                                                                        <span className="text-stone-400 text-xs">å…ƒ</span>
                                                                    </div>
                                                                    <div className="flex items-center gap-1">
                                                                        <Coins size={14} className="text-gold-500" />
                                                                        <span className="text-gold-500 font-bold text-sm">
                                                                            {user.total_coins?.toLocaleString() || '0'}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td className="px-6 py-4 text-stone-300 text-sm">
                                                                {new Date(user.created_at).toLocaleString('zh-TW', {
                                                                    year: 'numeric',
                                                                    month: '2-digit',
                                                                    day: '2-digit',
                                                                    hour: '2-digit',
                                                                    minute: '2-digit'
                                                                })}
                                                            </td>
                                                            <td className="px-6 py-4">
                                                                <code className="text-xs text-stone-400 bg-stone-900 px-2 py-1 rounded font-mono">
                                                                    {user.id.split('-')[0]}...
                                                                </code>
                                                            </td>
                                                            <td className="px-6 py-4">
                                                                <div className="flex items-center justify-center gap-2 flex-wrap">
                                                                    <button
                                                                        onClick={() => { setCurrentTab('donations'); setSearchTerm(user.email || ''); showToast(`å·²ç¯©é¸ï¼š${user.email} çš„è´ŠåŠ©ç´€éŒ„`, 'success'); }}
                                                                        className="px-3 py-1.5 bg-water-600/20 hover:bg-water-600/30 text-water-400 text-xs font-bold rounded-lg transition-colors border border-water-500/30"
                                                                        title="æŸ¥çœ‹è©²ç”¨æˆ¶çš„è´ŠåŠ©ç´€éŒ„"
                                                                    >
                                                                        æŸ¥çœ‹è´ŠåŠ©
                                                                    </button>
                                                                    {user.id === supabaseUser?.id ? (
                                                                        <span className="text-stone-500 text-xs">ï¼ˆæœ¬äººï¼‰</span>
                                                                    ) : user.role === 'super_admin' ? (
                                                                        <button
                                                                            onClick={async () => {
                                                                                showConfirm(
                                                                                    'ç§»é™¤è¶…ç®¡æ¬Šé™',
                                                                                    `ç¢ºå®šè¦å°‡ã€Œ${user.email}ã€æ”¹ç‚ºä¸€èˆ¬ç®¡ç†å“¡å—ï¼Ÿ`,
                                                                                    async () => {
                                                                                        try {
                                                                                            const { error } = await supabase.rpc('update_user_role', {
                                                                                                target_user_id: user.id,
                                                                                                new_role: 'admin'
                                                                                            });
                                                                                            if (error) throw error;
                                                                                            showToast('å·²é™ç´šç‚ºç®¡ç†å“¡', 'success');
                                                                                            // é‡æ–°è¼‰å…¥åˆ—è¡¨
                                                                                            const { data } = await supabase.rpc('get_all_users');
                                                                                            setAllUsers(data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)));
                                                                                            hideConfirm();
                                                                                        } catch (err) {
                                                                                            console.error('æ›´æ–°å¤±æ•—:', err);
                                                                                            showToast('æ›´æ–°å¤±æ•—', 'error');
                                                                                        }
                                                                                    }
                                                                                );
                                                                            }}
                                                                            className="px-3 py-1.5 bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 text-xs font-bold rounded-lg transition-colors border border-purple-500/30"
                                                                        >
                                                                            é™ç‚ºç®¡ç†å“¡
                                                                        </button>
                                                                    ) : user.role === 'admin' ? (
                                                                        <>
                                                                            <button
                                                                                onClick={async () => {
                                                                                    showConfirm(
                                                                                        'å‡ç´šç‚ºè¶…ç®¡',
                                                                                        `ç¢ºå®šè¦å°‡ã€Œ${user.email}ã€å‡ç´šç‚ºè¶…ç´šç®¡ç†å“¡å—ï¼Ÿ`,
                                                                                        async () => {
                                                                                            try {
                                                                                                const { error } = await supabase.rpc('update_user_role', {
                                                                                                    target_user_id: user.id,
                                                                                                    new_role: 'super_admin'
                                                                                                });
                                                                                                if (error) throw error;
                                                                                                showToast('å·²å‡ç´šç‚ºè¶…ç®¡', 'success');
                                                                                                // é‡æ–°è¼‰å…¥åˆ—è¡¨
                                                                                                const { data } = await supabase.rpc('get_all_users');
                                                                                                setAllUsers(data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)));
                                                                                                hideConfirm();
                                                                                            } catch (err) {
                                                                                                console.error('æ›´æ–°å¤±æ•—:', err);
                                                                                                showToast('æ›´æ–°å¤±æ•—', 'error');
                                                                                            }
                                                                                        }
                                                                                    );
                                                                                }}
                                                                                className="px-3 py-1.5 bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 text-xs font-bold rounded-lg transition-colors border border-purple-500/30"
                                                                            >
                                                                                å‡ç‚ºè¶…ç®¡
                                                                            </button>
                                                                            <button
                                                                                onClick={async () => {
                                                                                    showConfirm(
                                                                                        'ç§»é™¤ç®¡ç†å“¡æ¬Šé™',
                                                                                        `ç¢ºå®šè¦å°‡ã€Œ${user.email}ã€æ”¹ç‚ºä¸€èˆ¬ç©å®¶å—ï¼Ÿ`,
                                                                                        async () => {
                                                                                            try {
                                                                                                const { error } = await supabase.rpc('update_user_role', {
                                                                                                    target_user_id: user.id,
                                                                                                    new_role: null
                                                                                                });
                                                                                                if (error) throw error;
                                                                                                showToast('å·²æ”¹ç‚ºä¸€èˆ¬ç©å®¶', 'success');
                                                                                                // é‡æ–°è¼‰å…¥åˆ—è¡¨
                                                                                                const { data } = await supabase.rpc('get_all_users');
                                                                                                setAllUsers(data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)));
                                                                                                hideConfirm();
                                                                                            } catch (err) {
                                                                                                console.error('æ›´æ–°å¤±æ•—:', err);
                                                                                                showToast('æ›´æ–°å¤±æ•—', 'error');
                                                                                            }
                                                                                        }
                                                                                    );
                                                                                }}
                                                                                className="px-3 py-1.5 bg-stone-700 hover:bg-stone-600 text-stone-300 text-xs font-bold rounded-lg transition-colors"
                                                                            >
                                                                                ç§»é™¤æ¬Šé™
                                                                            </button>
                                                                        </>
                                                                    ) : (
                                                                        <>
                                                                            <button
                                                                                onClick={async () => {
                                                                                    showConfirm(
                                                                                        'è¨­ç‚ºç®¡ç†å“¡',
                                                                                        `ç¢ºå®šè¦å°‡ã€Œ${user.email}ã€è¨­ç‚ºç®¡ç†å“¡å—ï¼Ÿ`,
                                                                                        async () => {
                                                                                            try {
                                                                                                const { error } = await supabase.rpc('update_user_role', {
                                                                                                    target_user_id: user.id,
                                                                                                    new_role: 'admin'
                                                                                                });
                                                                                                if (error) throw error;
                                                                                                showToast('å·²è¨­ç‚ºç®¡ç†å“¡', 'success');
                                                                                                await logAction('create', 'admin', user.id, `è¨­å®š ${user.email} ç‚ºç®¡ç†å“¡`);
                                                                                                // é‡æ–°è¼‰å…¥åˆ—è¡¨
                                                                                                const { data } = await supabase.rpc('get_all_users');
                                                                                                setAllUsers(data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)));
                                                                                                hideConfirm();
                                                                                            } catch (err) {
                                                                                                console.error('æ›´æ–°å¤±æ•—:', err);
                                                                                                showToast('æ›´æ–°å¤±æ•—', 'error');
                                                                                            }
                                                                                        }
                                                                                    );
                                                                                }}
                                                                                className="px-3 py-1.5 bg-gold-600/20 hover:bg-gold-600/30 text-gold-400 text-xs font-bold rounded-lg transition-colors border border-gold-500/30"
                                                                            >
                                                                                è¨­ç‚ºç®¡ç†å“¡
                                                                            </button>
                                                                            <button
                                                                                onClick={async () => {
                                                                                    showConfirm(
                                                                                        'è¨­ç‚ºè¶…ç®¡',
                                                                                        `ç¢ºå®šè¦å°‡ã€Œ${user.email}ã€è¨­ç‚ºè¶…ç´šç®¡ç†å“¡å—ï¼Ÿ`,
                                                                                        async () => {
                                                                                            try {
                                                                                                const { error } = await supabase.rpc('update_user_role', {
                                                                                                    target_user_id: user.id,
                                                                                                    new_role: 'super_admin'
                                                                                                });
                                                                                                if (error) throw error;
                                                                                                showToast('å·²è¨­ç‚ºè¶…ç®¡', 'success');
                                                                                                await logAction('create', 'admin', user.id, `è¨­å®š ${user.email} ç‚ºè¶…ç´šç®¡ç†å“¡`);
                                                                                                // é‡æ–°è¼‰å…¥åˆ—è¡¨
                                                                                                const { data } = await supabase.rpc('get_all_users');
                                                                                                setAllUsers(data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)));
                                                                                                hideConfirm();
                                                                                            } catch (err) {
                                                                                                console.error('æ›´æ–°å¤±æ•—:', err);
                                                                                                showToast('æ›´æ–°å¤±æ•—', 'error');
                                                                                            }
                                                                                        }
                                                                                    );
                                                                                }}
                                                                                className="px-3 py-1.5 bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 text-xs font-bold rounded-lg transition-colors border border-purple-500/30"
                                                                            >
                                                                                è¨­ç‚ºè¶…ç®¡
                                                                            </button>
                                                                        </>
                                                                    )}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    {/* æ‰‹æ©Ÿç‰ˆï¼šå¡ç‰‡åˆ—è¡¨ */}
                                    <div className="lg:hidden space-y-4">
                                        {allUsers.map((user, idx) => (
                                            <div key={user.id} className="bg-stone-800 rounded-2xl p-5 border border-stone-700">
                                                {/* Email å’Œé ­åƒ */}
                                                <div className="flex items-start justify-between mb-4">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-black text-base flex-shrink-0">
                                                            {(user.email || '?')[0].toUpperCase()}
                                                        </div>
                                                        <div className="min-w-0">
                                                            <p className="text-white font-bold text-sm break-all">{user.email}</p>
                                                            <p className="text-stone-400 text-xs mt-1">
                                                                {new Date(user.created_at).toLocaleDateString('zh-TW', {
                                                                    year: 'numeric',
                                                                    month: '2-digit',
                                                                    day: '2-digit'
                                                                })}
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* è§’è‰²æ¨™ç±¤ */}
                                                <div className="mb-4">
                                                    {user.role === 'super_admin' ? (
                                                        <span className="inline-block px-3 py-1.5 text-xs font-bold rounded-full bg-purple-500/20 text-purple-400 border border-purple-500/30">
                                                            ğŸŸ£ è¶…ç´šç®¡ç†å“¡
                                                        </span>
                                                    ) : user.role === 'admin' ? (
                                                        <span className="inline-block px-3 py-1.5 text-xs font-bold rounded-full bg-gold-500/20 text-gold-400 border border-gold-500/30">
                                                            ğŸŸ¡ ç®¡ç†å“¡
                                                        </span>
                                                    ) : (
                                                        <span className="inline-block px-3 py-1.5 text-xs font-bold rounded-full bg-stone-700 text-stone-400">
                                                            âšª ä¸€èˆ¬ç©å®¶
                                                        </span>
                                                    )}
                                                </div>
                                                
                                                {/* ç´¯è¨ˆå„²å€¼ */}
                                                <div className="bg-stone-900/50 rounded-xl p-4 mb-4">
                                                    <p className="text-stone-400 text-xs mb-2">ç´¯è¨ˆå„²å€¼</p>
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-gold-400 font-black text-2xl">
                                                                {user.total_amount?.toLocaleString() || '0'}
                                                            </span>
                                                            <span className="text-stone-400 text-sm">å…ƒ</span>
                                                        </div>
                                                        <div className="flex items-center gap-2 bg-gold-500/10 px-3 py-1.5 rounded-lg">
                                                            <Coins size={16} className="text-gold-500" />
                                                            <span className="text-gold-500 font-bold text-base">
                                                                {user.total_coins?.toLocaleString() || '0'}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* æ“ä½œæŒ‰éˆ• */}
                                                <div className="space-y-2">
                                                    <button
                                                        onClick={() => { setCurrentTab('donations'); setSearchTerm(user.email || ''); showToast(`å·²ç¯©é¸ï¼š${user.email} çš„è´ŠåŠ©ç´€éŒ„`, 'success'); }}
                                                        className="w-full px-4 py-3 bg-water-600/20 hover:bg-water-600/30 text-water-400 text-sm font-bold rounded-xl transition-colors border border-water-500/30 flex items-center justify-center gap-2"
                                                    >
                                                        <Coins size={16} />
                                                        æŸ¥çœ‹è©²ç”¨æˆ¶è´ŠåŠ©
                                                    </button>
                                                    {user.id === supabaseUser?.id ? (
                                                        <div className="text-center py-2 text-stone-500 text-sm">ï¼ˆæœ¬äººå¸³è™Ÿï¼‰</div>
                                                    ) : user.role === 'super_admin' ? (
                                                        <button
                                                            onClick={async () => {
                                                                showConfirm(
                                                                    'ç§»é™¤è¶…ç®¡æ¬Šé™',
                                                                    `ç¢ºå®šè¦å°‡ã€Œ${user.email}ã€æ”¹ç‚ºä¸€èˆ¬ç®¡ç†å“¡å—ï¼Ÿ`,
                                                                    async () => {
                                                                        try {
                                                                            const { error } = await supabase.rpc('update_user_role', {
                                                                                target_user_id: user.id,
                                                                                new_role: 'admin'
                                                                            });
                                                                            if (error) throw error;
                                                                            showToast('å·²é™ç´šç‚ºç®¡ç†å“¡', 'success');
                                                                            const { data } = await supabase.rpc('get_all_users');
                                                                            setAllUsers(data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)));
                                                                            hideConfirm();
                                                                        } catch (err) {
                                                                            console.error('æ›´æ–°å¤±æ•—:', err);
                                                                            showToast('æ›´æ–°å¤±æ•—', 'error');
                                                                        }
                                                                    }
                                                                );
                                                            }}
                                                            className="w-full px-4 py-3 bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 text-sm font-bold rounded-xl transition-colors border border-purple-500/30"
                                                        >
                                                            é™ç‚ºç®¡ç†å“¡
                                                        </button>
                                                    ) : user.role === 'admin' ? (
                                                        <div className="grid grid-cols-2 gap-2">
                                                            <button
                                                                onClick={async () => {
                                                                    showConfirm(
                                                                        'å‡ç´šç‚ºè¶…ç®¡',
                                                                        `ç¢ºå®šè¦å°‡ã€Œ${user.email}ã€å‡ç´šç‚ºè¶…ç´šç®¡ç†å“¡å—ï¼Ÿ`,
                                                                        async () => {
                                                                            try {
                                                                                const { error } = await supabase.rpc('update_user_role', {
                                                                                    target_user_id: user.id,
                                                                                    new_role: 'super_admin'
                                                                                });
                                                                                if (error) throw error;
                                                                                showToast('å·²å‡ç´šç‚ºè¶…ç®¡', 'success');
                                                                                const { data } = await supabase.rpc('get_all_users');
                                                                                setAllUsers(data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)));
                                                                                hideConfirm();
                                                                            } catch (err) {
                                                                                console.error('æ›´æ–°å¤±æ•—:', err);
                                                                                showToast('æ›´æ–°å¤±æ•—', 'error');
                                                                            }
                                                                        }
                                                                    );
                                                                }}
                                                                className="px-4 py-3 bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 text-sm font-bold rounded-xl transition-colors border border-purple-500/30"
                                                            >
                                                                å‡ç‚ºè¶…ç®¡
                                                            </button>
                                                            <button
                                                                onClick={async () => {
                                                                    showConfirm(
                                                                        'ç§»é™¤ç®¡ç†å“¡æ¬Šé™',
                                                                        `ç¢ºå®šè¦å°‡ã€Œ${user.email}ã€æ”¹ç‚ºä¸€èˆ¬ç©å®¶å—ï¼Ÿ`,
                                                                        async () => {
                                                                            try {
                                                                                const { error } = await supabase.rpc('update_user_role', {
                                                                                    target_user_id: user.id,
                                                                                    new_role: null
                                                                                });
                                                                                if (error) throw error;
                                                                                showToast('å·²æ”¹ç‚ºä¸€èˆ¬ç©å®¶', 'success');
                                                                                const { data } = await supabase.rpc('get_all_users');
                                                                                setAllUsers(data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)));
                                                                                hideConfirm();
                                                                            } catch (err) {
                                                                                console.error('æ›´æ–°å¤±æ•—:', err);
                                                                                showToast('æ›´æ–°å¤±æ•—', 'error');
                                                                            }
                                                                        }
                                                                    );
                                                                }}
                                                                className="px-4 py-3 bg-stone-700 hover:bg-stone-600 text-stone-300 text-sm font-bold rounded-xl transition-colors"
                                                            >
                                                                ç§»é™¤æ¬Šé™
                                                            </button>
                                                        </div>
                                                    ) : (
                                                        <div className="grid grid-cols-2 gap-2">
                                                            <button
                                                                onClick={async () => {
                                                                    showConfirm(
                                                                        'è¨­ç‚ºç®¡ç†å“¡',
                                                                        `ç¢ºå®šè¦å°‡ã€Œ${user.email}ã€è¨­ç‚ºç®¡ç†å“¡å—ï¼Ÿ`,
                                                                        async () => {
                                                                            try {
                                                                                const { error } = await supabase.rpc('update_user_role', {
                                                                                    target_user_id: user.id,
                                                                                    new_role: 'admin'
                                                                                });
                                                                                if (error) throw error;
                                                                                showToast('å·²è¨­ç‚ºç®¡ç†å“¡', 'success');
                                                                                await logAction('create', 'admin', user.id, `è¨­å®š ${user.email} ç‚ºç®¡ç†å“¡`);
                                                                                const { data } = await supabase.rpc('get_all_users');
                                                                                setAllUsers(data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)));
                                                                                hideConfirm();
                                                                            } catch (err) {
                                                                                console.error('æ›´æ–°å¤±æ•—:', err);
                                                                                showToast('æ›´æ–°å¤±æ•—', 'error');
                                                                            }
                                                                        }
                                                                    );
                                                                }}
                                                                className="px-4 py-3 bg-gold-600/20 hover:bg-gold-600/30 text-gold-400 text-sm font-bold rounded-xl transition-colors border border-gold-500/30"
                                                            >
                                                                è¨­ç‚ºç®¡ç†å“¡
                                                            </button>
                                                            <button
                                                                onClick={async () => {
                                                                    showConfirm(
                                                                        'è¨­ç‚ºè¶…ç®¡',
                                                                        `ç¢ºå®šè¦å°‡ã€Œ${user.email}ã€è¨­ç‚ºè¶…ç´šç®¡ç†å“¡å—ï¼Ÿ`,
                                                                        async () => {
                                                                            try {
                                                                                const { error } = await supabase.rpc('update_user_role', {
                                                                                    target_user_id: user.id,
                                                                                    new_role: 'super_admin'
                                                                                });
                                                                                if (error) throw error;
                                                                                showToast('å·²è¨­ç‚ºè¶…ç®¡', 'success');
                                                                                await logAction('create', 'admin', user.id, `è¨­å®š ${user.email} ç‚ºè¶…ç´šç®¡ç†å“¡`);
                                                                                const { data } = await supabase.rpc('get_all_users');
                                                                                setAllUsers(data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)));
                                                                                hideConfirm();
                                                                            } catch (err) {
                                                                                console.error('æ›´æ–°å¤±æ•—:', err);
                                                                                showToast('æ›´æ–°å¤±æ•—', 'error');
                                                                            }
                                                                        }
                                                                    );
                                                                }}
                                                                className="px-4 py-3 bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 text-sm font-bold rounded-xl transition-colors border border-purple-500/30"
                                                            >
                                                                è¨­ç‚ºè¶…ç®¡
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    </>
                                )}
                            </div>
                        )}
                        
                        {/* è¶…ç´šç®¡ç†å“¡ç®¡ç†åˆ†é ï¼ˆåƒ…è¶…ç´šç®¡ç†å“¡å¯è¦‹ï¼‰ */}
                        {currentTab === 'super_admins' && isSuperAdmin && (
                            <div className="space-y-6">
                                {/* æ¨™é¡Œèˆ‡æ–°å¢æŒ‰éˆ• */}
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h2 className="text-2xl font-black text-white mb-2">ç®¡ç†å“¡åˆ—è¡¨</h2>
                                        <p className="text-stone-400">ç®¡ç†æ‰€æœ‰ç³»çµ±ç®¡ç†å“¡å¸³è™Ÿ</p>
                                    </div>
                                    <button
                                        onClick={() => setShowAddAdminModal(true)}
                                        className="px-5 py-3 bg-fire-600 hover:bg-fire-500 text-white font-bold rounded-xl transition-colors flex items-center gap-2 shadow-lg"
                                    >
                                        <UserPlus size={20} />
                                        æ–°å¢ç®¡ç†å“¡
                                    </button>
                                </div>
                                
                                {/* ç®¡ç†å“¡å¡ç‰‡åˆ—è¡¨ */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {adminUsers.map(admin => (
                                        <div key={admin.id} className="bg-stone-800 rounded-2xl p-6 border border-stone-700 hover:border-stone-600 transition-colors">
                                            <div className="flex items-start justify-between mb-4">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-12 h-12 rounded-full bg-gradient-to-br from-gold-500 to-gold-600 flex items-center justify-center text-white font-black text-lg">
                                                        {(admin.email || '?')[0].toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <p className="text-white font-bold">{admin.email}</p>
                                                        <span className={`inline-block px-2 py-0.5 text-xs font-bold rounded mt-1 ${
                                                            admin.role === 'super_admin' 
                                                                ? 'bg-gold-500/20 text-gold-400 border border-gold-500/30' 
                                                                : 'bg-stone-700 text-stone-400'
                                                        }`}>
                                                            {admin.role === 'super_admin' ? 'è¶…ç´šç®¡ç†å“¡' : 'ç®¡ç†å“¡'}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div className="text-sm text-stone-400 space-y-1 mb-4">
                                                <p>è¨»å†Šæ™‚é–“ï¼š{new Date(admin.created_at).toLocaleDateString('zh-TW')}</p>
                                                <p>æœ€å¾Œç™»å…¥ï¼š{admin.last_sign_in_at ? new Date(admin.last_sign_in_at).toLocaleDateString('zh-TW') : 'ç„¡ç´€éŒ„'}</p>
                                            </div>
                                            
                                            {admin.id !== supabaseUser?.id && (
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => startEditAdmin(admin)}
                                                        className="flex-1 px-3 py-2 bg-stone-700 hover:bg-water-600 text-white font-bold rounded-lg transition-colors flex items-center justify-center gap-2"
                                                    >
                                                        <Edit2 size={14} />
                                                        ç·¨è¼¯
                                                    </button>
                                                    <button
                                                        onClick={() => handleRemoveAdmin(admin)}
                                                        className="flex-1 px-3 py-2 bg-stone-700 hover:bg-red-600 text-white font-bold rounded-lg transition-colors flex items-center justify-center gap-2"
                                                    >
                                                        <Trash2 size={14} />
                                                        ç§»é™¤
                                                    </button>
                                                </div>
                                            )}
                                            
                                            {admin.id === user.id && (
                                                <div className="text-center py-2 text-gold-500 font-bold text-sm">
                                                    é€™æ˜¯æ‚¨çš„å¸³è™Ÿ
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                
                                {adminUsers.length === 0 && (
                                    <div className="text-center py-20 text-stone-500">
                                        <UserPlus size={48} className="mx-auto mb-4 opacity-20" />
                                        <p className="text-lg font-bold">å°šç„¡ç®¡ç†å“¡</p>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {/* æ–°å¢/ç·¨è¼¯ç®¡ç†å“¡ Modal */}
                        {showAddAdminModal && (
                            <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                                <div className="bg-stone-800 rounded-3xl p-8 max-w-md w-full border border-stone-700 shadow-2xl">
                                    <h3 className="text-2xl font-black text-white mb-6 flex items-center gap-3">
                                        {editingAdmin ? <Edit2 size={24} className="text-water-500" /> : <UserPlus size={24} className="text-fire-500" />}
                                        {editingAdmin ? 'ç·¨è¼¯ç®¡ç†å“¡' : 'æ–°å¢ç®¡ç†å“¡'}
                                    </h3>
                                    
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-stone-400 text-sm font-bold mb-2">Email</label>
                                            <input
                                                type="email"
                                                value={newAdminEmail}
                                                onChange={(e) => setNewAdminEmail(e.target.value)}
                                                placeholder="admin@example.com"
                                                disabled={!!editingAdmin}
                                                className="w-full bg-stone-900 border border-stone-600 rounded-xl px-4 py-3 text-white placeholder-stone-500 focus:border-water-500 outline-none disabled:opacity-50 disabled:cursor-not-allowed"
                                            />
                                            {!editingAdmin && (
                                                <p className="text-stone-500 text-xs mt-2">è«‹è¼¸å…¥å·²è¨»å†Šç”¨æˆ¶çš„ Email</p>
                                            )}
                                        </div>
                                        
                                        <div>
                                            <label className="block text-stone-400 text-sm font-bold mb-2">è§’è‰²</label>
                                            <select
                                                value={newAdminRole}
                                                onChange={(e) => setNewAdminRole(e.target.value)}
                                                className="w-full bg-stone-900 border border-stone-600 rounded-xl px-4 py-3 text-white focus:border-water-500 outline-none cursor-pointer"
                                            >
                                                <option value="admin">ç®¡ç†å“¡</option>
                                                <option value="super_admin">è¶…ç´šç®¡ç†å“¡</option>
                                            </select>
                                            <p className="text-stone-500 text-xs mt-2">
                                                è¶…ç´šç®¡ç†å“¡å¯ä»¥ç®¡ç†å…¶ä»–ç®¡ç†å“¡
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div className="flex gap-3 mt-6">
                                        <button
                                            onClick={() => {
                                                setShowAddAdminModal(false);
                                                setEditingAdmin(null);
                                                setNewAdminEmail('');
                                                setNewAdminRole('admin');
                                            }}
                                            className="flex-1 px-4 py-3 bg-stone-700 hover:bg-stone-600 text-stone-300 font-bold rounded-xl transition-colors"
                                        >
                                            å–æ¶ˆ
                                        </button>
                                        <button
                                            onClick={handleSaveAdmin}
                                            className="flex-1 px-4 py-3 bg-fire-600 hover:bg-fire-500 text-white font-bold rounded-xl transition-colors"
                                        >
                                            {editingAdmin ? 'å„²å­˜' : 'æ–°å¢'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* ç¢ºèªå°è©±æ¡† Modal */}
                        {confirmModal.show && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                                <motion.div
                                    initial={{ opacity: 0, scale: 0.9 }}
                                    animate={{ opacity: 1, scale: 1 }}
                                    className="bg-stone-800 rounded-3xl border border-stone-700 shadow-2xl max-w-md w-full overflow-hidden"
                                >
                                    <div className="p-6 border-b border-stone-700">
                                        <h3 className="text-xl font-black text-white flex items-center gap-2">
                                            <AlertCircle className="text-gold-500" size={24} />
                                            {confirmModal.title}
                                        </h3>
                                    </div>
                                    <div className="p-6">
                                        <p className="text-stone-300 leading-relaxed">{confirmModal.message}</p>
                                    </div>
                                    <div className="p-6 bg-stone-900/50 flex gap-3">
                                        <button
                                            onClick={hideConfirm}
                                            className="flex-1 px-4 py-3 bg-stone-700 hover:bg-stone-600 text-stone-300 font-bold rounded-xl transition-colors"
                                        >
                                            å–æ¶ˆ
                                        </button>
                                        <button
                                            onClick={() => {
                                                if (confirmModal.onConfirm) {
                                                    confirmModal.onConfirm();
                                                }
                                            }}
                                            className="flex-1 px-4 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-xl transition-colors"
                                        >
                                            ç¢ºå®š
                                        </button>
                                    </div>
                                </motion.div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const LARGE_MODE_KEY = 'sodasa-accessibility-large';
        const ACTIVITY_FLOAT_DISMISSED_KEY = 'sodasa-activity-float-dismissed';
        const HOMEPAGE_POPUP_SHOWN_KEY = 'sodasa-homepage-popup-shown';
        const POPUP_NEVER_AUTO_KEY = 'sodasa-popup-never-auto';

        // å³ä¸‹è§’æ´»å‹•æµ®å‹•æŒ‰éˆ•ï¼šé»æ“Šå½ˆå‡ºæœ€æ–°æ´»å‹•
        const FloatingActivityButton = () => {
            const navigate = useNavigate();
            const location = useLocation();
            const [dismissed, setDismissed] = useState(() => {
                const raw = localStorage.getItem(ACTIVITY_FLOAT_DISMISSED_KEY);
                if (!raw) return false;
                const ts = parseInt(raw, 10);
                if (isNaN(ts)) return raw === '1';  // èˆŠæ ¼å¼ç›¸å®¹
                const SEVEN_DAYS = 7 * 24 * 60 * 60 * 1000;
                if (Date.now() - ts > SEVEN_DAYS) {
                    localStorage.removeItem(ACTIVITY_FLOAT_DISMISSED_KEY);
                    return false;
                }
                return true;
            });
            const [showModal, setShowModal] = useState(false);
            const [events, setEvents] = useState([]);
            const [loading, setLoading] = useState(false);
            const [neverAuto, setNeverAuto] = useState(() => localStorage.getItem(POPUP_NEVER_AUTO_KEY) === '1');

            const POPUP_EVENTS_COLUMNS = 'id, title, tag, timestamp, content, is_popup_featured, popup_aspect_ratio, show_in_popup';
            const fetchPopupEvents = () => getSupabaseData(DB_TABLES.EVENTS, { columns: POPUP_EVENTS_COLUMNS, limit: 20 })
                .then((loaded) => {
                    const visible = (loaded || []).filter((e) => e.show_in_popup !== false);
                    const sorted = visible.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    return [...sorted].sort((a, b) => (!!b.is_popup_featured ? 1 : 0) - (!!a.is_popup_featured ? 1 : 0));
                });

            // è·¨åˆ†é ï¼šç•¶å…¶ä»–åˆ†é ï¼ˆå¦‚å¾Œå°ï¼‰æ›´æ–°ä¸»æ‰“ç‹€æ…‹æ™‚ï¼Œå½ˆçª—é–‹å•Ÿä¸­å‰‡é‡æ–°è¼‰å…¥
            useEffect(() => {
                const onStorage = (e) => {
                    if (e.key === 'popup-events-updated' && showModal) {
                        fetchPopupEvents().then(setEvents);
                    }
                };
                window.addEventListener('storage', onStorage);
                return () => window.removeEventListener('storage', onStorage);
            }, [showModal]);

            // é¦–é è‡ªå‹•å½ˆçª—ï¼ˆæ¯ session åƒ…ä¸€æ¬¡ï¼›è‹¥ä½¿ç”¨è€…å‹¾é¸ã€Œä¸å†è‡ªå‹•é¡¯ç¤ºã€å‰‡è·³éï¼‰
            useEffect(() => {
                if (location.pathname !== '/' || dismissed || neverAuto) return;
                if (sessionStorage.getItem(HOMEPAGE_POPUP_SHOWN_KEY) === '1') return;
                const t = setTimeout(() => {
                    sessionStorage.setItem(HOMEPAGE_POPUP_SHOWN_KEY, '1');
                    setShowModal(true);
                    setLoading(true);
                    fetchPopupEvents().then(setEvents).finally(() => setLoading(false));
                }, 1500);
                return () => clearTimeout(t);
            }, [location.pathname, dismissed, neverAuto]);

            const extractFirstImage = (html) => {
                if (!html) return null;
                const m = html.match(/<img[^>]+src=["']([^"']+)["']/i);
                return m ? m[1] : null;
            };

            const handleOpen = async () => {
                setShowModal(true);
                setLoading(true);
                try {
                    const data = await fetchPopupEvents();
                    setEvents(data);
                } finally {
                    setLoading(false);
                }
            };

            const handleDismiss = (e) => {
                e.stopPropagation();
                setDismissed(true);
                localStorage.setItem(ACTIVITY_FLOAT_DISMISSED_KEY, Date.now().toString());
            };

            if (dismissed) return null;

            return (
                <>
                    <motion.button
                        initial={{ scale: 0, opacity: 0 }}
                        animate={{ scale: 1, opacity: 1 }}
                        transition={{ delay: 1, type: 'spring', stiffness: 200 }}
                        onClick={handleOpen}
                        className="fixed z-40 right-20 md:right-20 bottom-24 md:bottom-6 w-16 h-16 rounded-full bg-gradient-to-br from-orange-500 to-red-500 text-white shadow-xl shadow-orange-500/40 flex flex-col items-center justify-center hover:scale-105 active:scale-95 transition-transform border-2 border-white/30"
                        title="æœ€æ–°æ´»å‹•"
                        aria-label="é–‹å•Ÿæœ€æ–°æ´»å‹•"
                    >
                        <button
                            onClick={handleDismiss}
                            className="absolute -top-1 -right-1 w-6 h-6 rounded-full bg-stone-600 text-white flex items-center justify-center hover:bg-stone-500 transition-colors text-xs font-bold"
                            aria-label="é—œé–‰"
                        >
                            <X size={12} strokeWidth={3} />
                        </button>
                        <Gift size={20} className="mb-0.5" />
                        <span className="text-[10px] font-bold leading-tight">æ–°æ´»å‹•</span>
                    </motion.button>

                    <AnimatePresence>
                        {showModal && (
                            <motion.div
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                exit={{ opacity: 0 }}
                                className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-stone-900/70 backdrop-blur-sm"
                                onClick={() => setShowModal(false)}
                            >
                                <motion.div
                                    initial={{ scale: 0.9, opacity: 0 }}
                                    animate={{ scale: 1, opacity: 1 }}
                                    exit={{ scale: 0.9, opacity: 0 }}
                                    transition={{ type: 'spring', damping: 25 }}
                                    onClick={(e) => e.stopPropagation()}
                                    className="bg-white rounded-2xl shadow-2xl max-w-xl w-full max-h-[90vh] overflow-hidden flex flex-col"
                                >
                                    <div className="flex items-center justify-between p-4 border-b border-stone-200">
                                        <h3 className="text-xl font-black text-stone-800 flex items-center gap-2">
                                            <Megaphone size={24} className="text-fire-500" />
                                            æœ€æ–°æ´»å‹•
                                        </h3>
                                        <button onClick={() => setShowModal(false)} className="p-2 rounded-xl hover:bg-stone-100 text-stone-500">
                                            <X size={20} />
                                        </button>
                                    </div>
                                    <div className="overflow-y-auto flex-1 p-4 space-y-4">
                                        {loading ? (
                                            <div className="py-12 text-center text-stone-500">è¼‰å…¥ä¸­...</div>
                                        ) : events.length === 0 ? (
                                            <div className="py-12 text-center text-stone-500">ç›®å‰æ²’æœ‰æ´»å‹•å…¬å‘Š</div>
                                        ) : (
                                            (() => {
                                                const featured = events.find(e => !!e.is_popup_featured);
                                                const others = events.filter(e => !e.is_popup_featured).slice(0, 4);
                                                const aspectClass = (ratio) => {
                                                    const r = ratio || '1:1';
                                                    if (r === '16:9') return 'aspect-video';
                                                    if (r === '9:16') return 'aspect-[9/16]';
                                                    return 'aspect-square';
                                                };
                                                const list = featured ? [featured, ...others] : others;
                                                return list.map((ev) => {
                                                    const tag = EVENT_TAGS.find(t => t.id === ev.tag) || EVENT_TAGS[0];
                                                    const imgSrc = extractFirstImage(ev.content);
                                                    const isFeatured = !!ev.is_popup_featured;
                                                    const textPreview = (() => { const t = (ev.content || '').replace(/<[^>]+>/g, ' ').trim() || 'ç„¡å…§å®¹'; return t.length > 80 ? t.slice(0, 80) + 'â€¦' : t; })();
                                                    const aspect = aspectClass(ev.popup_aspect_ratio);
                                                    return (
                                                        <div key={ev.id} className={`rounded-xl border overflow-hidden transition-colors ${isFeatured ? 'bg-gradient-to-br from-amber-50 to-orange-50 border-amber-200 ring-2 ring-amber-200/50' : 'bg-stone-50 border-stone-100 hover:border-stone-200'}`}>
                                                            {isFeatured && <div className="px-3 py-1 bg-amber-500 text-white text-xs font-bold">å½ˆçª—ä¸»æ‰“</div>}
                                                            <div className="p-4">
                                                                {imgSrc && (
                                                                    <div className={`rounded-xl overflow-hidden mb-3 w-full ${isFeatured ? aspect : aspect + ' h-56'}`}>
                                                                        <img src={imgSrc} alt={ev.title} className="w-full h-full object-cover object-center" />
                                                                    </div>
                                                                )}
                                                                <div className="flex items-center gap-2 mb-2">
                                                                    <span className={`${tag.color} px-2 py-0.5 rounded text-xs font-bold`}>{tag.label}</span>
                                                                    <span className="text-stone-400 text-xs">{new Date(ev.timestamp || ev.created_at).toLocaleDateString('zh-TW')}</span>
                                                                </div>
                                                                <h4 className="font-bold text-stone-800 mb-1 line-clamp-2">{ev.title}</h4>
                                                                <p className="text-stone-600 text-sm line-clamp-2">{textPreview}</p>
                                                            </div>
                                                        </div>
                                                    );
                                                });
                                            })()
                                        )}
                                    </div>
                                    <div className="p-4 border-t border-stone-200 space-y-3">
                                        <button
                                            onClick={() => { setShowModal(false); navigate('/events'); }}
                                            className="w-full py-3 bg-gradient-to-r from-gold-500 to-orange-500 hover:from-gold-600 hover:to-orange-600 text-white font-bold rounded-xl transition-colors flex items-center justify-center gap-2"
                                        >
                                            æŸ¥çœ‹å…¨éƒ¨æ´»å‹• <ArrowRight size={18} />
                                        </button>
                                        <label className="flex items-center justify-center gap-2 cursor-pointer group">
                                            <input
                                                type="checkbox"
                                                checked={neverAuto}
                                                onChange={(e) => {
                                                    const v = e.target.checked;
                                                    setNeverAuto(v);
                                                    localStorage.setItem(POPUP_NEVER_AUTO_KEY, v ? '1' : '0');
                                                }}
                                                className="w-4 h-4 rounded border-stone-300 text-orange-500 focus:ring-orange-400"
                                            />
                                            <span className="text-xs text-stone-400 group-hover:text-stone-600 transition-colors select-none">ä¸å†è‡ªå‹•å½ˆå‡ºæ­¤è¦–çª—</span>
                                        </label>
                                    </div>
                                </motion.div>
                            </motion.div>
                        )}
                    </AnimatePresence>
                </>
            );
        };
        
        const Layout = () => {
            const [isScrolled, setIsScrolled] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [user, setUser] = useState(null);
            const [largeMode, setLargeMode] = useState(() => localStorage.getItem(LARGE_MODE_KEY) === '1');
            const location = useLocation();

            useEffect(() => {
                document.documentElement.classList.toggle('accessibility-large', largeMode);
                localStorage.setItem(LARGE_MODE_KEY, largeMode ? '1' : '0');
            }, [largeMode]);

            useEffect(() => {
                const handleScroll = () => setIsScrolled(window.scrollY > 50);
                window.addEventListener('scroll', handleScroll);
                setTimeout(() => setIsLoading(false), 1500);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);
            
            useEffect(() => {
                // æª¢æŸ¥ç•¶å‰ç”¨æˆ¶
                authHelpers.getCurrentUser().then(setUser);
                
                // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
                const { data } = authHelpers.onAuthStateChange((event, session) => {
                    setUser(session?.user ?? null);
                });
                
                return () => {
                    if (data?.subscription) {
                        data.subscription.unsubscribe();
                    }
                };
            }, []);

            return (
                <div className="min-h-screen flex flex-col font-sans pb-20 md:pb-0 text-stone-800">
                    <AnimatePresence>
                        {isLoading && <LoadingScreen key="loader" />}
                    </AnimatePresence>

                    <ToastContainer />
                    <GlobalRealtimeSync />

                    {/* å³ä¸‹è§’æ´»å‹•æµ®å‹•æŒ‰éˆ• */}
                    <FloatingActivityButton />

                    {/* å¤§å­—æ¨¡å¼åˆ‡æ›ï¼ˆä¸­é«˜é½¡å‹å–„ï¼‰ */}
                    <button
                        onClick={() => setLargeMode(v => !v)}
                        className={`fixed z-40 right-4 bottom-24 md:bottom-6 flex items-center justify-center w-12 h-12 rounded-full shadow-lg border-2 transition-all min-h-[48px] min-w-[48px] ${largeMode ? 'bg-gold-500 text-white border-gold-600' : 'bg-white/90 text-stone-600 border-stone-200 hover:bg-stone-50'}`}
                        title={largeMode ? 'åˆ‡æ›ä¸€èˆ¬æ¨¡å¼' : 'å¤§å­—æ¨¡å¼ï¼ˆå­—é«”æ”¾å¤§ã€æŒ‰éˆ•åŠ å¤§ï¼‰'}
                        aria-label={largeMode ? 'åˆ‡æ›ä¸€èˆ¬æ¨¡å¼' : 'å¤§å­—æ¨¡å¼'}
                    >
                        <Type size={22} strokeWidth={2.5} />
                    </button>

                    <ScrollToTop />
                    <PageTitle />
                    <nav className={`fixed top-0 w-full z-50 transition-all duration-300 ${isScrolled ? 'py-2.5 bg-white/95 backdrop-blur-xl shadow-md shadow-stone-200/30 border-b border-stone-100' : 'py-5 bg-transparent'}`}>
                        <div className="max-w-7xl mx-auto px-4 md:px-6 flex justify-between items-center">
                            <Link to="/" className="flex items-center gap-4 group min-h-[44px] min-w-[44px] md:min-w-0">
                                <div className="h-10 md:h-12 w-auto overflow-visible group-hover:scale-105 transition-transform duration-200 drop-shadow-sm">
                                    <SmartImage src={getAssetUrl(ASSETS.LOGO)} fallbackType="logo" className="h-full w-auto object-contain" alt="è˜‡æ‰“çŸ³å™¨" />
                                </div>
                            </Link>

                            <div className={`hidden lg:flex items-center gap-1 px-2 py-1.5 rounded-2xl transition-all duration-300 ${isScrolled ? 'bg-stone-100/60' : 'bg-white/80 backdrop-blur-lg border border-white/60 shadow-lg shadow-stone-200/20'}`}>
                                {['éƒ¨è½é¦–é ', 'æ´»å‹•æ”»ç•¥', 'é‡‘å¹£è´ŠåŠ©', 'å®˜æ–¹å®¢æœ'].map((label, i) => {
                                    const path = i === 0 ? '/' : i === 1 ? '/guides' : i === 2 ? '/recharge' : '/support';
                                    const isActive = location.pathname === path;
                                    return (
                                        <Link key={path} to={path} className="rounded-xl">
                                            <div className={`px-4 py-2.5 rounded-xl text-sm font-bold transition-all duration-200 ${isActive ? 'bg-white text-stone-800 shadow-md' : 'text-stone-500 hover:text-stone-700 hover:bg-white/60'}`}>
                                                {label}
                                            </div>
                                        </Link>
                                    );
                                })}
                                <Link key="events" to="/events" className="rounded-xl">
                                    <div className={`px-4 py-2.5 rounded-xl text-sm font-bold transition-all duration-200 ${location.pathname === '/events' ? 'bg-white text-stone-800 shadow-md' : 'text-stone-500 hover:text-stone-700 hover:bg-white/60'}`}>
                                        æœ€æ–°æ´»å‹•
                                    </div>
                                </Link>
                            </div>

                            <div className="flex items-center gap-2 md:gap-3">
                                <MusicPlayer />
                                
                                {/* æœƒå“¡/ç™»å…¥æŒ‰éˆ• */}
                                {user ? (
                                    <Link to="/member" className="hidden lg:flex items-center gap-2 px-3 py-2 text-stone-700 hover:text-stone-900 transition-colors bg-white/80 hover:bg-stone-50 border border-stone-200 rounded-xl shadow-sm font-bold text-sm" title="æœƒå“¡ä¸­å¿ƒ">
                                        <User className="w-4 h-4" />
                                        <span className="hidden xl:inline">æœƒå“¡ä¸­å¿ƒ</span>
                                    </Link>
                                ) : (
                                    <Link to="/auth" className="hidden lg:flex items-center gap-2 px-3 py-2 text-white bg-gradient-to-r from-gold-500 to-gold-600 hover:from-gold-600 hover:to-gold-700 transition-all rounded-xl shadow-md font-bold text-sm" title="ç™»å…¥/è¨»å†Š">
                                        <User className="w-4 h-4" />
                                        <span className="hidden xl:inline">ç™»å…¥</span>
                                    </Link>
                                )}
                                
                                {/* ç®¡ç†å“¡å°ˆç”¨ï¼šå¾Œå°ç®¡ç†æŒ‰éˆ•ï¼ˆæœ€å³é‚Šï¼‰ */}
                                {(user?.user_metadata?.role === 'admin' || user?.user_metadata?.role === 'super_admin') && (
                                    <Link to="/admin" className="hidden lg:flex items-center gap-2 px-3 py-2 transition-colors rounded-xl shadow-sm font-bold text-sm" title="å¾Œå°ç®¡ç†">
                                        <div className={`flex items-center gap-2 ${location.pathname === '/admin' ? 'bg-gradient-to-r from-gold-500 to-orange-500 text-white px-3 py-2 rounded-xl' : 'text-orange-600 hover:text-orange-700 bg-orange-50 hover:bg-orange-100 border border-orange-200 px-3 py-2 rounded-xl'}`}>
                                            <Settings className="w-4 h-4" />
                                            <span className="hidden xl:inline">å¾Œå°ç®¡ç†</span>
                                        </div>
                                    </Link>
                                )}
                            </div>
                        </div>
                    </nav>

                    <MobileBottomNav />

                    <div className="flex-grow">
                        <AnimatePresence mode="wait">
                            <Routes location={location} key={location.pathname}>
                                <Route path="/" element={<HomePage />} />
                                <Route path="/auth" element={<AuthPage />} />
                                <Route path="/member" element={<MemberPage />} />
                                <Route path="/recharge" element={<RechargePage />} />
                                <Route path="/support" element={<SupportPage />} />
                                <Route path="/terms" element={<TermsPage />} />
                                <Route path="/download" element={<DownloadPage />} />
                                <Route path="/guides/:id" element={<GuidesPage />} />
                                <Route path="/guides" element={<GuidesPage />} />
                                <Route path="/events" element={<EventsPage />} />
                                <Route path="/admin" element={<AdminPage />} />
                                <Route path="*" element={<NotFoundPage />} />
                            </Routes>
                        </AnimatePresence>
                    </div>

                    <footer className="bg-stone-900 py-12 md:py-16 px-6 border-t-4 border-wood-600 mt-auto relative z-10 text-stone-400 mb-20 md:mb-0">
                        <div className="max-w-7xl mx-auto space-y-8">
                            {/* å…è²¬è²æ˜å€å¡Š */}
                            <div className="bg-stone-800/50 rounded-2xl p-6 md:p-8 border border-stone-700">
                                <h3 className="text-gold-400 font-black text-lg mb-4 flex items-center gap-2">
                                    <AlertCircle size={20} />
                                    å…è²¬è²æ˜
                                </h3>
                                <div className="space-y-3 text-stone-400 text-sm leading-relaxed">
                                    <p>
                                        <strong className="text-stone-300">âš ï¸ æœ¬ä¼ºæœå™¨ç‚ºéç‡Ÿåˆ©æ€§è³ªçš„ç²‰çµ²ç§äººä¼ºæœå™¨</strong>ï¼Œèˆ‡åŸå» å…¬å¸ç„¡ä»»ä½•é—œè¯ã€‚
                                        åƒ…ä¾›ç©å®¶å¨›æ¨‚äº¤æµï¼Œç‚ºç¶­æŒä¼ºæœå™¨é‹ä½œæ¥å—ç©å®¶è‡ªé¡˜è´ŠåŠ©ã€‚
                                    </p>
                                    <p>
                                        â€¢ ç©å®¶è´ŠåŠ©ç‚º<strong className="text-red-400">è‡ªé¡˜è¡Œç‚º</strong>ï¼Œä¸€ç¶“å®Œæˆ<strong className="text-red-400">æ•ä¸æ¥å—é€€æ¬¾æˆ–æ›è²¨</strong>
                                    </p>
                                    <p>
                                        â€¢ è™›æ“¬ç‰©å“å›é¥‹<strong className="text-gold-400">åƒ…é™éŠæˆ²å…§ä½¿ç”¨</strong>ï¼Œä¸å…·å¯¦éš›åƒ¹å€¼ï¼Œç„¡æ³•å…Œæ›ç¾é‡‘
                                    </p>
                                    <p>
                                        â€¢ æœ¬æœå‹™å¯èƒ½å› ç¶­è­·ã€æ›´æ–°ã€ä¸å¯æŠ—åŠ›ç­‰å› ç´ ä¸­æ–·ï¼Œå°æ–¼æœå‹™ä¸­æ–·é€ æˆçš„æå¤±ï¼Œ<strong className="text-red-400">æœ¬æœå‹™ä¸è² è³ å„Ÿè²¬ä»»</strong>
                                    </p>
                                </div>
                                <div className="mt-4 pt-4 border-t border-stone-700">
                                    <Link 
                                        to="/terms" 
                                        className="inline-flex items-center gap-2 text-gold-400 hover:text-gold-300 font-bold text-sm transition-colors"
                                    >
                                        <ScrollText size={16} />
                                        æŸ¥çœ‹å®Œæ•´æœå‹™æ¢æ¬¾
                                        <ArrowRight size={14} />
                                    </Link>
                                </div>
                            </div>

                            {/* é å°¾è³‡è¨Š */}
                            <div className="flex flex-col md:flex-row justify-between items-center gap-6 pt-6 border-t border-stone-800">
                                <div className="flex items-center gap-5 opacity-90">
                                    <div className="h-9 md:h-10 w-auto overflow-hidden grayscale hover:grayscale-0 transition-all duration-300">
                                        <SmartImage src={getAssetUrl(ASSETS.LOGO)} fallbackType="logo" className="h-full w-auto object-contain brightness-0 invert" alt="è˜‡æ‰“çŸ³å™¨" />
                                    </div>
                                    <span className="font-bold text-sm tracking-widest border-l border-stone-600 pl-5 h-8 flex items-center">SODA STONE AGE</span>
                                </div>
                                <div className="flex flex-col md:flex-row items-center gap-4 md:gap-6 text-xs">
                                    <Link to="/support" className="hover:text-gold-400 transition-colors font-bold">å®˜æ–¹å®¢æœ</Link>
                                    <Link to="/terms" className="hover:text-gold-400 transition-colors font-bold">æœå‹™æ¢æ¬¾</Link>
                                    <p className="font-mono tracking-wide opacity-60">Â© 2026 Fan-made Project</p>
                                </div>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        const App = () => {
            return <Layout />;
        };

        const root = createRoot(document.getElementById('root'));
        root.render(
            <BrowserRouter>
                <App />
            </BrowserRouter>
        );
    </script>

    <!-- Structured Data (JSON-LD) for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "VideoGame",
      "name": "è˜‡æ‰“çŸ³å™¨",
      "alternateName": "Soda Stone Age",
      "description": "ç¶“å…¸çŸ³å™¨æ™‚ä»£ 2.5 ç‰ˆæœ¬ç§æœï¼Œå®Œç¾å¾©åˆ»åŸæ±åŸå‘³ï¼Œç´”æ·¨éŠæˆ²ç’°å¢ƒï¼Œé•·ä¹…ç©©å®šç¶“ç‡Ÿ",
      "genre": ["MMORPG", "è§’è‰²æ‰®æ¼”", "å¤šäººç·šä¸ŠéŠæˆ²"],
      "gamePlatform": "PC",
      "operatingSystem": "Windows",
      "applicationCategory": "Game",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "TWD",
        "availability": "https://schema.org/InStock"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "150",
        "bestRating": "5",
        "worstRating": "1"
      },
      "provider": {
        "@type": "Organization",
        "name": "è˜‡æ‰“çŸ³å™¨åœ˜éšŠ",
        "url": "https://soda-stone.com"
      }
    }
    </script>

    <!-- Service Worker Registration for PWA -->
    <script>
        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('âœ… Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('âŒ Service Worker registration failed:', error);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Optional: Show custom install button
            console.log('ğŸ’¡ PWA can be installed');
        });

        // Track PWA installation
        window.addEventListener('appinstalled', () => {
            console.log('âœ… PWA installed successfully');
            deferredPrompt = null;
        });
    </script>

    <!-- Performance Monitoring -->
    <script>
        // Log page load performance
        window.addEventListener('load', () => {
            if (window.performance) {
                const perfData = window.performance.timing;
                const pageLoadTime = perfData.loadEventEnd - perfData.navigationStart;
                const connectTime = perfData.responseEnd - perfData.requestStart;
                console.log(`ğŸ“Š Page Load: ${pageLoadTime}ms, Server Response: ${connectTime}ms`);
            }
        });
    </script>
</body>
</html>